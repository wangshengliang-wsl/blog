---
title: æ€§èƒ½åˆ†æ
description: ä½¿ç”¨ Bundle Analyzerã€Web Vitals å’Œ DevTools åˆ†æ Next.js åº”ç”¨æ€§èƒ½ï¼Œå®šä½ç“¶é¢ˆå¹¶ä¼˜åŒ–
pubDate: 2025-12-03
toc: true
ogImage: true
category: Next
tags: ['Next.js', 'æ€§èƒ½åˆ†æ', 'Core Web Vitals', 'Bundle Analyzer']
---

ğŸ™‹ åº”ç”¨å˜æ…¢äº†ä½†ä¸çŸ¥é“é—®é¢˜åœ¨å“ªï¼Ÿç³»ç»Ÿçš„æ€§èƒ½åˆ†æèƒ½å¸®ä½ æ‰¾åˆ°ç“¶é¢ˆã€‚

## Core Web Vitals

Google çš„æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡ï¼š

| æŒ‡æ ‡ | å…¨ç§°                      | è‰¯å¥½å€¼  | è¡¡é‡å†…å®¹         |
| ---- | ------------------------- | ------- | ---------------- |
| LCP  | Largest Contentful Paint  | < 2.5s  | æœ€å¤§å†…å®¹ç»˜åˆ¶æ—¶é—´ |
| INP  | Interaction to Next Paint | < 200ms | äº¤äº’å“åº”æ€§       |
| CLS  | Cumulative Layout Shift   | < 0.1   | å¸ƒå±€ç¨³å®šæ€§       |

## å†…ç½®æ€§èƒ½åˆ†æ

### useReportWebVitals

```tsx
// app/layout.tsx
import { WebVitals } from '@/components/WebVitals'

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="zh-CN">
      <body>
        <WebVitals />
        {children}
      </body>
    </html>
  )
}
```

```tsx
// components/WebVitals.tsx
'use client'

import { useReportWebVitals } from 'next/web-vitals'

export function WebVitals() {
  useReportWebVitals((metric) => {
    console.log(metric)

    // å‘é€åˆ°åˆ†ææœåŠ¡
    fetch('/api/analytics', {
      method: 'POST',
      body: JSON.stringify({
        name: metric.name,
        value: metric.value,
        id: metric.id,
        delta: metric.delta,
        rating: metric.rating,
      }),
    })
  })

  return null
}
```

### ä¸ŠæŠ¥åˆ°åˆ†æå¹³å°

```tsx
// components/WebVitals.tsx
'use client'

import { useReportWebVitals } from 'next/web-vitals'

export function WebVitals() {
  useReportWebVitals((metric) => {
    // Google Analytics
    if (window.gtag) {
      window.gtag('event', metric.name, {
        value: Math.round(
          metric.name === 'CLS' ? metric.value * 1000 : metric.value
        ),
        event_label: metric.id,
        non_interaction: true,
      })
    }

    // Vercel Analytics
    if (window.va) {
      window.va('event', {
        name: metric.name,
        value: metric.value,
      })
    }
  })

  return null
}
```

## Bundle Analyzer

### å®‰è£…é…ç½®

```bash
pnpm add @next/bundle-analyzer
```

```tsx
// next.config.ts
import type { NextConfig } from 'next'
import bundleAnalyzer from '@next/bundle-analyzer'

const withBundleAnalyzer = bundleAnalyzer({
  enabled: process.env.ANALYZE === 'true',
})

const config: NextConfig = {
  // å…¶ä»–é…ç½®
}

export default withBundleAnalyzer(config)
```

### è¿è¡Œåˆ†æ

```bash
ANALYZE=true pnpm build
```

è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨æ˜¾ç¤ºï¼š

- `client.html` - å®¢æˆ·ç«¯ bundle
- `nodejs.html` - æœåŠ¡ç«¯ bundle

### åˆ†æç»“æœè§£è¯»

é‡ç‚¹å…³æ³¨ï¼š

1. **å¤§æ¨¡å—** - è¶…è¿‡ 100KB çš„æ¨¡å—
2. **é‡å¤ä¾èµ–** - å¤šæ¬¡æ‰“åŒ…çš„åº“
3. **æœªä½¿ç”¨ä»£ç ** - tree-shaking æœªç§»é™¤çš„ä»£ç 

## æ„å»ºè¾“å‡ºåˆ†æ

```bash
pnpm build
```

è¾“å‡ºç¤ºä¾‹ï¼š

```
Route (app)                              Size     First Load JS
â”Œ â—‹ /                                    5.2 kB         92 kB
â”œ â—‹ /about                               1.2 kB         88 kB
â”œ â— /blog                                2.1 kB         89 kB
â”œ â— /blog/[slug]                         3.5 kB         91 kB
â”œ Î» /api/search                          0 B            0 B
â”” Î» /dashboard                           4.2 kB         95 kB

â—‹  (Static)   prerendered as static content
â—  (SSG)      prerendered as static HTML (uses getStaticProps)
Î»  (Dynamic)  server-rendered on demand

First Load JS shared by all              87.1 kB
â”œ chunks/framework-xxx.js                45.2 kB
â”œ chunks/main-xxx.js                     28.9 kB
â”” chunks/pages/_app-xxx.js               13 kB
```

### ä¼˜åŒ–ç›®æ ‡

| æŒ‡æ ‡          | ç›®æ ‡     | è¯´æ˜         |
| ------------- | -------- | ------------ |
| First Load JS | < 100 kB | é¦–å± JS ä½“ç§¯ |
| å•é¡µ Size     | < 50 kB  | é¡µé¢ç‰¹æœ‰ä»£ç  |
| å…±äº« chunks   | < 100 kB | æ‰€æœ‰é¡µé¢å…±ç”¨ |

## è¿è¡Œæ—¶æ€§èƒ½åˆ†æ

### React DevTools Profiler

```tsx
// åœ¨å¼€å‘ç¯å¢ƒå¯ç”¨ Profiler
;<Profiler id="MyComponent" onRender={onRenderCallback}>
  <MyComponent />
</Profiler>

function onRenderCallback(
  id: string,
  phase: 'mount' | 'update',
  actualDuration: number,
  baseDuration: number,
  startTime: number,
  commitTime: number
) {
  console.log({
    id,
    phase,
    actualDuration,
    baseDuration,
  })
}
```

### è‡ªå®šä¹‰æ€§èƒ½æ ‡è®°

```tsx
// lib/performance.ts
export function measureAsync<T>(
  name: string,
  fn: () => Promise<T>
): Promise<T> {
  if (typeof performance === 'undefined') {
    return fn()
  }

  const start = performance.now()
  return fn().finally(() => {
    const duration = performance.now() - start
    console.log(`[Performance] ${name}: ${duration.toFixed(2)}ms`)

    // å‘é€åˆ°åˆ†ææœåŠ¡
    if (process.env.NODE_ENV === 'production') {
      sendToAnalytics(name, duration)
    }
  })
}
```

```tsx
// ä½¿ç”¨
const data = await measureAsync('fetchPosts', () => getPosts())
```

## æœåŠ¡ç«¯æ€§èƒ½åˆ†æ

### æ•°æ®è·å–è®¡æ—¶

```tsx
// app/page.tsx
export default async function Page() {
  const start = Date.now()

  const [posts, users] = await Promise.all([getPosts(), getUsers()])

  if (process.env.NODE_ENV === 'development') {
    console.log(`Data fetching: ${Date.now() - start}ms`)
  }

  return <div>{/* ... */}</div>
}
```

### è¯·æ±‚è¿½è¸ª

```tsx
// lib/fetch.ts
export async function tracedFetch(
  url: string,
  options?: RequestInit
): Promise<Response> {
  const start = Date.now()

  try {
    const response = await fetch(url, options)
    const duration = Date.now() - start

    console.log(`[Fetch] ${url} - ${response.status} - ${duration}ms`)

    return response
  } catch (error) {
    const duration = Date.now() - start
    console.error(`[Fetch Error] ${url} - ${duration}ms`, error)
    throw error
  }
}
```

## å¸¸è§æ€§èƒ½é—®é¢˜

### 1. Bundle è¿‡å¤§

é—®é¢˜å®šä½ï¼š

```bash
ANALYZE=true pnpm build
```

è§£å†³æ–¹æ¡ˆï¼š

```tsx
// åŠ¨æ€å¯¼å…¥å¤§å‹åº“
import dynamic from 'next/dynamic'

const HeavyChart = dynamic(() => import('@/components/HeavyChart'), {
  loading: () => <div>åŠ è½½ä¸­...</div>,
  ssr: false,
})

// æŒ‰éœ€å¯¼å…¥
import { format } from 'date-fns/format' // âœ…
// import { format } from 'date-fns' // âŒ
```

### 2. è¯·æ±‚ç€‘å¸ƒ

é—®é¢˜ï¼šé¡ºåºè¯·æ±‚å¯¼è‡´åŠ è½½æ…¢

```tsx
// âŒ ç€‘å¸ƒæµ
const user = await getUser()
const posts = await getPosts(user.id)
const comments = await getComments(posts[0].id)

// âœ… å¹¶è¡Œè¯·æ±‚
const [user, posts] = await Promise.all([getUser(), getPosts()])
```

### 3. é‡å¤æ¸²æŸ“

ä½¿ç”¨ React DevTools æ£€æµ‹ï¼š

```tsx
// ä½¿ç”¨ memo é¿å…ä¸å¿…è¦æ¸²æŸ“
import { memo } from 'react'

const ExpensiveComponent = memo(function ExpensiveComponent({
  data,
}: {
  data: Data
}) {
  return <div>{/* å¤æ‚æ¸²æŸ“ */}</div>
})
```

### 4. å¤§å›¾ç‰‡

```tsx
// âœ… ä½¿ç”¨ next/image
import Image from 'next/image'

;<Image
  src="/large-image.jpg"
  alt="å¤§å›¾"
  width={1200}
  height={800}
  priority // é¦–å±å›¾ç‰‡
/>
```

## æ€§èƒ½ä¼˜åŒ–æ¸…å•

### æ„å»ºæ—¶ä¼˜åŒ–

- [ ] ä½¿ç”¨åŠ¨æ€å¯¼å…¥åˆ†å‰²ä»£ç 
- [ ] æŒ‰éœ€å¯¼å…¥åº“å‡½æ•°
- [ ] ç§»é™¤æœªä½¿ç”¨çš„ä¾èµ–
- [ ] å¯ç”¨ Tree Shaking
- [ ] å‹ç¼©å›¾ç‰‡èµ„æº

### è¿è¡Œæ—¶ä¼˜åŒ–

- [ ] ä½¿ç”¨ Server Components
- [ ] å®æ–½è¯·æ±‚å¹¶è¡ŒåŒ–
- [ ] æ·»åŠ é€‚å½“çš„ç¼“å­˜ç­–ç•¥
- [ ] ä½¿ç”¨ Suspense å®ç°æµå¼æ¸²æŸ“
- [ ] é¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“

### åŠ è½½ä¼˜åŒ–

- [ ] é¦–å±å›¾ç‰‡ä½¿ç”¨ priority
- [ ] ç¬¬ä¸‰æ–¹è„šæœ¬ä½¿ç”¨ lazyOnload
- [ ] å­—ä½“ä½¿ç”¨ next/font
- [ ] å¯ç”¨é¢„å– prefetch

## ç›‘æ§ä»ªè¡¨ç›˜

### è‡ªå»ºç›‘æ§

```tsx
// app/api/analytics/route.ts
import { NextRequest, NextResponse } from 'next/server'

interface Metric {
  name: string
  value: number
  id: string
  rating: 'good' | 'needs-improvement' | 'poor'
}

export async function POST(request: NextRequest) {
  const metric: Metric = await request.json()

  // å­˜å‚¨åˆ°æ•°æ®åº“
  await db.metric.create({
    data: {
      name: metric.name,
      value: metric.value,
      rating: metric.rating,
      timestamp: new Date(),
      page: request.headers.get('referer'),
      userAgent: request.headers.get('user-agent'),
    },
  })

  return NextResponse.json({ received: true })
}
```

### Vercel Analytics

```bash
pnpm add @vercel/analytics
```

```tsx
// app/layout.tsx
import { Analytics } from '@vercel/analytics/react'

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="zh-CN">
      <body>
        {children}
        <Analytics />
      </body>
    </html>
  )
}
```

### Speed Insights

```bash
pnpm add @vercel/speed-insights
```

```tsx
// app/layout.tsx
import { SpeedInsights } from '@vercel/speed-insights/next'

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="zh-CN">
      <body>
        {children}
        <SpeedInsights />
      </body>
    </html>
  )
}
```

## æ€§èƒ½æµ‹è¯•å·¥å…·

### Lighthouse

```bash
# å‘½ä»¤è¡Œè¿è¡Œ
npx lighthouse https://example.com --view
```

### PageSpeed Insights

è®¿é—® https://pagespeed.web.dev/ è¾“å…¥ç½‘å€åˆ†æã€‚

### WebPageTest

è®¿é—® https://www.webpagetest.org/ è¿›è¡Œè¯¦ç»†åˆ†æã€‚

## å¸¸è§é—®é¢˜

ğŸ¤” **Q: First Load JS è¿‡å¤§æ€ä¹ˆåŠï¼Ÿ**

1. æ£€æŸ¥æ˜¯å¦æœ‰å¤§å‹åº“å¯ä»¥åŠ¨æ€å¯¼å…¥
2. ä½¿ç”¨ Bundle Analyzer æ‰¾å‡ºå¤§æ¨¡å—
3. æ£€æŸ¥æ˜¯å¦æœ‰ä¸å¿…è¦çš„ polyfills

ğŸ¤” **Q: LCP è¿‡æ…¢æ€ä¹ˆä¼˜åŒ–ï¼Ÿ**

1. é¦–å±å›¾ç‰‡ä½¿ç”¨ `priority`
2. å‡å°‘æœåŠ¡ç«¯æ•°æ®è·å–æ—¶é—´
3. ä½¿ç”¨ Streaming æå‰å‘é€ HTML

ğŸ¤” **Q: CLS åˆ†æ•°å·®æ€ä¹ˆåŠï¼Ÿ**

1. å›¾ç‰‡è®¾ç½®æ˜ç¡®çš„å®½é«˜
2. ä½¿ç”¨ next/font é¿å…å­—ä½“é—ªçƒ
3. ä¸ºåŠ¨æ€å†…å®¹é¢„ç•™ç©ºé—´

---

æ­å–œä½ å®Œæˆäº†ä¼˜åŒ–ä¸æ€§èƒ½éƒ¨åˆ†ï¼ä¸‹ä¸€ç¯‡å°†è¿›å…¥å…¨æ ˆå¼€å‘éƒ¨åˆ†ï¼Œä»‹ç»è®¤è¯åŸºç¡€ã€‚

-EOF-
