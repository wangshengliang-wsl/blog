---
title: æµ‹è¯•ç­–ç•¥
description: æŒæ¡ Next.js åº”ç”¨çš„æµ‹è¯•æ–¹æ³•ï¼Œä½¿ç”¨ Vitest å’Œ Playwright è¿›è¡Œå•å…ƒæµ‹è¯•ä¸ç«¯åˆ°ç«¯æµ‹è¯•
pubDate: 2025-12-03
toc: true
ogImage: true
category: Next
tags: ['Next.js', 'æµ‹è¯•', 'Vitest', 'Playwright', 'Testing Library']
---

ğŸ™‹ å¦‚ä½•ç¡®ä¿ä»£ç è´¨é‡ï¼Ÿæµ‹è¯•æ˜¯å¼€å‘æµç¨‹ä¸­ä¸å¯æˆ–ç¼ºçš„ä¸€ç¯ã€‚

## æµ‹è¯•ç±»å‹

| ç±»å‹     | èŒƒå›´       | é€Ÿåº¦ | å·¥å…·                     |
| -------- | ---------- | ---- | ------------------------ |
| å•å…ƒæµ‹è¯• | å‡½æ•°/ç»„ä»¶  | å¿«   | Vitest                   |
| é›†æˆæµ‹è¯• | å¤šç»„ä»¶äº¤äº’ | ä¸­   | Vitest + Testing Library |
| E2E æµ‹è¯• | å®Œæ•´æµç¨‹   | æ…¢   | Playwright               |

## Vitest é…ç½®

### å®‰è£…

```bash
pnpm add -D vitest @vitejs/plugin-react jsdom @testing-library/react @testing-library/jest-dom
```

### é…ç½®æ–‡ä»¶

```tsx
// vitest.config.ts
import { defineConfig } from 'vitest/config'
import react from '@vitejs/plugin-react'
import { resolve } from 'path'

export default defineConfig({
  plugins: [react()],
  test: {
    environment: 'jsdom',
    setupFiles: ['./vitest.setup.ts'],
    include: ['**/*.test.{ts,tsx}'],
    globals: true,
  },
  resolve: {
    alias: {
      '@': resolve(__dirname, './src'),
    },
  },
})
```

### è®¾ç½®æ–‡ä»¶

```tsx
// vitest.setup.ts
import '@testing-library/jest-dom/vitest'
import { cleanup } from '@testing-library/react'
import { afterEach, vi } from 'vitest'

// æ¯ä¸ªæµ‹è¯•åæ¸…ç†
afterEach(() => {
  cleanup()
})

// Mock next/navigation
vi.mock('next/navigation', () => ({
  useRouter: () => ({
    push: vi.fn(),
    replace: vi.fn(),
    prefetch: vi.fn(),
    back: vi.fn(),
  }),
  usePathname: () => '/',
  useSearchParams: () => new URLSearchParams(),
}))

// Mock next/image
vi.mock('next/image', () => ({
  default: ({ src, alt, ...props }: any) => (
    <img src={src} alt={alt} {...props} />
  ),
}))
```

### package.json è„šæœ¬

```json
{
  "scripts": {
    "test": "vitest",
    "test:run": "vitest run",
    "test:coverage": "vitest run --coverage"
  }
}
```

## å•å…ƒæµ‹è¯•

### æµ‹è¯•å·¥å…·å‡½æ•°

```tsx
// lib/utils.ts
export function formatPrice(price: number): string {
  return `Â¥${price.toFixed(2)}`
}

export function slugify(text: string): string {
  return text
    .toLowerCase()
    .trim()
    .replace(/\s+/g, '-')
    .replace(/[^\w-]+/g, '')
}
```

```tsx
// lib/utils.test.ts
import { describe, it, expect } from 'vitest'
import { formatPrice, slugify } from './utils'

describe('formatPrice', () => {
  it('formats integer prices', () => {
    expect(formatPrice(100)).toBe('Â¥100.00')
  })

  it('formats decimal prices', () => {
    expect(formatPrice(99.9)).toBe('Â¥99.90')
  })

  it('handles zero', () => {
    expect(formatPrice(0)).toBe('Â¥0.00')
  })
})

describe('slugify', () => {
  it('converts spaces to hyphens', () => {
    expect(slugify('Hello World')).toBe('hello-world')
  })

  it('removes special characters', () => {
    expect(slugify('Hello, World!')).toBe('hello-world')
  })

  it('handles multiple spaces', () => {
    expect(slugify('hello   world')).toBe('hello-world')
  })
})
```

### æµ‹è¯• Server Actions

```tsx
// app/actions.ts
'use server'

import { z } from 'zod'

const schema = z.object({
  email: z.string().email(),
  name: z.string().min(2),
})

export async function createUser(formData: FormData) {
  const data = {
    email: formData.get('email'),
    name: formData.get('name'),
  }

  const result = schema.safeParse(data)

  if (!result.success) {
    return { error: result.error.flatten().fieldErrors }
  }

  // åˆ›å»ºç”¨æˆ·...
  return { success: true }
}
```

```tsx
// app/actions.test.ts
import { describe, it, expect, vi } from 'vitest'
import { createUser } from './actions'

describe('createUser', () => {
  it('validates email format', async () => {
    const formData = new FormData()
    formData.set('email', 'invalid-email')
    formData.set('name', 'John')

    const result = await createUser(formData)

    expect(result.error?.email).toBeDefined()
  })

  it('validates name length', async () => {
    const formData = new FormData()
    formData.set('email', 'test@example.com')
    formData.set('name', 'J')

    const result = await createUser(formData)

    expect(result.error?.name).toBeDefined()
  })

  it('succeeds with valid data', async () => {
    const formData = new FormData()
    formData.set('email', 'test@example.com')
    formData.set('name', 'John Doe')

    const result = await createUser(formData)

    expect(result.success).toBe(true)
  })
})
```

## ç»„ä»¶æµ‹è¯•

### åŸºç¡€ç»„ä»¶æµ‹è¯•

```tsx
// components/Button.tsx
interface ButtonProps {
  children: React.ReactNode
  onClick?: () => void
  disabled?: boolean
  loading?: boolean
}

export function Button({ children, onClick, disabled, loading }: ButtonProps) {
  return (
    <button
      onClick={onClick}
      disabled={disabled || loading}
      className="px-4 py-2 bg-blue-600 text-white rounded disabled:opacity-50"
    >
      {loading ? 'åŠ è½½ä¸­...' : children}
    </button>
  )
}
```

```tsx
// components/Button.test.tsx
import { describe, it, expect, vi } from 'vitest'
import { render, screen, fireEvent } from '@testing-library/react'
import { Button } from './Button'

describe('Button', () => {
  it('renders children', () => {
    render(<Button>Click me</Button>)
    expect(screen.getByText('Click me')).toBeInTheDocument()
  })

  it('calls onClick when clicked', () => {
    const handleClick = vi.fn()
    render(<Button onClick={handleClick}>Click me</Button>)

    fireEvent.click(screen.getByRole('button'))
    expect(handleClick).toHaveBeenCalledTimes(1)
  })

  it('is disabled when disabled prop is true', () => {
    render(<Button disabled>Click me</Button>)
    expect(screen.getByRole('button')).toBeDisabled()
  })

  it('shows loading text when loading', () => {
    render(<Button loading>Click me</Button>)
    expect(screen.getByText('åŠ è½½ä¸­...')).toBeInTheDocument()
  })
})
```

### æµ‹è¯•è¡¨å•ç»„ä»¶

```tsx
// components/LoginForm.test.tsx
import { describe, it, expect, vi } from 'vitest'
import { render, screen, fireEvent, waitFor } from '@testing-library/react'
import userEvent from '@testing-library/user-event'
import { LoginForm } from './LoginForm'

describe('LoginForm', () => {
  it('renders email and password inputs', () => {
    render(<LoginForm />)

    expect(screen.getByLabelText(/é‚®ç®±/i)).toBeInTheDocument()
    expect(screen.getByLabelText(/å¯†ç /i)).toBeInTheDocument()
  })

  it('submits form with valid data', async () => {
    const user = userEvent.setup()
    const onSubmit = vi.fn()
    render(<LoginForm onSubmit={onSubmit} />)

    await user.type(screen.getByLabelText(/é‚®ç®±/i), 'test@example.com')
    await user.type(screen.getByLabelText(/å¯†ç /i), 'password123')
    await user.click(screen.getByRole('button', { name: /ç™»å½•/i }))

    await waitFor(() => {
      expect(onSubmit).toHaveBeenCalledWith({
        email: 'test@example.com',
        password: 'password123',
      })
    })
  })

  it('shows validation errors', async () => {
    const user = userEvent.setup()
    render(<LoginForm />)

    await user.click(screen.getByRole('button', { name: /ç™»å½•/i }))

    await waitFor(() => {
      expect(screen.getByText(/è¯·è¾“å…¥é‚®ç®±/i)).toBeInTheDocument()
    })
  })
})
```

### æµ‹è¯•å¼‚æ­¥ç»„ä»¶

```tsx
// components/UserProfile.test.tsx
import { describe, it, expect, vi } from 'vitest'
import { render, screen, waitFor } from '@testing-library/react'
import { UserProfile } from './UserProfile'

// Mock fetch
global.fetch = vi.fn()

describe('UserProfile', () => {
  it('shows loading state initially', () => {
    vi.mocked(fetch).mockResolvedValueOnce({
      ok: true,
      json: async () => ({ name: 'John', email: 'john@example.com' }),
    } as Response)

    render(<UserProfile userId="1" />)
    expect(screen.getByText(/åŠ è½½ä¸­/i)).toBeInTheDocument()
  })

  it('displays user data after loading', async () => {
    vi.mocked(fetch).mockResolvedValueOnce({
      ok: true,
      json: async () => ({ name: 'John', email: 'john@example.com' }),
    } as Response)

    render(<UserProfile userId="1" />)

    await waitFor(() => {
      expect(screen.getByText('John')).toBeInTheDocument()
      expect(screen.getByText('john@example.com')).toBeInTheDocument()
    })
  })

  it('shows error message on fetch failure', async () => {
    vi.mocked(fetch).mockRejectedValueOnce(new Error('Network error'))

    render(<UserProfile userId="1" />)

    await waitFor(() => {
      expect(screen.getByText(/åŠ è½½å¤±è´¥/i)).toBeInTheDocument()
    })
  })
})
```

## Playwright E2E æµ‹è¯•

### å®‰è£…

```bash
pnpm add -D @playwright/test
npx playwright install
```

### é…ç½®

```tsx
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test'

export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
  },
  projects: [
    { name: 'chromium', use: { ...devices['Desktop Chrome'] } },
    { name: 'firefox', use: { ...devices['Desktop Firefox'] } },
    { name: 'webkit', use: { ...devices['Desktop Safari'] } },
  ],
  webServer: {
    command: 'pnpm dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
  },
})
```

### ç¼–å†™ E2E æµ‹è¯•

```tsx
// e2e/auth.spec.ts
import { test, expect } from '@playwright/test'

test.describe('Authentication', () => {
  test('can login with valid credentials', async ({ page }) => {
    await page.goto('/login')

    await page.fill('input[name="email"]', 'test@example.com')
    await page.fill('input[name="password"]', 'password123')
    await page.click('button[type="submit"]')

    await expect(page).toHaveURL('/dashboard')
    await expect(page.locator('text=æ¬¢è¿')).toBeVisible()
  })

  test('shows error with invalid credentials', async ({ page }) => {
    await page.goto('/login')

    await page.fill('input[name="email"]', 'wrong@example.com')
    await page.fill('input[name="password"]', 'wrongpassword')
    await page.click('button[type="submit"]')

    await expect(page.locator('text=é‚®ç®±æˆ–å¯†ç é”™è¯¯')).toBeVisible()
  })

  test('redirects to login when accessing protected route', async ({
    page,
  }) => {
    await page.goto('/dashboard')
    await expect(page).toHaveURL('/login')
  })
})
```

### æµ‹è¯•ç”¨æˆ·æµç¨‹

```tsx
// e2e/checkout.spec.ts
import { test, expect } from '@playwright/test'

test.describe('Checkout Flow', () => {
  test.beforeEach(async ({ page }) => {
    // ç™»å½•
    await page.goto('/login')
    await page.fill('input[name="email"]', 'test@example.com')
    await page.fill('input[name="password"]', 'password123')
    await page.click('button[type="submit"]')
    await page.waitForURL('/dashboard')
  })

  test('complete purchase flow', async ({ page }) => {
    // æµè§ˆå•†å“
    await page.goto('/products')
    await page.click('text=å•†å“ A')

    // æ·»åŠ åˆ°è´­ç‰©è½¦
    await page.click('text=åŠ å…¥è´­ç‰©è½¦')
    await expect(page.locator('.cart-count')).toHaveText('1')

    // è¿›å…¥è´­ç‰©è½¦
    await page.click('text=è´­ç‰©è½¦')
    await expect(page).toHaveURL('/cart')

    // ç»“è´¦
    await page.click('text=ç»“è´¦')
    await page.fill('input[name="address"]', 'åŒ—äº¬å¸‚æœé˜³åŒºxxx')
    await page.click('text=æäº¤è®¢å•')

    // éªŒè¯è®¢å•æˆåŠŸ
    await expect(page.locator('text=è®¢å•æäº¤æˆåŠŸ')).toBeVisible()
  })
})
```

## API è·¯ç”±æµ‹è¯•

```tsx
// app/api/users/route.test.ts
import { describe, it, expect, vi, beforeEach } from 'vitest'
import { GET, POST } from './route'
import { NextRequest } from 'next/server'

// Mock æ•°æ®åº“
vi.mock('@/lib/db', () => ({
  db: {
    user: {
      findMany: vi.fn(),
      create: vi.fn(),
    },
  },
}))

import { db } from '@/lib/db'

describe('Users API', () => {
  beforeEach(() => {
    vi.clearAllMocks()
  })

  describe('GET /api/users', () => {
    it('returns users list', async () => {
      const mockUsers = [
        { id: '1', name: 'John', email: 'john@example.com' },
        { id: '2', name: 'Jane', email: 'jane@example.com' },
      ]

      vi.mocked(db.user.findMany).mockResolvedValue(mockUsers)

      const response = await GET()
      const data = await response.json()

      expect(data).toEqual(mockUsers)
      expect(response.status).toBe(200)
    })
  })

  describe('POST /api/users', () => {
    it('creates a new user', async () => {
      const newUser = { id: '1', name: 'John', email: 'john@example.com' }
      vi.mocked(db.user.create).mockResolvedValue(newUser)

      const request = new NextRequest('http://localhost/api/users', {
        method: 'POST',
        body: JSON.stringify({ name: 'John', email: 'john@example.com' }),
      })

      const response = await POST(request)
      const data = await response.json()

      expect(data).toEqual(newUser)
      expect(response.status).toBe(201)
    })

    it('returns 400 for invalid data', async () => {
      const request = new NextRequest('http://localhost/api/users', {
        method: 'POST',
        body: JSON.stringify({ name: '' }),
      })

      const response = await POST(request)
      expect(response.status).toBe(400)
    })
  })
})
```

## æµ‹è¯•æœ€ä½³å®è·µ

### æµ‹è¯•è¦†ç›–ç‡

```tsx
// vitest.config.ts
export default defineConfig({
  test: {
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: ['node_modules/', 'e2e/', '*.config.*'],
    },
  },
})
```

### CI é›†æˆ

```yaml
# .github/workflows/test.yml
name: Test

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - run: pnpm install
      - run: pnpm test:run
      - run: pnpm test:e2e
```

## å¸¸è§é—®é¢˜

ğŸ¤” **Q: æµ‹è¯•ä¸­å¦‚ä½•å¤„ç†ç¯å¢ƒå˜é‡ï¼Ÿ**

åˆ›å»º `.env.test` æ–‡ä»¶æˆ–åœ¨æµ‹è¯•è®¾ç½®ä¸­ mockï¼š

```tsx
// vitest.setup.ts
process.env.DATABASE_URL = 'test-database-url'
```

ğŸ¤” **Q: å¦‚ä½•æµ‹è¯•éœ€è¦è®¤è¯çš„é¡µé¢ï¼Ÿ**

åœ¨ E2E æµ‹è¯•ä¸­å…ˆæ‰§è¡Œç™»å½•ï¼Œæˆ–ä½¿ç”¨ `storageState` ä¿å­˜è®¤è¯çŠ¶æ€ã€‚

ğŸ¤” **Q: å•å…ƒæµ‹è¯•å’Œ E2E æµ‹è¯•æ¯”ä¾‹ï¼Ÿ**

é€šå¸¸éµå¾ªæµ‹è¯•é‡‘å­—å¡”ï¼š70% å•å…ƒæµ‹è¯•ï¼Œ20% é›†æˆæµ‹è¯•ï¼Œ10% E2E æµ‹è¯•ã€‚

---

ä¸‹ä¸€ç¯‡å°†ä»‹ç»éƒ¨ç½²æ–¹æ¡ˆï¼Œå­¦ä¹ å¦‚ä½•å°†åº”ç”¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒã€‚

-EOF-
