---
title: Streaming ä¸ Suspense
description: æŒæ¡ Next.js æµå¼æ¸²æŸ“æœºåˆ¶ï¼Œä½¿ç”¨ Suspense å’Œ loading.tsx å®ç°æ¸è¿›å¼é¡µé¢åŠ è½½
pubDate: 2025-12-03
toc: true
ogImage: true
category: Next
tags: ['Next.js', 'Streaming', 'Suspense', 'loading', 'éª¨æ¶å±']
---

ğŸ™‹ æ•°æ®è¯·æ±‚æ…¢å¯¼è‡´æ•´ä¸ªé¡µé¢ç™½å±ï¼ŸStreaming å¯ä»¥è®©é¡µé¢é€æ­¥æ˜¾ç¤ºï¼Œå¤§å¹…æå‡ç”¨æˆ·ä½“éªŒã€‚

## ä»€ä¹ˆæ˜¯ Streaming

ä¼ ç»Ÿ SSR éœ€è¦ç­‰å¾…æ‰€æœ‰æ•°æ®å‡†å¤‡å¥½æ‰èƒ½å‘é€ HTMLã€‚Streaming å…è®¸å°†é¡µé¢åˆ†å—å‘é€ï¼Œå…ˆæ˜¾ç¤ºå·²å‡†å¤‡å¥½çš„éƒ¨åˆ†ã€‚

```
ä¼ ç»Ÿ SSR:
è¯·æ±‚ â†’ [ç­‰å¾…æ•°æ®1] â†’ [ç­‰å¾…æ•°æ®2] â†’ [ç­‰å¾…æ•°æ®3] â†’ å‘é€å®Œæ•´HTML
                                                    â”‚
                                                    â†“
                                              ç”¨æˆ·çœ‹åˆ°é¡µé¢

Streaming:
è¯·æ±‚ â†’ [å‘é€éª¨æ¶] â†’ [æ•°æ®1å‡†å¤‡å¥½ï¼Œå‘é€] â†’ [æ•°æ®2å‡†å¤‡å¥½ï¼Œå‘é€]
           â”‚                â”‚                     â”‚
           â†“                â†“                     â†“
      ç”¨æˆ·çœ‹åˆ°éª¨æ¶      éƒ¨åˆ†å†…å®¹æ˜¾ç¤º         æ›´å¤šå†…å®¹æ˜¾ç¤º
```

## loading.tsx

### åŸºç¡€ç”¨æ³•

```
app/
â””â”€â”€ dashboard/
    â”œâ”€â”€ page.tsx
    â””â”€â”€ loading.tsx   # è‡ªåŠ¨åŒ…è£¹ Suspense
```

```tsx
// app/dashboard/loading.tsx
// Next.js 15.x

export default function Loading() {
  return (
    <div className="animate-pulse space-y-4">
      <div className="h-8 bg-gray-200 rounded w-1/3"></div>
      <div className="h-4 bg-gray-200 rounded w-full"></div>
      <div className="h-4 bg-gray-200 rounded w-2/3"></div>
    </div>
  )
}
```

```tsx
// app/dashboard/page.tsx
// Next.js 15.x

async function getSlowData() {
  await new Promise((resolve) => setTimeout(resolve, 2000))
  return { message: 'æ•°æ®åŠ è½½å®Œæˆ' }
}

export default async function DashboardPage() {
  const data = await getSlowData()

  return <div>{data.message}</div>
}
```

ğŸ¯ **æ•ˆæœ**ï¼šç”¨æˆ·ç«‹å³çœ‹åˆ° loading çŠ¶æ€ï¼Œ2 ç§’åæ˜¾ç¤ºå®é™…å†…å®¹ã€‚

### éª¨æ¶å±è®¾è®¡

```tsx
// app/products/loading.tsx
// Next.js 15.x

export default function ProductsLoading() {
  return (
    <div className="grid grid-cols-4 gap-4">
      {Array.from({ length: 8 }).map((_, i) => (
        <div key={i} className="animate-pulse">
          {/* å›¾ç‰‡éª¨æ¶ */}
          <div className="aspect-square bg-gray-200 rounded-lg mb-2" />
          {/* æ ‡é¢˜éª¨æ¶ */}
          <div className="h-4 bg-gray-200 rounded w-3/4 mb-1" />
          {/* ä»·æ ¼éª¨æ¶ */}
          <div className="h-4 bg-gray-200 rounded w-1/2" />
        </div>
      ))}
    </div>
  )
}
```

## Suspense è¾¹ç•Œ

### æ‰‹åŠ¨æ§åˆ¶åŠ è½½è¾¹ç•Œ

```tsx
// app/dashboard/page.tsx
// Next.js 15.x
import { Suspense } from 'react'

async function SlowStats() {
  await new Promise((r) => setTimeout(r, 2000))
  return <div>ç»Ÿè®¡æ•°æ®</div>
}

async function SlowChart() {
  await new Promise((r) => setTimeout(r, 3000))
  return <div>å›¾è¡¨</div>
}

async function SlowTable() {
  await new Promise((r) => setTimeout(r, 1500))
  return <div>è¡¨æ ¼</div>
}

export default function DashboardPage() {
  return (
    <div className="grid grid-cols-2 gap-4">
      {/* æ¯ä¸ªç»„ä»¶ç‹¬ç«‹åŠ è½½ */}
      <Suspense fallback={<div className="h-32 bg-gray-100 animate-pulse" />}>
        <SlowStats />
      </Suspense>

      <Suspense fallback={<div className="h-32 bg-gray-100 animate-pulse" />}>
        <SlowChart />
      </Suspense>

      <div className="col-span-2">
        <Suspense fallback={<div className="h-64 bg-gray-100 animate-pulse" />}>
          <SlowTable />
        </Suspense>
      </div>
    </div>
  )
}
```

ğŸ¯ **æ•ˆæœ**ï¼šä¸‰ä¸ªç»„ä»¶å¹¶è¡ŒåŠ è½½ï¼Œå„è‡ªæ˜¾ç¤ºå„è‡ªçš„éª¨æ¶ï¼Œè°å…ˆå®Œæˆè°å…ˆæ˜¾ç¤ºã€‚

### åµŒå¥— Suspense

```tsx
// app/page.tsx
// Next.js 15.x
import { Suspense } from 'react'

export default function Page() {
  return (
    <Suspense fallback={<PageSkeleton />}>
      <Header />
      <main>
        <Suspense fallback={<SidebarSkeleton />}>
          <Sidebar />
        </Suspense>
        <Suspense fallback={<ContentSkeleton />}>
          <MainContent />
        </Suspense>
      </main>
    </Suspense>
  )
}

function PageSkeleton() {
  return <div>æ•´é¡µåŠ è½½ä¸­...</div>
}

function SidebarSkeleton() {
  return <div className="w-64 h-screen bg-gray-100 animate-pulse" />
}

function ContentSkeleton() {
  return <div className="flex-1 h-screen bg-gray-50 animate-pulse" />
}
```

## å®æˆ˜æ¨¡å¼

### 1. å³æ—¶å¯¼èˆªåé¦ˆ

```tsx
// app/blog/[slug]/page.tsx
// Next.js 15.x
import { Suspense } from 'react'

async function getPost(slug: string) {
  const res = await fetch(`https://api.example.com/posts/${slug}`)
  return res.json()
}

async function getComments(slug: string) {
  // è¯„è®ºåŠ è½½æ…¢ä¸€äº›
  await new Promise((r) => setTimeout(r, 1000))
  const res = await fetch(`https://api.example.com/posts/${slug}/comments`)
  return res.json()
}

async function PostContent({ slug }: { slug: string }) {
  const post = await getPost(slug)
  return (
    <article>
      <h1 className="text-3xl font-bold">{post.title}</h1>
      <div dangerouslySetInnerHTML={{ __html: post.content }} />
    </article>
  )
}

async function Comments({ slug }: { slug: string }) {
  const comments = await getComments(slug)
  return (
    <section>
      <h2 className="text-xl font-bold mb-4">è¯„è®º ({comments.length})</h2>
      <ul className="space-y-4">
        {comments.map((comment: any) => (
          <li key={comment.id} className="border-b pb-4">
            <p className="font-medium">{comment.author}</p>
            <p>{comment.content}</p>
          </li>
        ))}
      </ul>
    </section>
  )
}

export default async function BlogPost({
  params,
}: {
  params: Promise<{ slug: string }>
}) {
  const { slug } = await params

  return (
    <div className="max-w-3xl mx-auto py-8">
      {/* æ–‡ç« å†…å®¹ */}
      <Suspense fallback={<ArticleSkeleton />}>
        <PostContent slug={slug} />
      </Suspense>

      {/* è¯„è®ºåŒºç‹¬ç«‹åŠ è½½ */}
      <div className="mt-12">
        <Suspense fallback={<CommentsSkeleton />}>
          <Comments slug={slug} />
        </Suspense>
      </div>
    </div>
  )
}

function ArticleSkeleton() {
  return (
    <div className="animate-pulse">
      <div className="h-10 bg-gray-200 rounded w-3/4 mb-4" />
      <div className="space-y-2">
        <div className="h-4 bg-gray-200 rounded" />
        <div className="h-4 bg-gray-200 rounded" />
        <div className="h-4 bg-gray-200 rounded w-5/6" />
      </div>
    </div>
  )
}

function CommentsSkeleton() {
  return (
    <div className="animate-pulse">
      <div className="h-6 bg-gray-200 rounded w-32 mb-4" />
      <div className="space-y-4">
        {[1, 2, 3].map((i) => (
          <div key={i} className="border-b pb-4">
            <div className="h-4 bg-gray-200 rounded w-24 mb-2" />
            <div className="h-4 bg-gray-200 rounded w-full" />
          </div>
        ))}
      </div>
    </div>
  )
}
```

### 2. åˆ—è¡¨ä¸è¯¦æƒ…

```tsx
// app/users/page.tsx
// Next.js 15.x
import { Suspense } from 'react'
import Link from 'next/link'

async function UserList() {
  const res = await fetch('https://api.example.com/users')
  const users = await res.json()

  return (
    <ul className="divide-y">
      {users.map((user: any) => (
        <li key={user.id} className="py-4">
          <Link href={`/users/${user.id}`} className="hover:text-blue-600">
            {user.name}
          </Link>
        </li>
      ))}
    </ul>
  )
}

async function UserStats() {
  await new Promise((r) => setTimeout(r, 1500))
  const res = await fetch('https://api.example.com/users/stats')
  const stats = await res.json()

  return (
    <div className="bg-blue-50 p-4 rounded">
      <p>æ€»ç”¨æˆ·: {stats.total}</p>
      <p>æ´»è·ƒç”¨æˆ·: {stats.active}</p>
    </div>
  )
}

export default function UsersPage() {
  return (
    <div className="grid grid-cols-3 gap-8">
      <div className="col-span-2">
        <h1 className="text-2xl font-bold mb-4">ç”¨æˆ·åˆ—è¡¨</h1>
        <Suspense fallback={<ListSkeleton />}>
          <UserList />
        </Suspense>
      </div>

      <div>
        <h2 className="text-xl font-bold mb-4">ç»Ÿè®¡</h2>
        <Suspense fallback={<StatsSkeleton />}>
          <UserStats />
        </Suspense>
      </div>
    </div>
  )
}

function ListSkeleton() {
  return (
    <div className="animate-pulse divide-y">
      {[1, 2, 3, 4, 5].map((i) => (
        <div key={i} className="h-12 flex items-center">
          <div className="h-4 bg-gray-200 rounded w-1/3" />
        </div>
      ))}
    </div>
  )
}

function StatsSkeleton() {
  return <div className="animate-pulse bg-gray-100 p-4 rounded h-24" />
}
```

### 3. æ¸è¿›å¼è¡¨å•

```tsx
// app/settings/page.tsx
// Next.js 15.x
import { Suspense } from 'react'

async function UserProfile() {
  const res = await fetch('https://api.example.com/me/profile')
  const profile = await res.json()

  return (
    <form className="space-y-4">
      <div>
        <label className="block font-medium">å§“å</label>
        <input
          defaultValue={profile.name}
          className="border rounded px-3 py-2 w-full"
        />
      </div>
      <div>
        <label className="block font-medium">é‚®ç®±</label>
        <input
          defaultValue={profile.email}
          className="border rounded px-3 py-2 w-full"
        />
      </div>
      <button className="bg-blue-600 text-white px-4 py-2 rounded">ä¿å­˜</button>
    </form>
  )
}

async function Preferences() {
  await new Promise((r) => setTimeout(r, 1000))
  const res = await fetch('https://api.example.com/me/preferences')
  const prefs = await res.json()

  return (
    <div className="space-y-4">
      <label className="flex items-center gap-2">
        <input type="checkbox" defaultChecked={prefs.notifications} />
        æ¥æ”¶é€šçŸ¥
      </label>
      <label className="flex items-center gap-2">
        <input type="checkbox" defaultChecked={prefs.newsletter} />
        è®¢é˜…é‚®ä»¶
      </label>
    </div>
  )
}

export default function SettingsPage() {
  return (
    <div className="max-w-xl space-y-8">
      <section>
        <h2 className="text-xl font-bold mb-4">ä¸ªäººèµ„æ–™</h2>
        <Suspense fallback={<FormSkeleton />}>
          <UserProfile />
        </Suspense>
      </section>

      <section>
        <h2 className="text-xl font-bold mb-4">åå¥½è®¾ç½®</h2>
        <Suspense fallback={<PrefsSkeleton />}>
          <Preferences />
        </Suspense>
      </section>
    </div>
  )
}

function FormSkeleton() {
  return (
    <div className="animate-pulse space-y-4">
      <div>
        <div className="h-4 bg-gray-200 rounded w-16 mb-2" />
        <div className="h-10 bg-gray-200 rounded" />
      </div>
      <div>
        <div className="h-4 bg-gray-200 rounded w-16 mb-2" />
        <div className="h-10 bg-gray-200 rounded" />
      </div>
      <div className="h-10 bg-gray-200 rounded w-20" />
    </div>
  )
}

function PrefsSkeleton() {
  return (
    <div className="animate-pulse space-y-4">
      <div className="h-6 bg-gray-200 rounded w-32" />
      <div className="h-6 bg-gray-200 rounded w-28" />
    </div>
  )
}
```

## éª¨æ¶å±ç»„ä»¶åº“

```tsx
// components/Skeleton.tsx
// Next.js 15.x

interface SkeletonProps {
  className?: string
}

export function Skeleton({ className }: SkeletonProps) {
  return <div className={`animate-pulse bg-gray-200 rounded ${className}`} />
}

export function SkeletonText({ lines = 3 }: { lines?: number }) {
  return (
    <div className="space-y-2">
      {Array.from({ length: lines }).map((_, i) => (
        <Skeleton
          key={i}
          className={`h-4 ${i === lines - 1 ? 'w-2/3' : 'w-full'}`}
        />
      ))}
    </div>
  )
}

export function SkeletonCard() {
  return (
    <div className="border rounded-lg p-4 space-y-3">
      <Skeleton className="h-48 w-full" />
      <Skeleton className="h-4 w-3/4" />
      <Skeleton className="h-4 w-1/2" />
    </div>
  )
}

export function SkeletonTable({ rows = 5 }: { rows?: number }) {
  return (
    <div className="space-y-2">
      <div className="flex gap-4 p-2 bg-gray-50">
        <Skeleton className="h-4 w-1/4" />
        <Skeleton className="h-4 w-1/4" />
        <Skeleton className="h-4 w-1/4" />
        <Skeleton className="h-4 w-1/4" />
      </div>
      {Array.from({ length: rows }).map((_, i) => (
        <div key={i} className="flex gap-4 p-2">
          <Skeleton className="h-4 w-1/4" />
          <Skeleton className="h-4 w-1/4" />
          <Skeleton className="h-4 w-1/4" />
          <Skeleton className="h-4 w-1/4" />
        </div>
      ))}
    </div>
  )
}
```

## å¸¸è§é—®é¢˜

ğŸ¤” **Q: loading.tsx å’Œ Suspense æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**

- `loading.tsx` æ˜¯æ•´ä¸ªè·¯ç”±æ®µçš„åŠ è½½çŠ¶æ€
- `Suspense` å¯ä»¥ç²¾ç»†æ§åˆ¶ä»»æ„ç»„ä»¶çš„åŠ è½½è¾¹ç•Œ

ğŸ¤” **Q: å¦‚ä½•é¿å…ç€‘å¸ƒæµè¯·æ±‚ï¼Ÿ**

å°†è¯·æ±‚å¹¶è¡ŒåŒ–ï¼š

```tsx
// âŒ ç€‘å¸ƒæµ
const user = await getUser()
const posts = await getPosts()

// âœ… å¹¶è¡Œ
const [user, posts] = await Promise.all([getUser(), getPosts()])
```

ğŸ¤” **Q: éª¨æ¶å±åº”è¯¥å’Œå®é™…å†…å®¹ä¸€æ ·å—ï¼Ÿ**

æ˜¯çš„ï¼Œä¿æŒå¸ƒå±€ä¸€è‡´å¯ä»¥é¿å…å†…å®¹è·³åŠ¨ï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚

---

ä¸‹ä¸€ç¯‡å°†ä»‹ç»é™æ€ä¸åŠ¨æ€æ¸²æŸ“ï¼Œæ·±å…¥ç†è§£ SSGã€SSRã€ISR çš„é€‰æ‹©ä¸é…ç½®ã€‚

-EOF-
