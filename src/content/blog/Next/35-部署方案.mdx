---
title: éƒ¨ç½²æ–¹æ¡ˆ
description: æŒæ¡ Next.js åº”ç”¨çš„å¤šç§éƒ¨ç½²æ–¹å¼ï¼ŒåŒ…æ‹¬ Vercelã€Docker å’Œè‡ªæ‰˜ç®¡æ–¹æ¡ˆ
pubDate: 2025-12-03
toc: true
ogImage: true
category: Next
tags: ['Next.js', 'éƒ¨ç½²', 'Vercel', 'Docker', 'è‡ªæ‰˜ç®¡']
---

ğŸ™‹ åº”ç”¨å¼€å‘å®Œæˆï¼Œå¦‚ä½•éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Ÿä¸åŒåœºæ™¯éœ€è¦ä¸åŒçš„éƒ¨ç½²ç­–ç•¥ã€‚

## éƒ¨ç½²æ–¹å¼å¯¹æ¯”

| æ–¹å¼     | ä¼˜ç‚¹             | ç¼ºç‚¹       | é€‚ç”¨åœºæ™¯           |
| -------- | ---------------- | ---------- | ------------------ |
| Vercel   | é›¶é…ç½®ã€è‡ªåŠ¨ä¼˜åŒ– | æˆæœ¬è¾ƒé«˜   | å¿«é€Ÿä¸Šçº¿ã€å°å›¢é˜Ÿ   |
| Docker   | å¯ç§»æ¤ã€ç¯å¢ƒä¸€è‡´ | éœ€è¦è¿ç»´   | ä¼ä¸šå†…éƒ¨ã€è‡ªå»ºæœåŠ¡ |
| é™æ€å¯¼å‡º | ç®€å•ã€CDN å‹å¥½   | åŠŸèƒ½å—é™   | çº¯é™æ€ç«™ç‚¹         |
| Node.js  | å®Œæ•´åŠŸèƒ½         | éœ€è¦æœåŠ¡å™¨ | è‡ªæ‰˜ç®¡             |

## Vercel éƒ¨ç½²

### è¿æ¥ä»“åº“

```bash
# å®‰è£… Vercel CLI
pnpm add -g vercel

# ç™»å½•
vercel login

# éƒ¨ç½²
vercel
```

### ç¯å¢ƒå˜é‡

åœ¨ Vercel Dashboard ä¸­é…ç½®ï¼š

```
Settings > Environment Variables
```

æˆ–ä½¿ç”¨ CLIï¼š

```bash
vercel env add DATABASE_URL production
vercel env add API_SECRET production
```

### vercel.json é…ç½®

```json
{
  "buildCommand": "pnpm build",
  "outputDirectory": ".next",
  "framework": "nextjs",
  "regions": ["hkg1"],
  "headers": [
    {
      "source": "/api/(.*)",
      "headers": [{ "key": "Access-Control-Allow-Origin", "value": "*" }]
    }
  ],
  "redirects": [
    {
      "source": "/old-path",
      "destination": "/new-path",
      "permanent": true
    }
  ]
}
```

### è‡ªå®šä¹‰åŸŸå

```
Settings > Domains > Add Domain
```

è¾“å…¥åŸŸååï¼ŒæŒ‰ç…§æç¤ºé…ç½® DNSï¼š

```
Type: CNAME
Name: www
Value: cname.vercel-dns.com

Type: A
Name: @
Value: 76.76.21.21
```

## Docker éƒ¨ç½²

### Dockerfile

```dockerfile
# Dockerfile
FROM node:20-alpine AS base

# å®‰è£…ä¾èµ–
FROM base AS deps
RUN apk add --no-cache libc6-compat
WORKDIR /app

COPY package.json pnpm-lock.yaml ./
RUN corepack enable pnpm && pnpm install --frozen-lockfile

# æ„å»º
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .

ENV NEXT_TELEMETRY_DISABLED 1

RUN corepack enable pnpm && pnpm build

# ç”Ÿäº§é•œåƒ
FROM base AS runner
WORKDIR /app

ENV NODE_ENV production
ENV NEXT_TELEMETRY_DISABLED 1

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs

EXPOSE 3000

ENV PORT 3000
ENV HOSTNAME "0.0.0.0"

CMD ["node", "server.js"]
```

### next.config.ts é…ç½®

```tsx
// next.config.ts
import type { NextConfig } from 'next'

const config: NextConfig = {
  output: 'standalone', // ç”Ÿæˆç‹¬ç«‹æ„å»º
}

export default config
```

### æ„å»ºå’Œè¿è¡Œ

```bash
# æ„å»ºé•œåƒ
docker build -t my-nextjs-app .

# è¿è¡Œå®¹å™¨
docker run -p 3000:3000 \
  -e DATABASE_URL="postgresql://..." \
  -e API_SECRET="..." \
  my-nextjs-app
```

### Docker Compose

```yaml
# docker-compose.yml
version: '3.8'

services:
  app:
    build: .
    ports:
      - '3000:3000'
    environment:
      - DATABASE_URL=postgresql://postgres:password@db:5432/myapp
      - REDIS_URL=redis://redis:6379
    depends_on:
      - db
      - redis

  db:
    image: postgres:15-alpine
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=myapp

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data

volumes:
  postgres_data:
  redis_data:
```

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f app

# åœæ­¢æœåŠ¡
docker-compose down
```

## è‡ªæ‰˜ç®¡ Node.js

### æ„å»º

```bash
pnpm build
```

### å¯åŠ¨æœåŠ¡å™¨

```bash
# å¼€å‘
pnpm start

# ç”Ÿäº§ï¼ˆä½¿ç”¨ PM2ï¼‰
pm2 start npm --name "nextjs" -- start
```

### PM2 é…ç½®

```javascript
// ecosystem.config.js
module.exports = {
  apps: [
    {
      name: 'nextjs',
      script: 'node_modules/.bin/next',
      args: 'start',
      instances: 'max',
      exec_mode: 'cluster',
      env: {
        NODE_ENV: 'production',
        PORT: 3000,
      },
    },
  ],
}
```

```bash
pm2 start ecosystem.config.js
pm2 save
pm2 startup
```

### Nginx åå‘ä»£ç†

```nginx
# /etc/nginx/sites-available/nextjs
server {
    listen 80;
    server_name example.com www.example.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # é™æ€æ–‡ä»¶ç¼“å­˜
    location /_next/static {
        proxy_pass http://localhost:3000;
        proxy_cache_valid 60m;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }

    location /static {
        proxy_pass http://localhost:3000;
        proxy_cache_valid 60m;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }
}
```

```bash
# å¯ç”¨é…ç½®
sudo ln -s /etc/nginx/sites-available/nextjs /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### SSL è¯ä¹¦ï¼ˆLet's Encryptï¼‰

```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d example.com -d www.example.com
```

## é™æ€å¯¼å‡º

### é…ç½®

```tsx
// next.config.ts
const config: NextConfig = {
  output: 'export',
  images: {
    unoptimized: true, // é™æ€å¯¼å‡ºéœ€è¦ç¦ç”¨å›¾ç‰‡ä¼˜åŒ–
  },
}
```

### æ„å»º

```bash
pnpm build
# è¾“å‡ºåˆ° out/ ç›®å½•
```

### éƒ¨ç½²åˆ° CDN

```bash
# Cloudflare Pages
npx wrangler pages deploy out

# GitHub Pages
# å°† out/ ç›®å½•æ¨é€åˆ° gh-pages åˆ†æ”¯

# Netlify
netlify deploy --prod --dir=out
```

### é™åˆ¶

é™æ€å¯¼å‡ºä¸æ”¯æŒï¼š

- åŠ¨æ€è·¯ç”±ï¼ˆæœªä½¿ç”¨ `generateStaticParams`ï¼‰
- API Routes
- ä¸­é—´ä»¶
- ISR
- `headers`ã€`redirects`ã€`rewrites` é…ç½®

## CI/CD é…ç½®

### GitHub Actions

```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: 8

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Run tests
        run: pnpm test:run

      - name: Build
        run: pnpm build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
```

### Docker æ„å»ºå’Œæ¨é€

```yaml
# .github/workflows/docker.yml
name: Docker Build

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            username/myapp:latest
            username/myapp:${{ github.sha }}
```

## ç›‘æ§ä¸æ—¥å¿—

### å¥åº·æ£€æŸ¥

```tsx
// app/api/health/route.ts
import { NextResponse } from 'next/server'

export async function GET() {
  try {
    // æ£€æŸ¥æ•°æ®åº“è¿æ¥
    await db.$queryRaw`SELECT 1`

    return NextResponse.json({
      status: 'healthy',
      timestamp: new Date().toISOString(),
    })
  } catch (error) {
    return NextResponse.json(
      { status: 'unhealthy', error: 'Database connection failed' },
      { status: 503 }
    )
  }
}
```

### æ—¥å¿—æ”¶é›†

```tsx
// lib/logger.ts
import pino from 'pino'

export const logger = pino({
  level: process.env.LOG_LEVEL || 'info',
  transport:
    process.env.NODE_ENV === 'development'
      ? { target: 'pino-pretty' }
      : undefined,
})
```

```tsx
// middleware.ts
import { logger } from '@/lib/logger'

export function middleware(request: NextRequest) {
  logger.info({
    method: request.method,
    url: request.url,
    userAgent: request.headers.get('user-agent'),
  })

  return NextResponse.next()
}
```

## æ€§èƒ½ä¼˜åŒ–

### CDN é…ç½®

```tsx
// next.config.ts
const config: NextConfig = {
  // é™æ€èµ„æºä½¿ç”¨ CDN
  assetPrefix: process.env.CDN_URL,

  // å›¾ç‰‡ä¼˜åŒ–å™¨ä½¿ç”¨ CDN
  images: {
    loader: 'custom',
    loaderFile: './lib/image-loader.ts',
  },
}
```

### ç¼“å­˜ç­–ç•¥

```tsx
// next.config.ts
const config: NextConfig = {
  headers: async () => [
    {
      source: '/:all*(svg|jpg|png|webp)',
      headers: [
        {
          key: 'Cache-Control',
          value: 'public, max-age=31536000, immutable',
        },
      ],
    },
  ],
}
```

## å¸¸è§é—®é¢˜

ğŸ¤” **Q: Vercel å…è´¹ç‰ˆæœ‰ä»€ä¹ˆé™åˆ¶ï¼Ÿ**

- å¸¦å®½ï¼š100GB/æœˆ
- æ‰§è¡Œæ—¶é—´ï¼š10ç§’ï¼ˆServerless Functionsï¼‰
- æ„å»ºæ—¶é—´ï¼š6000åˆ†é’Ÿ/æœˆ

ğŸ¤” **Q: Docker æ„å»ºå¾ˆæ…¢æ€ä¹ˆåŠï¼Ÿ**

ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºå’Œç¼“å­˜ï¼š

```dockerfile
# ä½¿ç”¨ BuildKit ç¼“å­˜
RUN --mount=type=cache,target=/root/.pnpm-store \
    pnpm install --frozen-lockfile
```

ğŸ¤” **Q: å¦‚ä½•å®ç°é›¶åœæœºéƒ¨ç½²ï¼Ÿ**

ä½¿ç”¨è“ç»¿éƒ¨ç½²æˆ–æ»šåŠ¨æ›´æ–°ï¼š

```yaml
# docker-compose.yml
deploy:
  replicas: 3
  update_config:
    parallelism: 1
    delay: 10s
```

---

æ­å–œï¼ä¸‹ä¸€ç¯‡å°†è¿›å…¥é¡¹ç›®å®æˆ˜ï¼Œç»¼åˆè¿ç”¨æ‰€å­¦çŸ¥è¯†æ„å»ºå®Œæ•´åº”ç”¨ã€‚

-EOF-
