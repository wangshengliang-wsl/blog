---
title: ä¸­é—´ä»¶
description: æŒæ¡ Next.js ä¸­é—´ä»¶çš„ä½¿ç”¨ï¼Œå®ç°è¯·æ±‚æ‹¦æˆªã€è®¤è¯æ£€æŸ¥ã€é‡å®šå‘ä¸å“åº”ä¿®æ”¹
pubDate: 2025-12-03
toc: true
ogImage: true
category: Next
tags: ['Next.js', 'ä¸­é—´ä»¶', 'middleware', 'è®¤è¯', 'è¯·æ±‚æ‹¦æˆª']
---

ğŸ™‹ å¦‚ä½•åœ¨è¯·æ±‚åˆ°è¾¾é¡µé¢ä¹‹å‰è¿›è¡Œè®¤è¯æ£€æŸ¥ï¼Ÿå¦‚ä½•æ ¹æ®åœ°åŒºè‡ªåŠ¨é‡å®šå‘ï¼Ÿä¸­é—´ä»¶å¯ä»¥è§£å†³è¿™äº›é—®é¢˜ã€‚

## ä¸­é—´ä»¶åŸºç¡€

ä¸­é—´ä»¶åœ¨è¯·æ±‚å®Œæˆä¹‹å‰è¿è¡Œï¼Œå¯ä»¥ä¿®æ”¹å“åº”ã€é‡å®šå‘ã€æ·»åŠ è¯·æ±‚å¤´ç­‰ã€‚

### åˆ›å»ºä¸­é—´ä»¶

åœ¨é¡¹ç›®æ ¹ç›®å½•ï¼ˆæˆ– `src` ç›®å½•ï¼‰åˆ›å»º `middleware.ts`ï¼š

```tsx
// middleware.ts
// Next.js 15.x
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export function middleware(request: NextRequest) {
  console.log('è¯·æ±‚è·¯å¾„:', request.nextUrl.pathname)

  // ç»§ç»­å¤„ç†è¯·æ±‚
  return NextResponse.next()
}
```

### åŒ¹é…è·¯å¾„

ä½¿ç”¨ `config.matcher` æŒ‡å®šä¸­é—´ä»¶ç”Ÿæ•ˆçš„è·¯å¾„ï¼š

```tsx
// middleware.ts
// Next.js 15.x
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export function middleware(request: NextRequest) {
  // åªå¯¹åŒ¹é…çš„è·¯å¾„æ‰§è¡Œ
  return NextResponse.next()
}

export const config = {
  matcher: '/dashboard/:path*',
}
```

### å¤šè·¯å¾„åŒ¹é…

```tsx
export const config = {
  matcher: ['/dashboard/:path*', '/api/:path*', '/admin/:path*'],
}
```

### æ­£åˆ™åŒ¹é…

```tsx
export const config = {
  matcher: [
    // åŒ¹é…æ‰€æœ‰è·¯å¾„ï¼Œæ’é™¤é™æ€æ–‡ä»¶å’Œ API
    '/((?!_next/static|_next/image|favicon.ico|api).*)',
  ],
}
```

## å¸¸è§ç”¨ä¾‹

### 1. è®¤è¯æ£€æŸ¥

```tsx
// middleware.ts
// Next.js 15.x
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export function middleware(request: NextRequest) {
  const token = request.cookies.get('token')?.value

  // æœªç™»å½•ç”¨æˆ·è®¿é—®å—ä¿æŠ¤è·¯ç”±
  if (!token && request.nextUrl.pathname.startsWith('/dashboard')) {
    const loginUrl = new URL('/login', request.url)
    loginUrl.searchParams.set('from', request.nextUrl.pathname)
    return NextResponse.redirect(loginUrl)
  }

  // å·²ç™»å½•ç”¨æˆ·è®¿é—®ç™»å½•é¡µ
  if (token && request.nextUrl.pathname === '/login') {
    return NextResponse.redirect(new URL('/dashboard', request.url))
  }

  return NextResponse.next()
}

export const config = {
  matcher: ['/dashboard/:path*', '/login'],
}
```

### 2. å›½é™…åŒ–é‡å®šå‘

```tsx
// middleware.ts
// Next.js 15.x
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

const locales = ['zh', 'en', 'ja']
const defaultLocale = 'zh'

function getLocale(request: NextRequest): string {
  // ä» Accept-Language å¤´è·å–é¦–é€‰è¯­è¨€
  const acceptLanguage = request.headers.get('accept-language')
  if (acceptLanguage) {
    const preferred = acceptLanguage.split(',')[0].split('-')[0]
    if (locales.includes(preferred)) {
      return preferred
    }
  }
  return defaultLocale
}

export function middleware(request: NextRequest) {
  const { pathname } = request.nextUrl

  // æ£€æŸ¥è·¯å¾„æ˜¯å¦å·²åŒ…å«è¯­è¨€å‰ç¼€
  const hasLocale = locales.some(
    (locale) => pathname.startsWith(`/${locale}/`) || pathname === `/${locale}`
  )

  if (hasLocale) {
    return NextResponse.next()
  }

  // é‡å®šå‘åˆ°å¸¦è¯­è¨€å‰ç¼€çš„è·¯å¾„
  const locale = getLocale(request)
  return NextResponse.redirect(new URL(`/${locale}${pathname}`, request.url))
}

export const config = {
  matcher: ['/((?!_next|api|favicon.ico).*)'],
}
```

### 3. è¯·æ±‚å¤´æ³¨å…¥

```tsx
// middleware.ts
// Next.js 15.x
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export function middleware(request: NextRequest) {
  // å…‹éš†è¯·æ±‚å¤´
  const requestHeaders = new Headers(request.headers)

  // æ·»åŠ è‡ªå®šä¹‰è¯·æ±‚å¤´
  requestHeaders.set('x-custom-header', 'my-value')
  requestHeaders.set('x-request-id', crypto.randomUUID())

  // ä¼ é€’ç»™é¡µé¢
  const response = NextResponse.next({
    request: {
      headers: requestHeaders,
    },
  })

  // æ·»åŠ å“åº”å¤´
  response.headers.set('x-response-time', Date.now().toString())

  return response
}
```

### 4. åœ°ç†ä½ç½®é‡å®šå‘

```tsx
// middleware.ts
// Next.js 15.x
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export function middleware(request: NextRequest) {
  const country = request.geo?.country || 'CN'

  // æ ¹æ®åœ°åŒºé‡å®šå‘
  if (country === 'CN' && !request.nextUrl.pathname.startsWith('/cn')) {
    return NextResponse.redirect(new URL('/cn', request.url))
  }

  if (country === 'US' && !request.nextUrl.pathname.startsWith('/us')) {
    return NextResponse.redirect(new URL('/us', request.url))
  }

  return NextResponse.next()
}
```

### 5. A/B æµ‹è¯•

```tsx
// middleware.ts
// Next.js 15.x
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export function middleware(request: NextRequest) {
  const bucket = request.cookies.get('ab-bucket')?.value

  if (bucket) {
    return NextResponse.next()
  }

  // éšæœºåˆ†é… A/B æµ‹è¯•ç»„
  const newBucket = Math.random() < 0.5 ? 'control' : 'experiment'

  const response = NextResponse.next()
  response.cookies.set('ab-bucket', newBucket, {
    maxAge: 60 * 60 * 24 * 30, // 30 å¤©
  })

  return response
}
```

### 6. é€Ÿç‡é™åˆ¶

```tsx
// middleware.ts
// Next.js 15.x
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

// ç®€å•çš„å†…å­˜å­˜å‚¨ï¼ˆç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨ Redisï¼‰
const rateLimit = new Map<string, { count: number; timestamp: number }>()

export function middleware(request: NextRequest) {
  if (!request.nextUrl.pathname.startsWith('/api')) {
    return NextResponse.next()
  }

  const ip = request.ip || 'anonymous'
  const now = Date.now()
  const windowMs = 60 * 1000 // 1 åˆ†é’Ÿ
  const maxRequests = 100

  const record = rateLimit.get(ip)

  if (!record || now - record.timestamp > windowMs) {
    rateLimit.set(ip, { count: 1, timestamp: now })
    return NextResponse.next()
  }

  if (record.count >= maxRequests) {
    return new NextResponse('è¯·æ±‚è¿‡äºé¢‘ç¹', {
      status: 429,
      headers: {
        'Retry-After': '60',
      },
    })
  }

  record.count++
  return NextResponse.next()
}

export const config = {
  matcher: '/api/:path*',
}
```

## å“åº”æ“ä½œ

### é‡å®šå‘

```tsx
// ä¸´æ—¶é‡å®šå‘ (307)
return NextResponse.redirect(new URL('/new-path', request.url))

// æ°¸ä¹…é‡å®šå‘ (308)
return NextResponse.redirect(new URL('/new-path', request.url), 308)
```

### é‡å†™

```tsx
// é‡å†™ URLï¼ˆç”¨æˆ·çœ‹åˆ°çš„ URL ä¸å˜ï¼‰
return NextResponse.rewrite(new URL('/proxy-path', request.url))
```

### ç›´æ¥å“åº”

```tsx
// è¿”å› JSON
return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })

// è¿”å› HTML
return new NextResponse('<h1>Error</h1>', {
  status: 500,
  headers: { 'content-type': 'text/html' },
})
```

### Cookie æ“ä½œ

```tsx
// middleware.ts
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export function middleware(request: NextRequest) {
  const response = NextResponse.next()

  // è®¾ç½® Cookie
  response.cookies.set('theme', 'dark', {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    sameSite: 'strict',
    maxAge: 60 * 60 * 24 * 365, // 1 å¹´
  })

  // è¯»å– Cookie
  const token = request.cookies.get('token')?.value

  // åˆ é™¤ Cookie
  response.cookies.delete('old-cookie')

  return response
}
```

## é«˜çº§ç”¨æ³•

### æ¡ä»¶ä¸­é—´ä»¶é€»è¾‘

```tsx
// middleware.ts
// Next.js 15.x
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export function middleware(request: NextRequest) {
  const { pathname } = request.nextUrl

  // API è·¯ç”±å¤„ç†
  if (pathname.startsWith('/api')) {
    return handleApiRoutes(request)
  }

  // ç®¡ç†åå°å¤„ç†
  if (pathname.startsWith('/admin')) {
    return handleAdminRoutes(request)
  }

  // æ™®é€šé¡µé¢å¤„ç†
  return handlePageRoutes(request)
}

function handleApiRoutes(request: NextRequest) {
  // API è®¤è¯æ£€æŸ¥
  const apiKey = request.headers.get('x-api-key')
  if (!apiKey) {
    return NextResponse.json({ error: 'Missing API key' }, { status: 401 })
  }
  return NextResponse.next()
}

function handleAdminRoutes(request: NextRequest) {
  // ç®¡ç†å‘˜æƒé™æ£€æŸ¥
  const token = request.cookies.get('admin-token')?.value
  if (!token) {
    return NextResponse.redirect(new URL('/admin/login', request.url))
  }
  return NextResponse.next()
}

function handlePageRoutes(request: NextRequest) {
  // æ™®é€šé¡µé¢å¤„ç†
  return NextResponse.next()
}
```

### è¯»å–é¡µé¢æ•°æ®

ä¸­é—´ä»¶å¯ä»¥å‘é¡µé¢ä¼ é€’æ•°æ®ï¼š

```tsx
// middleware.ts
export function middleware(request: NextRequest) {
  const requestHeaders = new Headers(request.headers)

  // æ·»åŠ æ•°æ®åˆ°è¯·æ±‚å¤´
  requestHeaders.set('x-user-id', 'user-123')
  requestHeaders.set('x-feature-flags', JSON.stringify({ newUI: true }))

  return NextResponse.next({
    request: { headers: requestHeaders },
  })
}
```

```tsx
// app/page.tsx
import { headers } from 'next/headers'

export default async function Page() {
  const headersList = await headers()
  const userId = headersList.get('x-user-id')
  const featureFlags = JSON.parse(headersList.get('x-feature-flags') || '{}')

  return <div>ç”¨æˆ·: {userId}</div>
}
```

## æ³¨æ„äº‹é¡¹

### ä¸­é—´ä»¶é™åˆ¶

ğŸ”¶ ä¸­é—´ä»¶è¿è¡Œåœ¨ Edge Runtimeï¼Œæœ‰ä»¥ä¸‹é™åˆ¶ï¼š

- ä¸èƒ½ä½¿ç”¨ Node.js APIï¼ˆå¦‚ `fs`ã€`path`ï¼‰
- ä¸èƒ½ä½¿ç”¨æŸäº› npm åŒ…
- ä»£ç åŒ…å¤§å°é™åˆ¶ï¼ˆ1MBï¼‰
- åªèƒ½ä½¿ç”¨ Web API

### æ€§èƒ½è€ƒè™‘

```tsx
// âœ… å¥½ï¼šåªåŒ¹é…éœ€è¦çš„è·¯å¾„
export const config = {
  matcher: ['/dashboard/:path*'],
}

// âŒ å·®ï¼šåŒ¹é…æ‰€æœ‰è·¯å¾„
export const config = {
  matcher: ['/:path*'],
}
```

### è°ƒè¯•æŠ€å·§

```tsx
export function middleware(request: NextRequest) {
  // å¼€å‘ç¯å¢ƒæ—¥å¿—
  if (process.env.NODE_ENV === 'development') {
    console.log('ä¸­é—´ä»¶æ‰§è¡Œ:', {
      path: request.nextUrl.pathname,
      method: request.method,
      cookies: Object.fromEntries(
        request.cookies.getAll().map((c) => [c.name, c.value])
      ),
    })
  }

  return NextResponse.next()
}
```

## å¸¸è§é—®é¢˜

ğŸ¤” **Q: ä¸­é—´ä»¶å¯ä»¥è®¿é—®æ•°æ®åº“å—ï¼Ÿ**

ä¸èƒ½ç›´æ¥ä½¿ç”¨ä¼ ç»Ÿæ•°æ®åº“å®¢æˆ·ç«¯ã€‚å¯ä»¥ä½¿ç”¨ Edge å…¼å®¹çš„æ–¹æ¡ˆï¼š

- Vercel KV / Redis
- PlanetScaleï¼ˆHTTP æ¨¡å¼ï¼‰
- å¤–éƒ¨ API è°ƒç”¨

ğŸ¤” **Q: ä¸­é—´ä»¶æ‰§è¡Œå¤šæ¬¡æ€ä¹ˆåŠï¼Ÿ**

ç¡®ä¿ `matcher` é…ç½®æ­£ç¡®ï¼Œæ’é™¤é™æ€èµ„æºè·¯å¾„ã€‚

ğŸ¤” **Q: å¦‚ä½•åœ¨ä¸­é—´ä»¶ä¸­éªŒè¯ JWTï¼Ÿ**

```tsx
import { jwtVerify } from 'jose'

async function verifyToken(token: string) {
  const secret = new TextEncoder().encode(process.env.JWT_SECRET)
  const { payload } = await jwtVerify(token, secret)
  return payload
}
```

---

æ­å–œä½ å®Œæˆäº†è·¯ç”±ç³»ç»Ÿçš„å­¦ä¹ ï¼ä¸‹ä¸€ç¯‡å°†è¿›å…¥æ¸²æŸ“æ¨¡å¼éƒ¨åˆ†ï¼Œæ·±å…¥ç†è§£ Server Componentsã€‚

-EOF-
