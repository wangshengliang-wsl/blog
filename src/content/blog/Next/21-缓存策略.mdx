---
title: ç¼“å­˜ç­–ç•¥
description: æ·±å…¥ç†è§£ Next.js çš„å››å±‚ç¼“å­˜æœºåˆ¶ï¼ŒæŒæ¡è¯·æ±‚ç¼“å­˜ã€æ•°æ®ç¼“å­˜ã€è·¯ç”±ç¼“å­˜ä¸å®Œæ•´è·¯ç”±ç¼“å­˜çš„é…ç½®
pubDate: 2025-12-03
toc: true
ogImage: true
category: Next
tags: ['Next.js', 'ç¼“å­˜', 'revalidate', 'æ€§èƒ½ä¼˜åŒ–']
---

ğŸ™‹ Next.js çš„ç¼“å­˜æœºåˆ¶æœ‰ç‚¹å¤æ‚ï¼Ÿç†è§£å››å±‚ç¼“å­˜åï¼Œä½ å°±èƒ½ç²¾ç¡®æ§åˆ¶æ•°æ®æ–°é²œåº¦å’Œæ€§èƒ½ã€‚

## ç¼“å­˜æœºåˆ¶æ¦‚è§ˆ

Next.js æœ‰å››å±‚ç¼“å­˜ï¼š

| ç¼“å­˜ç±»å‹     | ä½ç½®   | ä½œç”¨           | é»˜è®¤è¡Œä¸º     |
| ------------ | ------ | -------------- | ------------ |
| è¯·æ±‚è®°å¿†åŒ–   | æœåŠ¡å™¨ | åŒä¸€æ¸²æŸ“ä¸­å»é‡ | è‡ªåŠ¨         |
| æ•°æ®ç¼“å­˜     | æœåŠ¡å™¨ | è·¨è¯·æ±‚æŒä¹…åŒ–   | å¯ç”¨         |
| å®Œæ•´è·¯ç”±ç¼“å­˜ | æœåŠ¡å™¨ | ç¼“å­˜æ¸²æŸ“ç»“æœ   | é™æ€è·¯ç”±å¯ç”¨ |
| è·¯ç”±ç¼“å­˜     | å®¢æˆ·ç«¯ | ç¼“å­˜å·²è®¿é—®é¡µé¢ | å¯ç”¨         |

## è¯·æ±‚è®°å¿†åŒ–

### è‡ªåŠ¨å»é‡

åŒä¸€æ¸²æŸ“è¿‡ç¨‹ä¸­ï¼Œç›¸åŒçš„ fetch è¯·æ±‚åªæ‰§è¡Œä¸€æ¬¡ï¼š

```tsx
// è¿™ä¸¤ä¸ªç»„ä»¶åœ¨åŒä¸€é¡µé¢æ¸²æŸ“æ—¶ï¼Œåªå‘é€ä¸€æ¬¡è¯·æ±‚
async function ComponentA() {
  const data = await fetch('https://api.example.com/data').then((r) => r.json())
  return <div>{data.a}</div>
}

async function ComponentB() {
  const data = await fetch('https://api.example.com/data').then((r) => r.json())
  return <div>{data.b}</div>
}

export default function Page() {
  return (
    <>
      <ComponentA />
      <ComponentB />
    </>
  )
}
```

### é fetch è¯·æ±‚çš„å»é‡

ä½¿ç”¨ React `cache` å‡½æ•°ï¼š

```tsx
// lib/db.ts
import { cache } from 'react'
import { db } from './prisma'

export const getUser = cache(async (id: string) => {
  console.log('æŸ¥è¯¢ç”¨æˆ·:', id) // åªè¾“å‡ºä¸€æ¬¡
  return db.user.findUnique({ where: { id } })
})
```

## æ•°æ®ç¼“å­˜

### é»˜è®¤ç¼“å­˜

fetch è¯·æ±‚é»˜è®¤è¢«ç¼“å­˜ï¼š

```tsx
// é»˜è®¤è¡Œä¸ºï¼šæ°¸ä¹…ç¼“å­˜
const data = await fetch('https://api.example.com/data')
// ç­‰åŒäº
const data = await fetch('https://api.example.com/data', {
  cache: 'force-cache',
})
```

### ç¦ç”¨ç¼“å­˜

```tsx
// æ¯æ¬¡è¯·æ±‚éƒ½è·å–æœ€æ–°æ•°æ®
const data = await fetch('https://api.example.com/data', {
  cache: 'no-store',
})
```

### å®šæ—¶é‡æ–°éªŒè¯

```tsx
// 60 ç§’åæ•°æ®è¿‡æœŸ
const data = await fetch('https://api.example.com/data', {
  next: { revalidate: 60 },
})
```

### ç¼“å­˜æ ‡ç­¾

```tsx
// æ·»åŠ æ ‡ç­¾ä¾¿äºæŒ‰éœ€å¤±æ•ˆ
const data = await fetch('https://api.example.com/posts', {
  next: { tags: ['posts'] },
})

const post = await fetch(`https://api.example.com/posts/${id}`, {
  next: { tags: ['posts', `post-${id}`] },
})
```

## æŒ‰éœ€é‡æ–°éªŒè¯

### revalidatePath

```tsx
// app/actions.ts
'use server'

import { revalidatePath } from 'next/cache'

export async function createPost(formData: FormData) {
  // åˆ›å»ºæ–‡ç« ...

  // é‡æ–°éªŒè¯æ–‡ç« åˆ—è¡¨é¡µ
  revalidatePath('/blog')

  // é‡æ–°éªŒè¯æ•´ä¸ªå¸ƒå±€
  revalidatePath('/blog', 'layout')

  // é‡æ–°éªŒè¯æ‰€æœ‰æ•°æ®
  revalidatePath('/', 'layout')
}
```

### revalidateTag

```tsx
// app/actions.ts
'use server'

import { revalidateTag } from 'next/cache'

export async function updatePost(id: string, formData: FormData) {
  // æ›´æ–°æ–‡ç« ...

  // åªé‡æ–°éªŒè¯ç›¸å…³æ ‡ç­¾çš„æ•°æ®
  revalidateTag(`post-${id}`)
}

export async function refreshAllPosts() {
  // é‡æ–°éªŒè¯æ‰€æœ‰æ–‡ç« 
  revalidateTag('posts')
}
```

### API è·¯ç”±è§¦å‘

```tsx
// app/api/revalidate/route.ts
import { revalidateTag, revalidatePath } from 'next/cache'
import { NextRequest, NextResponse } from 'next/server'

export async function POST(request: NextRequest) {
  const { secret, tag, path } = await request.json()

  // éªŒè¯å¯†é’¥
  if (secret !== process.env.REVALIDATE_SECRET) {
    return NextResponse.json({ error: 'Invalid secret' }, { status: 401 })
  }

  if (tag) {
    revalidateTag(tag)
  }

  if (path) {
    revalidatePath(path)
  }

  return NextResponse.json({ revalidated: true, now: Date.now() })
}
```

Webhook è°ƒç”¨ç¤ºä¾‹ï¼š

```bash
curl -X POST https://your-site.com/api/revalidate \
  -H "Content-Type: application/json" \
  -d '{"secret": "your-secret", "tag": "posts"}'
```

## è·¯ç”±æ®µé…ç½®

### é¡µé¢çº§é…ç½®

```tsx
// app/dashboard/page.tsx

// ç¦ç”¨æ­¤é¡µé¢çš„æ‰€æœ‰ç¼“å­˜
export const dynamic = 'force-dynamic'

// å¼ºåˆ¶é™æ€ç”Ÿæˆ
// export const dynamic = 'force-static'

// è®¾ç½®é‡æ–°éªŒè¯æ—¶é—´
export const revalidate = 3600 // 1 å°æ—¶

// æ§åˆ¶ fetch é»˜è®¤è¡Œä¸º
export const fetchCache = 'default-cache'
// å¯é€‰å€¼: 'auto' | 'default-cache' | 'only-cache' |
//         'force-cache' | 'force-no-store' | 'default-no-store' | 'only-no-store'

export default function DashboardPage() {
  return <div>Dashboard</div>
}
```

### å¸ƒå±€çº§é…ç½®

```tsx
// app/blog/layout.tsx

// æ­¤å¸ƒå±€åŠæ‰€æœ‰å­è·¯ç”± 60 ç§’é‡æ–°éªŒè¯
export const revalidate = 60

export default function BlogLayout({ children }) {
  return <div>{children}</div>
}
```

## ç¼“å­˜ç­–ç•¥é€‰æ‹©

### å†³ç­–æµç¨‹

```
æ•°æ®æ˜¯å¦é¢‘ç¹å˜åŒ–ï¼Ÿ
â”‚
â”œâ”€ å¦ â†’ ä½¿ç”¨é»˜è®¤ç¼“å­˜ï¼ˆæ°¸ä¹…ï¼‰
â”‚       é€‚ç”¨ï¼šé™æ€å†…å®¹ã€é…ç½®ã€ä¸å¸¸æ›´æ–°çš„æ•°æ®
â”‚
â””â”€ æ˜¯ â†’ æ˜¯å¦éœ€è¦å®æ—¶æ›´æ–°ï¼Ÿ
        â”‚
        â”œâ”€ æ˜¯ â†’ cache: 'no-store'
        â”‚       é€‚ç”¨ï¼šç”¨æˆ·æ•°æ®ã€å®æ—¶çŠ¶æ€
        â”‚
        â””â”€ å¦ â†’ ä½¿ç”¨ revalidate
                é€‚ç”¨ï¼šæ–°é—»ã€å•†å“ã€åšå®¢
```

### åœºæ™¯é…ç½®è¡¨

| åœºæ™¯       | é…ç½®                | è¯´æ˜                |
| ---------- | ------------------- | ------------------- |
| é™æ€é¡µé¢   | é»˜è®¤                | æ„å»ºæ—¶ç”Ÿæˆ          |
| åšå®¢æ–‡ç«    | `revalidate: 3600`  | 1 å°æ—¶æ›´æ–°          |
| å•†å“ä»·æ ¼   | `revalidate: 60`    | 1 åˆ†é’Ÿæ›´æ–°          |
| ç”¨æˆ·ä»ªè¡¨ç›˜ | `cache: 'no-store'` | å®æ—¶æ•°æ®            |
| é…ç½®ä¿¡æ¯   | é»˜è®¤ + æŒ‰éœ€         | æ°¸ä¹…ç¼“å­˜ + æ‰‹åŠ¨å¤±æ•ˆ |

## å®æˆ˜é…ç½®

### ç”µå•†ç½‘ç«™

```tsx
// lib/api.ts

// å•†å“åˆ—è¡¨ï¼š5 åˆ†é’Ÿç¼“å­˜
export async function getProducts() {
  return fetch('https://api.example.com/products', {
    next: { revalidate: 300, tags: ['products'] },
  }).then((r) => r.json())
}

// å•†å“è¯¦æƒ…ï¼š1 å°æ—¶ç¼“å­˜ + æ ‡ç­¾
export async function getProduct(id: string) {
  return fetch(`https://api.example.com/products/${id}`, {
    next: { revalidate: 3600, tags: ['products', `product-${id}`] },
  }).then((r) => r.json())
}

// åº“å­˜ï¼šä¸ç¼“å­˜
export async function getStock(id: string) {
  return fetch(`https://api.example.com/products/${id}/stock`, {
    cache: 'no-store',
  }).then((r) => r.json())
}

// åˆ†ç±»ï¼šæ°¸ä¹…ç¼“å­˜
export async function getCategories() {
  return fetch('https://api.example.com/categories').then((r) => r.json())
}
```

```tsx
// app/actions.ts
'use server'

import { revalidateTag } from 'next/cache'

export async function updateProduct(id: string, data: FormData) {
  await fetch(`https://api.example.com/products/${id}`, {
    method: 'PUT',
    body: data,
  })

  // åªå¤±æ•ˆè¿™ä¸ªäº§å“çš„ç¼“å­˜
  revalidateTag(`product-${id}`)
}

export async function addProduct(data: FormData) {
  await fetch('https://api.example.com/products', {
    method: 'POST',
    body: data,
  })

  // å¤±æ•ˆäº§å“åˆ—è¡¨ç¼“å­˜
  revalidateTag('products')
}
```

### æ–°é—»ç½‘ç«™

```tsx
// lib/news.ts

// å¤´æ¡ï¼š5 åˆ†é’Ÿ
export async function getHeadlines() {
  return fetch('https://api.example.com/headlines', {
    next: { revalidate: 300, tags: ['headlines'] },
  }).then((r) => r.json())
}

// æ–‡ç« ï¼š1 å°æ—¶
export async function getArticle(slug: string) {
  return fetch(`https://api.example.com/articles/${slug}`, {
    next: { revalidate: 3600, tags: ['articles', `article-${slug}`] },
  }).then((r) => r.json())
}

// è¯„è®ºï¼šä¸ç¼“å­˜
export async function getComments(articleId: string) {
  return fetch(`https://api.example.com/articles/${articleId}/comments`, {
    cache: 'no-store',
  }).then((r) => r.json())
}
```

## è°ƒè¯•ç¼“å­˜

### æŸ¥çœ‹ç¼“å­˜çŠ¶æ€

```tsx
// å¼€å‘ç¯å¢ƒæ—¥å¿—
async function getData() {
  const start = Date.now()
  const res = await fetch('https://api.example.com/data')
  console.log(`è¯·æ±‚è€—æ—¶: ${Date.now() - start}ms`)
  console.log('ç¼“å­˜çŠ¶æ€:', res.headers.get('x-vercel-cache'))
  return res.json()
}
```

### æ„å»ºè¾“å‡º

æ„å»ºæ—¶æŸ¥çœ‹è·¯ç”±ç±»å‹ï¼š

```
Route (app)                              Size     First Load JS
â”Œ â—‹ /                                    5.2 kB         92 kB
â”œ â—‹ /about                               1.2 kB         88 kB
â”œ Î» /api/revalidate                      0 B            0 B
â”œ â— /blog                                2.1 kB         89 kB
â”œ â— /blog/[slug]                         3.5 kB         91 kB
â”” Î» /dashboard                           4.2 kB         91 kB

â—‹ (Static)   é™æ€é¢„æ¸²æŸ“
â— (SSG)      é™æ€ç”Ÿæˆï¼Œå¯å¢é‡æ›´æ–°
Î» (Dynamic)  åŠ¨æ€æ¸²æŸ“
```

## å¸¸è§é—®é¢˜

ğŸ¤” **Q: ä¸ºä»€ä¹ˆæ•°æ®æ²¡æœ‰æ›´æ–°ï¼Ÿ**

æ£€æŸ¥ï¼š

1. revalidate æ—¶é—´æ˜¯å¦è¿‡é•¿
2. æ˜¯å¦æœ‰å®¢æˆ·ç«¯è·¯ç”±ç¼“å­˜ï¼ˆå°è¯•ç¡¬åˆ·æ–°ï¼‰
3. æ˜¯å¦æ­£ç¡®é…ç½®äº†ç¼“å­˜é€‰é¡¹

ğŸ¤” **Q: å¼€å‘ç¯å¢ƒç¼“å­˜å’Œç”Ÿäº§ç¯å¢ƒä¸€æ ·å—ï¼Ÿ**

ä¸å®Œå…¨ä¸€æ ·ã€‚å¼€å‘ç¯å¢ƒé»˜è®¤ä¸ç¼“å­˜ä»¥ä¾¿è°ƒè¯•ã€‚

ğŸ¤” **Q: å¦‚ä½•æ¸…é™¤æ‰€æœ‰ç¼“å­˜ï¼Ÿ**

```bash
# åˆ é™¤ .next ç›®å½•
rm -rf .next
# é‡æ–°æ„å»º
pnpm build
```

---

ä¸‹ä¸€ç¯‡å°†ä»‹ç» Server Actionsï¼Œå­¦ä¹ å¦‚ä½•ç›´æ¥ä»å®¢æˆ·ç«¯è°ƒç”¨æœåŠ¡ç«¯å‡½æ•°ã€‚

-EOF-
