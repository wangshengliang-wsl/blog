---
title: pnpm å®Œå…¨æŒ‡å—
description: pnpm æ˜¯ä¸€æ¬¾é«˜æ•ˆèŠ‚çœç£ç›˜ç©ºé—´çš„ JavaScript åŒ…ç®¡ç†å™¨ï¼Œæœ¬æ–‡æ¶µç›–å®‰è£…é…ç½®ã€ç¡¬é“¾æ¥æœºåˆ¶ã€ä¸¥æ ¼ä¾èµ–ç®¡ç†ã€Workspace ä¸ Monorepo å®è·µ
pubDate: 2025-11-09
toc: true
ogImage: true
category: åŒ…ç®¡ç†å·¥å…·
tags: ['pnpm', 'Node.js', 'åŒ…ç®¡ç†å™¨', 'JavaScript', 'Monorepo']
---

pnpmï¼ˆPerformant npmï¼‰é€šè¿‡ç¡¬é“¾æ¥å’Œå†…å®¹å¯»å€å­˜å‚¨æœºåˆ¶ï¼Œè§£å†³äº† npm/yarn é‡å¤å®‰è£…ä¾èµ–ã€ç£ç›˜å ç”¨å¤§çš„é—®é¢˜ã€‚åœ¨å¤§å‹é¡¹ç›®å’Œ Monorepo åœºæ™¯ä¸‹ï¼Œpnpm çš„ä¼˜åŠ¿å°¤ä¸ºæ˜æ˜¾ã€‚

ğŸ¯ **ç¯å¢ƒè¯´æ˜**ï¼šæœ¬æ–‡åŸºäº pnpm v9.x ç¼–å†™ï¼ŒNode.js v20.x ç¯å¢ƒã€‚

## ä¸ºä»€ä¹ˆé€‰æ‹© pnpm

### ç£ç›˜ç©ºé—´èŠ‚çœ

âœ… ä¼ ç»ŸåŒ…ç®¡ç†å™¨ä¸ºæ¯ä¸ªé¡¹ç›®å¤åˆ¶ä¸€ä»½å®Œæ•´çš„ä¾èµ–ã€‚å‡è®¾ 10 ä¸ªé¡¹ç›®éƒ½ç”¨äº† lodashï¼Œç£ç›˜ä¸Šå°±æœ‰ 10 ä»½ç›¸åŒçš„æ–‡ä»¶ã€‚

pnpm é‡‡ç”¨å†…å®¹å¯»å€å­˜å‚¨ï¼šæ‰€æœ‰åŒ…åªåœ¨å…¨å±€ store ä¸­ä¿å­˜ä¸€ä»½ï¼Œé¡¹ç›®ä¸­é€šè¿‡ç¡¬é“¾æ¥å¼•ç”¨ã€‚åŒæ · 10 ä¸ªé¡¹ç›®ï¼Œlodash å®é™…åªå ç”¨ä¸€ä»½ç£ç›˜ç©ºé—´ã€‚

### å®‰è£…é€Ÿåº¦å¿«

âœ… ç”±äºå¤§éƒ¨åˆ†æ–‡ä»¶å·²åœ¨ store ä¸­ï¼Œpnpm å®‰è£…ä¾èµ–æ—¶åªéœ€åˆ›å»ºç¡¬é“¾æ¥ï¼Œæ— éœ€å¤åˆ¶æ–‡ä»¶ã€‚åœ¨æœ‰ç¼“å­˜çš„æƒ…å†µä¸‹ï¼Œå®‰è£…é€Ÿåº¦æ¯” npm/yarn å¿« 2-3 å€ã€‚

### ä¸¥æ ¼çš„ä¾èµ–ç»“æ„

âœ… npm/yarn çš„æ‰å¹³åŒ– `node_modules` å…è®¸é¡¹ç›®è®¿é—®æœªå£°æ˜çš„ä¾èµ–ï¼ˆå¹½çµä¾èµ–ï¼‰ã€‚pnpm é»˜è®¤ä½¿ç”¨éæ‰å¹³ç»“æ„ï¼Œåªæœ‰æ˜¾å¼å£°æ˜çš„ä¾èµ–æ‰èƒ½è¢«è®¿é—®ï¼Œä»æ ¹æœ¬ä¸Šæœç»äº†å¹½çµä¾èµ–é—®é¢˜ã€‚

## å®‰è£… pnpm

### é€šè¿‡ Corepackï¼ˆæ¨èï¼‰

```bash
$ corepack enable
$ corepack prepare pnpm@latest --activate
$ pnpm -v
9.15.0
```

### é€šè¿‡ npm

```bash
$ npm install -g pnpm
```

### é€šè¿‡ç‹¬ç«‹è„šæœ¬

```bash
# macOS / Linux
$ curl -fsSL https://get.pnpm.io/install.sh | sh -

# Windows (PowerShell)
$ iwr https://get.pnpm.io/install.ps1 -useb | iex
```

### é€šè¿‡ Homebrewï¼ˆmacOSï¼‰

```bash
$ brew install pnpm
```

## é¡¹ç›®åˆå§‹åŒ–

```bash
$ mkdir my-project && cd my-project
$ pnpm init
```

ç”Ÿæˆæ ‡å‡† `package.json`ã€‚

## ä¾èµ–ç®¡ç†

### å®‰è£…ä¾èµ–

```bash
# å®‰è£… package.json ä¸­çš„æ‰€æœ‰ä¾èµ–
$ pnpm install
# æˆ–ç®€å†™
$ pnpm i

# å®‰è£…ç”Ÿäº§ä¾èµ–
$ pnpm add lodash

# å®‰è£…å¼€å‘ä¾èµ–
$ pnpm add -D typescript

# å®‰è£…æŒ‡å®šç‰ˆæœ¬
$ pnpm add lodash@4.17.21

# å…¨å±€å®‰è£…
$ pnpm add -g typescript
```

### ç§»é™¤ä¾èµ–

```bash
$ pnpm remove lodash
# æˆ–ç®€å†™
$ pnpm rm lodash

# å…¨å±€ç§»é™¤
$ pnpm remove -g typescript
```

### æ›´æ–°ä¾èµ–

```bash
# æ›´æ–°æŒ‡å®šåŒ…
$ pnpm update lodash
# æˆ–ç®€å†™
$ pnpm up lodash

# æ›´æ–°æ‰€æœ‰åŒ…
$ pnpm update

# äº¤äº’å¼æ›´æ–°
$ pnpm update -i

# æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ï¼ˆå¿½ç•¥ semver èŒƒå›´ï¼‰
$ pnpm update lodash --latest
```

## node_modules ç»“æ„

pnpm çš„ `node_modules` ç»“æ„ä¸ npm/yarn ä¸åŒï¼š

```
node_modules/
â”œâ”€â”€ .pnpm/                    # æ‰€æœ‰ä¾èµ–çš„å®é™…å­˜å‚¨ä½ç½®
â”‚   â”œâ”€â”€ lodash@4.17.21/
â”‚   â”‚   â””â”€â”€ node_modules/
â”‚   â”‚       â””â”€â”€ lodash/       # ç¡¬é“¾æ¥åˆ°å…¨å±€ store
â”‚   â””â”€â”€ express@4.18.2/
â”‚       â””â”€â”€ node_modules/
â”‚           â”œâ”€â”€ express/
â”‚           â””â”€â”€ body-parser/  # express çš„ä¾èµ–
â”œâ”€â”€ lodash -> .pnpm/lodash@4.17.21/node_modules/lodash
â””â”€â”€ express -> .pnpm/express@4.18.2/node_modules/express
```

é¡¶å±‚ `node_modules` åªåŒ…å«é¡¹ç›®ç›´æ¥å£°æ˜çš„ä¾èµ–çš„ç¬¦å·é“¾æ¥ï¼Œé—´æ¥ä¾èµ–è¢«ã€Œéšè—ã€åœ¨ `.pnpm` ç›®å½•ä¸­ï¼Œæ— æ³•ç›´æ¥è®¿é—®ã€‚

### å¤„ç†å…¼å®¹æ€§é—®é¢˜

ğŸ”¶ éƒ¨åˆ†è€æ—§åŒ…ä¾èµ–æ‰å¹³åŒ–ç»“æ„ï¼Œå¯èƒ½æ— æ³•æ­£å¸¸å·¥ä½œã€‚è§£å†³æ–¹æ¡ˆï¼š

**1. æå‡æŒ‡å®šåŒ…**

åœ¨ `.npmrc` ä¸­é…ç½®ï¼š

```ini
public-hoist-pattern[]=*eslint*
public-hoist-pattern[]=*prettier*
```

**2. ä½¿ç”¨ shamefully-hoist**

ğŸ”¶ å°†æ‰€æœ‰åŒ…æå‡åˆ°é¡¶å±‚ï¼ˆä¸æ¨èï¼Œå¤±å»ä¸¥æ ¼ä¾èµ–çš„ä¼˜åŠ¿ï¼‰ï¼š

```ini
shamefully-hoist=true
```

## pnpm-lock.yaml

pnpm ä½¿ç”¨ `pnpm-lock.yaml` é”å®šä¾èµ–ç‰ˆæœ¬ã€‚æ ¼å¼ä¸ npm/yarn çš„é”æ–‡ä»¶ä¸åŒï¼Œä½†åŠŸèƒ½ä¸€è‡´ã€‚

```bash
# å¼ºåˆ¶æ ¹æ® lock æ–‡ä»¶å®‰è£…ï¼ˆCI ç¯å¢ƒæ¨èï¼‰
$ pnpm install --frozen-lockfile
```

## å…¨å±€ Store

pnpm çš„å…¨å±€ store é»˜è®¤ä½äºï¼š

- macOS/Linuxï¼š`~/.local/share/pnpm/store`
- Windowsï¼š`%LOCALAPPDATA%/pnpm/store`

```bash
# æŸ¥çœ‹ store è·¯å¾„
$ pnpm store path

# æ¸…ç†æœªè¢«å¼•ç”¨çš„åŒ…
$ pnpm store prune

# æŸ¥çœ‹ store çŠ¶æ€
$ pnpm store status
```

## è¿è¡Œè„šæœ¬

```bash
# è¿è¡Œ package.json ä¸­çš„è„šæœ¬
$ pnpm run dev
$ pnpm run build

# ç®€å†™ï¼ˆéå†…ç½®å‘½ä»¤æ—¶ï¼‰
$ pnpm dev
$ pnpm build

# ä¼ é€’å‚æ•°
$ pnpm test -- --watch
```

## æ‰§è¡ŒåŒ…å‘½ä»¤

```bash
# ç±»ä¼¼ npxï¼Œä¸´æ—¶ä¸‹è½½å¹¶æ‰§è¡Œ
$ pnpm dlx create-react-app my-app
$ pnpm dlx degit user/repo my-project

# æ‰§è¡Œæœ¬åœ°å·²å®‰è£…çš„åŒ…
$ pnpm exec eslint src
```

## é…ç½®ç®¡ç†

pnpm é…ç½®å†™åœ¨ `.npmrc` æ–‡ä»¶ä¸­ï¼ˆä¸ npm å…±ç”¨æ ¼å¼ï¼‰ï¼š

```ini
# è®¾ç½®æº
registry=https://registry.npmmirror.com

# è®¾ç½® store ç›®å½•
store-dir=~/.pnpm-store

# ä¸¥æ ¼å¯¹ç­‰ä¾èµ–æ£€æŸ¥
strict-peer-dependencies=true

# è‡ªåŠ¨å®‰è£…å¯¹ç­‰ä¾èµ–
auto-install-peers=true

# æå‡æŒ‡å®šæ¨¡å¼çš„åŒ…
public-hoist-pattern[]=*eslint*
public-hoist-pattern[]=@types/*
```

å‘½ä»¤è¡ŒæŸ¥çœ‹/è®¾ç½®é…ç½®ï¼š

```bash
$ pnpm config list
$ pnpm config get registry
$ pnpm config set registry https://registry.npmmirror.com
```

## Workspaceï¼ˆMonorepoï¼‰

pnpm å†…ç½®å¼ºå¤§çš„ Workspace æ”¯æŒï¼Œæ˜¯ Monorepo é¡¹ç›®çš„ç†æƒ³é€‰æ‹©ã€‚

### é…ç½®

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `pnpm-workspace.yaml`ï¼š

```yaml
packages:
  - 'packages/*'
  - 'apps/*'
  - '!**/test/**' # æ’é™¤æµ‹è¯•ç›®å½•
```

ç›®å½•ç»“æ„ï¼š

```
my-monorepo/
â”œâ”€â”€ package.json
â”œâ”€â”€ pnpm-workspace.yaml
â”œâ”€â”€ pnpm-lock.yaml
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ shared/
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ package.json
â””â”€â”€ apps/
    â”œâ”€â”€ web/
    â”‚   â””â”€â”€ package.json
    â””â”€â”€ api/
        â””â”€â”€ package.json
```

### Workspace å‘½ä»¤

```bash
# åœ¨æ ¹ç›®å½•å®‰è£…æ‰€æœ‰ workspace çš„ä¾èµ–
$ pnpm install

# åœ¨æŒ‡å®š workspace æ‰§è¡Œå‘½ä»¤
$ pnpm --filter @my-monorepo/web dev

# ä½¿ç”¨é€šé…ç¬¦åŒ¹é…
$ pnpm --filter "@my-monorepo/*" build

# åœ¨æ‰€æœ‰ workspace æ‰§è¡Œå‘½ä»¤
$ pnpm -r run build
# æˆ–
$ pnpm --recursive run build

# å¹¶è¡Œæ‰§è¡Œ
$ pnpm -r --parallel run build

# åªåœ¨æœ‰å˜æ›´çš„ workspace æ‰§è¡Œ
$ pnpm -r --filter "...[origin/main]" run build
```

### è·¨ Workspace ä¾èµ–

ä½¿ç”¨ `workspace:` åè®®å¼•ç”¨æœ¬åœ°åŒ…ï¼š

```json
{
  "name": "@my-monorepo/web",
  "dependencies": {
    "@my-monorepo/shared": "workspace:*",
    "@my-monorepo/utils": "workspace:^1.0.0"
  }
}
```

| åè®®          | å‘å¸ƒæ—¶è½¬æ¢           |
| ------------- | -------------------- |
| `workspace:*` | å½“å‰ç‰ˆæœ¬ï¼Œå¦‚ `1.2.3` |
| `workspace:^` | `^1.2.3`             |
| `workspace:~` | `~1.2.3`             |

å‘å¸ƒåˆ° npm æ—¶ï¼Œ`workspace:` åè®®ä¼šè‡ªåŠ¨è½¬æ¢ä¸ºå®é™…ç‰ˆæœ¬å·ã€‚

### æ·»åŠ ä¾èµ–åˆ° Workspace

```bash
# ç»™æŒ‡å®š workspace æ·»åŠ ä¾èµ–
$ pnpm --filter @my-monorepo/web add react

# ç»™æ ¹é¡¹ç›®æ·»åŠ å¼€å‘ä¾èµ–
$ pnpm add -D -w typescript

# ç»™æ‰€æœ‰ workspace æ·»åŠ ä¾èµ–
$ pnpm -r add lodash
```

## è¿‡æ»¤å™¨è¯­æ³•

pnpm çš„ `--filter` éå¸¸å¼ºå¤§ï¼š

```bash
# æŒ‰åç§°
$ pnpm --filter @my-monorepo/web run build

# æŒ‰ç›®å½•
$ pnpm --filter ./apps/web run build

# é€šé…ç¬¦
$ pnpm --filter "@my-monorepo/*" run build
$ pnpm --filter "*web*" run build

# ä¾èµ–é“¾
$ pnpm --filter @my-monorepo/web... run build  # web åŠå…¶ä¾èµ–
$ pnpm --filter ...@my-monorepo/shared run build  # shared åŠä¾èµ–å®ƒçš„åŒ…

# å˜æ›´æ£€æµ‹
$ pnpm --filter "...[origin/main]" run test  # ç›¸å¯¹ main åˆ†æ”¯æœ‰å˜æ›´çš„åŒ…
```

## å¯¼å…¥å…¶ä»–é”æ–‡ä»¶

ä»ç°æœ‰é¡¹ç›®è¿ç§»åˆ° pnpmï¼š

```bash
# ä» package-lock.json å¯¼å…¥
$ pnpm import

# ä» yarn.lock å¯¼å…¥
$ pnpm import
```

pnpm ä¼šè‡ªåŠ¨æ£€æµ‹ç°æœ‰é”æ–‡ä»¶å¹¶è½¬æ¢ä¸º `pnpm-lock.yaml`ã€‚

## è¡¥ä¸åŠŸèƒ½

pnpm æ”¯æŒç›´æ¥ä¿®è¡¥ node_modules ä¸­çš„åŒ…ï¼š

```bash
# å‡†å¤‡ä¿®è¡¥
$ pnpm patch lodash@4.17.21

# ç¼–è¾‘ <ä¸´æ—¶ç›®å½•> ä¸­çš„æ–‡ä»¶...

# æäº¤ä¿®è¡¥
$ pnpm patch-commit <ä¸´æ—¶ç›®å½•>

# å¿½ç•¥å·²æœ‰è¡¥ä¸é‡æ–°ä¿®è¡¥
$ pnpm patch lodash@4.17.21 --ignore-existing
```

ä¿®è¡¥å†…å®¹ä¿å­˜åœ¨ `patches/` ç›®å½•ï¼Œå¹¶è®°å½•åœ¨ `package.json` ä¸­ï¼š

```json
{
  "pnpm": {
    "patchedDependencies": {
      "lodash@4.17.21": "patches/lodash@4.17.21.patch"
    }
  }
}
```

## Catalogsï¼ˆç‰ˆæœ¬ç›®å½•ï¼‰

pnpm v9+ å¼•å…¥äº† Catalogs åŠŸèƒ½ï¼Œç”¨äºåœ¨ Monorepo ä¸­ç»Ÿä¸€ç®¡ç†ä¾èµ–ç‰ˆæœ¬ã€‚

### å®šä¹‰ Catalog

åœ¨ `pnpm-workspace.yaml` ä¸­å®šä¹‰ï¼š

```yaml
packages:
  - 'packages/*'

# é»˜è®¤ catalog
catalog:
  react: ^18.3.1
  redux: ^5.0.1

# å‘½å catalogs
catalogs:
  react17:
    react: ^17.0.2
    react-dom: ^17.0.2
  react18:
    react: ^18.2.0
    react-dom: ^18.2.0
```

### ä½¿ç”¨ Catalog

åœ¨ `package.json` ä¸­å¼•ç”¨ï¼š

```json
{
  "name": "@example/app",
  "dependencies": {
    "react": "catalog:",
    "redux": "catalog:"
  }
}
```

ä½¿ç”¨å‘½å catalogï¼š

```json
{
  "dependencies": {
    "react": "catalog:react18",
    "react-dom": "catalog:react18"
  }
}
```

Catalogs çš„ä¼˜åŠ¿ï¼š

- ç»Ÿä¸€ç®¡ç† Monorepo ä¸­æ‰€æœ‰åŒ…çš„ä¾èµ–ç‰ˆæœ¬
- é¿å…ç‰ˆæœ¬ä¸ä¸€è‡´é—®é¢˜
- ç®€åŒ–ä¾èµ–å‡çº§æµç¨‹

## å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

| å‘½ä»¤                   | ç”¨é€”           |
| ---------------------- | -------------- |
| `pnpm install`         | å®‰è£…æ‰€æœ‰ä¾èµ–   |
| `pnpm add <pkg>`       | æ·»åŠ ç”Ÿäº§ä¾èµ–   |
| `pnpm add -D <pkg>`    | æ·»åŠ å¼€å‘ä¾èµ–   |
| `pnpm add -g <pkg>`    | å…¨å±€å®‰è£…       |
| `pnpm remove <pkg>`    | ç§»é™¤ä¾èµ–       |
| `pnpm update`          | æ›´æ–°ä¾èµ–       |
| `pnpm run <script>`    | è¿è¡Œè„šæœ¬       |
| `pnpm dlx <pkg>`       | ä¸´æ—¶æ‰§è¡ŒåŒ…     |
| `pnpm exec <cmd>`      | æ‰§è¡Œæœ¬åœ°å‘½ä»¤   |
| `pnpm --filter <name>` | è¿‡æ»¤ workspace |
| `pnpm -r <cmd>`        | é€’å½’æ‰§è¡Œ       |
| `pnpm store prune`     | æ¸…ç† store     |
| `pnpm import`          | å¯¼å…¥é”æ–‡ä»¶     |
| `pnpm patch <pkg>`     | ä¿®è¡¥ä¾èµ–       |

## npm vs yarn vs pnpm

| ç‰¹æ€§     | npm      | yarn     | pnpm     |
| -------- | -------- | -------- | -------- |
| ç£ç›˜å ç”¨ | é«˜       | é«˜       | ä½       |
| å®‰è£…é€Ÿåº¦ | ä¸­       | å¿«       | æ›´å¿«     |
| å¹½çµä¾èµ– | å­˜åœ¨     | å­˜åœ¨     | æœç»     |
| Monorepo | v7+ æ”¯æŒ | åŸç”Ÿæ”¯æŒ | åŸç”Ÿæ”¯æŒ |
| å†…å®¹å¯»å€ | âŒ       | âŒ       | âœ…       |
| ç¡¬é“¾æ¥   | âŒ       | âŒ       | âœ…       |

## å‚è€ƒèµ„æ–™

- [pnpm å®˜æ–¹æ–‡æ¡£](https://pnpm.io/zh/)
- [pnpm ä¸å…¶ä»–åŒ…ç®¡ç†å™¨å¯¹æ¯”](https://pnpm.io/benchmarks)
- [Flat node_modules is not the only way](https://pnpm.io/blog/2020/05/27/flat-node-modules-is-not-the-only-way)
- [Monorepo æœ€ä½³å®è·µ](https://pnpm.io/workspaces)
