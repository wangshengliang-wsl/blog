---
title: 'æ³›å‹çº¦æŸ'
description: 'TypeScript æ³›å‹çº¦æŸè¯¦è§£ï¼šextends çº¦æŸã€keyof çº¦æŸã€å¤šé‡çº¦æŸçš„ä½¿ç”¨æ–¹æ³•ä¸æœ€ä½³å®è·µ'
pubDate: 2024-02-01
toc: true
ogImage: true
category: 'TypeScript'
tags: ['TypeScript', 'æ³›å‹çº¦æŸ', 'extends', 'keyof', 'ç±»å‹çº¦æŸ']
---

æ³›å‹å¾ˆå¼ºå¤§ï¼Œä½†æœ‰æ—¶æˆ‘ä»¬éœ€è¦é™åˆ¶ç±»å‹å‚æ•°çš„èŒƒå›´ã€‚æ³›å‹çº¦æŸå…è®¸æˆ‘ä»¬æŒ‡å®šç±»å‹å‚æ•°å¿…é¡»æ»¡è¶³æŸäº›æ¡ä»¶ã€‚

## åŸºæœ¬çº¦æŸ

ä½¿ç”¨ `extends` å…³é”®å­—çº¦æŸç±»å‹å‚æ•°ï¼š

```typescript
// TypeScript 5.x

// æ²¡æœ‰çº¦æŸï¼šæ— æ³•è®¿é—®ä»»ä½•å±æ€§
function logLength<T>(arg: T): T {
  // console.log(arg.length);  // âŒ é”™è¯¯ï¼šT ä¸Šä¸å­˜åœ¨ length
  return arg
}

// æ·»åŠ çº¦æŸï¼šå¿…é¡»æœ‰ length å±æ€§
interface Lengthwise {
  length: number
}

function logLength2<T extends Lengthwise>(arg: T): T {
  console.log(arg.length) // âœ… ç°åœ¨å¯ä»¥è®¿é—®
  return arg
}

logLength2('hello') // âœ… string æœ‰ length
logLength2([1, 2, 3]) // âœ… æ•°ç»„æœ‰ length
logLength2({ length: 10 }) // âœ… å¯¹è±¡æœ‰ length
// logLength2(123);  // âŒ number æ²¡æœ‰ length
```

## keyof çº¦æŸ

ä½¿ç”¨ `keyof` çº¦æŸç±»å‹å‚æ•°ä¸ºå¯¹è±¡çš„é”®ï¼š

```typescript
// è·å–å¯¹è±¡å±æ€§
function getProperty<T, K extends keyof T>(obj: T, key: K): T[K] {
  return obj[key]
}

const person = {
  name: 'å¼ ä¸‰',
  age: 25,
  email: 'test@test.com',
}

const name = getProperty(person, 'name') // string
const age = getProperty(person, 'age') // number
// getProperty(person, 'invalid');  // âŒ é”™è¯¯

// è®¾ç½®å¯¹è±¡å±æ€§
function setProperty<T, K extends keyof T>(obj: T, key: K, value: T[K]): void {
  obj[key] = value
}

setProperty(person, 'age', 30) // âœ…
// setProperty(person, 'age', 'thirty');  // âŒ ç±»å‹ä¸åŒ¹é…
```

## å¤šé‡çº¦æŸ

ä¸€ä¸ªç±»å‹å‚æ•°å¯ä»¥æœ‰å¤šä¸ªçº¦æŸï¼š

```typescript
interface Named {
  name: string
}

interface Aged {
  age: number
}

// ä½¿ç”¨äº¤å‰ç±»å‹å®ç°å¤šé‡çº¦æŸ
function greet<T extends Named & Aged>(entity: T): string {
  return `Hello, ${entity.name}! You are ${entity.age} years old.`
}

greet({ name: 'å¼ ä¸‰', age: 25 }) // âœ…
greet({ name: 'å¼ ä¸‰', age: 25, email: 'test@test.com' }) // âœ… å¯ä»¥æœ‰é¢å¤–å±æ€§
// greet({ name: 'å¼ ä¸‰' });  // âŒ ç¼ºå°‘ age
```

## ç±»ç±»å‹çº¦æŸ

çº¦æŸç±»å‹å‚æ•°ä¸ºå¯æ„é€ çš„ç±»å‹ï¼š

```typescript
// æ„é€ å‡½æ•°çº¦æŸ
function create<T>(ctor: new () => T): T {
  return new ctor()
}

class User {
  name = 'default'
}

const user = create(User) // User

// å¸¦å‚æ•°çš„æ„é€ å‡½æ•°
function createWithArgs<T>(ctor: new (...args: any[]) => T, ...args: any[]): T {
  return new ctor(...args)
}

class Product {
  constructor(
    public name: string,
    public price: number
  ) {}
}

const product = createWithArgs(Product, 'æ‰‹æœº', 5999)

// æ›´ç²¾ç¡®çš„ç±»å‹çº¦æŸ
type Constructor<T = {}> = new (...args: any[]) => T

function factory<T extends Constructor>(Base: T) {
  return class extends Base {
    timestamp = new Date()
  }
}

const TimestampedUser = factory(User)
const user2 = new TimestampedUser()
console.log(user2.timestamp)
```

## æ¡ä»¶ç±»å‹ä¸çº¦æŸ

çº¦æŸå¯ä»¥ä¸æ¡ä»¶ç±»å‹ç»“åˆï¼š

```typescript
// æå–æ•°ç»„å…ƒç´ ç±»å‹
type ElementType<T> = T extends (infer E)[] ? E : never

type StringElement = ElementType<string[]> // string
type NumberElement = ElementType<number[]> // number
type Never = ElementType<string> // never

// æå–å‡½æ•°è¿”å›ç±»å‹
type MyReturnType<T> = T extends (...args: any[]) => infer R ? R : never

type FnReturn = MyReturnType<() => string> // string

// æå– Promise å†…éƒ¨ç±»å‹
type UnwrapPromise<T> = T extends Promise<infer U> ? U : T

type Unwrapped = UnwrapPromise<Promise<string>> // string
type NotPromise = UnwrapPromise<number> // number
```

## çº¦æŸä¼ é€’

ç±»å‹å‚æ•°ä¹‹é—´å¯ä»¥ç›¸äº’çº¦æŸï¼š

```typescript
// U çº¦æŸä¸º T çš„å­ç±»å‹
function copy<T extends U, U>(source: T, target: U): T {
  return { ...target, ...source }
}

// K çº¦æŸä¸º T çš„é”®
function pick<T, K extends keyof T>(obj: T, keys: K[]): Pick<T, K> {
  const result = {} as Pick<T, K>
  keys.forEach((key) => {
    result[key] = obj[key]
  })
  return result
}

const user = { name: 'å¼ ä¸‰', age: 25, email: 'test@test.com' }
const picked = pick(user, ['name', 'age'])
// { name: string; age: number }
```

## é»˜è®¤çº¦æŸ

```typescript
// é»˜è®¤çº¦æŸä¸º unknown
function identity<T = unknown>(arg: T): T {
  return arg
}

// é»˜è®¤çº¦æŸä¸ºç‰¹å®šç±»å‹
interface Container<T extends object = Record<string, unknown>> {
  data: T
}

const c1: Container = { data: { anything: 'here' } }
const c2: Container<{ name: string }> = { data: { name: 'å¼ ä¸‰' } }
```

## å®é™…åº”ç”¨

### ç±»å‹å®‰å…¨çš„äº‹ä»¶ç³»ç»Ÿ

```typescript
interface EventMap {
  click: { x: number; y: number }
  input: { value: string }
  submit: { data: Record<string, unknown> }
}

class TypedEventEmitter<T extends Record<string, unknown>> {
  private handlers = new Map<keyof T, Function[]>()

  on<K extends keyof T>(event: K, handler: (payload: T[K]) => void): void {
    const list = this.handlers.get(event) || []
    list.push(handler)
    this.handlers.set(event, list)
  }

  emit<K extends keyof T>(event: K, payload: T[K]): void {
    const handlers = this.handlers.get(event) || []
    handlers.forEach((h) => h(payload))
  }
}

const emitter = new TypedEventEmitter<EventMap>()

emitter.on('click', (e) => {
  console.log(e.x, e.y) // ç±»å‹å®‰å…¨
})

emitter.emit('click', { x: 100, y: 200 }) // âœ…
// emitter.emit('click', { value: 'test' });  // âŒ ç±»å‹ä¸åŒ¹é…
```

### ç±»å‹å®‰å…¨çš„ API å®¢æˆ·ç«¯

```typescript
interface ApiEndpoints {
  '/users': { request: { page: number }; response: User[] }
  '/users/:id': { request: { id: string }; response: User }
  '/posts': { request: {}; response: Post[] }
}

class ApiClient<
  T extends Record<string, { request: object; response: unknown }>,
> {
  async get<K extends keyof T>(
    endpoint: K,
    params: T[K]['request']
  ): Promise<T[K]['response']> {
    // å®ç° API è°ƒç”¨
    const response = await fetch(endpoint as string)
    return response.json()
  }
}

const api = new ApiClient<ApiEndpoints>()

// ç±»å‹å®‰å…¨çš„ API è°ƒç”¨
const users = await api.get('/users', { page: 1 }) // User[]
const user = await api.get('/users/:id', { id: '123' }) // User
```

### æ·±åº¦åªè¯»

```typescript
type DeepReadonly<T> = T extends object
  ? { readonly [K in keyof T]: DeepReadonly<T[K]> }
  : T

interface User {
  name: string
  address: {
    city: string
    street: string
  }
}

type ReadonlyUser = DeepReadonly<User>

const user: ReadonlyUser = {
  name: 'å¼ ä¸‰',
  address: {
    city: 'åŒ—äº¬',
    street: 'ä¸­å…³æ‘',
  },
}

// user.name = 'æå››';  // âŒ åªè¯»
// user.address.city = 'ä¸Šæµ·';  // âŒ æ·±åº¦åªè¯»
```

## å¸¸è§é—®é¢˜

### ğŸ™‹ çº¦æŸå’Œé»˜è®¤ç±»å‹æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ

é»˜è®¤ç±»å‹å¿…é¡»æ»¡è¶³çº¦æŸï¼š

```typescript
// âœ… æ­£ç¡®ï¼šstring æ»¡è¶³ Lengthwise
interface Lengthwise {
  length: number
}
function fn<T extends Lengthwise = string>(arg: T): T {
  return arg
}

// âŒ é”™è¯¯ï¼šnumber ä¸æ»¡è¶³ Lengthwise
// function fn2<T extends Lengthwise = number>(arg: T): T
```

### ğŸ™‹ å¦‚ä½•çº¦æŸç±»å‹å‚æ•°ä¸ºåŸå§‹ç±»å‹ï¼Ÿ

```typescript
type Primitive = string | number | boolean | null | undefined | symbol | bigint

function process<T extends Primitive>(value: T): T {
  return value
}

process('hello') // âœ…
process(42) // âœ…
// process({});  // âŒ
```

### ğŸ™‹ çº¦æŸä¸­çš„ extends å’Œç»§æ‰¿ä¸­çš„ extends ä¸€æ ·å—ï¼Ÿ

è¯­æ³•ç›¸åŒï¼Œä½†è¯­ä¹‰ä¸åŒï¼š

```typescript
// ç»§æ‰¿ï¼šåˆ›å»ºå­ç±»
class Dog extends Animal {}

// çº¦æŸï¼šç±»å‹å¿…é¡»æ»¡è¶³æ¡ä»¶
function fn<T extends Animal>(arg: T) {}
```

## æ€»ç»“

| çº¦æŸç±»å‹     | è¯­æ³•                        | ç”¨é€”             |
| ------------ | --------------------------- | ---------------- |
| æ¥å£çº¦æŸ     | `T extends Interface`       | å¿…é¡»æ»¡è¶³æ¥å£ç»“æ„ |
| keyof çº¦æŸ   | `K extends keyof T`         | å¿…é¡»æ˜¯å¯¹è±¡çš„é”®   |
| å¤šé‡çº¦æŸ     | `T extends A & B`           | å¿…é¡»æ»¡è¶³å¤šä¸ªæ¡ä»¶ |
| æ„é€ å‡½æ•°çº¦æŸ | `T extends new () => U`     | å¿…é¡»æ˜¯å¯æ„é€ ç±»å‹ |
| æ¡ä»¶çº¦æŸ     | `T extends ... ? ... : ...` | æ¡ä»¶ç±»å‹æ¨æ–­     |

ä¸‹ä¸€ç¯‡æˆ‘ä»¬å°†å­¦ä¹  TypeScript å†…ç½®çš„å·¥å…·ç±»å‹ï¼Œå¦‚ Partialã€Requiredã€Pick ç­‰ã€‚
