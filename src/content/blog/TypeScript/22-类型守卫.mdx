---
title: 'ç±»å‹å®ˆå«'
description: 'TypeScript ç±»å‹å®ˆå«è¯¦è§£ï¼štypeofã€instanceofã€in æ“ä½œç¬¦ã€è‡ªå®šä¹‰ç±»å‹å®ˆå«çš„ä½¿ç”¨æ–¹æ³•'
pubDate: 2024-02-05
toc: true
ogImage: true
category: 'TypeScript'
tags: ['TypeScript', 'ç±»å‹å®ˆå«', 'typeof', 'instanceof', 'ç±»å‹å®‰å…¨']
---

ç±»å‹å®ˆå«ï¼ˆType Guardï¼‰æ˜¯ TypeScript ä¸­ç”¨äºåœ¨è¿è¡Œæ—¶æ£€æŸ¥ç±»å‹çš„è¡¨è¾¾å¼ï¼Œå¯ä»¥å¸®åŠ©ç¼–è¯‘å™¨åœ¨ç‰¹å®šä»£ç å—ä¸­ç¡®å®šå˜é‡çš„å…·ä½“ç±»å‹ã€‚

## typeof ç±»å‹å®ˆå«

ä½¿ç”¨ `typeof` æ£€æŸ¥åŸå§‹ç±»å‹ï¼š

```typescript
// TypeScript 5.x

function process(value: string | number) {
  if (typeof value === 'string') {
    // è¿™é‡Œ value è¢«æ”¶çª„ä¸º string
    console.log(value.toUpperCase())
    console.log(value.length)
  } else {
    // è¿™é‡Œ value è¢«æ”¶çª„ä¸º number
    console.log(value.toFixed(2))
    console.log(value * 2)
  }
}

process('hello') // HELLO, 5
process(3.14159) // 3.14, 6.28318

// typeof æ”¯æŒçš„ç±»å‹
function checkType(value: unknown) {
  if (typeof value === 'string') {
    return 'string'
  }
  if (typeof value === 'number') {
    return 'number'
  }
  if (typeof value === 'boolean') {
    return 'boolean'
  }
  if (typeof value === 'function') {
    return 'function'
  }
  if (typeof value === 'object') {
    return 'object or null'
  }
  if (typeof value === 'undefined') {
    return 'undefined'
  }
  if (typeof value === 'symbol') {
    return 'symbol'
  }
  if (typeof value === 'bigint') {
    return 'bigint'
  }
}
```

## instanceof ç±»å‹å®ˆå«

ä½¿ç”¨ `instanceof` æ£€æŸ¥ç±»å®ä¾‹ï¼š

```typescript
class Dog {
  bark() {
    console.log('æ±ªæ±ª!')
  }
}

class Cat {
  meow() {
    console.log('å–µå–µ!')
  }
}

function makeSound(animal: Dog | Cat) {
  if (animal instanceof Dog) {
    animal.bark() // animal æ˜¯ Dog
  } else {
    animal.meow() // animal æ˜¯ Cat
  }
}

const dog = new Dog()
const cat = new Cat()

makeSound(dog) // æ±ªæ±ª!
makeSound(cat) // å–µå–µ!

// å¤„ç†å†…ç½®ç±»å‹
function processValue(value: Date | string[]) {
  if (value instanceof Date) {
    console.log(value.toISOString())
  } else {
    console.log(value.join(', '))
  }
}

processValue(new Date()) // 2024-02-05T...
processValue(['a', 'b', 'c']) // a, b, c

// å¤„ç†é”™è¯¯
function handleError(error: unknown) {
  if (error instanceof Error) {
    console.log(error.message)
    console.log(error.stack)
  } else if (typeof error === 'string') {
    console.log(error)
  } else {
    console.log('æœªçŸ¥é”™è¯¯')
  }
}
```

## in æ“ä½œç¬¦ç±»å‹å®ˆå«

ä½¿ç”¨ `in` æ£€æŸ¥å±æ€§æ˜¯å¦å­˜åœ¨ï¼š

```typescript
interface Bird {
  fly(): void
  layEggs(): void
}

interface Fish {
  swim(): void
  layEggs(): void
}

function move(animal: Bird | Fish) {
  if ('fly' in animal) {
    animal.fly() // animal æ˜¯ Bird
  } else {
    animal.swim() // animal æ˜¯ Fish
  }
}

// å¸¸ç”¨äºå¯è¾¨è¯†è”åˆ
interface Circle {
  kind: 'circle'
  radius: number
}

interface Rectangle {
  kind: 'rectangle'
  width: number
  height: number
}

type Shape = Circle | Rectangle

function getArea(shape: Shape): number {
  if ('radius' in shape) {
    return Math.PI * shape.radius ** 2
  } else {
    return shape.width * shape.height
  }
}

// æ£€æŸ¥å¯é€‰å±æ€§
interface User {
  name: string
  email?: string
  phone?: string
}

function contact(user: User) {
  if ('email' in user && user.email) {
    console.log(`å‘é€é‚®ä»¶åˆ°: ${user.email}`)
  } else if ('phone' in user && user.phone) {
    console.log(`æ‹¨æ‰“ç”µè¯: ${user.phone}`)
  } else {
    console.log('æ²¡æœ‰è”ç³»æ–¹å¼')
  }
}
```

## è‡ªå®šä¹‰ç±»å‹å®ˆå«

ä½¿ç”¨ `is` å…³é”®å­—åˆ›å»ºè‡ªå®šä¹‰ç±»å‹å®ˆå«ï¼š

```typescript
// åŸºæœ¬è¯­æ³•
function isString(value: unknown): value is string {
  return typeof value === 'string'
}

function isNumber(value: unknown): value is number {
  return typeof value === 'number'
}

function process(value: unknown) {
  if (isString(value)) {
    console.log(value.toUpperCase()) // value æ˜¯ string
  } else if (isNumber(value)) {
    console.log(value.toFixed(2)) // value æ˜¯ number
  }
}

// æ£€æŸ¥å¯¹è±¡ç±»å‹
interface User {
  id: number
  name: string
  email: string
}

function isUser(value: unknown): value is User {
  return (
    typeof value === 'object' &&
    value !== null &&
    'id' in value &&
    'name' in value &&
    'email' in value &&
    typeof (value as User).id === 'number' &&
    typeof (value as User).name === 'string' &&
    typeof (value as User).email === 'string'
  )
}

function greet(data: unknown) {
  if (isUser(data)) {
    console.log(`Hello, ${data.name}!`) // ç±»å‹å®‰å…¨
  } else {
    console.log('Invalid user data')
  }
}

// æ£€æŸ¥æ•°ç»„
function isStringArray(value: unknown): value is string[] {
  return Array.isArray(value) && value.every((item) => typeof item === 'string')
}

function processArray(data: unknown) {
  if (isStringArray(data)) {
    data.forEach((s) => console.log(s.toUpperCase()))
  }
}
```

## æ–­è¨€å‡½æ•°

ä½¿ç”¨ `asserts` å…³é”®å­—åˆ›å»ºæ–­è¨€å‡½æ•°ï¼š

```typescript
// æ–­è¨€å‡½æ•°ï¼šå¦‚æœæ£€æŸ¥å¤±è´¥åˆ™æŠ›å‡ºé”™è¯¯
function assertIsString(value: unknown): asserts value is string {
  if (typeof value !== 'string') {
    throw new Error('Value is not a string')
  }
}

function process(value: unknown) {
  assertIsString(value)
  // ä¹‹å value è¢«è§†ä¸º string
  console.log(value.toUpperCase())
}

// æ–­è¨€éç©º
function assertDefined<T>(value: T | null | undefined): asserts value is T {
  if (value === null || value === undefined) {
    throw new Error('Value is null or undefined')
  }
}

function getLength(str: string | null) {
  assertDefined(str)
  return str.length // str æ˜¯ string
}

// æ–­è¨€æ¡ä»¶
function assert(condition: boolean, message: string): asserts condition {
  if (!condition) {
    throw new Error(message)
  }
}

function divide(a: number, b: number) {
  assert(b !== 0, 'Divisor cannot be zero')
  return a / b
}
```

## ç±»å‹å®ˆå«ä¸æ³›å‹

```typescript
// æ³›å‹ç±»å‹å®ˆå«
function isDefined<T>(value: T | null | undefined): value is T {
  return value !== null && value !== undefined
}

const values: (string | null | undefined)[] = ['a', null, 'b', undefined, 'c']
const defined = values.filter(isDefined)
// defined: string[]

// å¸¦çº¦æŸçš„æ³›å‹å®ˆå«
interface WithId {
  id: string
}

function hasId<T>(value: T): value is T & WithId {
  return typeof value === 'object' && value !== null && 'id' in value
}

function processItem<T>(item: T) {
  if (hasId(item)) {
    console.log(`ID: ${item.id}`)
  }
}

// ç±»å‹è°“è¯ä¸æ˜ å°„
function isNotNull<T>(value: T | null): value is T {
  return value !== null
}

const items: (number | null)[] = [1, null, 2, null, 3]
const numbers = items.filter(isNotNull)
// numbers: number[]
```

## å®é™…åº”ç”¨

### API å“åº”éªŒè¯

```typescript
interface SuccessResponse<T> {
  success: true
  data: T
}

interface ErrorResponse {
  success: false
  error: string
}

type ApiResponse<T> = SuccessResponse<T> | ErrorResponse

function isSuccess<T>(
  response: ApiResponse<T>
): response is SuccessResponse<T> {
  return response.success === true
}

interface User {
  id: number
  name: string
}

async function fetchUser(id: number): Promise<User | null> {
  const response: ApiResponse<User> = await fetch(`/api/users/${id}`).then(
    (r) => r.json()
  )

  if (isSuccess(response)) {
    return response.data // ç±»å‹å®‰å…¨
  } else {
    console.error(response.error)
    return null
  }
}
```

### è¡¨å•æ•°æ®éªŒè¯

```typescript
interface FormData {
  username: string
  email: string
  age: number
}

interface ValidationResult {
  valid: boolean
  errors: string[]
}

function isValidFormData(data: unknown): data is FormData {
  if (typeof data !== 'object' || data === null) {
    return false
  }

  const obj = data as Record<string, unknown>

  return (
    typeof obj.username === 'string' &&
    obj.username.length >= 3 &&
    typeof obj.email === 'string' &&
    obj.email.includes('@') &&
    typeof obj.age === 'number' &&
    obj.age >= 0 &&
    obj.age <= 150
  )
}

function processForm(data: unknown): ValidationResult {
  if (isValidFormData(data)) {
    // å®‰å…¨å¤„ç†è¡¨å•æ•°æ®
    console.log(`ç”¨æˆ·: ${data.username}, é‚®ç®±: ${data.email}`)
    return { valid: true, errors: [] }
  }
  return { valid: false, errors: ['Invalid form data'] }
}
```

### äº‹ä»¶å¤„ç†

```typescript
interface MouseEvent {
  type: 'click' | 'mousemove'
  x: number
  y: number
}

interface KeyboardEvent {
  type: 'keydown' | 'keyup'
  key: string
  code: string
}

type AppEvent = MouseEvent | KeyboardEvent

function isMouseEvent(event: AppEvent): event is MouseEvent {
  return event.type === 'click' || event.type === 'mousemove'
}

function isKeyboardEvent(event: AppEvent): event is KeyboardEvent {
  return event.type === 'keydown' || event.type === 'keyup'
}

function handleEvent(event: AppEvent) {
  if (isMouseEvent(event)) {
    console.log(`é¼ æ ‡ä½ç½®: (${event.x}, ${event.y})`)
  } else if (isKeyboardEvent(event)) {
    console.log(`æŒ‰é”®: ${event.key}`)
  }
}
```

## å¸¸è§é—®é¢˜

### ğŸ™‹ typeof null è¿”å›ä»€ä¹ˆï¼Ÿ

```typescript
// typeof null è¿”å› 'object'ï¼Œè¿™æ˜¯ JavaScript çš„å†å²é—ç•™é—®é¢˜
function isObject(value: unknown): value is object {
  return typeof value === 'object' && value !== null
}

console.log(typeof null) // 'object'
console.log(isObject(null)) // false
console.log(isObject({})) // true
```

### ğŸ™‹ instanceof å¯¹åŸå§‹ç±»å‹æœ‰æ•ˆå—ï¼Ÿ

```typescript
// instanceof åªå¯¹å¯¹è±¡æœ‰æ•ˆ
const str = 'hello'
console.log(str instanceof String) // false

const strObj = new String('hello')
console.log(strObj instanceof String) // true

// ä½¿ç”¨ typeof æ£€æŸ¥åŸå§‹ç±»å‹
console.log(typeof str === 'string') // true
```

### ğŸ™‹ å¦‚ä½•ç»„åˆå¤šä¸ªç±»å‹å®ˆå«ï¼Ÿ

```typescript
function isStringOrNumber(value: unknown): value is string | number {
  return typeof value === 'string' || typeof value === 'number'
}

function isArrayOfStringsOrNumbers(
  value: unknown
): value is (string | number)[] {
  return Array.isArray(value) && value.every(isStringOrNumber)
}
```

## æ€»ç»“

| ç±»å‹å®ˆå«   | è¯­æ³•                    | é€‚ç”¨åœºæ™¯       |
| ---------- | ----------------------- | -------------- |
| typeof     | `typeof x === 'type'`   | åŸå§‹ç±»å‹æ£€æŸ¥   |
| instanceof | `x instanceof Class`    | ç±»å®ä¾‹æ£€æŸ¥     |
| in         | `'prop' in obj`         | å±æ€§å­˜åœ¨æ£€æŸ¥   |
| è‡ªå®šä¹‰å®ˆå« | `value is Type`         | å¤æ‚ç±»å‹æ£€æŸ¥   |
| æ–­è¨€å‡½æ•°   | `asserts value is Type` | éªŒè¯å¹¶æŠ›å‡ºé”™è¯¯ |

ä¸‹ä¸€ç¯‡æˆ‘ä»¬å°†æ·±å…¥å­¦ä¹ ç±»å‹æ”¶çª„ï¼Œäº†è§£ TypeScript å¦‚ä½•é€šè¿‡æ§åˆ¶æµåˆ†ææ”¶çª„ç±»å‹ã€‚
