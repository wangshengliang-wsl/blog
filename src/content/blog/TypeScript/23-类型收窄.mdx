---
title: 'ç±»å‹æ”¶çª„'
description: 'TypeScript ç±»å‹æ”¶çª„è¯¦è§£ï¼šæ§åˆ¶æµåˆ†æã€å¯è¾¨è¯†è”åˆã€never ç±»å‹ã€ç©·å°½æ€§æ£€æŸ¥'
pubDate: 2024-02-06
toc: true
ogImage: true
category: 'TypeScript'
tags: ['TypeScript', 'ç±»å‹æ”¶çª„', 'æ§åˆ¶æµåˆ†æ', 'å¯è¾¨è¯†è”åˆ', 'never']
---

ç±»å‹æ”¶çª„ï¼ˆType Narrowingï¼‰æ˜¯ TypeScript æ ¹æ®ä»£ç é€»è¾‘è‡ªåŠ¨ç¼©å°å˜é‡ç±»å‹èŒƒå›´çš„èƒ½åŠ›ã€‚ç†è§£ç±»å‹æ”¶çª„æœ‰åŠ©äºç¼–å†™æ›´å®‰å…¨çš„ä»£ç ã€‚

## æ§åˆ¶æµåˆ†æ

TypeScript é€šè¿‡åˆ†æä»£ç çš„æ§åˆ¶æµæ¥æ”¶çª„ç±»å‹ï¼š

```typescript
// TypeScript 5.x

function example(value: string | number | boolean) {
  // value: string | number | boolean

  if (typeof value === 'string') {
    // value: string
    console.log(value.toUpperCase())
    return
  }

  // value: number | booleanï¼ˆæ’é™¤äº† stringï¼‰

  if (typeof value === 'number') {
    // value: number
    console.log(value.toFixed(2))
    return
  }

  // value: booleanï¼ˆæ’é™¤äº† string å’Œ numberï¼‰
  console.log(value ? 'çœŸ' : 'å‡')
}

// èµ‹å€¼æ”¶çª„
let x: string | number

x = 'hello'
console.log(x.toUpperCase()) // x: string

x = 42
console.log(x.toFixed(2)) // x: number
```

## çœŸå€¼æ”¶çª„

é€šè¿‡çœŸå€¼æ£€æŸ¥æ”¶çª„ç±»å‹ï¼š

```typescript
function printLength(str: string | null | undefined) {
  if (str) {
    // str: stringï¼ˆæ’é™¤äº† nullã€undefinedã€ç©ºå­—ç¬¦ä¸²ï¼‰
    console.log(str.length)
  } else {
    console.log('ç©ºå€¼')
  }
}

// é…åˆé€»è¾‘è¿ç®—ç¬¦
function greet(name: string | null) {
  const displayName = name || 'æ¸¸å®¢'
  console.log(`ä½ å¥½ï¼Œ${displayName}`)
}

// ç©ºå€¼åˆå¹¶
function getConfig(config: { timeout?: number }) {
  const timeout = config.timeout ?? 3000
  console.log(`è¶…æ—¶æ—¶é—´: ${timeout}ms`)
}

// æ³¨æ„ï¼š0 å’Œç©ºå­—ç¬¦ä¸²æ˜¯å‡å€¼
function process(value: string | number | null) {
  if (value) {
    // è¿™é‡Œ value å¯èƒ½ä¸åŒ…å« 0 æˆ– ''
    console.log(value)
  }
}

// æ›´ç²¾ç¡®çš„æ£€æŸ¥
function processSafe(value: string | number | null) {
  if (value !== null) {
    // value: string | number
    console.log(value)
  }
}
```

## ç›¸ç­‰æ€§æ”¶çª„

ä½¿ç”¨ç›¸ç­‰æ€§æ£€æŸ¥æ”¶çª„ç±»å‹ï¼š

```typescript
function compare(a: string | number, b: string | boolean) {
  if (a === b) {
    // åªæœ‰ string æ˜¯ä¸¤è€…çš„å…±åŒç±»å‹
    // a: string, b: string
    console.log(a.toUpperCase())
    console.log(b.toLowerCase())
  }
}

// æ£€æŸ¥ç‰¹å®šå€¼
function handle(value: 'success' | 'error' | 'pending') {
  if (value === 'success') {
    console.log('æ“ä½œæˆåŠŸ')
  } else if (value === 'error') {
    console.log('æ“ä½œå¤±è´¥')
  } else {
    // value: 'pending'
    console.log('å¤„ç†ä¸­...')
  }
}

// æ’é™¤ null
function process(value: string | null) {
  if (value !== null) {
    // value: string
    console.log(value.length)
  }
}

// switch è¯­å¥
function getColor(status: 'success' | 'warning' | 'error'): string {
  switch (status) {
    case 'success':
      return 'green'
    case 'warning':
      return 'yellow'
    case 'error':
      return 'red'
  }
}
```

## å¯è¾¨è¯†è”åˆ

ä½¿ç”¨å…¬å…±å±æ€§ä½œä¸ºç±»å‹æ ‡è¯†ï¼š

```typescript
// å®šä¹‰å¯è¾¨è¯†è”åˆ
interface Circle {
  kind: 'circle'
  radius: number
}

interface Rectangle {
  kind: 'rectangle'
  width: number
  height: number
}

interface Triangle {
  kind: 'triangle'
  base: number
  height: number
}

type Shape = Circle | Rectangle | Triangle

// ä½¿ç”¨ kind å±æ€§åŒºåˆ†ç±»å‹
function getArea(shape: Shape): number {
  switch (shape.kind) {
    case 'circle':
      // shape: Circle
      return Math.PI * shape.radius ** 2
    case 'rectangle':
      // shape: Rectangle
      return shape.width * shape.height
    case 'triangle':
      // shape: Triangle
      return (shape.base * shape.height) / 2
  }
}

// å®é™…åº”ç”¨ï¼šRedux Action
interface AddTodoAction {
  type: 'ADD_TODO'
  payload: { text: string }
}

interface RemoveTodoAction {
  type: 'REMOVE_TODO'
  payload: { id: number }
}

interface ToggleTodoAction {
  type: 'TOGGLE_TODO'
  payload: { id: number }
}

type TodoAction = AddTodoAction | RemoveTodoAction | ToggleTodoAction

function todoReducer(state: string[], action: TodoAction): string[] {
  switch (action.type) {
    case 'ADD_TODO':
      return [...state, action.payload.text]
    case 'REMOVE_TODO':
      return state.filter((_, i) => i !== action.payload.id)
    case 'TOGGLE_TODO':
      return state // ç®€åŒ–ç¤ºä¾‹
  }
}
```

## never ç±»å‹ä¸ç©·å°½æ€§æ£€æŸ¥

ä½¿ç”¨ `never` ç¡®ä¿å¤„ç†äº†æ‰€æœ‰æƒ…å†µï¼š

```typescript
type Shape = Circle | Rectangle | Triangle

function getArea(shape: Shape): number {
  switch (shape.kind) {
    case 'circle':
      return Math.PI * shape.radius ** 2
    case 'rectangle':
      return shape.width * shape.height
    case 'triangle':
      return (shape.base * shape.height) / 2
    default:
      // å¦‚æœæ‰€æœ‰æƒ…å†µéƒ½å·²å¤„ç†ï¼Œshape ç±»å‹ä¸º never
      const _exhaustiveCheck: never = shape
      return _exhaustiveCheck
  }
}

// è¾…åŠ©å‡½æ•°
function assertNever(value: never): never {
  throw new Error(`Unexpected value: ${value}`)
}

function handleShape(shape: Shape): string {
  switch (shape.kind) {
    case 'circle':
      return `åœ†å½¢ï¼ŒåŠå¾„ ${shape.radius}`
    case 'rectangle':
      return `çŸ©å½¢ï¼Œ${shape.width} x ${shape.height}`
    case 'triangle':
      return `ä¸‰è§’å½¢ï¼Œåº• ${shape.base}ï¼Œé«˜ ${shape.height}`
    default:
      return assertNever(shape)
  }
}

// æ–°å¢ç±»å‹æ—¶ä¼šæŠ¥é”™
interface Square {
  kind: 'square'
  side: number
}

type ShapeWithSquare = Circle | Rectangle | Triangle | Square

function getAreaNew(shape: ShapeWithSquare): number {
  switch (shape.kind) {
    case 'circle':
      return Math.PI * shape.radius ** 2
    case 'rectangle':
      return shape.width * shape.height
    case 'triangle':
      return (shape.base * shape.height) / 2
    // case 'square':
    //   return shape.side ** 2;
    default:
      // âŒ é”™è¯¯ï¼šSquare ä¸èƒ½èµ‹å€¼ç»™ never
      const _exhaustiveCheck: never = shape
      return _exhaustiveCheck
  }
}
```

## èµ‹å€¼åˆ†æ

TypeScript è·Ÿè¸ªå˜é‡çš„èµ‹å€¼å†å²ï¼š

```typescript
let value: string | number

// value: string | numberï¼ˆæœªèµ‹å€¼ï¼‰

value = 'hello'
console.log(value.toUpperCase()) // value: string

value = 42
console.log(value.toFixed(2)) // value: number

// æ¡ä»¶èµ‹å€¼
function process(flag: boolean) {
  let result: string | number

  if (flag) {
    result = 'success'
  } else {
    result = 0
  }

  // result: string | number
  console.log(result)
}

// å¾ªç¯ä¸­çš„èµ‹å€¼
function findFirst(items: (string | number)[]): string | number | undefined {
  let found: string | number | undefined

  for (const item of items) {
    if (typeof item === 'string') {
      found = item
      break
    }
  }

  return found
}
```

## ç±»å‹è°“è¯æ”¶çª„

ç»“åˆç±»å‹å®ˆå«è¿›è¡Œæ”¶çª„ï¼š

```typescript
interface Fish {
  swim: () => void
}

interface Bird {
  fly: () => void
}

function isFish(pet: Fish | Bird): pet is Fish {
  return 'swim' in pet
}

function move(pet: Fish | Bird) {
  if (isFish(pet)) {
    pet.swim() // pet: Fish
  } else {
    pet.fly() // pet: Bird
  }
}

// æ•°ç»„è¿‡æ»¤
const pets: (Fish | Bird)[] = [
  { swim: () => console.log('æ¸¸æ³³') },
  { fly: () => console.log('é£ç¿”') },
  { swim: () => console.log('æ½œæ°´') },
]

const fishes = pets.filter(isFish)
// fishes: Fish[]

fishes.forEach((fish) => fish.swim())
```

## æ–­è¨€æ”¶çª„

ä½¿ç”¨æ–­è¨€å‡½æ•°æ”¶çª„ç±»å‹ï¼š

```typescript
function assertIsString(value: unknown): asserts value is string {
  if (typeof value !== 'string') {
    throw new TypeError('Expected string')
  }
}

function process(value: unknown) {
  assertIsString(value)
  // value: string
  console.log(value.toUpperCase())
}

// éç©ºæ–­è¨€
function assertDefined<T>(
  value: T | null | undefined,
  message?: string
): asserts value is T {
  if (value === null || value === undefined) {
    throw new Error(message ?? 'Value is null or undefined')
  }
}

function getFirstChar(str: string | null): string {
  assertDefined(str, 'String cannot be null')
  return str.charAt(0)
}
```

## å®é™…åº”ç”¨

### è§£æé…ç½®

```typescript
interface BaseConfig {
  type: string
}

interface DatabaseConfig extends BaseConfig {
  type: 'database'
  host: string
  port: number
  username: string
  password: string
}

interface CacheConfig extends BaseConfig {
  type: 'cache'
  host: string
  ttl: number
}

interface FileConfig extends BaseConfig {
  type: 'file'
  path: string
  encoding: string
}

type Config = DatabaseConfig | CacheConfig | FileConfig

function initializeService(config: Config): void {
  switch (config.type) {
    case 'database':
      console.log(`è¿æ¥æ•°æ®åº“: ${config.host}:${config.port}`)
      console.log(`ç”¨æˆ·: ${config.username}`)
      break
    case 'cache':
      console.log(`è¿æ¥ç¼“å­˜: ${config.host}`)
      console.log(`TTL: ${config.ttl}ms`)
      break
    case 'file':
      console.log(`è¯»å–æ–‡ä»¶: ${config.path}`)
      console.log(`ç¼–ç : ${config.encoding}`)
      break
  }
}
```

### çŠ¶æ€æœº

```typescript
type State =
  | { status: 'idle' }
  | { status: 'loading' }
  | { status: 'success'; data: string }
  | { status: 'error'; error: Error }

function renderState(state: State): string {
  switch (state.status) {
    case 'idle':
      return 'ç­‰å¾…æ“ä½œ...'
    case 'loading':
      return 'åŠ è½½ä¸­...'
    case 'success':
      return `æ•°æ®: ${state.data}`
    case 'error':
      return `é”™è¯¯: ${state.error.message}`
  }
}

// çŠ¶æ€è½¬æ¢
function transition(state: State, action: 'start' | 'succeed' | 'fail'): State {
  switch (state.status) {
    case 'idle':
      if (action === 'start') {
        return { status: 'loading' }
      }
      return state
    case 'loading':
      if (action === 'succeed') {
        return { status: 'success', data: 'è·å–çš„æ•°æ®' }
      }
      if (action === 'fail') {
        return { status: 'error', error: new Error('è¯·æ±‚å¤±è´¥') }
      }
      return state
    default:
      return state
  }
}
```

### API å“åº”å¤„ç†

```typescript
type ApiResult<T> =
  | { ok: true; data: T }
  | { ok: false; error: { code: number; message: string } }

async function fetchData<T>(url: string): Promise<ApiResult<T>> {
  try {
    const response = await fetch(url)
    const data = await response.json()
    return { ok: true, data }
  } catch (e) {
    return {
      ok: false,
      error: {
        code: 500,
        message: e instanceof Error ? e.message : 'Unknown error',
      },
    }
  }
}

async function getUser(id: string) {
  const result = await fetchData<{ name: string }>(`/api/users/${id}`)

  if (result.ok) {
    // result.data: { name: string }
    console.log(`ç”¨æˆ·å: ${result.data.name}`)
  } else {
    // result.error: { code: number; message: string }
    console.log(`é”™è¯¯ ${result.error.code}: ${result.error.message}`)
  }
}
```

## å¸¸è§é—®é¢˜

### ğŸ™‹ ä¸ºä»€ä¹ˆæœ‰æ—¶ç±»å‹æ²¡æœ‰è¢«æ­£ç¡®æ”¶çª„ï¼Ÿ

```typescript
// å›è°ƒå‡½æ•°ä¸­çš„æ”¶çª„é—®é¢˜
function example(value: string | null) {
  if (value !== null) {
    // value: string

    setTimeout(() => {
      // value: string | nullï¼ˆå›è°ƒä¸­ç±»å‹è¢«é‡ç½®ï¼‰
      // å› ä¸º TypeScript ä¸çŸ¥é“å›è°ƒæ‰§è¡Œæ—¶ value æ˜¯å¦å˜åŒ–
    }, 100)
  }
}

// è§£å†³æ–¹æ¡ˆï¼šä¿å­˜åˆ°å±€éƒ¨å˜é‡
function exampleFixed(value: string | null) {
  if (value !== null) {
    const safeValue = value // safeValue: string

    setTimeout(() => {
      console.log(safeValue.toUpperCase()) // å®‰å…¨
    }, 100)
  }
}
```

### ğŸ™‹ å¦‚ä½•æ”¶çª„å¯¹è±¡çš„å±æ€§ï¼Ÿ

```typescript
interface User {
  name: string
  email: string | null
}

function sendEmail(user: User) {
  // ç›´æ¥æ£€æŸ¥
  if (user.email !== null) {
    // user.email: string
    console.log(`å‘é€é‚®ä»¶åˆ°: ${user.email}`)
  }

  // è§£æ„åæ£€æŸ¥
  const { email } = user
  if (email !== null) {
    console.log(`å‘é€é‚®ä»¶åˆ°: ${email}`)
  }
}
```

## æ€»ç»“

| æ”¶çª„æ–¹å¼   | è¯´æ˜         | ç¤ºä¾‹                    |
| ---------- | ------------ | ----------------------- |
| typeof     | æ£€æŸ¥åŸå§‹ç±»å‹ | `typeof x === 'string'` |
| instanceof | æ£€æŸ¥ç±»å®ä¾‹   | `x instanceof Date`     |
| in         | æ£€æŸ¥å±æ€§å­˜åœ¨ | `'name' in obj`         |
| ç›¸ç­‰æ€§     | æ£€æŸ¥å…·ä½“å€¼   | `x === 'value'`         |
| çœŸå€¼       | æ’é™¤å‡å€¼     | `if (x) { }`            |
| å¯è¾¨è¯†è”åˆ | å…¬å…±æ ‡è¯†å±æ€§ | `switch (x.kind)`       |
| ç±»å‹è°“è¯   | è‡ªå®šä¹‰å®ˆå«   | `x is Type`             |
| æ–­è¨€å‡½æ•°   | æ–­è¨€æˆ–æŠ›é”™   | `asserts x is Type`     |

ä¸‹ä¸€ç¯‡æˆ‘ä»¬å°†å­¦ä¹ ç´¢å¼•ç±»å‹ä¸ç´¢å¼•ç­¾åã€‚
