---
title: Astro å†…å®¹é›†åˆ
description: æ·±å…¥ç†è§£ Astro 5 çš„ Content Layer APIï¼Œå­¦ä¹  Schema å®šä¹‰ã€é›†åˆæŸ¥è¯¢å’Œå†…å®¹æ¸²æŸ“
pubDate: 2025-12-02
toc: true
ogImage: true
category: Astro
tags: ['Astro', 'Content Collections', 'MDX', 'Zod']
---

## å†…å®¹é›†åˆæ¦‚è¿°

ğŸ™‹ å¦‚æœä½ æ›¾ç»ç”¨çº¯ Markdown æ–‡ä»¶ç®¡ç†åšå®¢ï¼Œä¸€å®šé‡åˆ°è¿‡è¿™äº›é—®é¢˜ï¼š

- Frontmatter å­—æ®µå†™é”™äº†ï¼Œæ„å»ºæ—¶æ‰å‘ç°
- ä¸åŒæ–‡ç« çš„ Frontmatter æ ¼å¼ä¸ä¸€è‡´
- æ²¡æœ‰ TypeScript ç±»å‹æç¤ºï¼Œå†™ä»£ç é çŒœ

Astro çš„å†…å®¹é›†åˆï¼ˆContent Collectionsï¼‰å°±æ˜¯ä¸ºè§£å†³è¿™äº›é—®é¢˜è€Œè®¾è®¡çš„ã€‚

### ä»€ä¹ˆæ˜¯å†…å®¹é›†åˆï¼Ÿ

å†…å®¹é›†åˆæ˜¯ä¸€ç§**ç±»å‹å®‰å…¨çš„å†…å®¹ç®¡ç†æ–¹å¼**ã€‚ä½ å¯ä»¥ï¼š

- ğŸ“ ç”¨ Zod Schema å®šä¹‰ Frontmatter ç»“æ„
- âœ… æ„å»ºæ—¶è‡ªåŠ¨éªŒè¯æ‰€æœ‰å†…å®¹æ–‡ä»¶
- ğŸ¯ è·å¾—å®Œæ•´çš„ TypeScript ç±»å‹æç¤º
- ğŸ” ç”¨ç»Ÿä¸€çš„ API æŸ¥è¯¢å’Œæ¸²æŸ“å†…å®¹

```typescript
// å®šä¹‰ä¸€ä¸ªåšå®¢é›†åˆ
const blog = defineCollection({
  loader: glob({ base: './src/content/blog', pattern: '**/*.mdx' }),
  schema: z.object({
    title: z.string().max(60),
    pubDate: z.coerce.date(),
    tags: z.array(z.string()).default([]),
  }),
})
```

### Astro 5 Content Layer API vs æ—§ç‰ˆ API

Astro 5 å¼•å…¥äº†å…¨æ–°çš„ **Content Layer API**ï¼Œç›¸æ¯”æ—§ç‰ˆæœ‰é‡å¤§æ”¹è¿›ï¼š

| ç‰¹æ€§     | æ—§ç‰ˆ (v4.x)             | Content Layer API (v5)  |
| -------- | ----------------------- | ----------------------- |
| é…ç½®æ–‡ä»¶ | `src/content/config.ts` | `src/content.config.ts` |
| æ•°æ®æº   | ä»…æœ¬åœ°æ–‡ä»¶              | æœ¬åœ° + è¿œç¨‹ï¼ˆCMSã€APIï¼‰ |
| æ€§èƒ½     | æ¯æ¬¡æ„å»ºå…¨é‡å¤„ç†        | å¢é‡æ„å»ºï¼Œç¼“å­˜ä¼˜åŒ–      |
| Loader   | å†…ç½®å›ºå®š                | å¯è‡ªå®šä¹‰                |
| render() | æ¡ç›®æ–¹æ³•                | ç‹¬ç«‹å‡½æ•°                |

ğŸ”¶ **è¿ç§»æ³¨æ„**: å¦‚æœä½ ä» Astro 4.x å‡çº§ï¼Œéœ€è¦è°ƒæ•´é…ç½®æ–‡ä»¶ä½ç½®å’Œ render æ–¹å¼ã€‚

### é›†åˆ vs æ™®é€š Markdown æ–‡ä»¶

ä¸ä½¿ç”¨é›†åˆæ—¶ï¼š

```astro
---
// âŒ æ‰‹åŠ¨å¯¼å…¥ï¼Œæ²¡æœ‰ç±»å‹æ£€æŸ¥
import posts from '../posts/*.md'

// æ— æ³•ä¿è¯æ¯ç¯‡æ–‡ç« éƒ½æœ‰è¿™äº›å­—æ®µ
posts.forEach((post) => {
  console.log(post.frontmatter.title) // å¯èƒ½æ˜¯ undefined
})
---
```

ä½¿ç”¨é›†åˆåï¼š

```astro
---
// âœ… ç±»å‹å®‰å…¨çš„æŸ¥è¯¢
import { getCollection } from 'astro:content'

const posts = await getCollection('blog')

posts.forEach((post) => {
  console.log(post.data.title) // TypeScript çŸ¥é“è¿™æ˜¯ string
})
---
```

## å®šä¹‰é›†åˆ

### src/content.config.ts é…ç½®æ–‡ä»¶

è¿™æ˜¯ Astro 5 å†…å®¹é›†åˆçš„é…ç½®å…¥å£ï¼š

```typescript
// src/content.config.ts
import { defineCollection, z } from 'astro:content'
import { glob, file } from 'astro/loaders'

// å®šä¹‰åšå®¢é›†åˆ
const blog = defineCollection({
  loader: glob({ base: './src/content/blog', pattern: '**/*.mdx' }),
  schema: z.object({
    title: z.string(),
    pubDate: z.coerce.date(),
    draft: z.boolean().default(false),
  }),
})

// å®šä¹‰é¡¹ç›®é›†åˆï¼ˆJSON æ•°æ®ï¼‰
const projects = defineCollection({
  loader: file('./src/content/projects/data.json'),
  schema: z.object({
    id: z.string(),
    name: z.string(),
    link: z.string().url(),
  }),
})

// å¯¼å‡ºæ‰€æœ‰é›†åˆ
export const collections = { blog, projects }
```

ğŸ¯ å…³é”®ç‚¹ï¼š

- æ–‡ä»¶å¿…é¡»å‘½åä¸º `content.config.ts`ï¼ˆæ³¨æ„ä¸æ˜¯ `config.ts`ï¼‰
- å¿…é¡»å¯¼å‡º `collections` å¯¹è±¡
- æ¯ä¸ªé›†åˆéœ€è¦ `loader` å’Œ `schema`

### defineCollection() å‡½æ•°

`defineCollection()` æ¥å—ä¸€ä¸ªé…ç½®å¯¹è±¡ï¼š

```typescript
const myCollection = defineCollection({
  // æ•°æ®åŠ è½½å™¨ï¼ˆå¿…éœ€ï¼‰
  loader: glob({ base: './src/content/my-collection', pattern: '**/*.md' }),

  // Schema å®šä¹‰ï¼ˆæ¨èï¼‰
  schema: z.object({
    title: z.string(),
    // ...
  }),
})
```

### Zod Schema éªŒè¯

Astro ä½¿ç”¨ [Zod](https://zod.dev/) è¿›è¡Œ Schema éªŒè¯ã€‚Zod æ˜¯ä¸€ä¸ª TypeScript-first çš„éªŒè¯åº“ã€‚

**åŸºæœ¬ç±»å‹**ï¼š

```typescript
z.string() // å­—ç¬¦ä¸²
z.number() // æ•°å­—
z.boolean() // å¸ƒå°”å€¼
z.date() // Date å¯¹è±¡
z.array(z.string()) // å­—ç¬¦ä¸²æ•°ç»„
```

**å¸¸ç”¨ä¿®é¥°ç¬¦**ï¼š

```typescript
z.string().optional() // å¯é€‰
z.string().default('é»˜è®¤å€¼') // é»˜è®¤å€¼
z.string().max(60) // æœ€å¤§é•¿åº¦
z.number().min(0).max(100) // èŒƒå›´é™åˆ¶
z.coerce.date() // è‡ªåŠ¨è½¬æ¢ä¸º Date
```

**å®Œæ•´ç¤ºä¾‹**ï¼š

```typescript
const postSchema = z.object({
  // å¿…éœ€å­—æ®µ
  title: z.string().max(60),
  pubDate: z.coerce.date(),

  // å¯é€‰å­—æ®µï¼ˆå¸¦é»˜è®¤å€¼ï¼‰
  description: z.string().default(''),
  draft: z.boolean().default(false),
  tags: z.array(z.string()).default([]),

  // å¯é€‰å­—æ®µï¼ˆå¯èƒ½ä¸å­˜åœ¨ï¼‰
  coverImage: z.string().optional(),

  // è”åˆç±»å‹
  category: z.enum(['tech', 'life', 'other']),

  // è‡ªå®šä¹‰éªŒè¯
  readingTime: z.number().min(1).optional(),
})
```

### å†…ç½® Loaderï¼šglob / file

**glob loader** - åŒ¹é…å¤šä¸ªæ–‡ä»¶ï¼š

```typescript
import { glob } from 'astro/loaders'

// åŒ¹é…æ‰€æœ‰ .md å’Œ .mdx æ–‡ä»¶
const blog = defineCollection({
  loader: glob({
    base: './src/content/blog',
    pattern: '**/*.{md,mdx}',
  }),
  schema: postSchema,
})

// æ’é™¤æŸäº›æ–‡ä»¶
const docs = defineCollection({
  loader: glob({
    base: './src/content/docs',
    pattern: '**/[^_]*.md', // æ’é™¤ä»¥ _ å¼€å¤´çš„æ–‡ä»¶
  }),
  schema: docSchema,
})
```

**file loader** - åŠ è½½å•ä¸ªæ•°æ®æ–‡ä»¶ï¼š

```typescript
import { file } from 'astro/loaders'

// JSON æ–‡ä»¶
const projects = defineCollection({
  loader: file('./src/content/projects/data.json'),
  schema: projectSchema,
})

// YAML æ–‡ä»¶
const config = defineCollection({
  loader: file('./src/content/config.yaml'),
  schema: configSchema,
})
```

JSON æ•°æ®æ ¼å¼ï¼š

```json
// src/content/projects/data.json
[
  {
    "id": "project-1",
    "name": "æˆ‘çš„é¡¹ç›®",
    "link": "https://example.com"
  },
  {
    "id": "project-2",
    "name": "å¦ä¸€ä¸ªé¡¹ç›®",
    "link": "https://example.org"
  }
]
```

## Schema è®¾è®¡

### å¿…éœ€ä¸å¯é€‰å­—æ®µ

```typescript
const schema = z.object({
  // å¿…éœ€ï¼šä¸æä¾›ä¼šæŠ¥é”™
  title: z.string(),

  // å¯é€‰ï¼šå¯ä»¥ä¸æä¾›ï¼ˆå€¼ä¸º undefinedï¼‰
  subtitle: z.string().optional(),

  // å¯é€‰ä½†æœ‰é»˜è®¤å€¼ï¼šä¸æä¾›æ—¶ä½¿ç”¨é»˜è®¤å€¼
  draft: z.boolean().default(false),
  tags: z.array(z.string()).default([]),
})
```

ğŸ”¶ **æœ€ä½³å®è·µ**: å¿…éœ€å­—æ®µå°½é‡ç²¾ç®€ï¼Œå…¶ä»–ç”¨ `default()` æä¾›é»˜è®¤å€¼ã€‚

### å­—æ®µç±»å‹

**å­—ç¬¦ä¸²ç±»å‹**ï¼š

```typescript
z.string() // ä»»æ„å­—ç¬¦ä¸²
z.string().min(1) // éç©ºå­—ç¬¦ä¸²
z.string().max(60) // é™åˆ¶é•¿åº¦
z.string().url() // URL æ ¼å¼
z.string().email() // é‚®ç®±æ ¼å¼
z.string().regex(/^[a-z]+$/) // æ­£åˆ™åŒ¹é…
z.enum(['a', 'b', 'c']) // æšä¸¾å€¼
```

**æ•°å­—ç±»å‹**ï¼š

```typescript
z.number() // ä»»æ„æ•°å­—
z.number().int() // æ•´æ•°
z.number().positive() // æ­£æ•°
z.number().min(0).max(100) // èŒƒå›´
```

**æ—¥æœŸç±»å‹**ï¼š

```typescript
// æ¨èä½¿ç”¨ coerceï¼Œè‡ªåŠ¨å°†å­—ç¬¦ä¸²è½¬ä¸º Date
z.coerce.date()

// Frontmatter ä¸­å¯ä»¥è¿™æ ·å†™ï¼š
// pubDate: 2025-12-02
// pubDate: "2025-12-02"
// pubDate: "December 2, 2025"
```

**æ•°ç»„ç±»å‹**ï¼š

```typescript
z.array(z.string()) // å­—ç¬¦ä¸²æ•°ç»„
z.array(z.string()).min(1) // è‡³å°‘ä¸€ä¸ªå…ƒç´ 
z.array(z.string()).max(5) // æœ€å¤šäº”ä¸ªå…ƒç´ 
```

**å¯¹è±¡ç±»å‹**ï¼š

```typescript
z.object({
  name: z.string(),
  url: z.string().url(),
})
```

**è”åˆç±»å‹**ï¼š

```typescript
// å­—ç¬¦ä¸²æˆ–å¸ƒå°”å€¼
z.union([z.string(), z.boolean()])

// ç®€å†™ï¼ˆä¸¤ç§ç±»å‹ï¼‰
z.string().or(z.boolean())
```

### è‡ªå®šä¹‰éªŒè¯é€»è¾‘

ä½¿ç”¨ `.refine()` æ·»åŠ è‡ªå®šä¹‰éªŒè¯ï¼š

```typescript
const schema = z
  .object({
    title: z.string(),
    pubDate: z.coerce.date(),
    lastModDate: z.coerce.date().optional(),
  })
  .refine(
    (data) => {
      // å¦‚æœæœ‰ lastModDateï¼Œå¿…é¡»æ™šäº pubDate
      if (data.lastModDate) {
        return data.lastModDate >= data.pubDate
      }
      return true
    },
    {
      message: 'æœ€åä¿®æ”¹æ—¥æœŸå¿…é¡»æ™šäºå‘å¸ƒæ—¥æœŸ',
    }
  )
```

### reference() é›†åˆå¼•ç”¨

å†…å®¹é›†åˆä¹‹é—´å¯ä»¥ç›¸äº’å¼•ç”¨ï¼š

```typescript
// src/content.config.ts
import { defineCollection, z, reference } from 'astro:content'

const authors = defineCollection({
  loader: file('./src/content/authors/data.json'),
  schema: z.object({
    id: z.string(),
    name: z.string(),
    avatar: z.string().url(),
  }),
})

const blog = defineCollection({
  loader: glob({ base: './src/content/blog', pattern: '**/*.mdx' }),
  schema: z.object({
    title: z.string(),
    // å¼•ç”¨ authors é›†åˆ
    author: reference('authors'),
    // å¼•ç”¨å¤šç¯‡ç›¸å…³æ–‡ç« 
    relatedPosts: z.array(reference('blog')).default([]),
  }),
})
```

åœ¨ Frontmatter ä¸­ä½¿ç”¨ï¼š

```yaml
---
title: 'æˆ‘çš„æ–‡ç« '
author: john-doe # å¯¹åº” authors é›†åˆä¸­çš„ id
relatedPosts:
  - another-post-id
  - yet-another-post
---
```

æŸ¥è¯¢æ—¶è§£æå¼•ç”¨ï¼š

```astro
---
import { getEntry, getEntries } from 'astro:content'

const post = await getEntry('blog', 'my-post')

// è§£æå•ä¸ªå¼•ç”¨
const author = await getEntry(post.data.author)

// è§£æå¤šä¸ªå¼•ç”¨
const relatedPosts = await getEntries(post.data.relatedPosts)
---

<p>ä½œè€…: {author.data.name}</p>
```

## æŸ¥è¯¢é›†åˆ

### getCollection() è·å–æ‰€æœ‰æ¡ç›®

```astro
---
import { getCollection } from 'astro:content'

// è·å–æ‰€æœ‰åšå®¢æ–‡ç« 
const allPosts = await getCollection('blog')

// å¸¦è¿‡æ»¤å™¨
const publishedPosts = await getCollection('blog', ({ data }) => {
  return data.draft !== true
})

// å¤æ‚è¿‡æ»¤
const recentTechPosts = await getCollection('blog', ({ data }) => {
  const oneMonthAgo = new Date()
  oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1)

  return (
    data.draft !== true &&
    data.category === 'tech' &&
    data.pubDate > oneMonthAgo
  )
})
---
```

### getEntry() è·å–å•ä¸ªæ¡ç›®

```astro
---
import { getEntry } from 'astro:content'

// é€šè¿‡é›†åˆåå’Œ ID è·å–
const post = await getEntry('blog', 'hello-world')

if (post) {
  console.log(post.data.title)
}

// ä¹Ÿå¯ä»¥ä¼ å…¥å¼•ç”¨å¯¹è±¡
const authorRef = post.data.author
const author = await getEntry(authorRef)
---
```

### getEntries() æ‰¹é‡è·å–

```astro
---
import { getEntries } from 'astro:content'

// æ‰¹é‡è·å–å¤šä¸ªæ¡ç›®
const featuredPosts = await getEntries([
  { collection: 'blog', id: 'post-1' },
  { collection: 'blog', id: 'post-2' },
  { collection: 'blog', id: 'post-3' },
])

// è§£æå¼•ç”¨æ•°ç»„
const relatedPosts = await getEntries(post.data.relatedPosts)
---
```

### è¿‡æ»¤ä¸æ’åº

```astro
---
import { getCollection } from 'astro:content'

// è·å–æ‰€æœ‰æ–‡ç« 
const posts = await getCollection('blog')

// æŒ‰å‘å¸ƒæ—¥æœŸæ’åºï¼ˆæœ€æ–°åœ¨å‰ï¼‰
const sortedPosts = posts.sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
)

// è¿‡æ»¤è‰ç¨¿ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
const publishedPosts = import.meta.env.PROD
  ? posts.filter((post) => !post.data.draft)
  : posts

// æŒ‰åˆ†ç±»åˆ†ç»„
const postsByCategory = posts.reduce(
  (acc, post) => {
    const category = post.data.category
    if (!acc[category]) acc[category] = []
    acc[category].push(post)
    return acc
  },
  {} as Record<string, typeof posts>
)

// è·å–æ‰€æœ‰æ ‡ç­¾
const allTags = [...new Set(posts.flatMap((post) => post.data.tags))]
---
```

### CollectionEntry ç±»å‹

æ¯ä¸ªé›†åˆæ¡ç›®çš„ç±»å‹ç»“æ„ï¼š

```typescript
import type { CollectionEntry } from 'astro:content'

type BlogPost = CollectionEntry<'blog'>

// BlogPost åŒ…å«ï¼š
// - id: string (æ–‡ä»¶è·¯å¾„/å”¯ä¸€æ ‡è¯†)
// - collection: 'blog'
// - data: { title: string, pubDate: Date, ... }  (Schema å®šä¹‰çš„å­—æ®µ)
// - body: string (åŸå§‹å†…å®¹)
```

åœ¨ç»„ä»¶ä¸­ä½¿ç”¨ç±»å‹ï¼š

```astro
---
import type { CollectionEntry } from 'astro:content'

interface Props {
  post: CollectionEntry<'blog'>
}

const { post } = Astro.props
---

<article>
  <h1>{post.data.title}</h1>
  <time>{post.data.pubDate.toLocaleDateString()}</time>
</article>
```

## æ¸²æŸ“å†…å®¹

### render() å‡½æ•°ï¼ˆAstro 5 æ–°æ–¹å¼ï¼‰

Astro 5 ä¸­ï¼Œ`render()` æ˜¯ä¸€ä¸ªç‹¬ç«‹å‡½æ•°ï¼Œè€Œä¸æ˜¯æ¡ç›®çš„æ–¹æ³•ï¼š

```astro
---
import { getEntry, render } from 'astro:content'

const post = await getEntry('blog', 'hello-world')
const { Content, headings } = await render(post)
---

<article>
  <h1>{post.data.title}</h1>
  <Content />
</article>
```

ğŸ”¶ **ä¸æ—§ç‰ˆçš„åŒºåˆ«**ï¼š

```typescript
// Astro 4.x (æ—§ç‰ˆ)
const { Content } = await post.render()

// Astro 5.x (æ–°ç‰ˆ)
import { render } from 'astro:content'
const { Content } = await render(post)
```

### `<Content />` ç»„ä»¶

`Content` æ˜¯ä¸€ä¸ª Astro ç»„ä»¶ï¼Œæ¸²æŸ“ Markdown/MDX å†…å®¹ï¼š

```astro
---
import { getEntry, render } from 'astro:content'

const post = await getEntry('blog', 'my-post')
const { Content } = await render(post)
---

<article class="prose">
  <Content />
</article>
```

### è·å– headings ç”Ÿæˆç›®å½•

`render()` è¿”å›çš„ `headings` åŒ…å«æ‰€æœ‰æ ‡é¢˜ä¿¡æ¯ï¼š

```astro
---
const { Content, headings } = await render(post)

// headings ç»“æ„:
// [
//   { depth: 2, slug: 'introduction', text: 'ä»‹ç»' },
//   { depth: 3, slug: 'getting-started', text: 'å¿«é€Ÿå¼€å§‹' },
//   { depth: 2, slug: 'examples', text: 'ç¤ºä¾‹' },
// ]
---

<nav class="toc">
  <h2>ç›®å½•</h2>
  <ul>
    {
      headings
        .filter((h) => h.depth <= 3) // åªæ˜¾ç¤º h2 å’Œ h3
        .map((h) => (
          <li style={`margin-left: ${(h.depth - 2) * 1}rem`}>
            <a href={`#${h.slug}`}>{h.text}</a>
          </li>
        ))
    }
  </ul>
</nav>

<article>
  <Content />
</article>
```

### è‡ªå®šä¹‰ç»„ä»¶ä¼ é€’

å¯ä»¥è¦†ç›– Markdown æ¸²æŸ“çš„é»˜è®¤ç»„ä»¶ï¼š

```astro
---
const { Content } = await render(post)
import CustomImage from '~/components/CustomImage.astro'
import CustomLink from '~/components/CustomLink.astro'
---

<Content
  components={{
    img: CustomImage,
    a: CustomLink,
    // è¦†ç›–æ›´å¤šå…ƒç´ ...
    h1: (props) => <h1 class="custom-h1" {...props} />,
  }}
/>
```

è‡ªå®šä¹‰å›¾ç‰‡ç»„ä»¶ç¤ºä¾‹ï¼š

```astro
---
// src/components/CustomImage.astro
interface Props {
  src: string
  alt: string
}
const { src, alt } = Astro.props
---

<figure class="image-wrapper">
  <img src={src} alt={alt} loading="lazy" />
  {alt && <figcaption>{alt}</figcaption>}
</figure>
```

## å®æˆ˜ï¼šå½“å‰åšå®¢çš„å†…å®¹æ¶æ„

è®©æˆ‘ä»¬æ·±å…¥åˆ†æå½“å‰åšå®¢é¡¹ç›®çš„å†…å®¹é›†åˆå®ç°ã€‚

### åˆ†æ src/content.config.ts

```typescript
// src/content.config.ts
import { glob, file } from 'astro/loaders'
import { defineCollection } from 'astro:content'

import {
  pageSchema,
  postSchema,
  projectSchema,
  streamSchema,
  photoSchema,
} from '~/content/schema'

// é¡µé¢é›†åˆï¼ˆMDX é¡µé¢çš„ Frontmatterï¼‰
const pages = defineCollection({
  loader: glob({ base: './src/pages', pattern: '**/*.mdx' }),
  schema: pageSchema,
})

// åšå®¢æ–‡ç« é›†åˆ
const blog = defineCollection({
  loader: glob({ base: './src/content/blog', pattern: '**/[^_]*.{md,mdx}' }),
  schema: postSchema,
})

// é¡¹ç›®æ•°æ®é›†åˆ
const projects = defineCollection({
  loader: file('./src/content/projects/data.json'),
  schema: projectSchema,
})

// ç…§ç‰‡é›†åˆ
const photos = defineCollection({
  loader: file('src/content/photos/data.json'),
  schema: photoSchema,
})

// æ›´æ–°æ—¥å¿—é›†åˆ
const changelog = defineCollection({
  loader: glob({
    base: './src/content/changelog',
    pattern: '**/[^_]*.{md,mdx}',
  }),
  schema: postSchema,
})

// å¤–éƒ¨é“¾æ¥æµé›†åˆ
const streams = defineCollection({
  loader: file('./src/content/streams/data.json'),
  schema: streamSchema,
})

export const collections = {
  pages,
  blog,
  projects,
  photos,
  changelog,
  streams,
}
```

ğŸ¯ è®¾è®¡è¦ç‚¹ï¼š

1. **å¤šç§å†…å®¹ç±»å‹**: blogã€changelog ç”¨ Markdownï¼Œprojectsã€streams ç”¨ JSON
2. **æ’é™¤ä¸‹åˆ’çº¿æ–‡ä»¶**: `**/[^_]*.{md,mdx}` æ’é™¤ä»¥ `_` å¼€å¤´çš„è‰ç¨¿
3. **å¤ç”¨ Schema**: blog å’Œ changelog å…±ç”¨ `postSchema`

### postSchema å­—æ®µè¯¦è§£

```typescript
// src/content/schema.ts
import { z } from 'astro:content'

export const postSchema = z.object({
  // å¿…éœ€å­—æ®µ
  title: z.string().max(60),
  pubDate: z.coerce.date(),

  // åˆ†ç±»ï¼ˆé»˜è®¤"æ‚è°ˆ"ï¼‰
  category: z.string().default('æ‚è°ˆ'),

  // å¯é€‰å…ƒæ•°æ®
  description: z.string().default(''),
  subtitle: z.string().default(''),
  lastModDate: z.union([z.coerce.date(), z.literal('')]).optional(),
  tags: z.array(z.string()).default([]),

  // å†…å®¹ç±»å‹æ ‡è®°
  radio: z.boolean().default(false),
  video: z.boolean().default(false),
  platform: z.string().default(''),

  // æ˜¾ç¤ºæ§åˆ¶
  toc: z.boolean().default(true),
  draft: z.boolean().default(false),
  ogImage: z.union([z.string(), z.boolean()]).default(true),

  // åŠŸèƒ½å¼€å…³
  share: z.boolean().default(true),
  giscus: z.boolean().default(true),
  search: z.boolean().default(true),

  // é‡å®šå‘
  redirect: z.string().url().optional(),

  // é˜…è¯»æ—¶é—´
  minutesRead: z.number().optional(),
})
```

### æ–‡ç« æŸ¥è¯¢ä¸æ¸²æŸ“æµç¨‹

**æŸ¥è¯¢æ–‡ç« ** (`src/utils/data.ts`):

```typescript
import { getCollection } from 'astro:content'
import type { CollectionEntry } from 'astro:content'

export async function getFilteredPosts(
  collection: 'blog' | 'changelog'
): Promise<CollectionEntry<typeof collection>[]> {
  const posts = await getCollection(collection)

  // ç”Ÿäº§ç¯å¢ƒè¿‡æ»¤è‰ç¨¿
  const filtered = import.meta.env.PROD
    ? posts.filter((post) => !post.data.draft)
    : posts

  // æŒ‰æ—¥æœŸæ’åº
  return filtered.sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
  )
}

// æŒ‰åˆ†ç±»è·å–
export async function getPostsByCategory(category: string) {
  const posts = await getFilteredPosts('blog')
  return posts.filter((post) => post.data.category === category)
}

// è·å–æ‰€æœ‰åˆ†ç±»
export async function getAllCategories() {
  const posts = await getFilteredPosts('blog')
  return [...new Set(posts.map((post) => post.data.category))]
}
```

**æ¸²æŸ“æ–‡ç« ** (`src/components/views/RenderPost.astro`):

```astro
---
import { render } from 'astro:content'
import type { CollectionEntry } from 'astro:content'

import BaseLayout from '~/layouts/BaseLayout.astro'
import PostMeta from '~/components/PostMeta.astro'
import TableOfContents from '~/components/TableOfContents.astro'
import Giscus from '~/components/Giscus.astro'

interface Props {
  post: CollectionEntry<'blog'>
  isCommentable?: boolean
}

const { post, isCommentable = false } = Astro.props
const { Content, headings } = await render(post)
const { title, description, pubDate, toc, giscus } = post.data
---

<BaseLayout title={title} description={description}>
  <article class="prose mx-auto">
    <h1>{title}</h1>
    <PostMeta date={pubDate} />

    {toc && headings.length > 0 && <TableOfContents {headings} />}

    <Content />
  </article>

  {isCommentable && giscus && <Giscus slot="giscus" />}
</BaseLayout>
```

### å†…å®¹æ–‡ä»¶ç»„ç»‡

```
src/content/
â”œâ”€â”€ blog/                    # åšå®¢æ–‡ç« 
â”‚   â”œâ”€â”€ Astro/              # åˆ†ç±»æ–‡ä»¶å¤¹
â”‚   â”‚   â”œâ”€â”€ 1-å…¥é—¨æŒ‡å—.mdx
â”‚   â”‚   â””â”€â”€ 2-è·¯ç”±ä¸é¡µé¢.mdx
â”‚   â”œâ”€â”€ TypeScript/
â”‚   â”‚   â””â”€â”€ æ³›å‹è¯¦è§£.mdx
â”‚   â””â”€â”€ _drafts/            # è‰ç¨¿ï¼ˆè¢«æ’é™¤ï¼‰
â”‚       â””â”€â”€ work-in-progress.mdx
â”œâ”€â”€ changelog/               # æ›´æ–°æ—¥å¿—
â”‚   â””â”€â”€ 2025-01.mdx
â”œâ”€â”€ projects/                # é¡¹ç›®æ•°æ®
â”‚   â””â”€â”€ data.json
â”œâ”€â”€ photos/                  # ç…§ç‰‡æ•°æ®
â”‚   â””â”€â”€ data.json
â”œâ”€â”€ streams/                 # å¤–éƒ¨é“¾æ¥
â”‚   â””â”€â”€ data.json
â””â”€â”€ schema.ts               # Schema å®šä¹‰
```

## å†…å®¹é›†åˆæœ€ä½³å®è·µ

### Schema è®¾è®¡åŸåˆ™

```typescript
// âœ… å¥½çš„ Schema è®¾è®¡
const schema = z.object({
  // 1. å¿…éœ€å­—æ®µç²¾ç®€
  title: z.string().max(60),
  pubDate: z.coerce.date(),

  // 2. å¯é€‰å­—æ®µæœ‰åˆç†é»˜è®¤å€¼
  description: z.string().default(''),
  draft: z.boolean().default(false),
  tags: z.array(z.string()).default([]),

  // 3. ä½¿ç”¨ coerce è‡ªåŠ¨è½¬æ¢
  pubDate: z.coerce.date(), // æ¥å—å­—ç¬¦ä¸²è‡ªåŠ¨è½¬ Date

  // 4. æä¾›æ¸…æ™°çš„ç±»å‹çº¦æŸ
  category: z.enum(['tech', 'life', 'other']),

  // 5. å¤æ‚ç±»å‹ç”¨è”åˆ
  ogImage: z.union([z.string(), z.boolean()]).default(true),
})
```

### æŸ¥è¯¢ä¼˜åŒ–

```typescript
// âœ… åœ¨ getStaticPaths ä¸­å¤ç”¨æŸ¥è¯¢ç»“æœ
export async function getStaticPaths() {
  const posts = await getFilteredPosts('blog')

  return posts.map((post) => ({
    params: { slug: post.id },
    props: { post }, // ä¼ é€’æ•´ä¸ª postï¼Œé¿å…é‡å¤æŸ¥è¯¢
  }))
}

// âŒ é¿å…åœ¨é¡µé¢ä¸­é‡å¤æŸ¥è¯¢
const posts = await getCollection('blog')
const post = posts.find((p) => p.id === slug) // é‡å¤æŸ¥è¯¢
```

### ç±»å‹å®‰å…¨

```typescript
// å¯¼å‡º Schema çš„ç±»å‹
export type PostSchema = z.infer<typeof postSchema>

// ç»„ä»¶ä¸­ä½¿ç”¨
import type { CollectionEntry } from 'astro:content'

interface Props {
  post: CollectionEntry<'blog'>
}
```

## ä¸‹ä¸€æ­¥

ğŸ¯ ç°åœ¨ä½ å·²ç»æŒæ¡äº† Astro çš„å†…å®¹é›†åˆç³»ç»Ÿï¼š

- Content Layer API çš„ä½¿ç”¨
- Schema å®šä¹‰å’Œ Zod éªŒè¯
- é›†åˆæŸ¥è¯¢æ–¹æ³•
- å†…å®¹æ¸²æŸ“æµç¨‹

ä¸‹ä¸€ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬å°†å­¦ä¹  Astro çš„**é›†æˆä¸éƒ¨ç½²**ï¼ŒåŒ…æ‹¬ï¼š

- å®˜æ–¹é›†æˆçš„å®‰è£…å’Œé…ç½®
- æ„å»ºä¼˜åŒ–ç­–ç•¥
- å¤šç§éƒ¨ç½²å¹³å°çš„å®è·µ
- å½“å‰åšå®¢çš„å®Œæ•´æŠ€æœ¯æ ˆåˆ†æ

## å‚è€ƒèµ„æ–™

- [Astro å†…å®¹é›†åˆæ–‡æ¡£](https://docs.astro.build/en/guides/content-collections/)
- [Astro 5 Content Layer API](https://docs.astro.build/en/guides/upgrade-to/v5/)
- [Zod æ–‡æ¡£](https://zod.dev/)
- [MDX å®˜æ–¹æ–‡æ¡£](https://mdxjs.com/)
