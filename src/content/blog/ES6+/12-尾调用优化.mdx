---
title: 'å°¾è°ƒç”¨ä¼˜åŒ–'
description: 'ç†è§£ ES6 å°¾è°ƒç”¨ä¸å°¾é€’å½’ä¼˜åŒ–çš„åŸç†ã€æ¡ä»¶å’Œå®é™…åº”ç”¨'
pubDate: 2024-01-12
toc: true
ogImage: true
category: 'ES6+'
tags: ['ES6', 'å°¾è°ƒç”¨', 'é€’å½’', 'æ€§èƒ½ä¼˜åŒ–']
---

å°¾è°ƒç”¨ä¼˜åŒ–ï¼ˆTail Call Optimizationï¼ŒTCOï¼‰æ˜¯ ES6 å¼•å…¥çš„ä¸€é¡¹é‡è¦ä¼˜åŒ–ï¼Œå¯ä»¥é¿å…é€’å½’è°ƒç”¨å¯¼è‡´çš„æ ˆæº¢å‡ºã€‚

## ä»€ä¹ˆæ˜¯å°¾è°ƒç”¨

å°¾è°ƒç”¨æ˜¯æŒ‡å‡½æ•°çš„æœ€åä¸€æ­¥æ˜¯è°ƒç”¨å¦ä¸€ä¸ªå‡½æ•°ï¼š

```javascript
// âœ… å°¾è°ƒç”¨
function f(x) {
  return g(x)
}

// âŒ ä¸æ˜¯å°¾è°ƒç”¨ï¼šè°ƒç”¨åè¿˜æœ‰æ“ä½œ
function f(x) {
  return g(x) + 1
}

// âŒ ä¸æ˜¯å°¾è°ƒç”¨ï¼šè°ƒç”¨åè¿˜è¦èµ‹å€¼
function f(x) {
  const result = g(x)
  return result
}

// âŒ ä¸æ˜¯å°¾è°ƒç”¨ï¼šæ²¡æœ‰ return
function f(x) {
  g(x)
}
```

ğŸ¤” **å…³é”®**ï¼šå°¾è°ƒç”¨çš„åˆ¤æ–­æ˜¯çœ‹"æœ€åä¸€æ­¥æ˜¯å¦åªæ˜¯è°ƒç”¨å‡½æ•°"ï¼Œè€Œä¸æ˜¯çœ‹ä½ç½®ï¼š

```javascript
// âœ… å°¾è°ƒç”¨ï¼ˆæœ€åä¸€æ­¥æ˜¯ g(x)ï¼‰
function f(x) {
  if (x > 0) {
    return m(x)
  }
  return g(x)
}
```

## å°¾è°ƒç”¨ä¼˜åŒ–åŸç†

### è°ƒç”¨æ ˆ

æ¯æ¬¡å‡½æ•°è°ƒç”¨éƒ½ä¼šåœ¨è°ƒç”¨æ ˆä¸­åˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼Œä¿å­˜å±€éƒ¨å˜é‡ã€è¿”å›åœ°å€ç­‰ä¿¡æ¯ï¼š

```javascript
function a() {
  return b() // éœ€è¦ä¿å­˜ a çš„æ ˆå¸§ï¼Œç­‰ b è¿”å›åç»§ç»­
}

function b() {
  return c() // éœ€è¦ä¿å­˜ b çš„æ ˆå¸§
}

function c() {
  return 1
}

// è°ƒç”¨æ ˆï¼ša -> b -> c
// æ¯ä¸€å±‚éƒ½å ç”¨å†…å­˜
```

### ä¼˜åŒ–æœºåˆ¶

å¦‚æœæ˜¯å°¾è°ƒç”¨ï¼Œå› ä¸ºå¤–å±‚å‡½æ•°ä¸å†éœ€è¦ä»»ä½•ä¿¡æ¯ï¼Œå¯ä»¥ç›´æ¥æ›¿æ¢æ ˆå¸§è€Œä¸æ˜¯æ–°å¢ï¼š

```javascript
// æ²¡æœ‰ä¼˜åŒ–æ—¶
function factorial(n) {
  if (n === 1) return 1
  return n * factorial(n - 1) // ä¸æ˜¯å°¾è°ƒç”¨ï¼Œéœ€è¦ç­‰é€’å½’è¿”å›åä¹˜ä»¥ n
}

factorial(5)
// è°ƒç”¨æ ˆï¼š
// factorial(5)
// factorial(5) -> factorial(4)
// factorial(5) -> factorial(4) -> factorial(3)
// factorial(5) -> factorial(4) -> factorial(3) -> factorial(2)
// factorial(5) -> factorial(4) -> factorial(3) -> factorial(2) -> factorial(1)

// æœ‰ä¼˜åŒ–æ—¶ï¼ˆå°¾è°ƒç”¨ç‰ˆæœ¬ï¼‰
function factorial(n, acc = 1) {
  if (n === 1) return acc
  return factorial(n - 1, n * acc) // å°¾è°ƒç”¨
}

factorial(5)
// è°ƒç”¨æ ˆå§‹ç»ˆåªæœ‰ä¸€å±‚
```

## å°¾é€’å½’

é€’å½’å‡½æ•°çš„å°¾è°ƒç”¨å°±æ˜¯å°¾é€’å½’ã€‚å°†æ™®é€šé€’å½’æ”¹ä¸ºå°¾é€’å½’æ˜¯å¸¸è§çš„ä¼˜åŒ–æ‰‹æ®µã€‚

### é˜¶ä¹˜

```javascript
// æ™®é€šé€’å½’ï¼ˆä¼šæ ˆæº¢å‡ºï¼‰
function factorial(n) {
  if (n === 1) return 1
  return n * factorial(n - 1)
}

// å°¾é€’å½’ï¼ˆä¸ä¼šæ ˆæº¢å‡ºï¼‰
function factorialTail(n, acc = 1) {
  if (n === 1) return acc
  return factorialTail(n - 1, n * acc)
}

// å¯¹æ¯”
// factorial(100000); // RangeError: Maximum call stack size exceeded
// factorialTail(100000); // æ­£å¸¸è®¡ç®—ï¼ˆå¦‚æœå¼•æ“æ”¯æŒ TCOï¼‰
```

### æ–æ³¢é‚£å¥‘æ•°åˆ—

```javascript
// æ™®é€šé€’å½’ï¼ˆææ…¢ä¸”ä¼šæ ˆæº¢å‡ºï¼‰
function fibonacci(n) {
  if (n <= 1) return n
  return fibonacci(n - 1) + fibonacci(n - 2)
}

// å°¾é€’å½’
function fibonacciTail(n, prev = 0, curr = 1) {
  if (n === 0) return prev
  if (n === 1) return curr
  return fibonacciTail(n - 1, curr, prev + curr)
}

fibonacci(40) // å¾ˆæ…¢
fibonacciTail(40) // å¾ˆå¿«
fibonacciTail(10000) // æ­£å¸¸è®¡ç®—ï¼ˆå¦‚æœå¼•æ“æ”¯æŒ TCOï¼‰
```

### æ•°ç»„æ±‚å’Œ

```javascript
// æ™®é€šé€’å½’
function sum(arr) {
  if (arr.length === 0) return 0
  return arr[0] + sum(arr.slice(1))
}

// å°¾é€’å½’
function sumTail(arr, acc = 0) {
  if (arr.length === 0) return acc
  return sumTail(arr.slice(1), acc + arr[0])
}
```

### æ•°ç»„å±•å¹³

```javascript
// æ™®é€šé€’å½’
function flatten(arr) {
  return arr.reduce((flat, item) => {
    return flat.concat(Array.isArray(item) ? flatten(item) : item)
  }, [])
}

// å°¾é€’å½’
function flattenTail(arr, result = []) {
  if (arr.length === 0) return result
  const [first, ...rest] = arr
  if (Array.isArray(first)) {
    return flattenTail([...first, ...rest], result)
  }
  return flattenTail(rest, [...result, first])
}

flatten([1, [2, [3, 4]], 5]) // [1, 2, 3, 4, 5]
```

## ğŸ”¶ æµè§ˆå™¨æ”¯æŒç°çŠ¶

é‡è¦çš„æ˜¯ï¼š**ç›®å‰åªæœ‰ Safari å®ç°äº†å°¾è°ƒç”¨ä¼˜åŒ–**ã€‚V8ï¼ˆChromeã€Node.jsï¼‰å’Œ SpiderMonkeyï¼ˆFirefoxï¼‰å‡ºäºå„ç§åŸå› æ²¡æœ‰å®ç°ã€‚

```javascript
// åœ¨ Chrome/Node.js ä¸­ä»ç„¶ä¼šæ ˆæº¢å‡º
function factorial(n, acc = 1) {
  if (n === 1) return acc
  return factorial(n - 1, n * acc)
}

factorial(100000) // ä»ç„¶ä¼š RangeError
```

## æ›¿ä»£æ–¹æ¡ˆ

### è¹¦åºŠå‡½æ•°ï¼ˆTrampolineï¼‰

è¹¦åºŠå‡½æ•°å¯ä»¥åœ¨ä¸æ”¯æŒ TCO çš„ç¯å¢ƒä¸­æ¨¡æ‹Ÿå°¾è°ƒç”¨ä¼˜åŒ–ï¼š

```javascript
// è¹¦åºŠå‡½æ•°
function trampoline(fn) {
  return function (...args) {
    let result = fn(...args)
    while (typeof result === 'function') {
      result = result()
    }
    return result
  }
}

// æ”¹å†™é€’å½’å‡½æ•°ï¼Œè¿”å›å‡½æ•°è€Œä¸æ˜¯è°ƒç”¨
function factorialTrampoline(n, acc = 1) {
  if (n === 1) return acc
  return () => factorialTrampoline(n - 1, n * acc) // è¿”å›å‡½æ•°
}

const factorial = trampoline(factorialTrampoline)
factorial(100000) // æ­£å¸¸è®¡ç®—ï¼Œä¸ä¼šæ ˆæº¢å‡º
```

### å¾ªç¯æ›¿ä»£

å°†é€’å½’æ”¹å†™ä¸ºå¾ªç¯æ˜¯æœ€ç›´æ¥çš„æ–¹æ¡ˆï¼š

```javascript
// é€’å½’ç‰ˆæœ¬
function factorial(n) {
  if (n === 1) return 1
  return n * factorial(n - 1)
}

// å¾ªç¯ç‰ˆæœ¬
function factorialLoop(n) {
  let result = 1
  for (let i = 2; i <= n; i++) {
    result *= i
  }
  return result
}

// é€’å½’ç‰ˆæœ¬ï¼ˆæ–æ³¢é‚£å¥‘ï¼‰
function fibonacci(n) {
  if (n <= 1) return n
  return fibonacci(n - 1) + fibonacci(n - 2)
}

// å¾ªç¯ç‰ˆæœ¬
function fibonacciLoop(n) {
  if (n <= 1) return n
  let prev = 0
  let curr = 1
  for (let i = 2; i <= n; i++) {
    ;[prev, curr] = [curr, prev + curr]
  }
  return curr
}
```

### Generator + å¾ªç¯

```javascript
function* factorialGen(n, acc = 1) {
  while (n > 1) {
    yield
    acc *= n
    n--
  }
  return acc
}

function runGenerator(gen) {
  let result = gen.next()
  while (!result.done) {
    result = gen.next()
  }
  return result.value
}

runGenerator(factorialGen(100000)) // æ­£å¸¸è®¡ç®—
```

## å°¾è°ƒç”¨ä¼˜åŒ–çš„æ¡ä»¶

ES6 è§„èŒƒè¦æ±‚æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ‰èƒ½è¿›è¡Œå°¾è°ƒç”¨ä¼˜åŒ–ï¼š

1. **ä¸¥æ ¼æ¨¡å¼**ï¼šå¿…é¡»åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹
2. **å°¾ä½ç½®**ï¼šè°ƒç”¨å¿…é¡»åœ¨å°¾ä½ç½®
3. **çº¯å‡½æ•°è°ƒç”¨**ï¼šä¸èƒ½æ˜¯æ–¹æ³•è°ƒç”¨æˆ–é—´æ¥è°ƒç”¨

```javascript
'use strict'

// âœ… å¯ä»¥ä¼˜åŒ–
function f(x) {
  return g(x)
}

// âŒ ä¸èƒ½ä¼˜åŒ–ï¼šä¸æ˜¯ä¸¥æ ¼æ¨¡å¼
// function f(x) {
//   return g(x);
// }

// âŒ ä¸èƒ½ä¼˜åŒ–ï¼šè°ƒç”¨åæœ‰å…¶ä»–æ“ä½œ
function f(x) {
  return g(x) + 1
}

// âŒ ä¸èƒ½ä¼˜åŒ–ï¼šæ–¹æ³•è°ƒç”¨
function f(x) {
  return obj.g(x) // g ä½œä¸ºæ–¹æ³•è°ƒç”¨
}

// âŒ ä¸èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨äº† arguments
function f() {
  return g(arguments[0])
}
```

## å®æˆ˜åº”ç”¨

### æ·±åº¦éå†

```javascript
// éå† DOM æ ‘ï¼ˆå°¾é€’å½’ç‰ˆæœ¬ï¼‰
function traverseDOM(node, callback, queue = []) {
  if (!node) {
    if (queue.length === 0) return
    return traverseDOM(queue.shift(), callback, queue)
  }

  callback(node)
  queue.push(...node.children)
  return traverseDOM(queue.shift(), callback, queue)
}

// ä½¿ç”¨å¾ªç¯ç‰ˆæœ¬æ›´å¯é 
function traverseDOMLoop(root, callback) {
  const queue = [root]
  while (queue.length > 0) {
    const node = queue.shift()
    callback(node)
    queue.push(...node.children)
  }
}
```

### è·¯å¾„æŸ¥æ‰¾

```javascript
// åœ¨æ ‘ç»“æ„ä¸­æŸ¥æ‰¾è·¯å¾„ï¼ˆå°¾é€’å½’ï¼‰
function findPath(node, target, path = []) {
  if (!node) return null

  const currentPath = [...path, node.value]

  if (node.value === target) return currentPath

  if (node.children) {
    for (const child of node.children) {
      const result = findPath(child, target, currentPath)
      if (result) return result
    }
  }

  return null
}
```

## å°ç»“

| è¦ç‚¹       | è¯´æ˜                         |
| ---------- | ---------------------------- |
| å°¾è°ƒç”¨     | å‡½æ•°æœ€åä¸€æ­¥æ˜¯è°ƒç”¨å¦ä¸€ä¸ªå‡½æ•° |
| å°¾é€’å½’     | é€’å½’å‡½æ•°çš„å°¾è°ƒç”¨å½¢å¼         |
| ä¼˜åŒ–åŸç†   | å¤ç”¨æ ˆå¸§ï¼Œé¿å…æ ˆæº¢å‡º         |
| æµè§ˆå™¨æ”¯æŒ | ç›®å‰åªæœ‰ Safari æ”¯æŒ         |
| æ›¿ä»£æ–¹æ¡ˆ   | è¹¦åºŠå‡½æ•°ã€å¾ªç¯ã€Generator    |

è™½ç„¶å°¾è°ƒç”¨ä¼˜åŒ–åœ¨å¤§å¤šæ•°ç¯å¢ƒä¸­æ²¡æœ‰å®ç°ï¼Œä½†ç†è§£è¿™ä¸ªæ¦‚å¿µå¯¹äºç¼–å†™é«˜æ•ˆçš„é€’å½’ä»£ç ä»ç„¶å¾ˆæœ‰ä»·å€¼ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œå»ºè®®å¯¹äºæ·±åº¦é€’å½’ä½¿ç”¨å¾ªç¯æˆ–è¹¦åºŠå‡½æ•°æ¥é¿å…æ ˆæº¢å‡ºã€‚
