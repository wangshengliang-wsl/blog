---
title: ES2024 æ–°ç‰¹æ€§
description: ES2024 (ES15) å¸¦æ¥ Promise.withResolversã€Object.groupByã€æ­£åˆ™ v æ ‡å¿—ã€å¯è°ƒæ•´å¤§å°çš„ ArrayBuffer ç­‰å®ç”¨æ–°åŠŸèƒ½
pubDate: 2025-11-28
toc: true
ogImage: true
category: ES6+
---

ES2024ï¼ˆES15ï¼‰äº 2024 å¹´ 6 æœˆæ­£å¼å‘å¸ƒï¼Œå¸¦æ¥äº† Promise çš„ä¾¿æ·åˆ›å»ºæ–¹å¼ã€å¼ºå¤§çš„æ•°æ®åˆ†ç»„æ–¹æ³•ã€æ­£åˆ™è¡¨è¾¾å¼çš„ Unicode é›†åˆå¢å¼ºç­‰ç‰¹æ€§ã€‚

## Promise.withResolvers()

`Promise.withResolvers()` è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å«æ–°åˆ›å»ºçš„ Promise åŠå…¶ `resolve` å’Œ `reject` å‡½æ•°ï¼š

```javascript
const { promise, resolve, reject } = Promise.withResolvers()

// åœ¨å…¶ä»–åœ°æ–¹æ§åˆ¶ Promise çš„çŠ¶æ€
setTimeout(() => resolve('done'), 1000)

const result = await promise // 'done'
```

åœ¨æ­¤ä¹‹å‰ï¼Œç±»ä¼¼çš„æ¨¡å¼éœ€è¦è¿™æ ·å†™ï¼š

```javascript
// ES2024 ä¹‹å‰
let resolve, reject
const promise = new Promise((res, rej) => {
  resolve = res
  reject = rej
})

// ES2024
const { promise, resolve, reject } = Promise.withResolvers()
```

å¸¸è§ç”¨é€”ï¼š

```javascript
// äº‹ä»¶è½¬ Promise
function waitForEvent(element, eventName) {
  const { promise, resolve } = Promise.withResolvers()
  element.addEventListener(eventName, resolve, { once: true })
  return promise
}

await waitForEvent(button, 'click')

// è¶…æ—¶æ§åˆ¶
function withTimeout(asyncFn, ms) {
  const { promise, resolve, reject } = Promise.withResolvers()

  const timer = setTimeout(() => reject(new Error('Timeout')), ms)

  asyncFn()
    .then((result) => {
      clearTimeout(timer)
      resolve(result)
    })
    .catch(reject)

  return promise
}

// è¯·æ±‚é˜Ÿåˆ—
class RequestQueue {
  #queue = []

  add(request) {
    const { promise, resolve, reject } = Promise.withResolvers()
    this.#queue.push({ request, resolve, reject })
    this.#process()
    return promise
  }

  async #process() {
    // å¤„ç†é˜Ÿåˆ—...
  }
}
```

æµå¼æ•°æ®å¤„ç†ï¼š

```javascript
async function* streamToAsyncIterator(stream) {
  const reader = stream.getReader()

  try {
    while (true) {
      const { done, value } = await reader.read()
      if (done) break
      yield value
    }
  } finally {
    reader.releaseLock()
  }
}
```

## Object.groupBy() / Map.groupBy()

æŒ‰æ¡ä»¶å¯¹æ•°ç»„å…ƒç´ åˆ†ç»„ï¼Œè¿”å›å¯¹è±¡æˆ– Mapã€‚

**Object.groupBy()**

```javascript
const items = [
  { name: 'è‹¹æœ', type: 'fruit' },
  { name: 'ç‰›è‚‰', type: 'meat' },
  { name: 'é¦™è•‰', type: 'fruit' },
  { name: 'é¸¡è‚‰', type: 'meat' },
]

const grouped = Object.groupBy(items, (item) => item.type)
// {
//   fruit: [{ name: 'è‹¹æœ', type: 'fruit' }, { name: 'é¦™è•‰', type: 'fruit' }],
//   meat: [{ name: 'ç‰›è‚‰', type: 'meat' }, { name: 'é¸¡è‚‰', type: 'meat' }]
// }
```

å›è°ƒå‡½æ•°è¿”å›çš„å€¼ä¼šè¢«è½¬æ¢ä¸ºå­—ç¬¦ä¸²ä½œä¸ºé”®ï¼š

```javascript
const nums = [1, 2, 3, 4, 5, 6]

Object.groupBy(nums, (n) => (n % 2 === 0 ? 'even' : 'odd'))
// { odd: [1, 3, 5], even: [2, 4, 6] }

// æŒ‰æ•°å­—èŒƒå›´åˆ†ç»„
Object.groupBy(nums, (n) => Math.floor(n / 3))
// { '0': [1, 2], '1': [3, 4, 5], '2': [6] }
```

**Map.groupBy()**

å½“éœ€è¦ç”¨å¯¹è±¡ä½œä¸ºé”®æ—¶ï¼Œä½¿ç”¨ `Map.groupBy()`ï¼š

```javascript
const items = [
  { name: 'A', category: { id: 1 } },
  { name: 'B', category: { id: 2 } },
  { name: 'C', category: { id: 1 } },
]

const cat1 = { id: 1 }
const cat2 = { id: 2 }

// é¢„å®šä¹‰çš„åˆ†ç±»å¯¹è±¡
const categories = new Map([
  [1, cat1],
  [2, cat2],
])

const grouped = Map.groupBy(items, (item) => categories.get(item.category.id))
// Map {
//   { id: 1 } => [{ name: 'A', ... }, { name: 'C', ... }],
//   { id: 2 } => [{ name: 'B', ... }]
// }
```

å®é™…åº”ç”¨ï¼š

```javascript
// æŒ‰çŠ¶æ€åˆ†ç»„è®¢å•
const orders = [
  { id: 1, status: 'pending' },
  { id: 2, status: 'shipped' },
  { id: 3, status: 'pending' },
  { id: 4, status: 'delivered' },
]

const byStatus = Object.groupBy(orders, (o) => o.status)
// { pending: [...], shipped: [...], delivered: [...] }

// æŒ‰é¦–å­—æ¯åˆ†ç»„
const words = ['apple', 'banana', 'avocado', 'blueberry']
Object.groupBy(words, (w) => w[0])
// { a: ['apple', 'avocado'], b: ['banana', 'blueberry'] }

// æŒ‰æ—¥æœŸåˆ†ç»„
const logs = [
  { date: '2024-01-01', msg: 'a' },
  { date: '2024-01-01', msg: 'b' },
  { date: '2024-01-02', msg: 'c' },
]
Object.groupBy(logs, (log) => log.date)
// { '2024-01-01': [...], '2024-01-02': [...] }
```

ä¸ Lodash `groupBy` çš„å¯¹æ¯”ï¼š

```javascript
// Lodash
import { groupBy } from 'lodash'
groupBy(items, 'type')
groupBy(items, (item) => item.type)

// åŸç”Ÿ
Object.groupBy(items, (item) => item.type)
```

## String.prototype.isWellFormed() / toWellFormed()

å¤„ç† Unicode å­—ç¬¦ä¸²ä¸­çš„å­¤ç«‹ä»£ç†é¡¹ï¼ˆlone surrogateï¼‰ã€‚

åœ¨ UTF-16 ç¼–ç ä¸­ï¼ŒæŸäº›å­—ç¬¦ï¼ˆå¦‚ emojiï¼‰ç”¨ä»£ç†å¯¹è¡¨ç¤ºã€‚å­¤ç«‹çš„ä»£ç†é¡¹ä¼šå¯¼è‡´ä¸€äº›æ“ä½œå‡ºé”™ï¼š

```javascript
// æ­£å¸¸å­—ç¬¦ä¸²
const normal = 'hello'

// åŒ…å«å­¤ç«‹ä»£ç†é¡¹çš„å­—ç¬¦ä¸²ï¼ˆä¸å®Œæ•´çš„ emojiï¼‰
const malformed = 'hello\uD800world' // \uD800 æ˜¯é«˜ä½ä»£ç†ï¼Œæ²¡æœ‰é…å¯¹çš„ä½ä½ä»£ç†
```

**isWellFormed()**

æ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦åŒ…å«å­¤ç«‹ä»£ç†é¡¹ï¼š

```javascript
'hello'.isWellFormed() // true
'helloğŸ˜€'.isWellFormed() // trueï¼ˆå®Œæ•´çš„ emojiï¼‰
'hello\uD800'.isWellFormed() // falseï¼ˆå­¤ç«‹é«˜ä½ä»£ç†ï¼‰
'\uDC00world'.isWellFormed() // falseï¼ˆå­¤ç«‹ä½ä½ä»£ç†ï¼‰
```

**toWellFormed()**

å°†å­¤ç«‹ä»£ç†é¡¹æ›¿æ¢ä¸º Unicode æ›¿æ¢å­—ç¬¦ï¼ˆU+FFFDï¼‰ï¼š

```javascript
'hello\uD800world'.toWellFormed() // 'helloï¿½world'
'\uDC00abc\uD800'.toWellFormed() // 'ï¿½abcï¿½'
'normal string'.toWellFormed() // 'normal string'ï¼ˆå·²ç»æ˜¯è‰¯æ„çš„ï¼‰
```

å®é™…åº”ç”¨ï¼š

```javascript
// å®‰å…¨åœ°ç¼–ç  URL
function safeEncodeURI(str) {
  // encodeURI å¯¹å­¤ç«‹ä»£ç†é¡¹ä¼šæŠ›å‡º URIError
  return encodeURI(str.toWellFormed())
}

// å¤„ç†ç”¨æˆ·è¾“å…¥
function sanitizeInput(input) {
  if (!input.isWellFormed()) {
    console.warn('è¾“å…¥åŒ…å«æ— æ•ˆçš„ Unicode å­—ç¬¦')
    return input.toWellFormed()
  }
  return input
}

// å®‰å…¨åœ°ä½¿ç”¨ TextEncoder
function safeEncode(str) {
  const encoder = new TextEncoder()
  // TextEncoder ä¼šå°†å­¤ç«‹ä»£ç†é¡¹æ›¿æ¢ä¸º U+FFFD
  // ä½¿ç”¨ toWellFormed() å¯ä»¥é¢„å…ˆå¤„ç†ï¼Œä½¿è¡Œä¸ºæ›´å¯é¢„æµ‹
  return encoder.encode(str.toWellFormed())
}
```

## æ­£åˆ™è¡¨è¾¾å¼ /v æ ‡å¿—

`v` æ ‡å¿—æ˜¯ `u` æ ‡å¿—çš„å¢å¼ºç‰ˆï¼Œæä¾›æ›´å¼ºå¤§çš„ Unicode é›†åˆæ“ä½œã€‚

**é›†åˆè¿ç®—**

```javascript
// äº¤é›†ï¼š[A&&B]
// åŒ¹é…æ—¢æ˜¯å¸Œè…Šå­—æ¯åˆæ˜¯å¤§å†™å­—æ¯çš„å­—ç¬¦
const regex = /[\p{Script=Greek}&&\p{Lu}]/v
regex.test('Î©') // trueï¼ˆå¤§å†™å¸Œè…Šå­—æ¯ï¼‰
regex.test('Ï‰') // falseï¼ˆå°å†™å¸Œè…Šå­—æ¯ï¼‰
regex.test('A') // falseï¼ˆå¤§å†™ä½†ä¸æ˜¯å¸Œè…Šå­—æ¯ï¼‰

// å·®é›†ï¼š[A--B]
// åŒ¹é…å­—æ¯ä½†ä¸æ˜¯ ASCII å­—æ¯
const nonAsciiLetter = /[\p{Letter}--[a-zA-Z]]/v
nonAsciiLetter.test('ä¸­') // true
nonAsciiLetter.test('A') // false
```

**åµŒå¥—å­—ç¬¦ç±»**

```javascript
// v æ ‡å¿—å…è®¸åœ¨å­—ç¬¦ç±»ä¸­åµŒå¥—å­—ç¬¦ç±»
const regex = /[[a-z]--[aeiou]]/v // è¾…éŸ³å­—æ¯
regex.test('b') // true
regex.test('a') // false

// å¤æ‚çš„é›†åˆè¿ç®—
const complexRegex = /[[\p{L}&&\p{ASCII}]--[A-Z]]/v // ASCII å°å†™å­—æ¯
```

**å­—ç¬¦ä¸²å­—é¢é‡**

```javascript
// v æ ‡å¿—æ”¯æŒåœ¨å­—ç¬¦ç±»ä¸­ä½¿ç”¨å¤šå­—ç¬¦å­—ç¬¦ä¸²
const flags = /[\q{ğŸ‡¨ğŸ‡³|ğŸ‡ºğŸ‡¸|ğŸ‡¯ğŸ‡µ}]/v
flags.test('ğŸ‡¨ğŸ‡³') // true
flags.test('ğŸ‡¬ğŸ‡§') // false

// \q{} è¯­æ³•ç”¨äºå­—ç¬¦ä¸²å­—é¢é‡
const words = /[\q{one|two|three}]/v
words.test('one') // true
```

**Unicode å±æ€§è½¬ä¹‰å¢å¼º**

```javascript
// v æ ‡å¿—ä¸‹çš„å±æ€§å¯ä»¥åŒ¹é…å¤šå­—ç¬¦åºåˆ—
const emojiRegex = /\p{RGI_Emoji}/v
emojiRegex.test('ğŸ‘¨â€ğŸ‘©â€ğŸ‘§') // trueï¼ˆå®¶åº­ emojiï¼Œå¤šä¸ªç ç‚¹ï¼‰

// u æ ‡å¿—åªèƒ½åŒ¹é…å•ä¸ªç ç‚¹
const oldRegex = /\p{Emoji}/u
// æ— æ³•æ­£ç¡®åŒ¹é…ç»„åˆ emoji
```

`v` æ ‡å¿—ä¸ `u` æ ‡å¿—äº’æ–¥ï¼š

```javascript
// ä¸èƒ½åŒæ—¶ä½¿ç”¨
// /./uv // SyntaxError

// æ£€æŸ¥æ ‡å¿—
const regex = /./v
regex.unicodeSets // true
```

## ArrayBuffer å¯è°ƒæ•´å¤§å°

ES2024 å…è®¸åˆ›å»ºå¯è°ƒæ•´å¤§å°çš„ ArrayBufferï¼š

```javascript
// åˆ›å»ºå¯è°ƒæ•´å¤§å°çš„ ArrayBuffer
// å‚æ•°ï¼šåˆå§‹å¤§å°ï¼Œæœ€å¤§å¤§å°
const buffer = new ArrayBuffer(8, { maxByteLength: 16 })

buffer.byteLength // 8
buffer.maxByteLength // 16
buffer.resizable // true

// è°ƒæ•´å¤§å°
buffer.resize(12)
buffer.byteLength // 12

buffer.resize(4)
buffer.byteLength // 4

// ä¸èƒ½è¶…è¿‡æœ€å¤§å¤§å°
buffer.resize(20) // RangeError
```

ä¸ TypedArray é…åˆä½¿ç”¨ï¼š

```javascript
const buffer = new ArrayBuffer(8, { maxByteLength: 32 })
const view = new Uint8Array(buffer)

view.length // 8
view[0] = 1
view[7] = 8

buffer.resize(16)
view.length // 16ï¼ˆè‡ªåŠ¨æ›´æ–°ï¼‰
view[0] // 1ï¼ˆæ•°æ®ä¿ç•™ï¼‰
view[15] = 16

buffer.resize(4)
view.length // 4
// è¶…å‡ºæ–°å¤§å°çš„æ•°æ®è¢«ä¸¢å¼ƒ
```

å›ºå®šé•¿åº¦è§†å›¾ï¼š

```javascript
const buffer = new ArrayBuffer(16, { maxByteLength: 32 })

// åˆ›å»ºå›ºå®šé•¿åº¦è§†å›¾
const fixedView = new Uint8Array(buffer, 0, 8)
fixedView.length // 8

buffer.resize(4)
// è®¿é—® fixedView ä¼šæŠ›å‡ºé”™è¯¯ï¼Œå› ä¸ºå®ƒå¼•ç”¨äº†è¢«æˆªæ–­çš„åŒºåŸŸ
fixedView[0] // TypeError: out of bounds
```

æ£€æŸ¥ ArrayBuffer æ˜¯å¦å¯è°ƒæ•´ï¼š

```javascript
const resizable = new ArrayBuffer(8, { maxByteLength: 16 })
const fixed = new ArrayBuffer(8)

resizable.resizable // true
fixed.resizable // false

resizable.maxByteLength // 16
fixed.maxByteLength // 8ï¼ˆç­‰äº byteLengthï¼‰
```

SharedArrayBuffer ä¹Ÿæ”¯æŒå¯å¢é•¿ï¼š

```javascript
const shared = new SharedArrayBuffer(8, { maxByteLength: 16 })
shared.growable // true

// åªèƒ½å¢é•¿ï¼Œä¸èƒ½æ”¶ç¼©
shared.grow(12)
shared.byteLength // 12
```

## Atomics.waitAsync()

`Atomics.waitAsync()` æ˜¯ `Atomics.wait()` çš„å¼‚æ­¥ç‰ˆæœ¬ï¼Œä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼š

```javascript
const sab = new SharedArrayBuffer(4)
const int32 = new Int32Array(sab)

// Atomics.wait() æ˜¯åŒæ­¥çš„ï¼Œä¼šé˜»å¡çº¿ç¨‹
// åªèƒ½åœ¨ Worker ä¸­ä½¿ç”¨ï¼Œä¸»çº¿ç¨‹ä¼šæŠ¥é”™

// Atomics.waitAsync() æ˜¯å¼‚æ­¥çš„ï¼Œå¯ä»¥åœ¨ä¸»çº¿ç¨‹ä½¿ç”¨
const result = Atomics.waitAsync(int32, 0, 0)
// { async: true, value: Promise }

result.value.then((status) => {
  console.log(status) // 'ok' æˆ– 'timed-out'
})

// åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­
Atomics.store(int32, 0, 1)
Atomics.notify(int32, 0)
```

è¿”å›å€¼ç»“æ„ï¼š

```javascript
// å¦‚æœå½“å‰å€¼å·²ç»ä¸ç­‰äºæœŸæœ›å€¼ï¼ŒåŒæ­¥è¿”å›
const immediate = Atomics.waitAsync(int32, 0, 999)
// { async: false, value: 'not-equal' }

// å¦‚æœéœ€è¦ç­‰å¾…ï¼Œè¿”å› Promise
const waiting = Atomics.waitAsync(int32, 0, 0)
// { async: true, value: Promise<'ok' | 'timed-out'> }
```

è¶…æ—¶å‚æ•°ï¼š

```javascript
// ç­‰å¾…æœ€å¤š 1000ms
const result = Atomics.waitAsync(int32, 0, 0, 1000)

result.value.then((status) => {
  if (status === 'timed-out') {
    console.log('ç­‰å¾…è¶…æ—¶')
  } else {
    console.log('è¢«å”¤é†’')
  }
})
```

å¤šçº¿ç¨‹åè°ƒç¤ºä¾‹ï¼š

```javascript
// ä¸»çº¿ç¨‹
const sab = new SharedArrayBuffer(4)
const int32 = new Int32Array(sab)

const worker = new Worker('worker.js')
worker.postMessage(sab)

// ç­‰å¾… worker å®Œæˆ
const { value } = Atomics.waitAsync(int32, 0, 0)
value.then(() => {
  console.log('Worker ä»»åŠ¡å®Œæˆ')
})

// worker.js
self.onmessage = (e) => {
  const int32 = new Int32Array(e.data)

  // æ‰§è¡Œä»»åŠ¡...

  // é€šçŸ¥ä¸»çº¿ç¨‹
  Atomics.store(int32, 0, 1)
  Atomics.notify(int32, 0)
}
```

ES2024 çš„ç‰¹æ€§ç»§ç»­å®Œå–„ JavaScript çš„èƒ½åŠ›ã€‚`Promise.withResolvers()` ç®€åŒ–äº† Promise çš„å¤–éƒ¨æ§åˆ¶ï¼Œ`Object.groupBy()` æä¾›äº†åŸç”Ÿçš„æ•°ç»„åˆ†ç»„æ–¹æ¡ˆï¼Œæ­£åˆ™è¡¨è¾¾å¼çš„ `v` æ ‡å¿—å¸¦æ¥äº†å¼ºå¤§çš„ Unicode é›†åˆè¿ç®—ã€‚è¿™äº›ç‰¹æ€§è®©æ—¥å¸¸å¼€å‘æ›´åŠ ä¾¿æ·ï¼Œç‰¹åˆ«æ˜¯ `groupBy` æ–¹æ³•ï¼Œå¡«è¡¥äº† JavaScript é•¿æœŸä»¥æ¥ç¼ºå°‘åŸç”Ÿåˆ†ç»„å‡½æ•°çš„ç©ºç™½ã€‚
