---
title: 'async å‡½æ•°'
description: 'æ·±å…¥ç†è§£ ES2017 async å‡½æ•°çš„è¯­æ³•ã€æ‰§è¡Œæœºåˆ¶ä¸å¼‚æ­¥ç¼–ç¨‹æœ€ä½³å®è·µ'
pubDate: 2024-02-02
toc: true
ogImage: true
category: 'ES6+'
tags: ['ES2017', 'async', 'await', 'å¼‚æ­¥', 'Promise']
---

async å‡½æ•°æ˜¯ ES2017 å¼•å…¥çš„å¼‚æ­¥ç¼–ç¨‹ç»ˆæè§£å†³æ–¹æ¡ˆï¼Œè®©å¼‚æ­¥ä»£ç å†™èµ·æ¥åƒåŒæ­¥ä»£ç ä¸€æ ·ç›´è§‚ã€‚

## åŸºæœ¬è¯­æ³•

### å®šä¹‰ async å‡½æ•°

```javascript
// å‡½æ•°å£°æ˜
async function fetchData() {
  return 'æ•°æ®'
}

// å‡½æ•°è¡¨è¾¾å¼
const getData = async function () {
  return 'æ•°æ®'
}

// ç®­å¤´å‡½æ•°
const loadData = async () => {
  return 'æ•°æ®'
}

// æ–¹æ³•
const obj = {
  async getData() {
    return 'æ•°æ®'
  },
}

// ç±»æ–¹æ³•
class API {
  async fetch() {
    return 'æ•°æ®'
  }
}
```

### async å‡½æ•°çš„è¿”å›å€¼

async å‡½æ•°æ€»æ˜¯è¿”å›ä¸€ä¸ª Promiseï¼š

```javascript
async function example() {
  return 'ç›´æ¥è¿”å›å€¼'
}

example().then(console.log) // 'ç›´æ¥è¿”å›å€¼'

// è¿”å›å€¼ä¼šè¢« Promise.resolve åŒ…è£…
async function returnPromise() {
  return Promise.resolve('å·²ç»æ˜¯ Promise')
}

returnPromise().then(console.log) // 'å·²ç»æ˜¯ Promise'

// æŠ›å‡ºé”™è¯¯ä¼šå˜æˆ rejected çŠ¶æ€
async function throwError() {
  throw new Error('å‡ºé”™äº†')
}

throwError().catch((err) => console.log(err.message)) // 'å‡ºé”™äº†'
```

## await è¡¨è¾¾å¼

### åŸºæœ¬ç”¨æ³•

`await` åªèƒ½åœ¨ async å‡½æ•°å†…éƒ¨ä½¿ç”¨ï¼Œç”¨äºç­‰å¾… Promise å®Œæˆï¼š

```javascript
async function fetchUser() {
  // await æš‚åœæ‰§è¡Œï¼Œç­‰å¾… Promise å®Œæˆ
  const response = await fetch('/api/user')
  const data = await response.json()
  return data
}
```

### await çš„æ‰§è¡Œé¡ºåº

```javascript
async function example() {
  console.log('1')
  const result = await Promise.resolve('2')
  console.log(result)
  console.log('3')
}

console.log('start')
example()
console.log('end')

// è¾“å‡ºé¡ºåºï¼š
// start
// 1
// end
// 2
// 3
```

ğŸ¤” await ä¹‹åçš„ä»£ç ä¼šåœ¨å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­æ‰§è¡Œã€‚

### await é Promise å€¼

await å¯ä»¥ç”¨äºä»»ä½•å€¼ï¼Œé Promise å€¼ä¼šè¢«è‡ªåŠ¨åŒ…è£…ï¼š

```javascript
async function example() {
  const a = await 1 // ç­‰ä»·äº await Promise.resolve(1)
  const b = await 'å­—ç¬¦ä¸²'
  const c = await { name: 'å¼ ä¸‰' }

  console.log(a, b, c)
}

example() // 1 'å­—ç¬¦ä¸²' { name: 'å¼ ä¸‰' }
```

### thenable å¯¹è±¡

await å¯ä»¥å¤„ç†ä»»ä½• thenable å¯¹è±¡ï¼š

```javascript
const thenable = {
  then(resolve) {
    setTimeout(() => resolve('thenable ç»“æœ'), 100)
  },
}

async function example() {
  const result = await thenable
  console.log(result) // 'thenable ç»“æœ'
}

example()
```

## å¯¹æ¯” Promise

### é“¾å¼è°ƒç”¨ vs async/await

```javascript
// Promise é“¾å¼è°ƒç”¨
function fetchUserPosts(userId) {
  return fetch(`/api/users/${userId}`)
    .then((response) => response.json())
    .then((user) => fetch(`/api/posts?userId=${user.id}`))
    .then((response) => response.json())
}

// async/await å†™æ³•
async function fetchUserPosts(userId) {
  const userResponse = await fetch(`/api/users/${userId}`)
  const user = await userResponse.json()
  const postsResponse = await fetch(`/api/posts?userId=${user.id}`)
  return postsResponse.json()
}
```

### æ¡ä»¶é€»è¾‘

```javascript
// Promise æ–¹å¼å¤„ç†æ¡ä»¶é€»è¾‘å¾ˆéº»çƒ¦
function getData(condition) {
  return fetch('/api/data')
    .then((response) => response.json())
    .then((data) => {
      if (condition) {
        return fetch('/api/extra')
          .then((r) => r.json())
          .then((extra) => ({ ...data, extra }))
      }
      return data
    })
}

// async/await æ›´æ¸…æ™°
async function getData(condition) {
  const response = await fetch('/api/data')
  const data = await response.json()

  if (condition) {
    const extraResponse = await fetch('/api/extra')
    const extra = await extraResponse.json()
    return { ...data, extra }
  }

  return data
}
```

### å¾ªç¯ä¸­çš„å¼‚æ­¥

```javascript
// é”™è¯¯ï¼šforEach ä¸ä¼šç­‰å¾…
async function wrong(urls) {
  urls.forEach(async (url) => {
    const data = await fetch(url)
    console.log(data)
  })
  console.log('å®Œæˆ') // ä¼šå…ˆæ‰“å°
}

// æ­£ç¡®ï¼šä¸²è¡Œæ‰§è¡Œ
async function sequential(urls) {
  for (const url of urls) {
    const response = await fetch(url)
    console.log(await response.json())
  }
  console.log('å®Œæˆ')
}

// æ­£ç¡®ï¼šå¹¶è¡Œæ‰§è¡Œ
async function parallel(urls) {
  const promises = urls.map((url) => fetch(url).then((r) => r.json()))
  const results = await Promise.all(promises)
  console.log(results)
  console.log('å®Œæˆ')
}
```

## é”™è¯¯å¤„ç†

### try/catch

```javascript
async function fetchData() {
  try {
    const response = await fetch('/api/data')
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`)
    }
    return await response.json()
  } catch (error) {
    console.error('è·å–æ•°æ®å¤±è´¥:', error)
    throw error // å¯ä»¥é‡æ–°æŠ›å‡º
  }
}
```

### å¤šä¸ª await çš„é”™è¯¯å¤„ç†

```javascript
async function fetchMultiple() {
  try {
    const user = await fetchUser()
    const posts = await fetchPosts(user.id)
    const comments = await fetchComments(posts[0].id)
    return { user, posts, comments }
  } catch (error) {
    // ä»»ä½•ä¸€ä¸ªå¤±è´¥éƒ½ä¼šåˆ°è¿™é‡Œ
    console.error('å‘ç”Ÿé”™è¯¯:', error)
  }
}
```

### å•ç‹¬å¤„ç†æ¯ä¸ª await

```javascript
async function fetchWithIndividualHandling() {
  let user, posts

  try {
    user = await fetchUser()
  } catch (error) {
    console.error('è·å–ç”¨æˆ·å¤±è´¥')
    user = null
  }

  try {
    posts = await fetchPosts()
  } catch (error) {
    console.error('è·å–æ–‡ç« å¤±è´¥')
    posts = []
  }

  return { user, posts }
}
```

### catch æ–¹æ³•ç»“åˆ

```javascript
async function fetchData() {
  // ä½¿ç”¨ catch æä¾›é»˜è®¤å€¼
  const user = await fetchUser().catch(() => null)
  const posts = await fetchPosts().catch(() => [])

  return { user, posts }
}
```

## å¹¶å‘æ‰§è¡Œ

### Promise.all å¹¶å‘

```javascript
async function fetchAllData() {
  // ä¸²è¡Œï¼šæ…¢
  // const users = await fetchUsers();
  // const posts = await fetchPosts();

  // å¹¶è¡Œï¼šå¿«
  const [users, posts] = await Promise.all([fetchUsers(), fetchPosts()])

  return { users, posts }
}
```

### Promise.allSettled å®¹é”™å¹¶å‘

```javascript
async function fetchAllWithFallback() {
  const results = await Promise.allSettled([
    fetchUsers(),
    fetchPosts(),
    fetchComments(),
  ])

  return {
    users: results[0].status === 'fulfilled' ? results[0].value : [],
    posts: results[1].status === 'fulfilled' ? results[1].value : [],
    comments: results[2].status === 'fulfilled' ? results[2].value : [],
  }
}
```

### ç«é€Ÿ

```javascript
async function fetchWithTimeout(url, timeout = 5000) {
  return Promise.race([
    fetch(url),
    new Promise((_, reject) =>
      setTimeout(() => reject(new Error('è¯·æ±‚è¶…æ—¶')), timeout)
    ),
  ])
}

async function example() {
  try {
    const response = await fetchWithTimeout('/api/data', 3000)
    return response.json()
  } catch (error) {
    console.error(error.message)
  }
}
```

## å®æˆ˜æ¨¡å¼

### é‡è¯•æœºåˆ¶

```javascript
async function fetchWithRetry(url, maxRetries = 3, delay = 1000) {
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      const response = await fetch(url)
      if (!response.ok) throw new Error(`HTTP ${response.status}`)
      return await response.json()
    } catch (error) {
      if (attempt === maxRetries) throw error
      console.log(`ç¬¬ ${attempt} æ¬¡å¤±è´¥ï¼Œ${delay}ms åé‡è¯•...`)
      await new Promise((r) => setTimeout(r, delay))
    }
  }
}
```

### ä¸²è¡Œé˜Ÿåˆ—

```javascript
async function processQueue(items, processor) {
  const results = []
  for (const item of items) {
    results.push(await processor(item))
  }
  return results
}

// ä½¿ç”¨
const urls = ['/api/1', '/api/2', '/api/3']
const results = await processQueue(urls, async (url) => {
  const response = await fetch(url)
  return response.json()
})
```

### é™åˆ¶å¹¶å‘æ•°

```javascript
async function asyncPool(limit, items, fn) {
  const results = []
  const executing = new Set()

  for (const item of items) {
    const promise = fn(item).then((result) => {
      executing.delete(promise)
      return result
    })

    results.push(promise)
    executing.add(promise)

    if (executing.size >= limit) {
      await Promise.race(executing)
    }
  }

  return Promise.all(results)
}

// æœ€å¤šåŒæ—¶ 3 ä¸ªè¯·æ±‚
const results = await asyncPool(3, urls, async (url) => {
  const response = await fetch(url)
  return response.json()
})
```

### ç¼“å­˜åŒ…è£…å™¨

```javascript
function withCache(fn) {
  const cache = new Map()

  return async function (...args) {
    const key = JSON.stringify(args)

    if (cache.has(key)) {
      return cache.get(key)
    }

    const result = await fn.apply(this, args)
    cache.set(key, result)
    return result
  }
}

const cachedFetch = withCache(async (url) => {
  const response = await fetch(url)
  return response.json()
})
```

## é¡¶å±‚ await

ES2022 å…è®¸åœ¨æ¨¡å—é¡¶å±‚ä½¿ç”¨ awaitï¼š

```javascript
// config.js (ES Module)
const response = await fetch('/api/config')
export const config = await response.json()

// main.js
import { config } from './config.js'
console.log(config) // å·²ç»æ˜¯è§£æåçš„æ•°æ®
```

### åŠ¨æ€å¯¼å…¥

```javascript
// æ ¹æ®æ¡ä»¶åŠ¨æ€å¯¼å…¥æ¨¡å—
const locale = navigator.language
const messages = await import(`./i18n/${locale}.js`)

// æ‡’åŠ è½½ç»„ä»¶
const { default: Component } = await import('./Component.js')
```

## å¸¸è§é™·é˜±

### ğŸ”¶ å¿˜è®° await

```javascript
async function wrong() {
  const data = fetchData() // å¿˜è®° awaitï¼Œdata æ˜¯ Promise
  console.log(data.name) // undefined
}

async function correct() {
  const data = await fetchData()
  console.log(data.name)
}
```

### ğŸ”¶ ä¸å¿…è¦çš„ await

```javascript
// ä¸å¿…è¦çš„ await
async function unnecessary() {
  return await fetchData() // await æ˜¯å¤šä½™çš„
}

// ç›´æ¥ return å³å¯
async function correct() {
  return fetchData()
}

// ä½†åœ¨ try/catch ä¸­éœ€è¦ await
async function withTryCatch() {
  try {
    return await fetchData() // éœ€è¦ await æ‰èƒ½æ•è·é”™è¯¯
  } catch (error) {
    console.error(error)
  }
}
```

### ğŸ”¶ ä¸²è¡Œ vs å¹¶è¡Œ

```javascript
// ä¸²è¡Œï¼šæ€»è€—æ—¶ = t1 + t2
async function slow() {
  const a = await fetch('/api/a')
  const b = await fetch('/api/b')
  return [a, b]
}

// å¹¶è¡Œï¼šæ€»è€—æ—¶ = max(t1, t2)
async function fast() {
  const [a, b] = await Promise.all([fetch('/api/a'), fetch('/api/b')])
  return [a, b]
}
```

## å°ç»“

| ç‰¹æ€§       | è¯´æ˜                        |
| ---------- | --------------------------- |
| async      | å£°æ˜å¼‚æ­¥å‡½æ•°ï¼Œè¿”å› Promise  |
| await      | æš‚åœæ‰§è¡Œï¼Œç­‰å¾… Promise å®Œæˆ |
| é”™è¯¯å¤„ç†   | try/catch æˆ– .catch()       |
| å¹¶å‘       | Promise.all/allSettled/race |
| é¡¶å±‚ await | ES2022 æ¨¡å—æ”¯æŒ             |

async/await æ˜¯ç›®å‰æœ€æ¨èçš„å¼‚æ­¥ç¼–ç¨‹æ–¹å¼ï¼Œè®©ä»£ç æ›´æ˜“è¯»ã€æ›´æ˜“ç»´æŠ¤ã€‚
