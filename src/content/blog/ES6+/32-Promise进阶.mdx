---
title: 'Promise è¿›é˜¶'
description: 'æ·±å…¥ç†è§£ Promise é™æ€æ–¹æ³•ã€é”™è¯¯å¤„ç†æ¨¡å¼ä¸å¹¶å‘æ§åˆ¶æŠ€å·§'
pubDate: 2024-02-01
toc: true
ogImage: true
category: 'ES6+'
tags: ['ES6', 'Promise', 'Promise.all', 'å¹¶å‘æ§åˆ¶', 'é”™è¯¯å¤„ç†']
---

åœ¨æŒæ¡ Promise åŸºç¡€åï¼Œæ¥çœ‹æ›´å¤šé™æ€æ–¹æ³•å’Œè¿›é˜¶ç”¨æ³•ã€‚

## Promise.all()

ç­‰å¾…æ‰€æœ‰ Promise å®Œæˆï¼Œä»»æ„ä¸€ä¸ªå¤±è´¥å°±ç«‹å³å¤±è´¥ï¼š

```javascript
const p1 = Promise.resolve(1)
const p2 = Promise.resolve(2)
const p3 = Promise.resolve(3)

Promise.all([p1, p2, p3]).then((values) => {
  console.log(values) // [1, 2, 3]ï¼ˆé¡ºåºä¸ä¼ å…¥ä¸€è‡´ï¼‰
})

// æœ‰ä¸€ä¸ªå¤±è´¥å°±å…¨éƒ¨å¤±è´¥
const p4 = Promise.reject(new Error('å¤±è´¥'))

Promise.all([p1, p2, p4]).catch((error) => {
  console.log(error.message) // 'å¤±è´¥'
})
```

### å®é™…åº”ç”¨

```javascript
// å¹¶è¡Œè¯·æ±‚å¤šä¸ªæ¥å£
async function fetchAllData() {
  const [users, posts, comments] = await Promise.all([
    fetch('/api/users').then((r) => r.json()),
    fetch('/api/posts').then((r) => r.json()),
    fetch('/api/comments').then((r) => r.json()),
  ])

  return { users, posts, comments }
}

// æ‰¹é‡å¤„ç†
async function processItems(items) {
  const results = await Promise.all(items.map((item) => processItem(item)))
  return results
}
```

### ğŸ”¶ æ³¨æ„äº‹é¡¹

```javascript
// ç©ºæ•°ç»„ç«‹å³ resolve
Promise.all([]).then((v) => console.log(v)) // []

// é Promise å€¼ä¼šè¢«è‡ªåŠ¨åŒ…è£…
Promise.all([1, 2, 3]).then((v) => console.log(v)) // [1, 2, 3]

// ä¸€æ—¦æœ‰ä¸€ä¸ªå¤±è´¥ï¼Œä¸ä¼šç­‰å¾…å…¶ä»–
const slow = new Promise((r) => setTimeout(() => r('slow'), 3000))
const fast = Promise.reject(new Error('fast'))

Promise.all([slow, fast]).catch((e) => console.log(e.message)) // 'fast'ï¼ˆä¸ä¼šç­‰å¾… slowï¼‰
```

## Promise.race()

è¿”å›æœ€å…ˆå®Œæˆï¼ˆæ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼‰çš„ç»“æœï¼š

```javascript
const p1 = new Promise((r) => setTimeout(() => r('p1'), 100))
const p2 = new Promise((r) => setTimeout(() => r('p2'), 200))

Promise.race([p1, p2]).then((value) => console.log(value)) // 'p1'

// è¶…æ—¶æ§åˆ¶
function fetchWithTimeout(url, timeout = 5000) {
  return Promise.race([
    fetch(url),
    new Promise((_, reject) =>
      setTimeout(() => reject(new Error('Timeout')), timeout)
    ),
  ])
}
```

### ç©ºæ•°ç»„æ°¸è¿œ pending

```javascript
Promise.race([]).then(() => {
  console.log('æ°¸è¿œä¸ä¼šæ‰§è¡Œ')
})
```

## Promise.allSettled()

ES2020 æ–°å¢ï¼Œç­‰å¾…æ‰€æœ‰ Promise å®Œæˆï¼Œæ— è®ºæˆåŠŸå¤±è´¥ï¼š

```javascript
const p1 = Promise.resolve(1)
const p2 = Promise.reject(new Error('å¤±è´¥'))
const p3 = Promise.resolve(3)

Promise.allSettled([p1, p2, p3]).then((results) => {
  console.log(results)
  // [
  //   { status: 'fulfilled', value: 1 },
  //   { status: 'rejected', reason: Error: å¤±è´¥ },
  //   { status: 'fulfilled', value: 3 }
  // ]
})
```

### å®é™…åº”ç”¨

```javascript
// æ‰¹é‡è¯·æ±‚ï¼Œå³ä½¿éƒ¨åˆ†å¤±è´¥ä¹Ÿè¦ç»§ç»­
async function fetchMultiple(urls) {
  const results = await Promise.allSettled(
    urls.map((url) => fetch(url).then((r) => r.json()))
  )

  const successful = results
    .filter((r) => r.status === 'fulfilled')
    .map((r) => r.value)

  const failed = results
    .filter((r) => r.status === 'rejected')
    .map((r) => r.reason)

  return { successful, failed }
}
```

## Promise.any()

ES2021 æ–°å¢ï¼Œè¿”å›ç¬¬ä¸€ä¸ªæˆåŠŸçš„ç»“æœï¼š

```javascript
const p1 = Promise.reject(new Error('å¤±è´¥1'))
const p2 = new Promise((r) => setTimeout(() => r('æˆåŠŸ'), 100))
const p3 = Promise.reject(new Error('å¤±è´¥2'))

Promise.any([p1, p2, p3]).then((value) => console.log(value)) // 'æˆåŠŸ'

// å…¨éƒ¨å¤±è´¥æ—¶æŠ›å‡º AggregateError
Promise.any([
  Promise.reject(new Error('1')),
  Promise.reject(new Error('2')),
]).catch((error) => {
  console.log(error instanceof AggregateError) // true
  console.log(error.errors) // [Error: 1, Error: 2]
})
```

### å®é™…åº”ç”¨

```javascript
// ä»å¤šä¸ªæºè·å–æ•°æ®ï¼Œä½¿ç”¨æœ€å¿«çš„
async function fetchFromAnyMirror(mirrors) {
  try {
    return await Promise.any(
      mirrors.map((url) => fetch(url).then((r) => r.json()))
    )
  } catch (error) {
    throw new Error('æ‰€æœ‰é•œåƒéƒ½å¤±è´¥')
  }
}
```

## é”™è¯¯å¤„ç†æ¨¡å¼

### ç»Ÿä¸€é”™è¯¯å¤„ç†

```javascript
class APIError extends Error {
  constructor(message, status) {
    super(message)
    this.name = 'APIError'
    this.status = status
  }
}

async function fetchAPI(url) {
  const response = await fetch(url)

  if (!response.ok) {
    throw new APIError(`è¯·æ±‚å¤±è´¥: ${response.statusText}`, response.status)
  }

  return response.json()
}

// ä½¿ç”¨
fetchAPI('/api/users')
  .then((data) => console.log(data))
  .catch((error) => {
    if (error instanceof APIError) {
      console.log(`API é”™è¯¯ (${error.status}): ${error.message}`)
    } else {
      console.log('æœªçŸ¥é”™è¯¯:', error)
    }
  })
```

### try-catch æ¨¡å¼

```javascript
async function safeExecute(fn) {
  try {
    const result = await fn()
    return { success: true, data: result }
  } catch (error) {
    return { success: false, error }
  }
}

const result = await safeExecute(() => fetchAPI('/api/users'))

if (result.success) {
  console.log(result.data)
} else {
  console.log('é”™è¯¯:', result.error)
}
```

### Go é£æ ¼é”™è¯¯å¤„ç†

```javascript
function to(promise) {
  return promise.then((data) => [null, data]).catch((err) => [err, null])
}

async function example() {
  const [err, data] = await to(fetchAPI('/api/users'))

  if (err) {
    console.log('é”™è¯¯:', err)
    return
  }

  console.log('æ•°æ®:', data)
}
```

## å¹¶å‘æ§åˆ¶

### é™åˆ¶å¹¶å‘æ•°

```javascript
async function asyncPool(limit, items, fn) {
  const results = []
  const executing = new Set()

  for (const [index, item] of items.entries()) {
    const promise = fn(item, index).then((result) => {
      executing.delete(promise)
      return result
    })

    results.push(promise)
    executing.add(promise)

    if (executing.size >= limit) {
      await Promise.race(executing)
    }
  }

  return Promise.all(results)
}

// ä½¿ç”¨ï¼šåŒæ—¶æœ€å¤š 3 ä¸ªå¹¶å‘è¯·æ±‚
const urls = ['url1', 'url2', 'url3', 'url4', 'url5']
const results = await asyncPool(3, urls, (url) => fetch(url))
```

### é˜Ÿåˆ—æ¨¡å¼

```javascript
class PromiseQueue {
  constructor(concurrency = 1) {
    this.concurrency = concurrency
    this.running = 0
    this.queue = []
  }

  add(fn) {
    return new Promise((resolve, reject) => {
      this.queue.push({ fn, resolve, reject })
      this.run()
    })
  }

  run() {
    while (this.running < this.concurrency && this.queue.length > 0) {
      const { fn, resolve, reject } = this.queue.shift()
      this.running++

      fn()
        .then(resolve)
        .catch(reject)
        .finally(() => {
          this.running--
          this.run()
        })
    }
  }
}

// ä½¿ç”¨
const queue = new PromiseQueue(2)

for (const url of urls) {
  queue.add(() => fetch(url)).then((response) => console.log('å®Œæˆ:', url))
}
```

## Promise å®ç°ç»†èŠ‚

### å¾®ä»»åŠ¡

Promise å›è°ƒåœ¨å¾®ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œï¼š

```javascript
console.log('1')

Promise.resolve().then(() => {
  console.log('2')
})

console.log('3')

// è¾“å‡ºé¡ºåº: 1, 3, 2
```

### å€¼ç©¿é€

```javascript
Promise.resolve(1)
  .then() // æ²¡æœ‰å›è°ƒå‡½æ•°
  .then(2) // éå‡½æ•°å‚æ•°è¢«å¿½ç•¥
  .then((v) => console.log(v)) // 1ï¼ˆå€¼ç©¿é€ï¼‰
```

### Promise é“¾çš„é”™è¯¯æ¢å¤

```javascript
Promise.reject(new Error('å¤±è´¥'))
  .catch((error) => {
    console.log('æ•è·:', error.message)
    return 'æ¢å¤çš„å€¼' // catch è¿”å›å€¼ä¼šè¢«ä¼ é€’
  })
  .then((value) => {
    console.log('ç»§ç»­:', value) // 'æ¢å¤çš„å€¼'
  })
```

## æ–¹æ³•å¯¹æ¯”

| æ–¹æ³•                 | ç‰ˆæœ¬   | è¡Œä¸º               |
| -------------------- | ------ | ------------------ |
| Promise.all()        | ES6    | å…¨éƒ¨æˆåŠŸæˆ–ä»»ä¸€å¤±è´¥ |
| Promise.race()       | ES6    | è¿”å›æœ€å…ˆå®Œæˆçš„     |
| Promise.allSettled() | ES2020 | ç­‰å¾…å…¨éƒ¨å®Œæˆ       |
| Promise.any()        | ES2021 | è¿”å›ç¬¬ä¸€ä¸ªæˆåŠŸçš„   |

```javascript
// å¯¹æ¯”
const p1 = Promise.resolve(1)
const p2 = Promise.reject(2)
const p3 = Promise.resolve(3)

Promise.all([p1, p2, p3]) // reject 2
Promise.race([p1, p2, p3]) // resolve 1
Promise.allSettled([p1, p2, p3]) // resolve [...]
Promise.any([p1, p2, p3]) // resolve 1
```

Promise æ˜¯ JavaScript å¼‚æ­¥ç¼–ç¨‹çš„æ ¸å¿ƒï¼Œç†Ÿç»ƒæŒæ¡å„ç§æ–¹æ³•å’Œæ¨¡å¼å¯¹äºç¼–å†™å¥å£®çš„å¼‚æ­¥ä»£ç è‡³å…³é‡è¦ã€‚
