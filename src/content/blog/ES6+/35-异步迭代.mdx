---
title: 'å¼‚æ­¥è¿­ä»£'
description: 'æ·±å…¥ç†è§£ ES2018 å¼‚æ­¥è¿­ä»£å™¨ã€å¼‚æ­¥ç”Ÿæˆå™¨å’Œ for await...of çš„ä½¿ç”¨åœºæ™¯'
pubDate: 2024-02-04
toc: true
ogImage: true
category: 'ES6+'
tags: ['ES2018', 'å¼‚æ­¥è¿­ä»£', 'for await', 'å¼‚æ­¥ç”Ÿæˆå™¨', 'æµå¤„ç†']
---

ES2018 å¼•å…¥äº†å¼‚æ­¥è¿­ä»£åè®®ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿä»¥åŒæ­¥çš„æ–¹å¼éå†å¼‚æ­¥æ•°æ®æµã€‚

## å¼‚æ­¥è¿­ä»£åè®®

### åŒæ­¥ vs å¼‚æ­¥è¿­ä»£å™¨

```javascript
// åŒæ­¥è¿­ä»£å™¨
const syncIterator = {
  [Symbol.iterator]() {
    let i = 0
    return {
      next() {
        if (i < 3) return { value: i++, done: false }
        return { done: true }
      },
    }
  },
}

// å¼‚æ­¥è¿­ä»£å™¨
const asyncIterator = {
  [Symbol.asyncIterator]() {
    let i = 0
    return {
      async next() {
        await delay(100)
        if (i < 3) return { value: i++, done: false }
        return { done: true }
      },
    }
  },
}

function delay(ms) {
  return new Promise((resolve) => setTimeout(resolve, ms))
}
```

### æ‰‹åŠ¨æ¶ˆè´¹å¼‚æ­¥è¿­ä»£å™¨

```javascript
async function consume() {
  const iterator = asyncIterator[Symbol.asyncIterator]()

  let result = await iterator.next()
  while (!result.done) {
    console.log(result.value)
    result = await iterator.next()
  }
}

consume() // 0, 1, 2ï¼ˆæ¯éš” 100msï¼‰
```

## for await...of

### åŸºæœ¬ç”¨æ³•

```javascript
const asyncIterable = {
  [Symbol.asyncIterator]() {
    let i = 0
    return {
      next() {
        if (i < 3) {
          return Promise.resolve({ value: i++, done: false })
        }
        return Promise.resolve({ done: true })
      },
    }
  },
}

async function example() {
  for await (const value of asyncIterable) {
    console.log(value)
  }
}

example() // 0, 1, 2
```

### éå† Promise æ•°ç»„

```javascript
async function fetchAll() {
  const promises = [
    fetch('/api/1').then((r) => r.json()),
    fetch('/api/2').then((r) => r.json()),
    fetch('/api/3').then((r) => r.json()),
  ]

  // æŒ‰é¡ºåºè·å–ç»“æœ
  for await (const result of promises) {
    console.log(result)
  }
}
```

ğŸ¤” æ³¨æ„ï¼šfor await...of éå† Promise æ•°ç»„æ—¶ï¼Œä¼šæŒ‰æ•°ç»„é¡ºåºè¾“å‡ºï¼Œè€Œä¸æ˜¯æŒ‰å®Œæˆé¡ºåºã€‚

## å¼‚æ­¥ç”Ÿæˆå™¨

### åŸºæœ¬è¯­æ³•

```javascript
async function* asyncGenerator() {
  yield await Promise.resolve(1)
  yield await Promise.resolve(2)
  yield await Promise.resolve(3)
}

async function example() {
  for await (const value of asyncGenerator()) {
    console.log(value)
  }
}

example() // 1, 2, 3
```

### æ¨¡æ‹Ÿæ•°æ®æµ

```javascript
async function* createDataStream() {
  let count = 0
  while (count < 5) {
    // æ¨¡æ‹Ÿå¼‚æ­¥è·å–æ•°æ®
    await delay(500)
    yield { id: count++, timestamp: Date.now() }
  }
}

async function consumeStream() {
  for await (const data of createDataStream()) {
    console.log('æ”¶åˆ°æ•°æ®:', data)
  }
  console.log('æ•°æ®æµç»“æŸ')
}

consumeStream()
```

### åˆ†é¡µæ•°æ®è·å–

```javascript
async function* fetchPages(baseUrl) {
  let page = 1
  let hasMore = true

  while (hasMore) {
    const response = await fetch(`${baseUrl}?page=${page}`)
    const data = await response.json()

    yield data.items

    hasMore = data.hasNextPage
    page++
  }
}

async function getAllItems() {
  const allItems = []

  for await (const items of fetchPages('/api/users')) {
    allItems.push(...items)
    console.log(`è·å–äº† ${items.length} æ¡æ•°æ®`)
  }

  return allItems
}
```

## å®é™…åº”ç”¨åœºæ™¯

### æ–‡ä»¶é€è¡Œè¯»å–ï¼ˆNode.jsï¼‰

```javascript
import { createReadStream } from 'fs'
import { createInterface } from 'readline'

async function* readLines(filePath) {
  const fileStream = createReadStream(filePath)
  const rl = createInterface({
    input: fileStream,
    crlfDelay: Infinity,
  })

  for await (const line of rl) {
    yield line
  }
}

async function processFile() {
  let lineNumber = 0
  for await (const line of readLines('./data.txt')) {
    lineNumber++
    console.log(`${lineNumber}: ${line}`)
  }
}
```

### WebSocket æ¶ˆæ¯æµ

```javascript
async function* createWebSocketStream(url) {
  const ws = new WebSocket(url)

  // ç­‰å¾…è¿æ¥å»ºç«‹
  await new Promise((resolve, reject) => {
    ws.onopen = resolve
    ws.onerror = reject
  })

  // åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—
  const messages = []
  let resolve
  let done = false

  ws.onmessage = (event) => {
    messages.push(event.data)
    if (resolve) {
      resolve()
      resolve = null
    }
  }

  ws.onclose = () => {
    done = true
    if (resolve) resolve()
  }

  try {
    while (!done || messages.length > 0) {
      if (messages.length === 0) {
        await new Promise((r) => {
          resolve = r
        })
      }
      if (messages.length > 0) {
        yield messages.shift()
      }
    }
  } finally {
    ws.close()
  }
}

async function handleMessages() {
  for await (const message of createWebSocketStream('wss://example.com')) {
    console.log('æ”¶åˆ°æ¶ˆæ¯:', message)
  }
}
```

### SSEï¼ˆServer-Sent Eventsï¼‰å¤„ç†

```javascript
async function* createSSEStream(url) {
  const response = await fetch(url)
  const reader = response.body.getReader()
  const decoder = new TextDecoder()

  let buffer = ''

  while (true) {
    const { done, value } = await reader.read()

    if (done) break

    buffer += decoder.decode(value, { stream: true })

    const lines = buffer.split('\n')
    buffer = lines.pop() // ä¿ç•™æœªå®Œæˆçš„è¡Œ

    for (const line of lines) {
      if (line.startsWith('data: ')) {
        yield JSON.parse(line.slice(6))
      }
    }
  }
}

async function consumeSSE() {
  for await (const event of createSSEStream('/api/events')) {
    console.log('SSE äº‹ä»¶:', event)
  }
}
```

### æ‰¹é‡å¤„ç†å¸¦é€Ÿç‡é™åˆ¶

```javascript
async function* batchProcess(items, batchSize, delayMs) {
  for (let i = 0; i < items.length; i += batchSize) {
    const batch = items.slice(i, i + batchSize)

    // å¹¶è¡Œå¤„ç†å½“å‰æ‰¹æ¬¡
    const results = await Promise.all(batch.map((item) => processItem(item)))

    yield* results

    // æ‰¹æ¬¡é—´å»¶è¿Ÿ
    if (i + batchSize < items.length) {
      await delay(delayMs)
    }
  }
}

async function processBatches() {
  const items = Array.from({ length: 100 }, (_, i) => i)

  for await (const result of batchProcess(items, 10, 1000)) {
    console.log('å¤„ç†ç»“æœ:', result)
  }
}
```

## é”™è¯¯å¤„ç†

### try/catch å¤„ç†

```javascript
async function* failingGenerator() {
  yield 1
  yield 2
  throw new Error('ç”Ÿæˆå™¨å†…éƒ¨é”™è¯¯')
  yield 3 // ä¸ä¼šæ‰§è¡Œ
}

async function handleErrors() {
  try {
    for await (const value of failingGenerator()) {
      console.log(value)
    }
  } catch (error) {
    console.error('æ•è·åˆ°é”™è¯¯:', error.message)
  }
}

handleErrors()
// 1
// 2
// æ•è·åˆ°é”™è¯¯: ç”Ÿæˆå™¨å†…éƒ¨é”™è¯¯
```

### åœ¨ç”Ÿæˆå™¨å†…éƒ¨å¤„ç†é”™è¯¯

```javascript
async function* resilientGenerator(urls) {
  for (const url of urls) {
    try {
      const response = await fetch(url)
      yield await response.json()
    } catch (error) {
      yield { error: error.message, url }
    }
  }
}

async function fetchAll() {
  for await (const result of resilientGenerator(urls)) {
    if (result.error) {
      console.error(`è·å– ${result.url} å¤±è´¥:`, result.error)
    } else {
      console.log('æ•°æ®:', result)
    }
  }
}
```

### return å’Œ throw æ–¹æ³•

```javascript
async function* generator() {
  try {
    yield 1
    yield 2
    yield 3
  } finally {
    console.log('æ¸…ç†èµ„æº')
  }
}

async function example() {
  const gen = generator()

  console.log(await gen.next()) // { value: 1, done: false }
  console.log(await gen.return('æå‰ç»“æŸ'))
  // æ¸…ç†èµ„æº
  // { value: 'æå‰ç»“æŸ', done: true }
}
```

## å¹¶å‘æ§åˆ¶

### å¹¶å‘å¼‚æ­¥è¿­ä»£

```javascript
async function* concurrentMap(iterable, fn, concurrency) {
  const iterator = iterable[Symbol.asyncIterator]
    ? iterable[Symbol.asyncIterator]()
    : iterable[Symbol.iterator]()

  const executing = new Set()
  const results = []
  let index = 0

  async function processNext() {
    const { value, done } = await iterator.next()
    if (done) return null

    const currentIndex = index++
    const promise = fn(value, currentIndex).then((result) => ({
      index: currentIndex,
      result,
    }))

    executing.add(promise)
    promise.finally(() => executing.delete(promise))

    return promise
  }

  // åˆå§‹å¡«å……
  for (let i = 0; i < concurrency; i++) {
    const promise = processNext()
    if (promise) executing.add(promise)
  }

  while (executing.size > 0) {
    const { index, result } = await Promise.race(executing)
    results[index] = result
    yield result

    const nextPromise = await processNext()
    if (nextPromise) executing.add(nextPromise)
  }
}

// ä½¿ç”¨
async function example() {
  const items = [1, 2, 3, 4, 5]

  for await (const result of concurrentMap(
    items,
    async (item) => {
      await delay(Math.random() * 1000)
      return item * 2
    },
    3
  )) {
    console.log(result)
  }
}
```

### é™é€Ÿè¿­ä»£

```javascript
async function* throttle(asyncIterable, intervalMs) {
  let lastTime = 0

  for await (const item of asyncIterable) {
    const now = Date.now()
    const elapsed = now - lastTime

    if (elapsed < intervalMs) {
      await delay(intervalMs - elapsed)
    }

    lastTime = Date.now()
    yield item
  }
}

async function example() {
  const fastStream = createFastStream()

  // æ¯ 100ms æœ€å¤šè¾“å‡ºä¸€ä¸ªå€¼
  for await (const value of throttle(fastStream, 100)) {
    console.log(value)
  }
}
```

## å·¥å…·å‡½æ•°

### å¼‚æ­¥è¿­ä»£å™¨è½¬æ•°ç»„

```javascript
async function toArray(asyncIterable) {
  const result = []
  for await (const item of asyncIterable) {
    result.push(item)
  }
  return result
}

const items = await toArray(asyncGenerator())
```

### map/filter ç»„åˆ

```javascript
async function* asyncMap(iterable, fn) {
  for await (const item of iterable) {
    yield await fn(item)
  }
}

async function* asyncFilter(iterable, predicate) {
  for await (const item of iterable) {
    if (await predicate(item)) {
      yield item
    }
  }
}

// é“¾å¼ä½¿ç”¨
const result = asyncFilter(asyncMap(dataStream, transform), validate)

for await (const item of result) {
  console.log(item)
}
```

### take/skip

```javascript
async function* take(iterable, n) {
  let count = 0
  for await (const item of iterable) {
    if (count++ >= n) break
    yield item
  }
}

async function* skip(iterable, n) {
  let count = 0
  for await (const item of iterable) {
    if (count++ < n) continue
    yield item
  }
}

// è·³è¿‡å‰ 5 ä¸ªï¼Œå–æ¥ä¸‹æ¥çš„ 10 ä¸ª
for await (const item of take(skip(dataStream, 5), 10)) {
  console.log(item)
}
```

## å°ç»“

| ç‰¹æ€§                 | è¯´æ˜                     |
| -------------------- | ------------------------ |
| Symbol.asyncIterator | å®šä¹‰å¼‚æ­¥è¿­ä»£å™¨æ¥å£       |
| async function\*     | å¼‚æ­¥ç”Ÿæˆå™¨å‡½æ•°           |
| for await...of       | éå†å¼‚æ­¥å¯è¿­ä»£å¯¹è±¡       |
| yield                | å¼‚æ­¥ç”Ÿæˆå™¨ä¸­æš‚åœå¹¶äº§å‡ºå€¼ |

å¼‚æ­¥è¿­ä»£æ˜¯å¤„ç†æµå¼æ•°æ®ã€åˆ†é¡µæ•°æ®ã€WebSocket æ¶ˆæ¯ç­‰å¼‚æ­¥åºåˆ—çš„å¼ºå¤§å·¥å…·ã€‚
