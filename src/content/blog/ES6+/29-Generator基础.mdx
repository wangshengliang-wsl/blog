---
title: 'Generator åŸºç¡€'
description: 'æŒæ¡ ES6 Generator ç”Ÿæˆå™¨å‡½æ•°çš„åŸºæœ¬è¯­æ³•ã€yield è¡¨è¾¾å¼å’Œ next æ–¹æ³•'
pubDate: 2024-01-29
toc: true
ogImage: true
category: 'ES6+'
tags: ['ES6', 'Generator', 'ç”Ÿæˆå™¨', 'yield', 'è¿­ä»£å™¨']
---

Generatorï¼ˆç”Ÿæˆå™¨ï¼‰æ˜¯ ES6 å¼•å…¥çš„ä¸€ç§ç‰¹æ®Šå‡½æ•°ï¼Œå¯ä»¥æš‚åœæ‰§è¡Œå¹¶åœ¨ç¨åæ¢å¤ã€‚

## åŸºæœ¬è¯­æ³•

### å®šä¹‰ç”Ÿæˆå™¨å‡½æ•°

ä½¿ç”¨ `function*` å®šä¹‰ç”Ÿæˆå™¨å‡½æ•°ï¼š

```javascript
function* myGenerator() {
  yield 1
  yield 2
  yield 3
}

// è°ƒç”¨ç”Ÿæˆå™¨å‡½æ•°è¿”å›ä¸€ä¸ªè¿­ä»£å™¨
const gen = myGenerator()

gen.next() // { value: 1, done: false }
gen.next() // { value: 2, done: false }
gen.next() // { value: 3, done: false }
gen.next() // { value: undefined, done: true }
```

### yield è¡¨è¾¾å¼

`yield` æš‚åœæ‰§è¡Œå¹¶è¿”å›å€¼ï¼š

```javascript
function* greet() {
  console.log('å¼€å§‹')
  yield 'ä½ å¥½'
  console.log('ç»§ç»­')
  yield 'ä¸–ç•Œ'
  console.log('ç»“æŸ')
  return 'å®Œæˆ'
}

const gen = greet()

gen.next()
// è¾“å‡º: å¼€å§‹
// è¿”å›: { value: 'ä½ å¥½', done: false }

gen.next()
// è¾“å‡º: ç»§ç»­
// è¿”å›: { value: 'ä¸–ç•Œ', done: false }

gen.next()
// è¾“å‡º: ç»“æŸ
// è¿”å›: { value: 'å®Œæˆ', done: true }
```

### ä½œä¸ºè¿­ä»£å™¨

ç”Ÿæˆå™¨è‡ªåŠ¨å®ç°äº†è¿­ä»£å™¨åè®®ï¼š

```javascript
function* numbers() {
  yield 1
  yield 2
  yield 3
}

// for...of éå†
for (const n of numbers()) {
  console.log(n) // 1, 2, 3
}

// æ‰©å±•è¿ç®—ç¬¦
;[...numbers()] // [1, 2, 3]

// Array.from
Array.from(numbers()) // [1, 2, 3]
```

## next() çš„å‚æ•°

`next()` çš„å‚æ•°ä¼šæˆä¸ºä¸Šä¸€ä¸ª `yield` è¡¨è¾¾å¼çš„è¿”å›å€¼ï¼š

```javascript
function* conversation() {
  const name = yield 'ä½ å«ä»€ä¹ˆåå­—ï¼Ÿ'
  const age = yield `${name}ï¼Œä½ å¤šå¤§äº†ï¼Ÿ`
  return `${name}ä»Šå¹´${age}å²`
}

const gen = conversation()

gen.next() // { value: 'ä½ å«ä»€ä¹ˆåå­—ï¼Ÿ', done: false }
gen.next('å¼ ä¸‰') // { value: 'å¼ ä¸‰ï¼Œä½ å¤šå¤§äº†ï¼Ÿ', done: false }
gen.next(25) // { value: 'å¼ ä¸‰ä»Šå¹´25å²', done: true }
```

ğŸ¤” æ³¨æ„ï¼šç¬¬ä¸€æ¬¡è°ƒç”¨ `next()` çš„å‚æ•°ä¼šè¢«å¿½ç•¥ï¼Œå› ä¸ºæ­¤æ—¶æ²¡æœ‰ç­‰å¾…çš„ `yield`ã€‚

### å®é™…åº”ç”¨ï¼šç´¯åŠ å™¨

```javascript
function* accumulator() {
  let total = 0
  while (true) {
    const value = yield total
    total += value ?? 0
  }
}

const acc = accumulator()
acc.next() // { value: 0, done: false }
acc.next(10) // { value: 10, done: false }
acc.next(20) // { value: 30, done: false }
acc.next(5) // { value: 35, done: false }
```

## return() å’Œ throw()

### return() æ–¹æ³•

æå‰ç»“æŸç”Ÿæˆå™¨ï¼š

```javascript
function* gen() {
  yield 1
  yield 2
  yield 3
}

const g = gen()
g.next() // { value: 1, done: false }
g.return('æå‰ç»“æŸ') // { value: 'æå‰ç»“æŸ', done: true }
g.next() // { value: undefined, done: true }
```

### throw() æ–¹æ³•

åœ¨ç”Ÿæˆå™¨å†…éƒ¨æŠ›å‡ºé”™è¯¯ï¼š

```javascript
function* gen() {
  try {
    yield 1
    yield 2
  } catch (e) {
    console.log('æ•è·é”™è¯¯:', e)
  }
  yield 3
}

const g = gen()
g.next() // { value: 1, done: false }
g.throw(new Error('å‡ºé”™äº†')) // æ•è·é”™è¯¯: Error: å‡ºé”™äº†
// { value: 3, done: false }
```

## yield\* è¡¨è¾¾å¼

`yield*` ç”¨äºå§”æ‰˜ç»™å¦ä¸€ä¸ªç”Ÿæˆå™¨æˆ–å¯è¿­ä»£å¯¹è±¡ï¼š

```javascript
function* inner() {
  yield 'a'
  yield 'b'
}

function* outer() {
  yield 1
  yield* inner() // å§”æ‰˜ç»™ inner
  yield 2
}

;[...outer()] // [1, 'a', 'b', 2]
```

### éå†åµŒå¥—æ•°ç»„

```javascript
function* flatten(arr) {
  for (const item of arr) {
    if (Array.isArray(item)) {
      yield* flatten(item)
    } else {
      yield item
    }
  }
}

;[...flatten([1, [2, [3, 4]], 5])] // [1, 2, 3, 4, 5]
```

### éå†æ ‘ç»“æ„

```javascript
function* traverseTree(node) {
  yield node.value
  if (node.children) {
    for (const child of node.children) {
      yield* traverseTree(child)
    }
  }
}

const tree = {
  value: 1,
  children: [
    { value: 2, children: [{ value: 4 }, { value: 5 }] },
    { value: 3, children: [{ value: 6 }] },
  ],
}

;[...traverseTree(tree)] // [1, 2, 4, 5, 3, 6]
```

## å®ç”¨æ¡ˆä¾‹

### æ— é™åºåˆ—

```javascript
// è‡ªç„¶æ•°
function* naturals() {
  let n = 1
  while (true) {
    yield n++
  }
}

// æ–æ³¢é‚£å¥‘æ•°åˆ—
function* fibonacci() {
  let [prev, curr] = [0, 1]
  while (true) {
    yield curr
    ;[prev, curr] = [curr, prev + curr]
  }
}

// å–å‰ n ä¸ª
function take(generator, n) {
  const result = []
  for (const value of generator) {
    if (result.length >= n) break
    result.push(value)
  }
  return result
}

take(fibonacci(), 10) // [1, 1, 2, 3, 5, 8, 13, 21, 34, 55]
```

### èŒƒå›´ç”Ÿæˆå™¨

```javascript
function* range(start, end, step = 1) {
  if (step > 0) {
    for (let i = start; i <= end; i += step) {
      yield i
    }
  } else {
    for (let i = start; i >= end; i += step) {
      yield i
    }
  }
}

;[...range(1, 5)] // [1, 2, 3, 4, 5]
;[...range(0, 10, 2)] // [0, 2, 4, 6, 8, 10]
;[...range(5, 1, -1)] // [5, 4, 3, 2, 1]
```

### å”¯ä¸€ ID ç”Ÿæˆå™¨

```javascript
function* idGenerator(prefix = '') {
  let id = 1
  while (true) {
    yield `${prefix}${id++}`
  }
}

const userIdGen = idGenerator('user_')
userIdGen.next().value // 'user_1'
userIdGen.next().value // 'user_2'

const orderIdGen = idGenerator('order_')
orderIdGen.next().value // 'order_1'
```

### åˆ†é¡µæ•°æ®åŠ è½½

```javascript
function* paginate(fetchPage) {
  let page = 1
  let hasMore = true

  while (hasMore) {
    const data = yield fetchPage(page)
    if (data && data.length > 0) {
      page++
    } else {
      hasMore = false
    }
  }
}

// ä½¿ç”¨ç¤ºä¾‹
async function loadAllData() {
  const gen = paginate(async (page) => {
    const response = await fetch(`/api/items?page=${page}`)
    return response.json()
  })

  const allItems = []
  let result = gen.next()

  while (!result.done) {
    const data = await result.value
    if (data.length === 0) {
      result = gen.next([])
    } else {
      allItems.push(...data)
      result = gen.next(data)
    }
  }

  return allItems
}
```

### çŠ¶æ€æœº

```javascript
function* trafficLight() {
  while (true) {
    yield 'çº¢ç¯'
    yield 'ç»¿ç¯'
    yield 'é»„ç¯'
  }
}

const light = trafficLight()
light.next().value // 'çº¢ç¯'
light.next().value // 'ç»¿ç¯'
light.next().value // 'é»„ç¯'
light.next().value // 'çº¢ç¯'
```

## ç”Ÿæˆå™¨æ–¹æ³•

åœ¨å¯¹è±¡å’Œç±»ä¸­å®šä¹‰ç”Ÿæˆå™¨æ–¹æ³•ï¼š

```javascript
// å¯¹è±¡æ–¹æ³•
const obj = {
  *generator() {
    yield 1
    yield 2
  },
}

// ç±»æ–¹æ³•
class MyClass {
  *[Symbol.iterator]() {
    yield 1
    yield 2
    yield 3
  }
}

;[...new MyClass()] // [1, 2, 3]
```

## å°ç»“

| ç‰¹æ€§       | è¯´æ˜                   |
| ---------- | ---------------------- |
| function\* | å®šä¹‰ç”Ÿæˆå™¨å‡½æ•°         |
| yield      | æš‚åœæ‰§è¡Œå¹¶è¿”å›å€¼       |
| yield\*    | å§”æ‰˜ç»™å¦ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡ |
| next()     | æ¢å¤æ‰§è¡Œï¼Œå¯ä¼ å‚       |
| return()   | æå‰ç»“æŸç”Ÿæˆå™¨         |
| throw()    | åœ¨ç”Ÿæˆå™¨å†…æŠ›å‡ºé”™è¯¯     |

ç”Ÿæˆå™¨æ˜¯å®ç°è¿­ä»£å™¨çš„ç®€æ´æ–¹å¼ï¼Œä¹Ÿæ˜¯ç†è§£ async/await çš„åŸºç¡€ã€‚
