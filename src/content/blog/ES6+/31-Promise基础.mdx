---
title: 'Promise åŸºç¡€'
description: 'æ·±å…¥ç†è§£ ES6 Promise çš„ä¸‰ç§çŠ¶æ€ã€then/catch é“¾å¼è°ƒç”¨ä¸é”™è¯¯å¤„ç†'
pubDate: 2024-01-31
toc: true
ogImage: true
category: 'ES6+'
tags: ['ES6', 'Promise', 'å¼‚æ­¥', 'then', 'catch']
---

Promise æ˜¯ ES6 å¼•å…¥çš„å¼‚æ­¥ç¼–ç¨‹è§£å†³æ–¹æ¡ˆï¼Œè§£å†³äº†å›è°ƒåœ°ç‹±é—®é¢˜ã€‚

## å›è°ƒåœ°ç‹±

Promise ä¹‹å‰ï¼Œå¼‚æ­¥æ“ä½œä¾èµ–å›è°ƒï¼š

```javascript
// å›è°ƒåœ°ç‹±
getData(function (a) {
  getMoreData(a, function (b) {
    getMoreData(b, function (c) {
      getMoreData(c, function (d) {
        // æ·±å±‚åµŒå¥—...
      })
    })
  })
})
```

## åˆ›å»º Promise

### åŸºæœ¬è¯­æ³•

```javascript
const promise = new Promise((resolve, reject) => {
  // å¼‚æ­¥æ“ä½œ
  setTimeout(() => {
    const success = true
    if (success) {
      resolve('æˆåŠŸçš„ç»“æœ')
    } else {
      reject(new Error('å¤±è´¥çš„åŸå› '))
    }
  }, 1000)
})
```

### ä¸‰ç§çŠ¶æ€

Promise æœ‰ä¸‰ç§çŠ¶æ€ï¼ŒçŠ¶æ€ä¸€æ—¦æ”¹å˜å°±ä¸å¯é€†ï¼š

```javascript
// pendingï¼ˆè¿›è¡Œä¸­ï¼‰-> fulfilledï¼ˆå·²æˆåŠŸï¼‰
// pendingï¼ˆè¿›è¡Œä¸­ï¼‰-> rejectedï¼ˆå·²å¤±è´¥ï¼‰

const p1 = new Promise((resolve, reject) => {
  resolve('æˆåŠŸ') // çŠ¶æ€å˜ä¸º fulfilled
  reject('å¤±è´¥') // æ— æ•ˆï¼ŒçŠ¶æ€å·²ç»æ”¹å˜
})

const p2 = new Promise((resolve, reject) => {
  reject('å¤±è´¥') // çŠ¶æ€å˜ä¸º rejected
  resolve('æˆåŠŸ') // æ— æ•ˆ
})
```

## then() æ–¹æ³•

### åŸºæœ¬ç”¨æ³•

```javascript
promise.then(
  (value) => {
    // fulfilled æ—¶æ‰§è¡Œ
    console.log('æˆåŠŸ:', value)
  },
  (reason) => {
    // rejected æ—¶æ‰§è¡Œ
    console.log('å¤±è´¥:', reason)
  }
)

// åªå¤„ç†æˆåŠŸ
promise.then((value) => {
  console.log('æˆåŠŸ:', value)
})
```

### é“¾å¼è°ƒç”¨

`then()` è¿”å›æ–°çš„ Promiseï¼Œæ”¯æŒé“¾å¼è°ƒç”¨ï¼š

```javascript
Promise.resolve(1)
  .then((value) => {
    console.log(value) // 1
    return value + 1
  })
  .then((value) => {
    console.log(value) // 2
    return value + 1
  })
  .then((value) => {
    console.log(value) // 3
  })
```

### è¿”å›å€¼è§„åˆ™

```javascript
// è¿”å›æ™®é€šå€¼
Promise.resolve(1)
  .then((v) => v + 1)
  .then((v) => console.log(v)) // 2

// è¿”å› Promise
Promise.resolve(1)
  .then((v) => Promise.resolve(v + 1))
  .then((v) => console.log(v)) // 2

// è¿”å› thenable å¯¹è±¡
Promise.resolve(1)
  .then((v) => ({
    then(resolve) {
      resolve(v + 1)
    },
  }))
  .then((v) => console.log(v)) // 2
```

## catch() æ–¹æ³•

`catch()` æ˜¯ `then(null, rejection)` çš„è¯­æ³•ç³–ï¼š

```javascript
promise
  .then((value) => {
    console.log('æˆåŠŸ:', value)
  })
  .catch((error) => {
    console.log('å¤±è´¥:', error)
  })

// ç­‰ä»·äº
promise.then(
  (value) => console.log('æˆåŠŸ:', value),
  (error) => console.log('å¤±è´¥:', error)
)
```

### é”™è¯¯å†’æ³¡

é”™è¯¯ä¼šæ²¿ç€é“¾å‘ä¸‹ä¼ é€’ï¼Œç›´åˆ°è¢«æ•è·ï¼š

```javascript
Promise.resolve()
  .then(() => {
    throw new Error('é”™è¯¯1')
  })
  .then(() => {
    console.log('ä¸ä¼šæ‰§è¡Œ')
  })
  .catch((err) => {
    console.log('æ•è·:', err.message) // æ•è·: é”™è¯¯1
  })
```

### æ¨èç”¨æ³•

æ€»æ˜¯ä½¿ç”¨ `catch()` è€Œä¸æ˜¯ `then` çš„ç¬¬äºŒä¸ªå‚æ•°ï¼š

```javascript
// ä¸æ¨è
promise.then(
  (value) => {
    // è¿™é‡ŒæŠ›å‡ºçš„é”™è¯¯ä¸ä¼šè¢«ç¬¬äºŒä¸ªå‚æ•°æ•è·
    throw new Error('å¤„ç†æ—¶å‡ºé”™')
  },
  (error) => {
    console.log('åªèƒ½æ•è· promise çš„é”™è¯¯')
  }
)

// æ¨è
promise
  .then((value) => {
    throw new Error('å¤„ç†æ—¶å‡ºé”™')
  })
  .catch((error) => {
    // å¯ä»¥æ•è·æ‰€æœ‰é”™è¯¯
    console.log('æ•è·:', error.message)
  })
```

## finally() æ–¹æ³•

æ— è®ºæˆåŠŸå¤±è´¥éƒ½ä¼šæ‰§è¡Œï¼š

```javascript
promise
  .then((value) => {
    console.log('æˆåŠŸ:', value)
  })
  .catch((error) => {
    console.log('å¤±è´¥:', error)
  })
  .finally(() => {
    console.log('æ¸…ç†å·¥ä½œ')
  })
```

`finally()` çš„ç‰¹ç‚¹ï¼š

```javascript
// ä¸æ¥æ”¶å‚æ•°
Promise.resolve(1)
  .finally(() => {
    // ä¸çŸ¥é“æ˜¯æˆåŠŸè¿˜æ˜¯å¤±è´¥
  })
  .then((value) => console.log(value)) // 1

// ä¼šä¼ é€’å€¼
Promise.resolve(1)
  .finally(() => {
    return 2 // è¿”å›å€¼è¢«å¿½ç•¥
  })
  .then((value) => console.log(value)) // 1

// æŠ›å‡ºé”™è¯¯ä¼šä¼ é€’
Promise.resolve(1)
  .finally(() => {
    throw new Error('finally å‡ºé”™')
  })
  .catch((err) => console.log(err.message)) // finally å‡ºé”™
```

## Promise.resolve()

åˆ›å»ºä¸€ä¸ªå·²å®Œæˆçš„ Promiseï¼š

```javascript
// æ™®é€šå€¼
Promise.resolve(1).then((v) => console.log(v)) // 1

// Promiseï¼ˆåŸæ ·è¿”å›ï¼‰
const p = Promise.resolve(1)
Promise.resolve(p) === p // true

// thenable å¯¹è±¡
Promise.resolve({
  then(resolve) {
    resolve('thenable')
  },
}).then((v) => console.log(v)) // 'thenable'
```

## Promise.reject()

åˆ›å»ºä¸€ä¸ªå·²æ‹’ç»çš„ Promiseï¼š

```javascript
Promise.reject(new Error('å¤±è´¥')).catch((err) => console.log(err.message)) // 'å¤±è´¥'

// æ³¨æ„ï¼šreject ä¸ä¼šè§£åŒ…å‚æ•°
Promise.reject(Promise.resolve(1)).catch((v) => console.log(v)) // Promise {<fulfilled>: 1}
```

## å®æˆ˜åº”ç”¨

### å°è£…å¼‚æ­¥æ“ä½œ

```javascript
function fetchJSON(url) {
  return new Promise((resolve, reject) => {
    fetch(url)
      .then((response) => {
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`)
        }
        return response.json()
      })
      .then(resolve)
      .catch(reject)
  })
}

// æ›´ç®€æ´çš„å†™æ³•
async function fetchJSON(url) {
  const response = await fetch(url)
  if (!response.ok) {
    throw new Error(`HTTP ${response.status}`)
  }
  return response.json()
}
```

### è¶…æ—¶æ§åˆ¶

```javascript
function timeout(promise, ms) {
  return Promise.race([
    promise,
    new Promise((_, reject) =>
      setTimeout(() => reject(new Error('Timeout')), ms)
    ),
  ])
}

timeout(fetch('/api/data'), 5000)
  .then((response) => response.json())
  .catch((error) => {
    if (error.message === 'Timeout') {
      console.log('è¯·æ±‚è¶…æ—¶')
    }
  })
```

### å»¶è¿Ÿæ‰§è¡Œ

```javascript
function delay(ms) {
  return new Promise((resolve) => setTimeout(resolve, ms))
}

async function example() {
  console.log('å¼€å§‹')
  await delay(1000)
  console.log('1ç§’å')
  await delay(2000)
  console.log('å†è¿‡2ç§’')
}
```

### é‡è¯•æœºåˆ¶

```javascript
function retry(fn, maxAttempts = 3, delay = 1000) {
  return new Promise((resolve, reject) => {
    function attempt(n) {
      fn()
        .then(resolve)
        .catch((error) => {
          if (n >= maxAttempts) {
            reject(error)
          } else {
            console.log(`å°è¯• ${n} å¤±è´¥ï¼Œ${delay}ms åé‡è¯•`)
            setTimeout(() => attempt(n + 1), delay)
          }
        })
    }
    attempt(1)
  })
}

retry(() => fetch('/api/unstable'))
  .then((response) => console.log('æˆåŠŸ'))
  .catch((error) => console.log('å…¨éƒ¨å¤±è´¥'))
```

## å¸¸è§é”™è¯¯

### ğŸ”¶ å¿˜è®° return

```javascript
// é”™è¯¯ï¼šæ²¡æœ‰ returnï¼Œä¸‹ä¸€ä¸ª then æ”¶åˆ° undefined
Promise.resolve()
  .then(() => {
    fetch('/api/data') // å¿˜è®° return
  })
  .then((data) => {
    console.log(data) // undefined
  })

// æ­£ç¡®
Promise.resolve()
  .then(() => {
    return fetch('/api/data')
  })
  .then((response) => response.json())
```

### ğŸ”¶ åœ¨ then ä¸­åµŒå¥— Promise

```javascript
// ä¸æ¨è
promise.then((value) => {
  fetchData().then((data) => {
    // åµŒå¥—...
  })
})

// æ¨è
promise
  .then((value) => fetchData())
  .then((data) => {
    // æ‰å¹³åŒ–
  })
```

### ğŸ”¶ æ²¡æœ‰å¤„ç†é”™è¯¯

```javascript
// é”™è¯¯å¯èƒ½è¢«é™é»˜åæ‰
promise.then((value) => {
  throw new Error('æœªå¤„ç†çš„é”™è¯¯')
})

// æ€»æ˜¯æ·»åŠ  catch
promise
  .then((value) => {
    throw new Error('é”™è¯¯')
  })
  .catch((error) => {
    console.error(error)
  })
```

## å°ç»“

| æ–¹æ³•              | è¯´æ˜                 |
| ----------------- | -------------------- |
| new Promise()     | åˆ›å»º Promise         |
| then()            | æˆåŠŸå›è°ƒ             |
| catch()           | é”™è¯¯å¤„ç†             |
| finally()         | æœ€ç»ˆæ‰§è¡Œ             |
| Promise.resolve() | åˆ›å»ºå·²å®Œæˆçš„ Promise |
| Promise.reject()  | åˆ›å»ºå·²æ‹’ç»çš„ Promise |

Promise æ˜¯ç°ä»£ JavaScript å¼‚æ­¥ç¼–ç¨‹çš„åŸºç¡€ï¼Œç†è§£å®ƒçš„å·¥ä½œåŸç†å¯¹äºæŒæ¡ async/await è‡³å…³é‡è¦ã€‚
