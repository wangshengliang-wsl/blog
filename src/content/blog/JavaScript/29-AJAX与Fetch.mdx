---
title: 'AJAX ä¸ Fetch'
description: 'æŒæ¡ JavaScript ç½‘ç»œè¯·æ±‚ï¼Œç†è§£ XMLHttpRequest å’Œ Fetch API'
pubDate: 2025-12-03
toc: true
ogImage: true
category: 'JavaScript'
tags: ['JavaScript', 'AJAX', 'Fetch', 'ç½‘ç»œè¯·æ±‚']
---

AJAXï¼ˆAsynchronous JavaScript and XMLï¼‰æ˜¯å®ç°ç½‘é¡µå¼‚æ­¥æ•°æ®äº¤äº’çš„æŠ€æœ¯ã€‚ç°ä»£å¼€å‘ä¸­ï¼ŒFetch API å·²æˆä¸ºé¦–é€‰çš„ç½‘ç»œè¯·æ±‚æ–¹å¼ã€‚

## ğŸ¯ XMLHttpRequest

### åŸºæœ¬ç”¨æ³•

```javascript
// åˆ›å»º XHR å¯¹è±¡
const xhr = new XMLHttpRequest()

// é…ç½®è¯·æ±‚
xhr.open('GET', '/api/users', true) // true è¡¨ç¤ºå¼‚æ­¥

// è®¾ç½®å“åº”å¤„ç†
xhr.onload = function () {
  if (xhr.status >= 200 && xhr.status < 300) {
    const data = JSON.parse(xhr.responseText)
    console.log('æˆåŠŸ:', data)
  } else {
    console.error('HTTP é”™è¯¯:', xhr.status)
  }
}

xhr.onerror = function () {
  console.error('ç½‘ç»œé”™è¯¯')
}

// å‘é€è¯·æ±‚
xhr.send()
```

### å‘é€ POST è¯·æ±‚

```javascript
const xhr = new XMLHttpRequest()
xhr.open('POST', '/api/users')

// è®¾ç½®è¯·æ±‚å¤´
xhr.setRequestHeader('Content-Type', 'application/json')

xhr.onload = function () {
  if (xhr.status === 201) {
    console.log('åˆ›å»ºæˆåŠŸ')
  }
}

// å‘é€ JSON æ•°æ®
const data = { name: 'å¼ ä¸‰', age: 25 }
xhr.send(JSON.stringify(data))
```

### è¯·æ±‚çŠ¶æ€

```javascript
const xhr = new XMLHttpRequest()

xhr.onreadystatechange = function () {
  console.log('çŠ¶æ€:', xhr.readyState)
  // 0: æœªåˆå§‹åŒ–
  // 1: å·²æ‰“å¼€ï¼ˆopen è°ƒç”¨åï¼‰
  // 2: å·²å‘é€ï¼ˆsend è°ƒç”¨åï¼‰
  // 3: æ¥æ”¶ä¸­ï¼ˆéƒ¨åˆ†å“åº”ï¼‰
  // 4: å®Œæˆï¼ˆå“åº”å®Œæˆï¼‰

  if (xhr.readyState === 4 && xhr.status === 200) {
    console.log('è¯·æ±‚å®Œæˆ')
  }
}

xhr.open('GET', '/api/data')
xhr.send()
```

### è¶…æ—¶å’Œå–æ¶ˆ

```javascript
const xhr = new XMLHttpRequest()
xhr.open('GET', '/api/slow')

// è®¾ç½®è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰
xhr.timeout = 5000

xhr.ontimeout = function () {
  console.error('è¯·æ±‚è¶…æ—¶')
}

xhr.send()

// å–æ¶ˆè¯·æ±‚
setTimeout(() => {
  xhr.abort()
  console.log('è¯·æ±‚å·²å–æ¶ˆ')
}, 3000)
```

### ä¸Šä¼ è¿›åº¦

```javascript
const xhr = new XMLHttpRequest()
xhr.open('POST', '/api/upload')

// ä¸Šä¼ è¿›åº¦
xhr.upload.onprogress = function (e) {
  if (e.lengthComputable) {
    const percent = (e.loaded / e.total) * 100
    console.log(`ä¸Šä¼ è¿›åº¦: ${percent.toFixed(2)}%`)
  }
}

// ä¸‹è½½è¿›åº¦
xhr.onprogress = function (e) {
  if (e.lengthComputable) {
    const percent = (e.loaded / e.total) * 100
    console.log(`ä¸‹è½½è¿›åº¦: ${percent.toFixed(2)}%`)
  }
}

const formData = new FormData()
formData.append('file', fileInput.files[0])
xhr.send(formData)
```

### XHR å°è£…

```javascript
function ajax(options) {
  return new Promise((resolve, reject) => {
    const { method = 'GET', url, data, headers = {}, timeout = 10000 } = options

    const xhr = new XMLHttpRequest()
    xhr.open(method, url)
    xhr.timeout = timeout

    // è®¾ç½®è¯·æ±‚å¤´
    for (const [key, value] of Object.entries(headers)) {
      xhr.setRequestHeader(key, value)
    }

    xhr.onload = () => {
      if (xhr.status >= 200 && xhr.status < 300) {
        try {
          resolve(JSON.parse(xhr.responseText))
        } catch {
          resolve(xhr.responseText)
        }
      } else {
        reject(new Error(`HTTP ${xhr.status}`))
      }
    }

    xhr.onerror = () => reject(new Error('ç½‘ç»œé”™è¯¯'))
    xhr.ontimeout = () => reject(new Error('è¯·æ±‚è¶…æ—¶'))

    if (data) {
      xhr.setRequestHeader('Content-Type', 'application/json')
      xhr.send(JSON.stringify(data))
    } else {
      xhr.send()
    }
  })
}

// ä½¿ç”¨
ajax({
  method: 'POST',
  url: '/api/users',
  data: { name: 'å¼ ä¸‰' },
}).then((data) => console.log(data))
```

## Fetch API

### åŸºæœ¬ç”¨æ³•

```javascript
// GET è¯·æ±‚
fetch('/api/users')
  .then((response) => {
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`)
    }
    return response.json()
  })
  .then((data) => console.log(data))
  .catch((error) => console.error(error))

// async/await æ–¹å¼
async function getUsers() {
  try {
    const response = await fetch('/api/users')
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`)
    }
    const data = await response.json()
    return data
  } catch (error) {
    console.error('è¯·æ±‚å¤±è´¥:', error)
  }
}
```

### POST è¯·æ±‚

```javascript
// å‘é€ JSON
async function createUser(user) {
  const response = await fetch('/api/users', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(user),
  })

  if (!response.ok) {
    throw new Error(`HTTP ${response.status}`)
  }

  return response.json()
}

createUser({ name: 'å¼ ä¸‰', age: 25 })

// å‘é€ FormData
async function uploadFile(file) {
  const formData = new FormData()
  formData.append('file', file)

  const response = await fetch('/api/upload', {
    method: 'POST',
    body: formData, // ä¸è¦è®¾ç½® Content-Type
  })

  return response.json()
}
```

### è¯·æ±‚é…ç½®

```javascript
fetch('/api/data', {
  method: 'POST', // GET, POST, PUT, DELETE, PATCH
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer token123',
  },
  body: JSON.stringify(data),
  mode: 'cors', // cors, no-cors, same-origin
  credentials: 'include', // omit, same-origin, include
  cache: 'no-cache', // default, no-cache, reload, force-cache
  redirect: 'follow', // follow, error, manual
  signal: abortController.signal, // å–æ¶ˆä¿¡å·
})
```

### å“åº”å¤„ç†

```javascript
const response = await fetch('/api/data')

// å“åº”çŠ¶æ€
console.log(response.status) // 200
console.log(response.statusText) // 'OK'
console.log(response.ok) // true (200-299)
console.log(response.url) // æœ€ç»ˆ URL

// å“åº”å¤´
console.log(response.headers.get('Content-Type'))
for (const [key, value] of response.headers) {
  console.log(`${key}: ${value}`)
}

// è§£æå“åº”ä½“ï¼ˆåªèƒ½è¯»å–ä¸€æ¬¡ï¼‰
const json = await response.json() // JSON
const text = await response.text() // æ–‡æœ¬
const blob = await response.blob() // Blob
const buffer = await response.arrayBuffer() // ArrayBuffer
const formData = await response.formData() // FormData

// å…‹éš†å“åº”ï¼ˆå¯å¤šæ¬¡è¯»å–ï¼‰
const cloned = response.clone()
const json1 = await response.json()
const json2 = await cloned.json()
```

### å–æ¶ˆè¯·æ±‚

```javascript
// ä½¿ç”¨ AbortController
const controller = new AbortController()

fetch('/api/slow', {
  signal: controller.signal,
})
  .then((response) => response.json())
  .catch((error) => {
    if (error.name === 'AbortError') {
      console.log('è¯·æ±‚è¢«å–æ¶ˆ')
    } else {
      console.error('è¯·æ±‚å¤±è´¥:', error)
    }
  })

// å–æ¶ˆè¯·æ±‚
setTimeout(() => {
  controller.abort()
}, 3000)

// è¶…æ—¶å°è£…
function fetchWithTimeout(url, options = {}, timeout = 5000) {
  const controller = new AbortController()
  const timeoutId = setTimeout(() => controller.abort(), timeout)

  return fetch(url, {
    ...options,
    signal: controller.signal,
  }).finally(() => clearTimeout(timeoutId))
}
```

### å¹¶å‘è¯·æ±‚

```javascript
// Promise.all - å…¨éƒ¨æˆåŠŸæ‰æˆåŠŸ
async function fetchAll() {
  try {
    const [users, posts] = await Promise.all([
      fetch('/api/users').then((r) => r.json()),
      fetch('/api/posts').then((r) => r.json()),
    ])
    return { users, posts }
  } catch (error) {
    console.error('è‡³å°‘ä¸€ä¸ªè¯·æ±‚å¤±è´¥')
  }
}

// Promise.allSettled - è·å–æ‰€æœ‰ç»“æœ
async function fetchAllSettled() {
  const results = await Promise.allSettled([
    fetch('/api/users').then((r) => r.json()),
    fetch('/api/posts').then((r) => r.json()),
  ])

  results.forEach((result, index) => {
    if (result.status === 'fulfilled') {
      console.log(`è¯·æ±‚ ${index} æˆåŠŸ:`, result.value)
    } else {
      console.log(`è¯·æ±‚ ${index} å¤±è´¥:`, result.reason)
    }
  })
}

// Promise.race - è¿”å›æœ€å¿«çš„ç»“æœ
async function fetchFastest() {
  return Promise.race([
    fetch('/api/server1').then((r) => r.json()),
    fetch('/api/server2').then((r) => r.json()),
  ])
}
```

## Fetch å°è£…

### åŸºç¡€å°è£…

```javascript
class Http {
  constructor(baseURL = '') {
    this.baseURL = baseURL
    this.defaultHeaders = {
      'Content-Type': 'application/json',
    }
  }

  async request(url, options = {}) {
    const { headers = {}, ...rest } = options

    const response = await fetch(this.baseURL + url, {
      ...rest,
      headers: {
        ...this.defaultHeaders,
        ...headers,
      },
    })

    if (!response.ok) {
      const error = new Error(`HTTP ${response.status}`)
      error.response = response
      throw error
    }

    const contentType = response.headers.get('Content-Type')
    if (contentType?.includes('application/json')) {
      return response.json()
    }
    return response.text()
  }

  get(url, options) {
    return this.request(url, { ...options, method: 'GET' })
  }

  post(url, data, options) {
    return this.request(url, {
      ...options,
      method: 'POST',
      body: JSON.stringify(data),
    })
  }

  put(url, data, options) {
    return this.request(url, {
      ...options,
      method: 'PUT',
      body: JSON.stringify(data),
    })
  }

  delete(url, options) {
    return this.request(url, { ...options, method: 'DELETE' })
  }
}

// ä½¿ç”¨
const http = new Http('/api')
const users = await http.get('/users')
await http.post('/users', { name: 'å¼ ä¸‰' })
```

### æ‹¦æˆªå™¨

```javascript
class Http {
  constructor(baseURL = '') {
    this.baseURL = baseURL
    this.interceptors = {
      request: [],
      response: [],
    }
  }

  useRequestInterceptor(fn) {
    this.interceptors.request.push(fn)
  }

  useResponseInterceptor(onSuccess, onError) {
    this.interceptors.response.push({ onSuccess, onError })
  }

  async request(url, options = {}) {
    // è¯·æ±‚æ‹¦æˆª
    let config = { url: this.baseURL + url, ...options }
    for (const interceptor of this.interceptors.request) {
      config = await interceptor(config)
    }

    try {
      let response = await fetch(config.url, config)

      // å“åº”æ‹¦æˆªï¼ˆæˆåŠŸï¼‰
      for (const { onSuccess } of this.interceptors.response) {
        if (onSuccess) {
          response = await onSuccess(response)
        }
      }

      return response
    } catch (error) {
      // å“åº”æ‹¦æˆªï¼ˆé”™è¯¯ï¼‰
      for (const { onError } of this.interceptors.response) {
        if (onError) {
          error = await onError(error)
        }
      }
      throw error
    }
  }
}

// ä½¿ç”¨
const http = new Http('/api')

// æ·»åŠ  token
http.useRequestInterceptor((config) => {
  const token = localStorage.getItem('token')
  if (token) {
    config.headers = {
      ...config.headers,
      Authorization: `Bearer ${token}`,
    }
  }
  return config
})

// å¤„ç†ï¿½ï¿½ï¿½åº”
http.useResponseInterceptor(
  async (response) => {
    if (!response.ok) {
      if (response.status === 401) {
        // è·³è½¬ç™»å½•
        location.href = '/login'
      }
      throw new Error(`HTTP ${response.status}`)
    }
    return response.json()
  },
  (error) => {
    console.error('è¯·æ±‚å¤±è´¥:', error)
    throw error
  }
)
```

### è¯·æ±‚é‡è¯•

```javascript
async function fetchWithRetry(url, options = {}, retries = 3) {
  for (let i = 0; i < retries; i++) {
    try {
      const response = await fetch(url, options)
      if (response.ok) return response
      throw new Error(`HTTP ${response.status}`)
    } catch (error) {
      if (i === retries - 1) throw error
      // æŒ‡æ•°é€€é¿
      await new Promise((r) => setTimeout(r, 1000 * Math.pow(2, i)))
    }
  }
}

// ä½¿ç”¨
fetchWithRetry('/api/unstable', {}, 3)
  .then((r) => r.json())
  .catch((e) => console.error('æ‰€æœ‰é‡è¯•å¤±è´¥'))
```

## å®é™…åº”ç”¨

### RESTful API å®¢æˆ·ç«¯

```javascript
class ApiClient {
  constructor(baseURL) {
    this.baseURL = baseURL
  }

  async request(endpoint, options = {}) {
    const url = `${this.baseURL}${endpoint}`
    const config = {
      headers: {
        'Content-Type': 'application/json',
        ...options.headers,
      },
      ...options,
    }

    const response = await fetch(url, config)

    if (!response.ok) {
      const error = await response.json().catch(() => ({}))
      throw new Error(error.message || `HTTP ${response.status}`)
    }

    return response.json()
  }

  // CRUD æ“ä½œ
  getAll(resource) {
    return this.request(`/${resource}`)
  }

  getOne(resource, id) {
    return this.request(`/${resource}/${id}`)
  }

  create(resource, data) {
    return this.request(`/${resource}`, {
      method: 'POST',
      body: JSON.stringify(data),
    })
  }

  update(resource, id, data) {
    return this.request(`/${resource}/${id}`, {
      method: 'PUT',
      body: JSON.stringify(data),
    })
  }

  delete(resource, id) {
    return this.request(`/${resource}/${id}`, {
      method: 'DELETE',
    })
  }
}

// ä½¿ç”¨
const api = new ApiClient('https://api.example.com')

const users = await api.getAll('users')
const user = await api.getOne('users', 1)
await api.create('users', { name: 'å¼ ä¸‰' })
await api.update('users', 1, { name: 'æå››' })
await api.delete('users', 1)
```

### å¸¦ç¼“å­˜çš„è¯·æ±‚

```javascript
const cache = new Map()

async function cachedFetch(url, options = {}, maxAge = 60000) {
  const cacheKey = `${options.method || 'GET'}-${url}`
  const cached = cache.get(cacheKey)

  if (cached && Date.now() - cached.timestamp < maxAge) {
    return cached.data
  }

  const response = await fetch(url, options)
  const data = await response.json()

  cache.set(cacheKey, {
    data,
    timestamp: Date.now(),
  })

  return data
}

// ä½¿ç”¨
const data = await cachedFetch('/api/config', {}, 300000) // ç¼“å­˜ 5 åˆ†é’Ÿ
```

### è¯·æ±‚é˜Ÿåˆ—

```javascript
class RequestQueue {
  constructor(concurrency = 3) {
    this.concurrency = concurrency
    this.queue = []
    this.running = 0
  }

  add(promiseFn) {
    return new Promise((resolve, reject) => {
      this.queue.push({ promiseFn, resolve, reject })
      this.run()
    })
  }

  run() {
    while (this.running < this.concurrency && this.queue.length) {
      const { promiseFn, resolve, reject } = this.queue.shift()
      this.running++

      promiseFn()
        .then(resolve)
        .catch(reject)
        .finally(() => {
          this.running--
          this.run()
        })
    }
  }
}

// ä½¿ç”¨ï¼šé™åˆ¶å¹¶å‘è¯·æ±‚æ•°
const queue = new RequestQueue(3)

const urls = ['/api/1', '/api/2', '/api/3', '/api/4', '/api/5']
const results = await Promise.all(
  urls.map((url) => queue.add(() => fetch(url).then((r) => r.json())))
)
```

## æ€»ç»“

| ç‰¹æ€§          | XMLHttpRequest | Fetch           |
| ------------- | -------------- | --------------- |
| API é£æ ¼      | å›è°ƒ           | Promise         |
| å–æ¶ˆè¯·æ±‚      | xhr.abort()    | AbortController |
| è¿›åº¦äº‹ä»¶      | æ”¯æŒ           | ä¸æ”¯æŒ          |
| è¶…æ—¶è®¾ç½®      | xhr.timeout    | éœ€è¦å°è£…        |
| è¯·æ±‚/å“åº”æ‹¦æˆª | éœ€è¦å°è£…       | éœ€è¦å°è£…        |

| Fetch é…ç½®    | è¯´æ˜         |
| ------------- | ------------ |
| `method`      | è¯·æ±‚æ–¹æ³•     |
| `headers`     | è¯·æ±‚å¤´       |
| `body`        | è¯·æ±‚ä½“       |
| `mode`        | CORS æ¨¡å¼    |
| `credentials` | æ˜¯å¦æºå¸¦å‡­è¯ |
| `signal`      | å–æ¶ˆä¿¡å·     |

**æ ¸å¿ƒè¦ç‚¹**ï¼š

- Fetch è¿”å› Promiseï¼Œæ›´ç¬¦åˆç°ä»£ç¼–ç¨‹é£æ ¼
- æ£€æŸ¥ response.ok åˆ¤æ–­è¯·æ±‚æ˜¯å¦æˆåŠŸ
- å“åº”ä½“åªèƒ½è¯»å–ä¸€æ¬¡ï¼Œéœ€è¦æ—¶å…ˆ clone()
- ä½¿ç”¨ AbortController å–æ¶ˆè¯·æ±‚
- å°è£…æ—¶æ³¨æ„æ·»åŠ è¶…æ—¶ã€é‡è¯•ã€æ‹¦æˆªå™¨ç­‰åŠŸèƒ½
