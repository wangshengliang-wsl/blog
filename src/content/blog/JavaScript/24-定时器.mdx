---
title: 'å®šæ—¶å™¨'
description: 'æŒæ¡ JavaScript å®šæ—¶å™¨çš„ä½¿ç”¨ï¼Œç†è§£ setTimeoutã€setInterval å’Œ requestAnimationFrame'
pubDate: 2025-12-03
toc: true
ogImage: true
category: 'JavaScript'
tags: ['JavaScript', 'å®šæ—¶å™¨', 'setTimeout', 'setInterval']
---

å®šæ—¶å™¨æ˜¯ JavaScript ä¸­å®ç°å»¶è¿Ÿæ‰§è¡Œå’Œå‘¨æœŸæ‰§è¡Œçš„æ ¸å¿ƒæœºåˆ¶ã€‚ç†è§£å®šæ—¶å™¨çš„å·¥ä½œåŸç†å¯¹äºç¼–å†™å¼‚æ­¥ä»£ç è‡³å…³é‡è¦ã€‚

## ğŸ¯ setTimeout

### åŸºæœ¬ç”¨æ³•

```javascript
// å»¶è¿Ÿæ‰§è¡Œä¸€æ¬¡
setTimeout(function () {
  console.log('3ç§’åæ‰§è¡Œ')
}, 3000)

// ç®­å¤´å‡½æ•°
setTimeout(() => {
  console.log('2ç§’åæ‰§è¡Œ')
}, 2000)

// è¿”å›å®šæ—¶å™¨ ID
const timerId = setTimeout(() => {
  console.log('æ‰§è¡Œ')
}, 1000)

console.log(timerId) // æ•°å­— ID
```

### ä¼ é€’å‚æ•°

```javascript
// æ–¹å¼1ï¼šé€šè¿‡ setTimeout çš„é¢å¤–å‚æ•°
setTimeout(
  (name, age) => {
    console.log(`å§“å: ${name}, å¹´é¾„: ${age}`)
  },
  1000,
  'å¼ ä¸‰',
  25
)

// æ–¹å¼2ï¼šé—­åŒ…
const name = 'æå››'
setTimeout(() => {
  console.log(name) // å¯ä»¥è®¿é—®å¤–éƒ¨å˜é‡
}, 1000)

// ğŸ”¶ ä¸è¦ç”¨å­—ç¬¦ä¸²ï¼ˆæœ‰å®‰å…¨é£é™©ï¼Œæ€§èƒ½å·®ï¼‰
setTimeout('console.log("ä¸æ¨è")', 1000)
```

### å–æ¶ˆå®šæ—¶å™¨

```javascript
const timerId = setTimeout(() => {
  console.log('ä¸ä¼šæ‰§è¡Œ')
}, 5000)

// å–æ¶ˆå®šæ—¶å™¨
clearTimeout(timerId)

// å®é™…åº”ç”¨ï¼šé˜²æ­¢é‡å¤æäº¤
let submitTimer = null

function handleSubmit() {
  if (submitTimer) {
    clearTimeout(submitTimer)
  }

  submitTimer = setTimeout(() => {
    // æäº¤é€»è¾‘
    console.log('æäº¤')
  }, 300)
}
```

### æœ€å°å»¶è¿Ÿæ—¶é—´

```javascript
// å»¶è¿Ÿæ—¶é—´æœ€å°çº¦ä¸º 4msï¼ˆæµè§ˆå™¨é™åˆ¶ï¼‰
setTimeout(() => console.log('1'), 0)
setTimeout(() => console.log('2'), 0)
console.log('3')

// è¾“å‡ºé¡ºåºï¼š3, 1, 2
// å³ä½¿è®¾ä¸º 0ï¼Œä¹Ÿä¸ä¼šç«‹å³æ‰§è¡Œ

// åµŒå¥— setTimeout åœ¨ 5 å±‚åå¼ºåˆ¶æœ€å° 4ms
function nested(n) {
  if (n === 0) return
  setTimeout(() => nested(n - 1), 0)
}
```

## setInterval

### åŸºæœ¬ç”¨æ³•

```javascript
// æ¯éš”æŒ‡ï¿½ï¿½ï¿½æ—¶é—´é‡å¤æ‰§è¡Œ
const intervalId = setInterval(() => {
  console.log('æ¯ç§’æ‰§è¡Œä¸€æ¬¡')
}, 1000)

// å–æ¶ˆå®šæ—¶å™¨
// clearInterval(intervalId)
```

### å®ç°è®¡æ•°å™¨

```javascript
let count = 0
const maxCount = 5

const intervalId = setInterval(() => {
  count++
  console.log(`è®¡æ•°: ${count}`)

  if (count >= maxCount) {
    clearInterval(intervalId)
    console.log('è®¡æ•°å®Œæˆ')
  }
}, 1000)
```

### ğŸ”¶ setInterval çš„é—®é¢˜

```javascript
// é—®é¢˜1ï¼šå›è°ƒæ‰§è¡Œæ—¶é—´ä¸è®¡å…¥é—´éš”
setInterval(() => {
  // å¦‚æœè¿™é‡Œæ‰§è¡Œéœ€è¦ 500ms
  // å®é™…é—´éš”ä¼šå°äºè®¾å®šçš„é—´éš”
  heavyTask()
}, 1000)

// é—®é¢˜2ï¼šé”™è¿‡çš„æ‰§è¡Œä¼šå †ç§¯
// å¦‚æœé¡µé¢è¢«éšè—ï¼Œå›æ¥åå¯èƒ½å¿«é€Ÿæ‰§è¡Œå¤šæ¬¡

// âœ… è§£å†³æ–¹æ¡ˆï¼šç”¨ setTimeout é€’å½’æ›¿ä»£
function betterInterval(callback, delay) {
  function loop() {
    callback()
    setTimeout(loop, delay)
  }
  setTimeout(loop, delay)
}

// æˆ–è€…ä½¿ç”¨è‡ªæ ¡å‡†çš„ setInterval
function accurateInterval(callback, delay) {
  let expected = Date.now() + delay

  function step() {
    const drift = Date.now() - expected
    callback()
    expected += delay
    setTimeout(step, Math.max(0, delay - drift))
  }

  setTimeout(step, delay)
}
```

## requestAnimationFrame

### åŸºæœ¬ç”¨æ³•

```javascript
// åœ¨ä¸‹æ¬¡é‡ç»˜ä¹‹å‰è°ƒç”¨ï¼ˆé€šå¸¸ 60fpsï¼Œçº¦ 16.67msï¼‰
function animate() {
  // åŠ¨ç”»é€»è¾‘
  console.log('åŠ¨ç”»å¸§')

  // ç»§ç»­ä¸‹ä¸€å¸§
  requestAnimationFrame(animate)
}

// å¼€å§‹åŠ¨ç”»
requestAnimationFrame(animate)
```

### ä¼˜åŠ¿

```javascript
// âœ… è‡ªåŠ¨ä¸æ˜¾ç¤ºå™¨åˆ·æ–°ç‡åŒæ­¥
// âœ… é¡µé¢éšè—æ—¶è‡ªåŠ¨æš‚åœï¼ŒèŠ‚çœèµ„æº
// âœ… æµè§ˆå™¨ä¼˜åŒ–ï¼Œæ›´æµç•…

// è·å–å¸§ ID å¹¶å–æ¶ˆ
const frameId = requestAnimationFrame(animate)
cancelAnimationFrame(frameId)
```

### å®ç°å¹³æ»‘åŠ¨ç”»

```javascript
// ç§»åŠ¨å…ƒç´ 
function moveElement(element, targetX, duration) {
  const startX = element.offsetLeft
  const distance = targetX - startX
  const startTime = performance.now()

  function animate(currentTime) {
    const elapsed = currentTime - startTime
    const progress = Math.min(elapsed / duration, 1)

    // ç¼“åŠ¨å‡½æ•°ï¼ˆease-outï¼‰
    const easeProgress = 1 - Math.pow(1 - progress, 3)

    element.style.left = startX + distance * easeProgress + 'px'

    if (progress < 1) {
      requestAnimationFrame(animate)
    }
  }

  requestAnimationFrame(animate)
}

// ä½¿ç”¨
const box = document.getElementById('box')
moveElement(box, 500, 1000) // 1ç§’å†…ç§»åŠ¨åˆ° x=500
```

### å¸§ç‡æ§åˆ¶

```javascript
// é™åˆ¶å¸§ç‡ï¼ˆä¾‹å¦‚ 30fpsï¼‰
function animateWithFPS(callback, fps) {
  const interval = 1000 / fps
  let lastTime = 0

  function loop(currentTime) {
    requestAnimationFrame(loop)

    const delta = currentTime - lastTime
    if (delta >= interval) {
      lastTime = currentTime - (delta % interval)
      callback(delta)
    }
  }

  requestAnimationFrame(loop)
}

// ä½¿ç”¨
animateWithFPS((delta) => {
  console.log(`å¸§é—´éš”: ${delta}ms`)
}, 30)
```

## å®é™…åº”ç”¨

### é˜²æŠ–ï¼ˆDebounceï¼‰

```javascript
// å»¶è¿Ÿæ‰§è¡Œï¼Œé‡å¤è§¦å‘ä¼šé‡æ–°è®¡æ—¶
function debounce(fn, delay) {
  let timer = null

  return function (...args) {
    if (timer) clearTimeout(timer)

    timer = setTimeout(() => {
      fn.apply(this, args)
    }, delay)
  }
}

// ä½¿ç”¨ï¼šæœç´¢æ¡†è¾“å…¥
const search = debounce((keyword) => {
  console.log('æœç´¢:', keyword)
  // å‘èµ·è¯·æ±‚
}, 300)

input.addEventListener('input', (e) => {
  search(e.target.value)
})
```

### èŠ‚æµï¼ˆThrottleï¼‰

```javascript
// é™åˆ¶æ‰§è¡Œé¢‘ç‡ï¼Œå›ºå®šæ—¶é—´å†…åªæ‰§è¡Œä¸€æ¬¡
function throttle(fn, delay) {
  let lastTime = 0

  return function (...args) {
    const now = Date.now()

    if (now - lastTime >= delay) {
      lastTime = now
      fn.apply(this, args)
    }
  }
}

// ä½¿ç”¨ï¼šæ»šåŠ¨äº‹ä»¶
const handleScroll = throttle(() => {
  console.log('æ»šåŠ¨ä½ç½®:', window.scrollY)
}, 100)

window.addEventListener('scroll', handleScroll)
```

### å€’è®¡æ—¶

```javascript
function countdown(seconds, onTick, onComplete) {
  let remaining = seconds

  function tick() {
    onTick(remaining)

    if (remaining > 0) {
      remaining--
      setTimeout(tick, 1000)
    } else {
      onComplete()
    }
  }

  tick()
}

// ä½¿ç”¨
countdown(
  10,
  (sec) => console.log(`å‰©ä½™ ${sec} ç§’`),
  () => console.log('å€’è®¡æ—¶ç»“æŸ')
)
```

### è½®è¯¢

```javascript
// å®šæœŸæ£€æŸ¥çŠ¶æ€
function poll(fn, interval, maxAttempts = Infinity) {
  let attempts = 0

  return new Promise((resolve, reject) => {
    function check() {
      attempts++

      Promise.resolve(fn())
        .then((result) => {
          if (result) {
            resolve(result)
          } else if (attempts >= maxAttempts) {
            reject(new Error('è¶…è¿‡æœ€å¤§å°è¯•æ¬¡æ•°'))
          } else {
            setTimeout(check, interval)
          }
        })
        .catch(reject)
    }

    check()
  })
}

// ä½¿ç”¨ï¼šç­‰å¾…ä»»åŠ¡å®Œæˆ
poll(
  async () => {
    const status = await checkTaskStatus()
    return status === 'completed'
  },
  2000, // æ¯ 2 ç§’æ£€æŸ¥
  30 // æœ€å¤š 30 æ¬¡
)
```

### å»¶è¿ŸåŠ è½½

```javascript
// å»¶è¿ŸåŠ è½½å›¾ç‰‡
function lazyLoadImages() {
  const images = document.querySelectorAll('img[data-src]')

  const loadImage = (img) => {
    img.src = img.dataset.src
    img.removeAttribute('data-src')
  }

  // ä½¿ç”¨ Intersection Observer
  const observer = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        // å°å»¶è¿Ÿï¼Œé¿å…æ»šåŠ¨è¿‡å¿«æ—¶åŠ è½½è¿‡å¤š
        setTimeout(() => loadImage(entry.target), 100)
        observer.unobserve(entry.target)
      }
    })
  })

  images.forEach((img) => observer.observe(img))
}
```

### è‡ªåŠ¨ä¿å­˜

```javascript
class AutoSave {
  constructor(saveFunction, delay = 2000) {
    this.saveFunction = saveFunction
    this.delay = delay
    this.timer = null
    this.isDirty = false
  }

  markDirty() {
    this.isDirty = true
    this.scheduleSave()
  }

  scheduleSave() {
    if (this.timer) {
      clearTimeout(this.timer)
    }

    this.timer = setTimeout(() => {
      if (this.isDirty) {
        this.saveFunction()
        this.isDirty = false
      }
    }, this.delay)
  }

  saveNow() {
    if (this.timer) {
      clearTimeout(this.timer)
    }
    if (this.isDirty) {
      this.saveFunction()
      this.isDirty = false
    }
  }
}

// ä½¿ç”¨
const autoSave = new AutoSave(() => {
  console.log('ä¿å­˜æ•°æ®')
})

textarea.addEventListener('input', () => {
  autoSave.markDirty()
})

// é¡µé¢å…³é—­å‰ç«‹å³ä¿å­˜
window.addEventListener('beforeunload', () => {
  autoSave.saveNow()
})
```

## å®šæ—¶å™¨ä¸ï¿½ï¿½ï¿½ä»¶å¾ªç¯

```javascript
// å®šæ—¶å™¨å›è°ƒè¿›å…¥å®ä»»åŠ¡é˜Ÿåˆ—
console.log('1')

setTimeout(() => {
  console.log('2')
}, 0)

Promise.resolve().then(() => {
  console.log('3')
})

console.log('4')

// è¾“å‡ºé¡ºåºï¼š1, 4, 3, 2
// åŒæ­¥ä»£ç  > å¾®ä»»åŠ¡ï¿½ï¿½Promiseï¼‰> å®ä»»åŠ¡ï¼ˆsetTimeoutï¼‰
```

### æ‰§è¡Œé¡ºåº

```javascript
setTimeout(() => console.log('timeout1'), 0)
setTimeout(() => console.log('timeout2'), 0)

Promise.resolve()
  .then(() => console.log('promise1'))
  .then(() => console.log('promise2'))

console.log('sync')

// è¾“å‡ºï¼š
// sync
// promise1
// promise2
// timeout1
// timeout2
```

## æ³¨æ„äº‹é¡¹

### this ç»‘å®š

```javascript
const obj = {
  name: 'å¯¹è±¡',
  greet() {
    // ğŸ”¶ æ™®é€šå‡½æ•°ä¼šä¸¢å¤± this
    setTimeout(function () {
      console.log(this.name) // undefined
    }, 1000)

    // âœ… ç®­å¤´å‡½æ•°ä¿æŒ this
    setTimeout(() => {
      console.log(this.name) // 'å¯¹è±¡'
    }, 1000)

    // âœ… bind ç»‘å®š
    setTimeout(
      function () {
        console.log(this.name) // 'å¯¹è±¡'
      }.bind(this),
      1000
    )
  },
}
```

### æ¸…ç†å®šæ—¶å™¨

```javascript
// ç»„ä»¶å¸è½½æ—¶æ¸…ç†
class Component {
  constructor() {
    this.timers = []
  }

  setTimeout(fn, delay) {
    const id = setTimeout(fn, delay)
    this.timers.push({ type: 'timeout', id })
    return id
  }

  setInterval(fn, delay) {
    const id = setInterval(fn, delay)
    this.timers.push({ type: 'interval', id })
    return id
  }

  destroy() {
    this.timers.forEach(({ type, id }) => {
      if (type === 'timeout') {
        clearTimeout(id)
      } else {
        clearInterval(id)
      }
    })
    this.timers = []
  }
}
```

### é¿å…é•¿æ—¶é—´å®šæ—¶å™¨

```javascript
// ğŸ”¶ æµè§ˆå™¨å¯¹é•¿æ—¶é—´å®šæ—¶å™¨å¯èƒ½ä¸å‡†ç¡®
setTimeout(() => {
  console.log('1å°æ—¶å')
}, 3600000) // 1å°æ—¶

// âœ… å¯¹äºé•¿æ—¶é—´ä»»åŠ¡ï¼Œä½¿ç”¨çŸ­é—´éš”æ£€æŸ¥
function scheduleAt(targetTime, callback) {
  function check() {
    const remaining = targetTime - Date.now()

    if (remaining <= 0) {
      callback()
    } else if (remaining > 60000) {
      // è¿˜æœ‰è¶…è¿‡1åˆ†é’Ÿï¼Œ1åˆ†é’Ÿåå†æ£€æŸ¥
      setTimeout(check, 60000)
    } else {
      // ä¸åˆ°1åˆ†é’Ÿï¼Œç²¾ç¡®ç­‰å¾…
      setTimeout(callback, remaining)
    }
  }

  check()
}
```

## æ€»ç»“

| æ–¹æ³•                    | ç”¨é€”         | ç²¾åº¦             |
| ----------------------- | ------------ | ---------------- |
| `setTimeout`            | å»¶è¿Ÿæ‰§è¡Œä¸€æ¬¡ | â‰¥4ms             |
| `setInterval`           | å‘¨æœŸæ‰§è¡Œ     | â‰¥4ms             |
| `requestAnimationFrame` | åŠ¨ç”»         | ~16.67ms (60fps) |

| åœºæ™¯      | æ¨èæ–¹æ³•              |
| --------- | --------------------- |
| å»¶è¿Ÿæ‰§è¡Œ  | setTimeout            |
| åŠ¨ç”»æ•ˆæœ  | requestAnimationFrame |
| å®šæ—¶ä»»åŠ¡  | setTimeout é€’å½’       |
| é˜²æŠ–/èŠ‚æµ | setTimeout            |
| å€’è®¡æ—¶    | setTimeout é€’å½’       |

**æ ¸å¿ƒè¦ç‚¹**ï¼š

- setTimeout/setInterval è¿”å› ID ç”¨äºå–æ¶ˆ
- requestAnimationFrame æ›´é€‚åˆåŠ¨ç”»
- é¿å… setInterval çš„æ—¶é—´ç´¯ç§¯é—®é¢˜
- æ³¨æ„ this ç»‘å®šå’Œå†…å­˜æ³„æ¼
- å®šæ—¶å™¨å›è°ƒæ˜¯å®ä»»åŠ¡
