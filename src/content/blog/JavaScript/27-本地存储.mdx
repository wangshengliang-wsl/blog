---
title: 'æœ¬åœ°å­˜å‚¨'
description: 'æŒæ¡æµè§ˆå™¨æœ¬åœ°å­˜å‚¨æ–¹æ¡ˆï¼Œç†è§£ localStorageã€sessionStorage å’Œ Cookie'
pubDate: 2025-12-03
toc: true
ogImage: true
category: 'JavaScript'
tags: ['JavaScript', 'localStorage', 'sessionStorage', 'Cookie']
---

æµè§ˆå™¨æä¾›äº†å¤šç§æœ¬åœ°å­˜å‚¨æ–¹æ¡ˆï¼Œç”¨äºåœ¨å®¢æˆ·ç«¯ä¿å­˜æ•°æ®ã€‚äº†è§£å®ƒä»¬çš„ç‰¹ç‚¹å’Œä½¿ç”¨åœºæ™¯ï¼Œæ‰èƒ½é€‰æ‹©åˆé€‚çš„å­˜å‚¨æ–¹å¼ã€‚

## ğŸ¯ å­˜å‚¨æ–¹æ¡ˆå¯¹æ¯”

| ç‰¹æ€§     | localStorage | sessionStorage | Cookie         |
| -------- | ------------ | -------------- | -------------- |
| å®¹é‡     | çº¦ 5MB       | çº¦ 5MB         | çº¦ 4KB         |
| ç”Ÿå‘½å‘¨æœŸ | æ°¸ä¹…         | æ ‡ç­¾é¡µå…³é—­     | å¯è®¾ç½®è¿‡æœŸæ—¶é—´ |
| è¯·æ±‚æºå¸¦ | å¦           | å¦             | è‡ªåŠ¨æºå¸¦       |
| ä½œç”¨åŸŸ   | åŒæºå…±äº«     | ä»…å½“å‰æ ‡ç­¾é¡µ   | å¯è®¾ç½®è·¯å¾„å’ŒåŸŸ |
| API      | ç®€å•         | ç®€å•           | è¾ƒå¤æ‚         |

## localStorage

### åŸºæœ¬æ“ä½œ

```javascript
// å­˜å‚¨æ•°æ®
localStorage.setItem('username', 'å¼ ä¸‰')

// è¯»å–æ•°æ®
const username = localStorage.getItem('username')
console.log(username) // 'å¼ ä¸‰'

// åˆ é™¤æ•°æ®
localStorage.removeItem('username')

// æ¸…ç©ºæ‰€æœ‰æ•°æ®
localStorage.clear()

// è·å–å­˜å‚¨é¡¹æ•°é‡
console.log(localStorage.length)

// è·å–ç¬¬ n ä¸ªé”®å
console.log(localStorage.key(0))
```

### å­˜å‚¨å¯¹è±¡

```javascript
// ğŸ”¶ localStorage åªèƒ½å­˜å‚¨å­—ç¬¦ä¸²
localStorage.setItem('user', { name: 'å¼ ä¸‰' })
localStorage.getItem('user') // '[object Object]'ï¼ˆé”™è¯¯ï¼‰

// âœ… ä½¿ç”¨ JSON åºåˆ—åŒ–
const user = { name: 'å¼ ä¸‰', age: 25 }
localStorage.setItem('user', JSON.stringify(user))

const stored = localStorage.getItem('user')
const parsedUser = JSON.parse(stored)
console.log(parsedUser.name) // 'å¼ ä¸‰'
```

### å°è£…å·¥å…·ç±»

```javascript
const storage = {
  set(key, value, expires) {
    const data = {
      value,
      expires: expires ? Date.now() + expires : null,
    }
    localStorage.setItem(key, JSON.stringify(data))
  },

  get(key, defaultValue = null) {
    const item = localStorage.getItem(key)
    if (!item) return defaultValue

    try {
      const data = JSON.parse(item)

      // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
      if (data.expires && Date.now() > data.expires) {
        localStorage.removeItem(key)
        return defaultValue
      }

      return data.value
    } catch {
      return defaultValue
    }
  },

  remove(key) {
    localStorage.removeItem(key)
  },

  clear() {
    localStorage.clear()
  },

  has(key) {
    return localStorage.getItem(key) !== null
  },
}

// ä½¿ç”¨
storage.set('token', 'abc123', 3600000) // 1å°æ—¶åè¿‡æœŸ
storage.get('token') // 'abc123'
```

### ç›‘å¬å­˜å‚¨å˜åŒ–

```javascript
// ç›‘å¬å…¶ï¿½ï¿½æ ‡ç­¾é¡µçš„å­˜å‚¨å˜åŒ–
window.addEventListener('storage', (event) => {
  console.log('é”®:', event.key)
  console.log('æ—§å€¼:', event.oldValue)
  console.log('æ–°å€¼:', event.newValue)
  console.log('æ¥æº:', event.url)
})

// ğŸ”¶ æ³¨æ„ï¼šåŒä¸€æ ‡ç­¾é¡µçš„å˜åŒ–ä¸ä¼šè§¦å‘
// åªæœ‰å…¶ä»–æ ‡ç­¾é¡µä¿®æ”¹æ—¶æ‰è§¦å‘

// å®ç°è·¨æ ‡ç­¾é¡µé€šä¿¡
function broadcast(type, data) {
  localStorage.setItem(
    'broadcast',
    JSON.stringify({
      type,
      data,
      timestamp: Date.now(),
    })
  )
  localStorage.removeItem('broadcast')
}

window.addEventListener('storage', (event) => {
  if (event.key === 'broadcast' && event.newValue) {
    const { type, data } = JSON.parse(event.newValue)
    handleBroadcast(type, data)
  }
})
```

## sessionStorage

### åŸºæœ¬ç”¨æ³•

```javascript
// API ä¸ localStorage ç›¸åŒ
sessionStorage.setItem('tempData', 'value')
sessionStorage.getItem('tempData')
sessionStorage.removeItem('tempData')
sessionStorage.clear()

// åŒºåˆ«ï¼šå…³é—­æ ‡ç­¾é¡µåæ•°æ®æ¶ˆå¤±
// åˆ·æ–°é¡µé¢æ•°æ®ä¿ç•™
```

### ä½¿ç”¨åœºæ™¯

```javascript
// 1. è¡¨å•æ•°æ®ä¸´æ—¶ä¿å­˜
const form = document.getElementById('myForm')

// ä¿å­˜è¡¨å•çŠ¶æ€
form.addEventListener('input', () => {
  const formData = new FormData(form)
  const data = Object.fromEntries(formData)
  sessionStorage.setItem('formDraft', JSON.stringify(data))
})

// æ¢å¤è¡¨å•çŠ¶æ€
const draft = sessionStorage.getItem('formDraft')
if (draft) {
  const data = JSON.parse(draft)
  Object.entries(data).forEach(([name, value]) => {
    const input = form.elements[name]
    if (input) input.value = value
  })
}

// æäº¤åæ¸…é™¤
form.addEventListener('submit', () => {
  sessionStorage.removeItem('formDraft')
})

// 2. é¡µé¢é—´ä¼ é€’ï¿½ï¿½æ®
// é¡µé¢ A
sessionStorage.setItem('selectedItem', JSON.stringify({ id: 1, name: 'å•†å“' }))
location.href = '/detail'

// é¡µé¢ B
const item = JSON.parse(sessionStorage.getItem('selectedItem'))
console.log(item.name)

// 3. ä¸€æ¬¡æ€§æç¤º
if (!sessionStorage.getItem('welcomeShown')) {
  showWelcomeMessage()
  sessionStorage.setItem('welcomeShown', 'true')
}
```

## Cookie

### è¯»å– Cookie

```javascript
// è·å–æ‰€æœ‰ Cookieï¼ˆå­—ç¬¦ä¸²ï¼‰
document.cookie
// 'name=å¼ ä¸‰; token=abc123; theme=dark'

// è§£æ Cookie
function getCookie(name) {
  const cookies = document.cookie.split('; ')
  for (const cookie of cookies) {
    const [key, value] = cookie.split('=')
    if (key === name) {
      return decodeURIComponent(value)
    }
  }
  return null
}

getCookie('name') // 'å¼ ä¸‰'

// è·å–æ‰€æœ‰ Cookie ä¸ºå¯¹è±¡
function getAllCookies() {
  return document.cookie.split('; ').reduce((obj, cookie) => {
    const [key, value] = cookie.split('=')
    obj[key] = decodeURIComponent(value)
    return obj
  }, {})
}
```

### è®¾ç½® Cookie

```javascript
// åŸºæœ¬è®¾ç½®
document.cookie = 'name=å¼ ä¸‰'

// è®¾ç½®è¿‡æœŸæ—¶é—´
const expires = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // 7å¤©å
document.cookie = `name=å¼ ä¸‰; expires=${expires.toUTCString()}`

// ä½¿ç”¨ max-ageï¼ˆç§’ï¼‰
document.cookie = 'name=å¼ ä¸‰; max-age=604800' // 7å¤©

// è®¾ç½®è·¯å¾„
document.cookie = 'name=å¼ ä¸‰; path=/'

// è®¾ç½®åŸŸ
document.cookie = 'name=å¼ ä¸‰; domain=.example.com'

// å®‰å…¨æ ‡å¿—
document.cookie = 'token=abc; secure' // ä»… HTTPS
document.cookie = 'token=abc; httpOnly' // ä»…æœåŠ¡å™¨å¯è®¿é—®ï¼ˆJS æ— æ³•è®¾ç½®ï¼‰
document.cookie = 'token=abc; samesite=strict' // é˜²æ­¢ CSRF

// å®Œæ•´ç¤ºä¾‹
function setCookie(name, value, options = {}) {
  const {
    expires,
    maxAge,
    path = '/',
    domain,
    secure,
    sameSite = 'lax',
  } = options

  let cookie = `${encodeURIComponent(name)}=${encodeURIComponent(value)}`

  if (expires) {
    cookie += `; expires=${expires.toUTCString()}`
  }
  if (maxAge !== undefined) {
    cookie += `; max-age=${maxAge}`
  }
  cookie += `; path=${path}`
  if (domain) {
    cookie += `; domain=${domain}`
  }
  if (secure) {
    cookie += '; secure'
  }
  cookie += `; samesite=${sameSite}`

  document.cookie = cookie
}

setCookie('user', 'zhangsan', { maxAge: 86400 }) // 1å¤©
```

### åˆ é™¤ Cookie

```javascript
// è®¾ç½®è¿‡æœŸæ—¶é—´ä¸ºè¿‡å»
function deleteCookie(name, path = '/') {
  document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=${path}`
}

deleteCookie('name')

// æˆ–ä½¿ç”¨ max-age=0
document.cookie = 'name=; max-age=0; path=/'
```

### Cookie å·¥å…·ç±»

```javascript
const cookie = {
  get(name) {
    const cookies = document.cookie.split('; ')
    for (const c of cookies) {
      const [key, value] = c.split('=')
      if (key === name) {
        return decodeURIComponent(value)
      }
    }
    return null
  },

  set(name, value, days = 7) {
    const maxAge = days * 24 * 60 * 60
    document.cookie = `${encodeURIComponent(name)}=${encodeURIComponent(value)}; max-age=${maxAge}; path=/; samesite=lax`
  },

  remove(name) {
    document.cookie = `${name}=; max-age=0; path=/`
  },

  has(name) {
    return this.get(name) !== null
  },
}

cookie.set('theme', 'dark', 30) // 30å¤©
cookie.get('theme') // 'dark'
cookie.remove('theme')
```

## IndexedDBï¼ˆç®€ä»‹ï¼‰

```javascript
// IndexedDB é€‚åˆå­˜å‚¨å¤§é‡ç»“æ„åŒ–æ•°æ®

// æ‰“å¼€æ•°æ®åº“
const request = indexedDB.open('MyDatabase', 1)

request.onerror = () => console.error('æ•°æ®åº“æ‰“å¼€å¤±è´¥')

request.onupgradeneeded = (event) => {
  const db = event.target.result
  // åˆ›å»ºå¯¹è±¡å­˜å‚¨ï¼ˆè¡¨ï¼‰
  if (!db.objectStoreNames.contains('users')) {
    db.createObjectStore('users', { keyPath: 'id' })
  }
}

request.onsuccess = (event) => {
  const db = event.target.result

  // æ·»åŠ æ•°æ®
  const transaction = db.transaction(['users'], 'readwrite')
  const store = transaction.objectStore('users')
  store.add({ id: 1, name: 'å¼ ä¸‰', age: 25 })

  // è¯»å–æ•°æ®
  const getRequest = store.get(1)
  getRequest.onsuccess = () => {
    console.log(getRequest.result)
  }
}

// æ›´æ¨èä½¿ç”¨å°è£…åº“å¦‚ idbã€Dexie.js
```

## å®é™…åº”ç”¨

### ç”¨æˆ·åå¥½è®¾ç½®

```javascript
const preferences = {
  defaults: {
    theme: 'light',
    fontSize: 16,
    language: 'zh-CN',
  },

  load() {
    const stored = localStorage.getItem('preferences')
    return stored ? { ...this.defaults, ...JSON.parse(stored) } : this.defaults
  },

  save(prefs) {
    localStorage.setItem('preferences', JSON.stringify(prefs))
  },

  get(key) {
    return this.load()[key]
  },

  set(key, value) {
    const current = this.load()
    current[key] = value
    this.save(current)
  },

  reset() {
    localStorage.removeItem('preferences')
  },
}

// ï¿½ï¿½ç”¨
preferences.set('theme', 'dark')
preferences.get('theme') // 'dark'
```

### ç™»å½•çŠ¶æ€ç®¡ç†

```javascript
const auth = {
  setToken(token, remember = false) {
    if (remember) {
      // è®°ä½ç™»å½•ï¼Œä½¿ç”¨ localStorage
      localStorage.setItem('authToken', token)
    } else {
      // ä¸è®°ä½ï¼Œä½¿ç”¨ sessionStorage
      sessionStorage.setItem('authToken', token)
    }
  },

  getToken() {
    return (
      localStorage.getItem('authToken') || sessionStorage.getItem('authToken')
    )
  },

  isLoggedIn() {
    return !!this.getToken()
  },

  logout() {
    localStorage.removeItem('authToken')
    sessionStorage.removeItem('authToken')
    // æ¸…é™¤ Cookie
    document.cookie = 'authToken=; max-age=0; path=/'
  },
}
```

### ç¼“å­˜ API æ•°æ®

```javascript
const apiCache = {
  get(key) {
    const item = localStorage.getItem(`cache_${key}`)
    if (!item) return null

    const { data, timestamp, maxAge } = JSON.parse(item)
    if (Date.now() - timestamp > maxAge) {
      localStorage.removeItem(`cache_${key}`)
      return null
    }

    return data
  },

  set(key, data, maxAge = 300000) {
    // é»˜è®¤ 5 åˆ†é’Ÿ
    localStorage.setItem(
      `cache_${key}`,
      JSON.stringify({
        data,
        timestamp: Date.now(),
        maxAge,
      })
    )
  },

  async fetch(url, options = {}) {
    const cacheKey = url

    // æ£€æŸ¥ç¼“å­˜
    const cached = this.get(cacheKey)
    if (cached) {
      return cached
    }

    // è¯·æ±‚ API
    const response = await fetch(url)
    const data = await response.json()

    // å­˜å…¥ç¼“å­˜
    this.set(cacheKey, data, options.maxAge)

    return data
  },

  clear() {
    Object.keys(localStorage)
      .filter((key) => key.startsWith('cache_'))
      .forEach((key) => localStorage.removeItem(key))
  },
}

// ä½¿ç”¨
const users = await apiCache.fetch('/api/users', { maxAge: 60000 })
```

### å­˜å‚¨å®¹é‡æ£€æµ‹

```javascript
function getStorageSize() {
  let total = 0
  for (const key in localStorage) {
    if (localStorage.hasOwnProperty(key)) {
      total += localStorage.getItem(key).length * 2 // UTF-16
    }
  }
  return {
    used: total,
    usedMB: (total / 1024 / 1024).toFixed(2),
    available: 5 * 1024 * 1024 - total, // å‡è®¾ 5MB é™åˆ¶
  }
}

// å­˜å‚¨å‰æ£€æŸ¥ç©ºé—´
function safeSetItem(key, value) {
  try {
    localStorage.setItem(key, value)
    return true
  } catch (e) {
    if (e.name === 'QuotaExceededError') {
      console.error('å­˜å‚¨ç©ºé—´å·²æ»¡')
      // å¯ä»¥å°è¯•æ¸…ç†æ—§æ•°æ®
      cleanOldCache()
      return false
    }
    throw e
  }
}
```

## å®‰å…¨æ³¨æ„äº‹é¡¹

```javascript
// ğŸ”¶ ä¸è¦å­˜å‚¨æ•æ„Ÿæ•°æ®
// å¯†ç ã€ä¿¡ç”¨å¡å·ç­‰ä¸åº”å­˜ï¿½ï¿½åœ¨ localStorage

// ğŸ”¶ XSS æ”»å‡»é£é™©
// localStorage å¯è¢« JavaScript è®¿é—®
// å¦‚æœç½‘ç«™æœ‰ XSS æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥è¯»å–å­˜å‚¨æ•°æ®

// âœ… Token å­˜å‚¨å»ºè®®
// - çŸ­æœŸ tokenï¼šsessionStorage
// - é•¿æœŸ tokenï¼šhttpOnly Cookieï¼ˆæ›´å®‰å…¨ï¼‰

// âœ… æ•°æ®éªŒè¯
function getStoredData(key, validate) {
  const data = localStorage.getItem(key)
  if (!data) return null

  try {
    const parsed = JSON.parse(data)
    // éªŒè¯æ•°æ®ç»“æ„
    if (validate && !validate(parsed)) {
      localStorage.removeItem(key)
      return null
    }
    return parsed
  } catch {
    localStorage.removeItem(key)
    return null
  }
}

// ä½¿ç”¨
const user = getStoredData('user', (data) => {
  return data && typeof data.id === 'number' && typeof data.name === 'string'
})
```

## æ€»ç»“

| åœºæ™¯               | æ¨èæ–¹æ¡ˆ                   |
| ------------------ | -------------------------- |
| ç”¨æˆ·åå¥½è®¾ç½®       | localStorage               |
| ç™»å½•çŠ¶æ€ï¼ˆè®°ä½æˆ‘ï¼‰ | localStorage + Cookie      |
| ç™»å½•çŠ¶æ€ï¼ˆä¸è®°ä½ï¼‰ | sessionStorage             |
| è¡¨å•ä¸´æ—¶æ•°æ®       | sessionStorage             |
| API ç¼“å­˜           | localStorageï¼ˆå¸¦è¿‡æœŸæ—¶é—´ï¼‰ |
| æ•æ„Ÿæ•°æ®           | httpOnly Cookie            |
| å¤§é‡ç»“æ„åŒ–æ•°æ®     | IndexedDB                  |

| æ–¹æ³• | localStorage / sessionStorage |
| ---- | ----------------------------- |
| å­˜å‚¨ | `setItem(key, value)`         |
| è¯»å– | `getItem(key)`                |
| åˆ é™¤ | `removeItem(key)`             |
| æ¸…ç©º | `clear()`                     |
| æ•°é‡ | `length`                      |

**æ ¸å¿ƒè¦ç‚¹**ï¼š

- localStorage æ•°æ®æ°¸ä¹…ä¿å­˜ï¼ŒsessionStorage å…³é—­æ ‡ç­¾é¡µæ¸…é™¤
- åªèƒ½å­˜å‚¨å­—ç¬¦ä¸²ï¼Œå¯¹è±¡éœ€è¦ JSON åºåˆ—åŒ–
- Cookie ä¼šéšè¯·æ±‚è‡ªåŠ¨å‘é€ï¼Œé€‚åˆèº«ä»½éªŒè¯
- æ³¨æ„å­˜å‚¨å®¹é‡é™åˆ¶å’Œå®‰å…¨é—®é¢˜
- æ•æ„Ÿæ•°æ®ä½¿ç”¨ httpOnly Cookie
