---
title: 'Matcher resolve 解析'
pubDate: 2024-01-15
category: 'Vue'
tags: ['VueRouter', '源码']
description: 'Vue Router Matcher resolve 方法源码解析'
---

## resolve 方法

根据 location 解析匹配的路由：

```ts
function resolve(
  location: MatcherLocationRaw,
  currentLocation: MatcherLocation
): MatcherLocation {
  let matcher: RouteRecordMatcher | undefined
  let params: PathParams = {}
  let path: MatcherLocation['path']
  let name: MatcherLocation['name']

  if ('name' in location && location.name) {
    // 按名称查找
    matcher = matcherMap.get(location.name)
    if (!matcher) throw createRouterError(...)

    name = matcher.record.name
    params = assign(
      paramsFromLocation(currentLocation.params, matcher.keys),
      location.params && paramsFromLocation(location.params, matcher.keys)
    )
    path = matcher.stringify(params)

  } else if (location.path != null) {
    // 按路径查找
    path = location.path
    matcher = matchers.find(m => m.re.test(path))

    if (matcher) {
      params = matcher.parse(path)!
      name = matcher.record.name
    }

  } else {
    // 使用当前路由
    matcher = currentLocation.name
      ? matcherMap.get(currentLocation.name)
      : matchers.find(m => m.re.test(currentLocation.path))

    if (!matcher) throw createRouterError(...)

    name = matcher.record.name
    params = assign({}, currentLocation.params, location.params)
    path = matcher.stringify(params)
  }

  // 构建 matched 数组
  const matched: MatcherLocation['matched'] = []
  let parentMatcher: RouteRecordMatcher | undefined = matcher
  while (parentMatcher) {
    matched.unshift(parentMatcher.record)
    parentMatcher = parentMatcher.parent
  }

  return {
    name,
    path,
    params,
    matched,
    meta: mergeMetaFields(matched)
  }
}
```

## 解析流程

```
resolve(location)
       │
       ├── location.name 存在？
       │         │
       │         ├── Yes → matcherMap.get(name)
       │         │
       │         └── No → location.path 存在？
       │                        │
       │                        ├── Yes → 遍历 matchers 匹配
       │                        │
       │                        └── No → 使用 currentLocation
       │
       ├── 解析 params
       │
       ├── 构建 matched 数组（从子到父）
       │
       └── 返回 MatcherLocation
```

## matched 数组构建

```ts
// 从当前 matcher 向上遍历
const matched = []
let parentMatcher = matcher
while (parentMatcher) {
  matched.unshift(parentMatcher.record) // 插入到头部
  parentMatcher = parentMatcher.parent
}
```

示例：

```
/user/123/profile
matched: [
  { path: '/' },           // 根路由
  { path: '/user/:id' },   // 用户路由
  { path: 'profile' }      // 个人资料路由
]
```

## mergeMetaFields

合并所有匹配路由的 meta：

```ts
function mergeMetaFields(matched: RouteRecord[]) {
  return matched.reduce((meta, record) => {
    return assign(meta, record.meta)
  }, {} as RouteMeta)
}
```

## MatcherLocation 结构

```ts
interface MatcherLocation {
  name: RouteRecordName | null | undefined
  path: string
  params: RouteParams
  matched: RouteRecordNormalized[]
  meta: RouteMeta
}
```

## 路径解析器

```ts
// tokenizePath: 将路径转为 token 数组
tokenizePath('/user/:id/profile')
// [
//   { type: 'Static', value: '/user' },
//   { type: 'Param', value: 'id' },
//   { type: 'Static', value: '/profile' }
// ]

// tokensToParser: 将 token 转为正则
// /user/:id/profile → /^\/user\/([^\/]+)\/profile\/?$/

// matcher.re: 生成的正则表达式
// matcher.parse: 从路径提取参数
// matcher.stringify: 从参数生成路径
```
