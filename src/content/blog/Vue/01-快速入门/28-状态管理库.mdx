---
title: 'Pinia çŠ¶æ€ç®¡ç†å¿«é€Ÿå…¥é—¨'
pubDate: 2024-01-15
category: 'Vue'
tags: ['Vue3', 'Pinia', 'çŠ¶æ€ç®¡ç†']
description: 'äº†è§£çŠ¶æ€ç®¡ç†çš„æ¦‚å¿µï¼Œå¿«é€Ÿä¸Šæ‰‹ Vue å®˜æ–¹æ¨èçš„ Pinia'
---

## ä¸ºä»€ä¹ˆéœ€è¦çŠ¶æ€ç®¡ç†

ğŸ™‹ ç»„ä»¶é€šä¿¡çš„ç—›ç‚¹ï¼š

- çˆ¶å­ï¼šProps + Emits
- å…„å¼Ÿï¼šé€šè¿‡çˆ¶ç»„ä»¶ä¸­è½¬
- è·¨å±‚çº§ï¼šProvide/Inject

å½“åº”ç”¨å˜å¤§ï¼Œç»„ä»¶å±‚çº§å˜æ·±ï¼ŒçŠ¶æ€ä¼ é€’ä¼šå˜å¾—éå¸¸éº»çƒ¦ï¼š

```
       App
      /   \
   Sidebar  Main
      |       |
   NavItem  Content
      |       |
   ...     UserCard  â† éœ€è¦ç”¨æˆ·æ•°æ®
```

å¦‚æœ UserCard éœ€è¦ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼Œè¦ä¸€å±‚å±‚ä¼ ä¸‹æ¥...

**çŠ¶æ€ç®¡ç†åº“**çš„è§£å†³æ–¹æ¡ˆï¼šæŠŠå…±äº«çŠ¶æ€æ”¾åˆ°**å…¨å±€ä»“åº“**ï¼Œä»»ä½•ç»„ä»¶éƒ½èƒ½ç›´æ¥è®¿é—®ã€‚

## Pinia ç®€ä»‹

[Pinia](https://pinia.vuejs.org/) æ˜¯ Vue å®˜æ–¹æ¨èçš„çŠ¶æ€ç®¡ç†åº“ï¼Œæ›¿ä»£ä¹‹å‰çš„ Vuexã€‚

ğŸ¯ **ä¼˜åŠ¿**ï¼š

- API æ›´ç®€æ´ï¼Œæ²¡æœ‰ mutations
- å®Œç¾æ”¯æŒ TypeScript
- æ”¯æŒç»„åˆå¼ API
- ä½“ç§¯å°ï¼ˆ~2KBï¼‰

## å¿«é€Ÿå¼€å§‹

### å®‰è£…

```bash
npm install pinia
```

### åˆ›å»º Pinia å®ä¾‹

```ts
// main.ts
import { createApp } from 'vue'
import { createPinia } from 'pinia'
import App from './App.vue'

const app = createApp(App)
const pinia = createPinia()

app.use(pinia).mount('#app')
```

### å®šä¹‰ Store

åˆ›å»º `src/stores/counter.ts`ï¼š

```ts
import { defineStore } from 'pinia'

export const useCounterStore = defineStore('counter', {
  // çŠ¶æ€
  state: () => ({
    count: 0,
  }),

  // è®¡ç®—å±æ€§
  getters: {
    doubleCount: (state) => state.count * 2,
  },

  // æ–¹æ³•ï¼ˆå¯ä»¥æ˜¯åŒæ­¥æˆ–å¼‚æ­¥ï¼‰
  actions: {
    increment() {
      this.count++
    },
    async fetchCount() {
      const res = await fetch('/api/count')
      this.count = await res.json()
    },
  },
})
```

### ä½¿ç”¨ Store

```vue
<script setup>
import { useCounterStore } from '@/stores/counter'

const counter = useCounterStore()
</script>

<template>
  <p>Count: {{ counter.count }}</p>
  <p>Double: {{ counter.doubleCount }}</p>
  <button @click="counter.increment">+1</button>
</template>
```

## ç»„åˆå¼ API é£æ ¼

æ›´æ¨èçš„å†™æ³•ï¼š

```ts
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'

export const useCounterStore = defineStore('counter', () => {
  // state
  const count = ref(0)

  // getters
  const doubleCount = computed(() => count.value * 2)

  // actions
  const increment = () => count.value++

  return { count, doubleCount, increment }
})
```

å’Œå†™ç»„åˆå¼å‡½æ•°ä¸€æ ·ï¼Œæ›´çµæ´»ã€‚

## è§£æ„ä¿æŒå“åº”å¼

ç›´æ¥è§£æ„ä¼šä¸¢å¤±å“åº”å¼ï¼š

```ts
const { count } = useCounterStore() // âŒ count ä¸æ˜¯å“åº”å¼çš„
```

ç”¨ `storeToRefs`ï¼š

```ts
import { storeToRefs } from 'pinia'

const counter = useCounterStore()
const { count, doubleCount } = storeToRefs(counter) // âœ… å“åº”å¼

// actions ç›´æ¥è§£æ„
const { increment } = counter // âœ… æ–¹æ³•ä¸éœ€è¦ storeToRefs
```

## ä¿®æ”¹çŠ¶æ€

```ts
const counter = useCounterStore()

// æ–¹å¼ 1ï¼šç›´æ¥ä¿®æ”¹
counter.count++

// æ–¹å¼ 2ï¼šè°ƒç”¨ action
counter.increment()

// æ–¹å¼ 3ï¼š$patch æ‰¹é‡ä¿®æ”¹
counter.$patch({
  count: 10,
  name: 'new',
})

// æ–¹å¼ 4ï¼š$patch å‡½æ•°å½¢å¼
counter.$patch((state) => {
  state.count++
  state.items.push({ id: 1 })
})

// æ–¹å¼ 5ï¼š$reset é‡ç½®
counter.$reset()
```

## å®æˆ˜ï¼šç”¨æˆ·çŠ¶æ€ç®¡ç†

```ts
// stores/user.ts
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'

export const useUserStore = defineStore('user', () => {
  const token = ref(localStorage.getItem('token') || '')
  const userInfo = ref(null)

  const isLoggedIn = computed(() => !!token.value)

  const login = async (username: string, password: string) => {
    const res = await fetch('/api/login', {
      method: 'POST',
      body: JSON.stringify({ username, password }),
    })
    const data = await res.json()
    token.value = data.token
    userInfo.value = data.user
    localStorage.setItem('token', data.token)
  }

  const logout = () => {
    token.value = ''
    userInfo.value = null
    localStorage.removeItem('token')
  }

  return { token, userInfo, isLoggedIn, login, logout }
})
```

ä½¿ç”¨ï¼š

```vue
<script setup>
import { useUserStore } from '@/stores/user'

const user = useUserStore()
</script>

<template>
  <div v-if="user.isLoggedIn">
    æ¬¢è¿ï¼Œ{{ user.userInfo?.name }}
    <button @click="user.logout">é€€å‡º</button>
  </div>
  <div v-else>
    <button @click="user.login('admin', '123')">ç™»å½•</button>
  </div>
</template>
```

## å°ç»“

| æ¦‚å¿µ          | è¯´æ˜              |
| ------------- | ----------------- |
| `defineStore` | å®šä¹‰ store        |
| `state`       | çŠ¶æ€æ•°æ®          |
| `getters`     | è®¡ç®—å±æ€§          |
| `actions`     | æ–¹æ³•ï¼ˆåŒæ­¥/å¼‚æ­¥ï¼‰ |
| `storeToRefs` | è§£æ„æ—¶ä¿æŒå“åº”å¼  |

```ts
// æ¨èï¼šç»„åˆå¼é£æ ¼
export const useXxxStore = defineStore('xxx', () => {
  const state = ref()
  const getter = computed(() => state.value)
  const action = () => {
    state.value = 'new'
  }
  return { state, getter, action }
})
```

ä¸‹ä¸€ç¯‡æˆ‘ä»¬æ¥çœ‹ç»„ä»¶åº“çš„ä½¿ç”¨ã€‚
