---
title: 'createRouter 结构解析'
pubDate: 2024-01-15
category: 'Vue'
tags: ['VueRouter', '源码']
description: 'Vue Router 4.x 源码解析：createRouter 方法整体结构分析'
---

## 源码目录结构

Vue Router 源码位于 `packages/router/src`：

```
├── history/          # 路由历史相关
├── matcher/          # 路由匹配器
├── RouterLink.ts     # RouterLink 组件
├── RouterView.ts     # RouterView 组件
├── router.ts         # 核心 createRouter
└── navigationGuards.ts # 导航守卫
```

## createRouter 使用方式

```ts
import { createRouter, createWebHistory } from 'vue-router'

const router = createRouter({
  history: createWebHistory(),
  routes: [
    { path: '/', component: Home },
    { path: '/about', component: About },
  ],
})

// 注册为 Vue 插件
app.use(router)
```

## createRouter 整体结构

```ts
export function createRouter(options: RouterOptions): Router {
  // 1. 核心变量
  const matcher = createRouterMatcher(routes)  // 路由匹配器
  const routerHistory = options.history        // 路由历史

  // 2. 导航守卫
  const beforeGuards = useCallbacks()
  const beforeResolveGuards = useCallbacks()
  const afterGuards = useCallbacks()

  // 3. 当前路由
  const currentRoute = shallowRef(START_LOCATION)

  // 4. 内部方法
  function addRoute() { ... }
  function removeRoute() { ... }
  function resolve() { ... }
  function push() { ... }
  function replace() { ... }
  function navigate() { ... }
  // ... 更多方法

  // 5. 返回 Router 对象
  const router: Router = {
    currentRoute,
    options,

    // 路由操作
    addRoute,
    removeRoute,
    getRoutes,
    push,
    replace,
    go,
    back: () => go(-1),
    forward: () => go(1),

    // 导航守卫
    beforeEach: beforeGuards.add,
    beforeResolve: beforeResolveGuards.add,
    afterEach: afterGuards.add,

    // Vue 插件
    install(app) {
      // 注册组件
      app.component('RouterLink', RouterLink)
      app.component('RouterView', RouterView)

      // 依赖注入
      app.provide(routerKey, router)
      app.provide(routeLocationKey, currentRoute)

      // 初始化导航
      // ...
    }
  }

  return router
}
```

## 工作流程

```
createRouter(options)
       │
       ├── 创建 matcher（路由匹配器）
       │
       ├── 初始化 history（路由历史）
       │
       ├── 创建导航守卫容器
       │
       ├── 定义各种方法（push/replace/navigate 等）
       │
       └── 返回 Router 对象
              │
              └── install() 注册为 Vue 插件
```

## 核心模块

| 模块             | 作用           |
| ---------------- | -------------- |
| matcher          | 路由匹配和解析 |
| history          | 管理浏览器历史 |
| navigationGuards | 处理导航守卫   |
| RouterView       | 渲染匹配的组件 |
| RouterLink       | 声明式导航链接 |
