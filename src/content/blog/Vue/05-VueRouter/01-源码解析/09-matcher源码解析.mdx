---
title: 'Matcher addRoute 解析'
pubDate: 2024-01-15
category: 'Vue'
tags: ['VueRouter', '源码']
description: 'Vue Router Matcher addRoute 方法源码解析'
---

## addRoute 概览

```ts
function addRoute(
  record: RouteRecordRaw,
  parent?: RouteRecordMatcher,
  originalRecord?: RouteRecordMatcher
) {
  // 1. 处理别名
  // 2. 标准化路由记录
  // 3. 处理嵌套路由
  // 4. 插入 matcher
}
```

## 别名处理

```ts
const isRootAdd = !originalRecord

// 标准化主记录
let mainNormalizedRecord = normalizeRouteRecord(record)

// 处理别名
if ('alias' in record) {
  const aliases =
    typeof record.alias === 'string' ? [record.alias] : record.alias!

  for (const alias of aliases) {
    // 为每个别名创建一个新的路由记录
    normalizedRecords.push(
      assign({}, mainNormalizedRecord, {
        path: alias,
        components: originalRecord
          ? originalRecord.record.components
          : mainNormalizedRecord.components,
      })
    )
  }
}
```

## normalizeRouteRecord

标准化路由记录：

```ts
function normalizeRouteRecord(record: RouteRecordRaw): RouteRecordNormalized {
  return {
    path: record.path,
    redirect: record.redirect,
    name: record.name,
    meta: record.meta || {},
    aliasOf: undefined,
    beforeEnter: record.beforeEnter,
    props: normalizeRecordProps(record),
    children: record.children || [],
    instances: {},
    leaveGuards: new Set(),
    updateGuards: new Set(),
    enterCallbacks: {},
    components:
      'components' in record
        ? record.components || null
        : record.component && { default: record.component },
  }
}
```

## 创建 RouteRecordMatcher

```ts
for (const normalizedRecord of normalizedRecords) {
  const { path } = normalizedRecord

  // 嵌套路由路径拼接
  if (parent && path[0] !== '/') {
    const parentPath = parent.record.path
    const connectingSlash = parentPath[parentPath.length - 1] === '/' ? '' : '/'
    normalizedRecord.path = parent.record.path + connectingSlash + path
  }

  // 创建 matcher
  matcher = createRouteRecordMatcher(normalizedRecord, parent, options)

  // 设置别名关系
  if (originalRecord) {
    matcher.record.aliasOf = originalRecord.record
  }
}
```

## 递归处理子路由

```ts
if (mainNormalizedRecord.children) {
  const children = mainNormalizedRecord.children

  for (let i = 0; i < children.length; i++) {
    // 递归调用 addRoute
    addRoute(
      children[i],
      matcher, // 当前 matcher 作为 parent
      originalRecord && originalRecord.children[i]
    )
  }
}
```

## 插入 matcher

```ts
if (
  matcher.record.components ||
  matcher.record.name ||
  matcher.record.redirect
) {
  insertMatcher(matcher)
}
```

## createRouteRecordMatcher

创建单个 RouteRecordMatcher：

```ts
function createRouteRecordMatcher(
  record: RouteRecordNormalized,
  parent: RouteRecordMatcher | undefined,
  options?: PathParserOptions
): RouteRecordMatcher {
  // 解析路径，生成正则表达式
  const parser = tokensToParser(tokenizePath(record.path), options)

  const matcher: RouteRecordMatcher = assign(parser, {
    record,
    parent,
    children: [],
    alias: [],
  })

  // 建立父子关系
  if (parent) {
    if (!matcher.record.aliasOf === !parent.record.aliasOf) {
      parent.children.push(matcher)
    }
  }

  return matcher
}
```

## RouteRecordMatcher 结构

```ts
interface RouteRecordMatcher extends PathParser {
  record: RouteRecordNormalized // 路由记录
  parent: RouteRecordMatcher | undefined // 父 matcher
  children: RouteRecordMatcher[] // 子 matcher
  alias: RouteRecordMatcher[] // 别名 matcher
}
```
