---
title: 'useHistoryListeners 源码解析'
pubDate: 2024-01-15
category: 'Vue'
tags: ['VueRouter', '源码']
description: 'Vue Router 历史监听器源码解析'
---

## 调用方式

```ts
const historyListeners = useHistoryListeners(
  base,
  historyNavigation.state,
  historyNavigation.location,
  historyNavigation.replace
)
```

## 整体结构

```ts
function useHistoryListeners(
  base: string,
  historyState: ValueContainer<StateEntry>,
  currentLocation: ValueContainer<HistoryLocation>,
  replace: RouterHistory['replace']
) {
  // 私有变量
  let listeners: NavigationCallback[] = []   // 导航回调列表
  let teardowns: Array<() => void> = []      // 清理函数列表
  let pauseState: HistoryLocation | null = null  // 暂停状态

  // 事件处理函数
  const popStateHandler = ({ state }) => { ... }
  function beforeUnloadListener() { ... }

  // 暴露的方法
  function pauseListeners() { ... }
  function listen(callback) { ... }
  function destroy() { ... }

  // 绑定事件
  window.addEventListener('popstate', popStateHandler)
  window.addEventListener('beforeunload', beforeUnloadListener, { passive: true })

  return { pauseListeners, listen, destroy }
}
```

## popStateHandler

处理浏览器前进/后退：

```ts
const popStateHandler = ({ state }: { state: StateEntry | null }) => {
  const to = createCurrentLocation(base, location)
  const from = currentLocation.value
  const fromState = historyState.value

  // 是否是前进操作
  let delta = 0
  if (state) {
    currentLocation.value = to
    historyState.value = state

    // 如果是暂停状态，直接返回
    if (pauseState && pauseState === from) {
      pauseState = null
      return
    }

    delta = fromState ? state.position - fromState.position : 0
  } else {
    replace(to)
  }

  // 通知所有监听器
  listeners.forEach((listener) => {
    listener(currentLocation.value, from, {
      delta,
      type: NavigationType.pop,
      direction: delta ? (delta > 0 ? 'forward' : 'back') : '',
    })
  })
}
```

## listen

注册导航监听器：

```ts
function listen(callback: NavigationCallback) {
  listeners.push(callback)

  // 返回取消监听的函数
  const teardown = () => {
    const index = listeners.indexOf(callback)
    if (index > -1) listeners.splice(index, 1)
  }

  teardowns.push(teardown)
  return teardown
}
```

## pauseListeners

暂停监听（用于编程式导航避免重复触发）：

```ts
function pauseListeners() {
  pauseState = currentLocation.value
}
```

## beforeUnloadListener

页面卸载前保存滚动位置：

```ts
function beforeUnloadListener() {
  const { history } = window
  if (!history.state) return

  // 保存当前滚动位置
  history.replaceState(
    assign({}, history.state, {
      scroll: computeScrollPosition(),
    }),
    ''
  )
}
```

## destroy

销毁监听器：

```ts
function destroy() {
  // 执行所有清理函数
  for (const teardown of teardowns) teardown()
  teardowns = []

  // 移除事件监听
  window.removeEventListener('popstate', popStateHandler)
  window.removeEventListener('beforeunload', beforeUnloadListener)
}
```

## NavigationCallback 类型

```ts
interface NavigationCallback {
  (
    to: HistoryLocation,
    from: HistoryLocation,
    information: NavigationInformation
  ): void
}

interface NavigationInformation {
  delta: number // 导航步数
  type: NavigationType // 导航类型
  direction: '' | 'back' | 'forward' // 方向
}
```
