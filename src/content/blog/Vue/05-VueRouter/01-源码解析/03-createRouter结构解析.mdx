---
title: 'createRouter 方法总结'
pubDate: 2024-01-15
category: 'Vue'
tags: ['VueRouter', '源码']
description: 'Vue Router createRouter 核心流程和方法总结'
---

## addRoute 动态添加路由

```ts
function addRoute(
  parentOrRoute: RouteRecordName | RouteRecordRaw,
  route?: RouteRecordRaw
) {
  let parent: Parameters<typeof matcher.addRoute>[1] | undefined
  let record: RouteRecordRaw

  if (isRouteName(parentOrRoute)) {
    // 有父路由
    parent = matcher.getRecordMatcher(parentOrRoute)
    record = route!
  } else {
    // 无父路由
    record = parentOrRoute
  }

  return matcher.addRoute(record, parent)
}
```

## removeRoute 删除路由

```ts
function removeRoute(name: RouteRecordName) {
  const recordMatcher = matcher.getRecordMatcher(name)
  if (recordMatcher) {
    matcher.removeRoute(recordMatcher)
  }
}
```

## hasRoute 检查路由

```ts
function hasRoute(name: RouteRecordName): boolean {
  return !!matcher.getRecordMatcher(name)
}
```

## getRoutes 获取所有路由

```ts
function getRoutes() {
  return matcher.getRoutes().map((routeMatcher) => routeMatcher.record)
}
```

## go / back / forward

```ts
const go = (delta: number) => routerHistory.go(delta)

const router: Router = {
  go,
  back: () => go(-1),
  forward: () => go(1),
}
```

## 导航守卫注册

```ts
const beforeGuards = useCallbacks<NavigationGuardWithThis<undefined>>()
const beforeResolveGuards = useCallbacks<NavigationGuardWithThis<undefined>>()
const afterGuards = useCallbacks<NavigationHookAfter>()

const router: Router = {
  beforeEach: beforeGuards.add,
  beforeResolve: beforeResolveGuards.add,
  afterEach: afterGuards.add,
}
```

## useCallbacks 实现

```ts
function useCallbacks<T>() {
  let handlers: T[] = []

  function add(handler: T) {
    handlers.push(handler)
    return () => {
      const i = handlers.indexOf(handler)
      if (i > -1) handlers.splice(i, 1)
    }
  }

  function reset() {
    handlers = []
  }

  return {
    add,
    list: () => handlers.slice(),
    reset,
  }
}
```

## isReady

等待路由初始化完成：

```ts
function isReady(): Promise<void> {
  if (ready && currentRoute.value !== START_LOCATION_NORMALIZED) {
    return Promise.resolve()
  }
  return new Promise((resolve, reject) => {
    readyHandlers.push({ resolve, reject })
  })
}
```

## 完整 Router 对象

```ts
const router: Router = {
  // 当前路由
  currentRoute,
  listening: true,

  // 路由操作
  addRoute,
  removeRoute,
  hasRoute,
  getRoutes,
  resolve,
  options,

  // 导航
  push,
  replace,
  go,
  back: () => go(-1),
  forward: () => go(1),

  // 导航守卫
  beforeEach: beforeGuards.add,
  beforeResolve: beforeResolveGuards.add,
  afterEach: afterGuards.add,

  // 错误处理
  onError: errorListeners.add,

  // 状态
  isReady,

  // Vue 插件
  install(app) { ... }
}
```

## 核心流程图

```
createRouter(options)
       │
       ├── createRouterMatcher(routes) → matcher
       │
       ├── options.history → routerHistory
       │
       ├── 初始化导航守卫容器
       │
       ├── 定义 push/replace/navigate 等方法
       │
       └── 返回 Router 对象
              │
              └── install(app)
                     │
                     ├── 注册 RouterLink/RouterView
                     ├── 设置 $router/$route
                     ├── provide 依赖注入
                     └── 执行初始导航
```
