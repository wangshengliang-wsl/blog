---
title: 'RouterView 组件解析'
pubDate: 2024-01-15
category: 'Vue'
tags: ['VueRouter', '源码']
description: 'Vue Router RouterView 组件源码解析'
---

## 整体结构

```ts
export const RouterViewImpl = defineComponent({
  name: 'RouterView',
  props: { name: { type: String, default: 'default' } },

  setup(props, { attrs, slots }) {
    // 1. 计算深度
    // 2. 监听变化
    // 3. 渲染组件
  },
})
```

## 深度计算

嵌套路由需要计算当前 RouterView 的深度：

```vue
<!-- 布局组件 -->
<router-view></router-view>
<!-- depth = 0 -->

<!-- 嵌套的子路由 -->
<router-view></router-view>
<!-- depth = 1 -->
```

```ts
setup(props) {
  // 获取父级注入的路由和深度
  const injectedRoute = inject(routerViewLocationKey)
  const injectedDepth = inject(viewDepthKey, 0)

  // 计算当前深度
  const depth = computed(() => {
    let initialDepth = unref(injectedDepth)
    const { matched } = routeToDisplay.value

    // 跳过没有 components 的路由记录
    while (matched[initialDepth] && !matched[initialDepth].components) {
      initialDepth++
    }
    return initialDepth
  })

  // 获取对应深度的路由记录
  const matchedRouteRef = computed(() =>
    routeToDisplay.value.matched[depth.value]
  )

  // 向子 RouterView 注入深度
  provide(viewDepthKey, computed(() => depth.value + 1))
  provide(matchedRouteKey, matchedRouteRef)
}
```

## 监听路由变化

```ts
watch(
  () => [viewRef.value, matchedRouteRef.value, props.name],
  ([instance, to, name], [oldInstance, from, oldName]) => {
    if (to) {
      // 保存组件实例
      to.instances[name] = instance

      // 复用组件时，复制守卫
      if (from && from !== to && instance === oldInstance) {
        if (!to.leaveGuards.size) to.leaveGuards = from.leaveGuards
        if (!to.updateGuards.size) to.updateGuards = from.updateGuards
      }
    }

    // 执行 beforeRouteEnter 的 next 回调
    if (instance && to && (!from || !isSameRouteRecord(to, from))) {
      ;(to.enterCallbacks[name] || []).forEach((cb) => cb(instance))
    }
  },
  { flush: 'post' }
)
```

## 渲染逻辑

```ts
return () => {
  const route = routeToDisplay.value
  const matchedRoute = matchedRouteRef.value

  // 获取要渲染的组件
  const ViewComponent = matchedRoute?.components?.[props.name]

  if (!ViewComponent) {
    // 没有匹配的组件，渲染默认插槽
    return slots.default?.({ Component: ViewComponent, route })
  }

  // 处理路由 props
  const routePropsOption = matchedRoute.props[props.name]
  const routeProps =
    routePropsOption === true
      ? route.params
      : typeof routePropsOption === 'function'
        ? routePropsOption(route)
        : routePropsOption

  // 创建组件 VNode
  const component = h(ViewComponent, {
    ...routeProps,
    ...attrs,
    onVnodeUnmounted: (vnode) => {
      if (vnode.component?.isUnmounted) {
        matchedRoute.instances[props.name] = null
      }
    },
    ref: viewRef,
  })

  // 支持插槽自定义渲染
  return slots.default?.({ Component: component, route }) || component
}
```

## 关键点总结

| 功能       | 实现方式                        |
| ---------- | ------------------------------- |
| 嵌套路由   | depth 深度计算 + provide/inject |
| 组件复用   | watch 监听实例变化              |
| props 传递 | 支持 boolean/object/function    |
| 插槽自定义 | 暴露 Component 和 route         |
