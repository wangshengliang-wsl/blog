---
title: 'RouterLink 组件解析'
pubDate: 2024-01-15
category: 'Vue'
tags: ['VueRouter', '源码']
description: 'Vue Router RouterLink 组件源码解析'
---

## 使用方式

```vue
<router-link to="/">Home</router-link>
<router-link :to="{ name: 'user', params: { id: 1 } }">User</router-link>
```

## Props

```ts
props: {
  to: { type: [String, Object], required: true },  // 目标路由
  replace: Boolean,           // 是否使用 replace 模式
  activeClass: String,        // 激活时的类名
  exactActiveClass: String,   // 精确匹配时的类名
  custom: Boolean,            // 自定义渲染
  ariaCurrentValue: String    // 无障碍属性
}
```

## useLink 函数

`useLink` 是 RouterLink 的核心逻辑：

```ts
function useLink(props) {
  const router = inject(routerKey)
  const currentRoute = inject(routeLocationKey)

  // 解析目标路由
  const route = computed(() => router.resolve(props.to))

  // 计算激活状态
  const isActive = computed(() => /* 判断是否激活 */)
  const isExactActive = computed(() => /* 判断是否精确激活 */)

  // 导航函数
  function navigate(e) {
    if (guardEvent(e)) {
      return router[props.replace ? 'replace' : 'push'](props.to)
    }
  }

  return { route, href, isActive, isExactActive, navigate }
}
```

## guardEvent 函数

判断点击事件是否应该被处理：

```ts
function guardEvent(e) {
  // 以下情况不处理：
  // - 按住 meta/alt/ctrl/shift 键
  // - 已阻止默认行为
  // - 非左键点击
  // - target="_blank"

  if (e.metaKey || e.altKey || e.ctrlKey || e.shiftKey) return
  if (e.defaultPrevented) return
  if (e.button !== 0) return

  const target = e.currentTarget?.getAttribute('target')
  if (/\b_blank\b/i.test(target)) return

  e.preventDefault()
  return true
}
```

## setup 函数

```ts
setup(props, { slots }) {
  const link = reactive(useLink(props))

  // 计算激活类名
  const elClass = computed(() => ({
    'router-link-active': link.isActive,
    'router-link-exact-active': link.isExactActive
  }))

  return () => {
    const children = slots.default?.(link)

    // 自定义渲染
    if (props.custom) return children

    // 默认渲染为 <a> 标签
    return h('a', {
      href: link.href,
      onClick: link.navigate,
      class: elClass.value
    }, children)
  }
}
```

## 激活状态判断

```ts
// isActive: 路由匹配且参数包含
const isActive = computed(
  () =>
    activeRecordIndex.value > -1 &&
    includesParams(currentRoute.params, route.value.params)
)

// isExactActive: 路由完全匹配且参数相同
const isExactActive = computed(
  () =>
    activeRecordIndex.value === currentRoute.matched.length - 1 &&
    isSameRouteLocationParams(currentRoute.params, route.value.params)
)
```
