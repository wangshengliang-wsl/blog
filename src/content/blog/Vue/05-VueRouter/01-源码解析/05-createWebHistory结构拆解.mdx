---
title: 'createWebHistory 结构拆解'
pubDate: 2024-01-15
category: 'Vue'
tags: ['VueRouter', '源码']
description: 'Vue Router createWebHistory 方法源码解析'
---

## 使用方式

```ts
const router = createRouter({
  history: createWebHistory(import.meta.env.BASE_URL),
  routes: [...]
})
```

## 整体结构

```ts
export function createWebHistory(base?: string): RouterHistory {
  // 1. 标准化 base
  base = normalizeBase(base)

  // 2. 创建导航和监听器
  const historyNavigation = useHistoryStateNavigation(base)
  const historyListeners = useHistoryListeners(
    base,
    historyNavigation.state,
    historyNavigation.location,
    historyNavigation.replace
  )

  // 3. go 方法
  function go(delta: number, triggerListeners = true) {
    if (!triggerListeners) historyListeners.pauseListeners()
    history.go(delta)
  }

  // 4. 合并返回对象
  const routerHistory: RouterHistory = assign(
    { location: '', base, go, createHref: createHref.bind(null, base) },
    historyNavigation,
    historyListeners
  )

  // 5. 定义 location 和 state 的 getter
  Object.defineProperty(routerHistory, 'location', {
    get: () => historyNavigation.location.value,
  })
  Object.defineProperty(routerHistory, 'state', {
    get: () => historyNavigation.state.value,
  })

  return routerHistory
}
```

## normalizeBase 标准化

```ts
function normalizeBase(base?: string): string {
  // 没有传入 base，检查 <base> 标签或使用 '/'
  if (!base) {
    if (isBrowser) {
      const baseEl = document.querySelector('base')
      base = baseEl?.getAttribute('href') || '/'
      base = base.replace(/^\w+:\/\/[^\/]+/, '')
    } else {
      base = '/'
    }
  }

  // 确保以 / 开头
  if (base[0] !== '/' && base[0] !== '#') {
    base = '/' + base
  }

  // 移除尾部斜杠
  return removeTrailingSlash(base)
}
```

示例：

- `'app/'` → `'/app'`
- `'/app/'` → `'/app'`

## 核心方法

### useHistoryStateNavigation

处理路由导航状态：

```ts
function useHistoryStateNavigation(base: string) {
  const { history, location } = window

  const currentLocation = {
    value: createCurrentLocation(base, location),
  }

  const historyState = {
    value: history.state,
  }

  function push(to, data) {
    // 调用 history.pushState
  }

  function replace(to, data) {
    // 调用 history.replaceState
  }

  return {
    location: currentLocation,
    state: historyState,
    push,
    replace,
  }
}
```

### useHistoryListeners

监听浏览器前进后退：

```ts
function useHistoryListeners(base, state, location, replace) {
  let listeners = []

  // 监听 popstate 事件
  window.addEventListener('popstate', popStateHandler)

  function listen(callback) {
    listeners.push(callback)
    return () => {
      const i = listeners.indexOf(callback)
      if (i > -1) listeners.splice(i, 1)
    }
  }

  return { listen, pauseListeners, destroy }
}
```

## 返回的 RouterHistory 对象

```ts
{
  location: string,      // 当前路径
  base: string,          // 基础路径
  state: HistoryState,   // 历史状态

  push(to, data),        // 添加历史记录
  replace(to, data),     // 替换当前记录
  go(delta),             // 前进/后退

  listen(callback),      // 监听路由变化
  pauseListeners(),      // 暂停监听
  destroy()              // 销毁
}
```
