---
title: 'Suspense 异步依赖处理'
pubDate: 2024-01-15
category: 'Vue'
tags: ['Vue3', '进阶']
description: '使用 Suspense 统一处理组件树中的异步依赖加载状态'
---

## 问题场景

组件树中有多个异步组件时，每个都有自己的加载状态：

```
<Dashboard>
├─ <Profile>
│  └─ <FriendStatus>（异步 setup）
└─ <Content>
   ├─ <ActivityFeed>（异步组件）
   └─ <Stats>（异步组件）
```

最坏情况：页面上出现多个加载状态，不同时间显示内容。

## 解决方案：Suspense

在顶层统一处理所有异步依赖的加载状态：

```vue
<Suspense>
  <!-- 所有异步依赖完成后显示 -->
  <template #default>
    <Dashboard />
  </template>
  
  <!-- 任一异步依赖未完成时显示 -->
  <template #fallback>
    <LoadingSpinner />
  </template>
</Suspense>
```

## Suspense 能等待什么

### 1. 异步 setup 组件

```vue
<script setup>
// 顶层 await
const res = await fetch('/api/data')
const data = await res.json()
</script>
```

或：

```js
export default {
  async setup() {
    const res = await fetch('/api/data')
    return { data: await res.json() }
  },
}
```

### 2. 异步组件

```js
const AsyncComponent = defineAsyncComponent(() => import('./MyComponent.vue'))
```

## 基本用法

```vue
<template>
  <Suspense>
    <template #default>
      <AsyncUserProfile />
    </template>
    <template #fallback>
      <div class="loading">加载中...</div>
    </template>
  </Suspense>
</template>

<script setup>
import { defineAsyncComponent } from 'vue'

const AsyncUserProfile = defineAsyncComponent(() => import('./UserProfile.vue'))
</script>
```

## 嵌套 Suspense

可以让部分内容先显示：

```vue
<Suspense>
  <template #default>
    <div>
      <!-- Profile 先显示 -->
      <Profile />

      <!-- Content 有自己的 Suspense -->
      <Suspense>
        <template #default>
          <Content />
        </template>
        <template #fallback>
          <div>内容加载中...</div>
        </template>
      </Suspense>
    </div>
  </template>
  <template #fallback>
    <div>页面加载中...</div>
  </template>
</Suspense>
```

## 事件

```vue
<Suspense @pending="onPending" @resolve="onResolve" @fallback="onFallback">
  ...
</Suspense>

<script setup>
const onPending = () => console.log('进入挂起状态')
const onResolve = () => console.log('异步完成')
const onFallback = () => console.log('显示后备内容')
</script>
```

## 与其他内置组件配合

推荐嵌套顺序：

```vue
<RouterView v-slot="{ Component }">
  <template v-if="Component">
    <Transition mode="out-in">
      <KeepAlive>
        <Suspense>
          <component :is="Component" />
          <template #fallback>
            加载中...
          </template>
        </Suspense>
      </KeepAlive>
    </Transition>
  </template>
</RouterView>
```

## 注意事项

1. **插槽限制**：每个插槽只能有一个直接子节点
2. **实验性功能**：Suspense 仍是实验性功能，API 可能变化
3. **错误处理**：配合 `onErrorCaptured` 处理异步错误

```vue
<script setup>
import { onErrorCaptured, ref } from 'vue'

const error = ref(null)

onErrorCaptured((err) => {
  error.value = err
  return false // 阻止错误继续传播
})
</script>

<template>
  <div v-if="error">出错了: {{ error.message }}</div>
  <Suspense v-else> ... </Suspense>
</template>
```
