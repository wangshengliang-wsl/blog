---
title: '自定义 ref 实现防抖'
pubDate: 2024-01-15
category: 'Vue'
tags: ['Vue3', '进阶']
description: '使用 customRef 创建自带防抖功能的响应式引用'
---

## 问题场景

输入框防抖的常规实现：

```vue
<script setup>
import { ref } from 'vue'
import { debounce } from 'lodash'

const text = ref('')
const debouncedUpdate = debounce((val) => {
  text.value = val
}, 500)
</script>

<template>
  <input @input="(e) => debouncedUpdate(e.target.value)" />
  <p>{{ text }}</p>
</template>
```

如果能这样用就好了：

```vue
<script setup>
const text = useDebouncedRef('', 500)
</script>

<template>
  <input v-model="text" />
  <p>{{ text }}</p>
</template>
```

## customRef 基础

`customRef` 允许自定义 ref 的 get/set 行为：

```js
import { customRef } from 'vue'

const myRef = customRef((track, trigger) => {
  let value = 'initial'
  return {
    get() {
      track() // 收集依赖
      return value
    },
    set(newValue) {
      value = newValue
      trigger() // 触发更新
    },
  }
})
```

## 实现 useDebouncedRef

```js
import { customRef } from 'vue'

export function useDebouncedRef(initialValue, delay = 300) {
  let value = initialValue
  let timeout = null

  return customRef((track, trigger) => ({
    get() {
      track()
      return value
    },
    set(newValue) {
      clearTimeout(timeout)
      timeout = setTimeout(() => {
        value = newValue
        trigger()
      }, delay)
    },
  }))
}
```

## 使用示例

```vue
<script setup>
import { useDebouncedRef } from './composables/useDebouncedRef'

const searchText = useDebouncedRef('', 500)

// 每次 searchText 变化都是防抖后的
watch(searchText, (val) => {
  console.log('搜索:', val)
  // fetchSearchResults(val)
})
</script>

<template>
  <input v-model="searchText" placeholder="搜索..." />
  <p>搜索词: {{ searchText }}</p>
</template>
```

## 扩展：节流 ref

```js
export function useThrottledRef(initialValue, delay = 300) {
  let value = initialValue
  let lastTrigger = 0

  return customRef((track, trigger) => ({
    get() {
      track()
      return value
    },
    set(newValue) {
      const now = Date.now()
      if (now - lastTrigger >= delay) {
        value = newValue
        lastTrigger = now
        trigger()
      }
    },
  }))
}
```

## 使用 lodash

```js
import { customRef } from 'vue'
import { debounce } from 'lodash-es'

export function useDebouncedRef(initialValue, delay = 300) {
  let value = initialValue

  return customRef((track, trigger) => {
    const debouncedTrigger = debounce(trigger, delay)

    return {
      get() {
        track()
        return value
      },
      set(newValue) {
        value = newValue
        debouncedTrigger()
      },
    }
  })
}
```
