---
title: 'WebSocket 聊天室实现'
pubDate: 2024-01-15
category: 'Vue'
tags: ['Vue3', 'WebSocket']
description: '使用 Socket.IO 实现 Vue3 实时聊天应用'
---

## Socket.IO 简介

Socket.IO 是基于 WebSocket 的实时双向通信库，提供：

- 自动重连
- 事件驱动 API
- 房间和命名空间
- 跨平台兼容

## 服务端（Node.js + Express）

```js
// server.js
const express = require('express')
const { createServer } = require('http')
const { Server } = require('socket.io')

const app = express()
const httpServer = createServer(app)
const io = new Server(httpServer, {
  cors: { origin: '*' },
})

io.on('connection', (socket) => {
  console.log('用户连接:', socket.id)

  // 接收消息
  socket.on('chat message', (msg) => {
    // 广播给所有用户
    io.emit('chat message', {
      id: socket.id,
      text: msg,
      time: new Date().toISOString(),
    })
  })

  socket.on('disconnect', () => {
    console.log('用户断开:', socket.id)
  })
})

httpServer.listen(3000)
```

## 客户端配置

```bash
npm install socket.io-client
```

```js
// main.js
import { createApp } from 'vue'
import { io } from 'socket.io-client'
import App from './App.vue'

const socket = io('http://localhost:3000', {
  transports: ['websocket', 'polling'],
})

const app = createApp(App)
app.config.globalProperties.$socket = socket
app.provide('socket', socket)
app.mount('#app')
```

## 聊天组件

```vue
<template>
  <div class="chat">
    <div class="messages">
      <div v-for="msg in messages" :key="msg.time" class="message">
        <span class="user">{{ msg.id.slice(0, 6) }}:</span>
        <span>{{ msg.text }}</span>
      </div>
    </div>

    <form @submit.prevent="sendMessage">
      <input v-model="newMessage" placeholder="输入消息..." />
      <button type="submit">发送</button>
    </form>
  </div>
</template>

<script setup>
import { ref, inject, onMounted, onUnmounted } from 'vue'

const socket = inject('socket')
const messages = ref([])
const newMessage = ref('')

const sendMessage = () => {
  if (newMessage.value.trim()) {
    socket.emit('chat message', newMessage.value)
    newMessage.value = ''
  }
}

onMounted(() => {
  socket.on('chat message', (msg) => {
    messages.value.push(msg)
  })
})

onUnmounted(() => {
  socket.off('chat message')
})
</script>
```

## Socket.IO 常用 API

| 方法                       | 说明           |
| -------------------------- | -------------- |
| socket.emit(event, data)   | 发送事件       |
| socket.on(event, callback) | 监听事件       |
| socket.off(event)          | 移除监听       |
| io.emit(event, data)       | 广播给所有人   |
| socket.join(room)          | 加入房间       |
| io.to(room).emit()         | 发送给特定房间 |
