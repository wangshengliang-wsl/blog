---
title: '组件树与虚拟 DOM 树的关系'
pubDate: 2024-01-15
category: 'Vue'
tags: ['Vue3', '原理', '虚拟DOM']
description: '理解组件树和虚拟 DOM 树的区别，以及 Vue 响应式 + 虚拟 DOM 的设计思路'
---

🙋 Vue 既有响应式，又有虚拟 DOM，它们是什么关系？

## 两棵树

### DOM 树

浏览器解析 HTML 后生成的树结构：

```html
<div>
  <h1>水果列表</h1>
  <ul>
    <li>苹果</li>
    <li>香蕉</li>
  </ul>
</div>
```

### 组件树

组件之间的嵌套关系形成的树：

```
App
├── Header
├── Sidebar
│   └── NavItem
└── Main
    └── UserCard
```

### 虚拟 DOM 树

**单个组件内部**的虚拟 DOM 结构：

```js
// UserCard 组件的虚拟 DOM
{
  tag: 'div',
  props: { class: 'card' },
  children: [
    { tag: 'h2', children: '张三' },
    { tag: 'p', children: 'test@example.com' }
  ]
}
```

🔶 **关键区别**：

- 组件树：描述组件之间的关系
- 虚拟 DOM 树：描述**单个组件内部**的 DOM 结构

## Vue 的架构演进

### Vue 1.x：细粒度响应式

```
数据 ←→ Watcher ←→ DOM 节点
```

每个模板中用到数据的地方，都会生成一个 Watcher：

```vue
<template>
  <div>{{ name }}</div>
  <!-- Watcher 1 -->
  <div>{{ name }}</div>
  <!-- Watcher 2 -->
  <div>{{ age }}</div>
  <!-- Watcher 3 -->
</template>
```

- ✅ 优点：精确知道哪个 DOM 需要更新
- ❌ 缺点：大型应用有成千上万个 Watcher，内存爆炸

### Vue 2.x/3.x：组件级响应式 + 虚拟 DOM

```
数据变化 → 通知组件 → diff 虚拟 DOM → 更新 DOM
```

**Watcher 粒度提升到组件级**：一个组件只有一个 Watcher。

```
组件 A 的 Watcher → 组件 A 的虚拟 DOM 树
组件 B 的 Watcher → 组件 B 的虚拟 DOM 树
```

当数据变化时：

1. **响应式系统**：知道是哪个**组件**需要更新
2. **虚拟 DOM diff**：计算组件内部哪个**节点**需要更新

```
               响应式               虚拟 DOM
数据变化 ────────────→ 定位组件 ────────────→ 定位节点 → 更新 DOM
```

## 为什么这样设计

| 方案                         | 优点       | 缺点          |
| ---------------------------- | ---------- | ------------- |
| 纯响应式（Vue 1.x）          | 精确更新   | Watcher 太多  |
| 纯虚拟 DOM（React）          | 内存占用小 | 需要从根 diff |
| 响应式 + 虚拟 DOM（Vue 2/3） | 折中方案   | 实现复杂      |

Vue 的方案：

- 用响应式**缩小 diff 范围**（只 diff 变化的组件）
- 用虚拟 DOM **精确定位节点**（组件内部）

## 图解

```
┌─────────────────────────────────────────────────────┐
│                      组件树                         │
│                                                     │
│                       App                           │
│                      /   \                          │
│                 Header    Main                      │
│                           /  \                      │
│                      Card    List                   │
│                                                     │
└─────────────────────────────────────────────────────┘
                          │
                          │ 数据变化，响应式定位到 Card 组件
                          ▼
┌─────────────────────────────────────────────────────┐
│              Card 组件的虚拟 DOM 树                  │
│                                                     │
│                      div.card                       │
│                      /      \                       │
│                  h2          p                      │
│                  │           │                      │
│               "张三"      "test@..."                │
│                                                     │
│               diff 计算出 h2 的文本变化              │
└─────────────────────────────────────────────────────┘
                          │
                          │ 只更新 h2 的文本
                          ▼
                      真实 DOM
```

## Vue3 的改进

Vue3 仍然是**响应式 + 虚拟 DOM** 架构，但做了优化：

| 方面      | Vue2                  | Vue3                |
| --------- | --------------------- | ------------------- |
| 响应式    | Object.defineProperty | Proxy               |
| diff 算法 | 双端对比              | 最长递增子序列      |
| 编译优化  | 无                    | 静态提升、PatchFlag |

## 小结

| 概念        | 范围     | 作用             |
| ----------- | -------- | ---------------- |
| 组件树      | 整个应用 | 描述组件嵌套关系 |
| 虚拟 DOM 树 | 单个组件 | 描述组件内部结构 |
| 响应式      | 组件级   | 定位哪个组件更新 |
| diff 算法   | 组件内   | 定位哪个节点更新 |

下一篇我们来看数据拦截的两种方式。
