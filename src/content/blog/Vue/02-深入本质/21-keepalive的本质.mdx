---
title: 'KeepAlive çš„å®ç°åŸç†'
pubDate: 2024-01-15
category: 'Vue'
tags: ['Vue3', 'åŸç†', 'KeepAlive']
description: 'æ·±å…¥ç†è§£ KeepAlive çš„ç¼“å­˜æœºåˆ¶ã€éšè—å®¹å™¨ã€ä¸æ¸²æŸ“å™¨çš„é…åˆ'
---

ğŸ™‹ KeepAlive æ˜¯å¦‚ä½•å®ç°ç»„ä»¶ç¼“å­˜çš„ï¼Ÿ

**æ ¸å¿ƒåŸç†**ï¼šä¸çœŸæ­£å¸è½½ï¼Œè€Œæ˜¯ç§»åŠ¨åˆ°éšè—å®¹å™¨ï¼›æ¢å¤æ—¶å†ç§»åŠ¨å›æ¥ã€‚

## åŸºæœ¬åŸç†å›¾è§£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      é¡µé¢å®¹å™¨                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚ ç»„ä»¶ A  â”‚  â†â”€â”€ å½“å‰æ˜¾ç¤º                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    åˆ‡æ¢åˆ°ç»„ä»¶ B
                         â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      é¡µé¢å®¹å™¨                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚ ç»„ä»¶ B  â”‚  â†â”€â”€ å½“å‰æ˜¾ç¤º                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    éšè—å®¹å™¨                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚ ç»„ä»¶ A  â”‚  â†â”€â”€ è¢«ç¼“å­˜ï¼ŒDOM ä»å­˜åœ¨                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ ¸å¿ƒå®ç°

```ts
const KeepAlive = {
  __isKeepAlive: true, // æ ‡è¯†è¿™æ˜¯ KeepAlive ç»„ä»¶

  setup(props, { slots }) {
    // ç¼“å­˜ï¼škey â†’ vnode
    const cache = new Map()

    // è·å–ç»„ä»¶å®ä¾‹
    const instance = getCurrentInstance()

    // ä»æ¸²æŸ“å™¨è·å–æ“ä½œæ–¹æ³•
    const { move, createElement } = instance.keepAliveCtx

    // åˆ›å»ºéšè—å®¹å™¨
    const storageContainer = createElement('div')

    // å¤±æ´»ï¼šç§»åŠ¨åˆ°éšè—å®¹å™¨
    instance._deActivate = (vnode) => {
      move(vnode, storageContainer)
    }

    // æ¿€æ´»ï¼šä»éšè—å®¹å™¨ç§»å›
    instance._activate = (vnode, container, anchor) => {
      move(vnode, container, anchor)
    }

    return () => {
      // è·å–é»˜è®¤æ’æ§½å†…å®¹
      let rawVNode = slots.default()

      // éç»„ä»¶ç›´æ¥è¿”å›
      if (typeof rawVNode.type !== 'object') {
        return rawVNode
      }

      // æŸ¥æ‰¾ç¼“å­˜
      const cachedVNode = cache.get(rawVNode.type)

      if (cachedVNode) {
        // æœ‰ç¼“å­˜ï¼šå¤ç”¨ç»„ä»¶å®ä¾‹
        rawVNode.component = cachedVNode.component
        rawVNode.keptAlive = true // æ ‡è®°å·²ç¼“å­˜
      } else {
        // æ— ç¼“å­˜ï¼šåŠ å…¥ç¼“å­˜
        cache.set(rawVNode.type, rawVNode)
      }

      // æ·»åŠ æ ‡è®°ï¼Œå‘Šè¯‰æ¸²æŸ“å™¨ç‰¹æ®Šå¤„ç†
      rawVNode.shouldKeepAlive = true
      rawVNode.keepAliveInstance = instance

      return rawVNode
    }
  },
}
```

## æ¸²æŸ“å™¨é…åˆ

KeepAlive éœ€è¦æ¸²æŸ“å™¨çš„ç‰¹æ®Šå¤„ç†ï¼š

### æŒ‚è½½æ—¶

```ts
function patch(n1, n2, container, anchor) {
  // ...
  if (typeof type === 'object') {
    if (!n1) {
      // æ£€æŸ¥æ˜¯å¦æ˜¯ KeepAlive ç¼“å­˜çš„ç»„ä»¶
      if (n2.keptAlive) {
        // ä¸é‡æ–°æŒ‚è½½ï¼Œè€Œæ˜¯è°ƒç”¨ _activate ç§»åŠ¨
        n2.keepAliveInstance._activate(n2, container, anchor)
      } else {
        mountComponent(n2, container, anchor)
      }
    }
  }
}
```

### å¸è½½æ—¶

```ts
function unmount(vnode) {
  if (typeof vnode.type === 'object') {
    // æ£€æŸ¥æ˜¯å¦éœ€è¦ KeepAlive
    if (vnode.shouldKeepAlive) {
      // ä¸çœŸæ­£å¸è½½ï¼Œè€Œæ˜¯è°ƒç”¨ _deActivate ç§»åŠ¨åˆ°éšè—å®¹å™¨
      vnode.keepAliveInstance._deActivate(vnode)
    } else {
      unmount(vnode.component.subTree)
    }
    return
  }
  // æ™®é€šå¸è½½é€»è¾‘...
}
```

## include / exclude

```ts
const KeepAlive = {
  props: {
    include: [String, RegExp, Array],
    exclude: [String, RegExp, Array],
  },

  setup(props, { slots }) {
    // ...

    return () => {
      let rawVNode = slots.default()

      // è·å–ç»„ä»¶å
      const name = rawVNode.type.name

      // æ£€æŸ¥æ˜¯å¦åŒ¹é…
      if (
        name &&
        ((props.include && !matches(props.include, name)) ||
          (props.exclude && matches(props.exclude, name)))
      ) {
        // ä¸ç¼“å­˜ï¼Œç›´æ¥è¿”å›
        return rawVNode
      }

      // è¿›å…¥ç¼“å­˜é€»è¾‘...
    }
  },
}

function matches(pattern, name) {
  if (Array.isArray(pattern)) {
    return pattern.includes(name)
  } else if (typeof pattern === 'string') {
    return pattern.split(',').includes(name)
  } else if (pattern instanceof RegExp) {
    return pattern.test(name)
  }
  return false
}
```

## max ç¼“å­˜é™åˆ¶

ä½¿ç”¨ LRUï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰ç­–ç•¥ç®¡ç†ç¼“å­˜ï¼š

```ts
const cache = new Map()
const keys = new Set()

// æ·»åŠ ç¼“å­˜æ—¶
if (cachedVNode) {
  // å·²ç¼“å­˜ï¼šæ›´æ–°é¡ºåºï¼ˆç§»åˆ°æœ€åï¼‰
  keys.delete(key)
  keys.add(key)
} else {
  // æ–°ç¼“å­˜
  keys.add(key)
  cache.set(key, rawVNode)

  // è¶…è¿‡ max æ—¶ï¼Œåˆ é™¤æœ€æ—§çš„
  if (props.max && keys.size > props.max) {
    const oldestKey = keys.values().next().value
    pruneCacheEntry(oldestKey)
  }
}

function pruneCacheEntry(key) {
  const cached = cache.get(key)
  // å¸è½½ç¼“å­˜çš„ç»„ä»¶
  unmount(cached)
  cache.delete(key)
  keys.delete(key)
}
```

## VNode æ ‡è®°å±æ€§

| å±æ€§              | ä½œç”¨                                                     |
| ----------------- | -------------------------------------------------------- |
| keptAlive         | æ ‡è®°ç»„ä»¶å·²è¢«ç¼“å­˜ï¼ŒæŒ‚è½½æ—¶è°ƒç”¨ \_activate è€Œéé‡æ–°åˆ›å»º     |
| shouldKeepAlive   | æ ‡è®°ç»„ä»¶éœ€è¦è¢«ç¼“å­˜ï¼Œå¸è½½æ—¶è°ƒç”¨ \_deActivate è€ŒéçœŸæ­£å¸è½½ |
| keepAliveInstance | æŒæœ‰ KeepAlive ç»„ä»¶å®ä¾‹çš„å¼•ç”¨                            |

## å°ç»“

| æœºåˆ¶            | å®ç°æ–¹å¼               |
| --------------- | ---------------------- |
| ç¼“å­˜ç»„ä»¶        | Map å­˜å‚¨ vnode         |
| å‡å¸è½½          | ç§»åŠ¨åˆ°éšè—å®¹å™¨         |
| å‡æŒ‚è½½          | ä»éšè—å®¹å™¨ç§»å›         |
| include/exclude | åŒ¹é…ç»„ä»¶åå†³å®šæ˜¯å¦ç¼“å­˜ |
| max             | LRU ç­–ç•¥ï¼Œæ·˜æ±°æœ€æ—§ç¼“å­˜ |

**æ ¸å¿ƒç†è§£**ï¼šKeepAlive æœ¬èº«ä¸æ¸²æŸ“ä»»ä½•å†…å®¹ï¼Œåªæ˜¯ç»™å†…éƒ¨ç»„ä»¶æ‰“æ ‡è®°ï¼Œè®©æ¸²æŸ“å™¨æ‰§è¡Œç‰¹æ®Šçš„æŒ‚è½½/å¸è½½é€»è¾‘ã€‚

ä¸‹ä¸€ç¯‡æˆ‘ä»¬æ¥çœ‹ key çš„æœ¬è´¨ã€‚
