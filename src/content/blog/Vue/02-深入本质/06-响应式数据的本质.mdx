---
title: 'å“åº”å¼æ•°æ®çš„æœ¬è´¨ï¼šref ä¸ reactive'
pubDate: 2024-01-15
category: 'Vue'
tags: ['Vue3', 'åŸç†', 'å“åº”å¼']
description: 'ä»æºç è§’åº¦ç†è§£ ref å’Œ reactive çš„å®ç°å·®å¼‚ï¼Œå­¦ä¼šåˆ¤æ–­å“ªäº›æ“ä½œä¼šè§¦å‘æ‹¦æˆª'
---

ğŸ™‹ å“åº”å¼æ•°æ®çš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ

å°±æ˜¯**è¢«æ‹¦æˆªçš„å¯¹è±¡**ã€‚åªæœ‰æ‹¦æˆªäº†ï¼Œæ‰èƒ½åœ¨æ•°æ®å˜åŒ–æ—¶åšé¢å¤–æ“ä½œï¼ˆé€šçŸ¥è§†å›¾æ›´æ–°ï¼‰ã€‚

## ref å’Œ reactive çš„å®ç°

### reactiveï¼šçº¯ Proxy

```ts
// ç®€åŒ–ç‰ˆæºç 
function reactive(target) {
  return new Proxy(target, {
    get(target, key) {
      track(target, key) // ä¾èµ–æ”¶é›†
      return target[key]
    },
    set(target, key, value) {
      target[key] = value
      trigger(target, key) // æ´¾å‘æ›´æ–°
      return true
    },
  })
}
```

### refï¼šdefineProperty + Proxy

```ts
// ç®€åŒ–ç‰ˆæºç 
class RefImpl {
  private _value

  constructor(value) {
    // å¦‚æœæ˜¯å¯¹è±¡ï¼Œç”¨ reactive åŒ…è£…
    this._value = isObject(value) ? reactive(value) : value
  }

  get value() {
    track(this, 'value') // ä¾èµ–æ”¶é›†
    return this._value
  }

  set value(newVal) {
    this._value = isObject(newVal) ? reactive(newVal) : newVal
    trigger(this, 'value') // æ´¾å‘æ›´æ–°
  }
}
```

ğŸ¯ **å…³é”®ç†è§£**ï¼š

- `ref` é€šè¿‡ getter/setter æ‹¦æˆª `.value` çš„è¯»å†™
- `ref` çš„å€¼å¦‚æœæ˜¯å¯¹è±¡ï¼Œå†…éƒ¨ä¼šç”¨ `reactive` åŒ…è£…

## åˆ¤æ–­æ˜¯å¦ä¼šè§¦å‘æ‹¦æˆª

è¿™æ˜¯ç†è§£å“åº”å¼çš„**æ ¸å¿ƒèƒ½åŠ›**ã€‚

### æ‹¦æˆªæ¡ä»¶

| API      | ä¼šè¢«æ‹¦æˆªçš„æ“ä½œ         |
| -------- | ---------------------- |
| ref      | è¯»å†™ `.value`          |
| reactive | è¯»å†™ä»£ç†å¯¹è±¡çš„ä»»æ„æˆå‘˜ |

### ç»ƒä¹  1ï¼šref åŸºç¡€ç±»å‹

```ts
let state = ref(1)

state // âŒ ä¸æ‹¦æˆªï¼ˆæ²¡æœ‰è®¿é—® .valueï¼‰
console.log(state) // âŒ ä¸æ‹¦æˆª
console.log(state.value) // âœ… æ‹¦æˆªï¼ˆè®¿é—® .valueï¼‰
state.value = 2 // âœ… æ‹¦æˆªï¼ˆè®¾ç½® .valueï¼‰
state = 3 // âŒ ä¸æ‹¦æˆªï¼ˆé‡æ–°èµ‹å€¼å˜é‡ï¼Œä¸æ˜¯æ“ä½œ refï¼‰
```

### ç»ƒä¹  2ï¼šref å¯¹è±¡ç±»å‹

```ts
let state = ref({ a: 1 })

state.value // âœ… æ‹¦æˆª value çš„ get
state.value.a // âœ… æ‹¦æˆª value çš„ get + a çš„ get
state.value.a = 2 // âœ… æ‹¦æˆª value çš„ get + a çš„ set
state.value = {} // âœ… æ‹¦æˆª value çš„ set
state.a // âŒ ä¸æ‹¦æˆªï¼ˆref å¯¹è±¡æœ¬èº«æ²¡æœ‰ a å±æ€§ï¼‰
```

### ç»ƒä¹  3ï¼šreactive

```ts
let state = reactive({ a: 1 })

state // âŒ ä¸æ‹¦æˆªï¼ˆæ²¡æœ‰æ“ä½œæˆå‘˜ï¼‰
state.a // âœ… æ‹¦æˆª a çš„ get
state.a = 2 // âœ… æ‹¦æˆª a çš„ set
state.b = 3 // âœ… æ‹¦æˆª b çš„ setï¼ˆæ–°å¢å±æ€§ä¹Ÿèƒ½æ‹¦æˆªï¼‰
delete state.a // âœ… æ‹¦æˆª delete æ“ä½œ
```

### ç»ƒä¹  4ï¼šåµŒå¥—å¯¹è±¡

```ts
const state = reactive({
  user: { name: 'Tom' },
})

state.user // âœ… æ‹¦æˆª user çš„ get
state.user.name // âœ… æ‹¦æˆª user çš„ get + name çš„ get
state.user.name = 'Jerry' // âœ… æ‹¦æˆª user çš„ get + name çš„ set
```

### ç»ƒä¹  5ï¼šè§£æ„é™·é˜±

```ts
const state = ref({ a: 1 })
const obj = state.value // âœ… æ‹¦æˆª value çš„ get

// æ­¤æ—¶ obj æ˜¯ä¸€ä¸ª Proxy å¯¹è±¡
obj.a // âœ… æ‹¦æˆªï¼ˆæ“ä½œçš„æ˜¯ Proxyï¼‰
obj.a = 2 // âœ… æ‹¦æˆª
```

```ts
const state = reactive({ a: 1 })
const { a } = state // âœ… æ‹¦æˆª a çš„ get

// æ­¤æ—¶ a æ˜¯æ™®é€šå€¼ 1
a // âŒ ä¸æ‹¦æˆªï¼ˆa ä¸æ˜¯å“åº”å¼çš„ï¼‰
```

### ç»ƒä¹  6ï¼šæ•°ç»„

```ts
const arr = reactive([1, 2, 3])

arr // âŒ ä¸æ‹¦æˆª
arr.length // âœ… æ‹¦æˆª length çš„ get
arr[0] // âœ… æ‹¦æˆªç´¢å¼• 0 çš„ get
arr[0] = 10 // âœ… æ‹¦æˆªç´¢å¼• 0 çš„ set
arr.push(4) // âœ… æ‹¦æˆªï¼ˆpush å†…éƒ¨ä¼šè¯»å†™å¤šä¸ªå±æ€§ï¼‰
```

## å¸¸è§è¯¯åŒº

### è¯¯åŒº 1ï¼šä»¥ä¸ºèµ‹å€¼å˜é‡ä¼šè§¦å‘å“åº”å¼

```ts
let state = ref(1)
state = ref(2) // âŒ è¿™ä¸ä¼šè§¦å‘ä»»ä½•å“åº”å¼æ›´æ–°ï¼
// åªæ˜¯æŠŠ state æŒ‡å‘äº†æ–°çš„ refï¼ŒåŸæ¥çš„ ref æ²¡äººç”¨äº†
```

### è¯¯åŒº 2ï¼šè§£æ„åå¤±å»å“åº”å¼

```ts
const state = reactive({ count: 0 })
let { count } = state // count æ˜¯æ™®é€šå€¼ 0

count++ // âŒ ä¸ä¼šè§¦å‘æ›´æ–°ï¼Œå› ä¸º count ä¸æ˜¯å“åº”å¼çš„
```

è§£å†³ï¼šç”¨ `toRefs`

```ts
const { count } = toRefs(state)
count.value++ // âœ… ä¼šè§¦å‘æ›´æ–°
```

## å°ç»“

| æƒ…å†µ                  | æ˜¯å¦æ‹¦æˆª |
| --------------------- | -------- |
| `ref.value`           | âœ…       |
| `ref.xxx`ï¼ˆé valueï¼‰ | âŒ       |
| `reactive.xxx`        | âœ…       |
| å˜é‡é‡æ–°èµ‹å€¼          | âŒ       |
| è§£æ„å‡ºçš„åŸå§‹å€¼        | âŒ       |

ğŸ¯ **æ ¸å¿ƒåŸåˆ™**ï¼šåªæœ‰æ“ä½œ**è¢«ä»£ç†çš„å¯¹è±¡çš„æˆå‘˜**æ‰ä¼šè§¦å‘æ‹¦æˆªã€‚

ä¸‹ä¸€ç¯‡æˆ‘ä»¬æ¥çœ‹å“åº”å¼ç³»ç»Ÿå¦‚ä½•å®ç°ä¾èµ–æ”¶é›†å’Œæ´¾å‘æ›´æ–°ã€‚
