---
title: 'Vue3 运行机制'
pubDate: 2024-01-15
category: 'Vue'
tags: ['Vue3', '面试']
description: '面试题：介绍一下 Vue3 内部的运行机制是怎样的？'
---

## 面试题

> 介绍一下 Vue3 内部的运行机制是怎样的？

## 三大核心模块

```
模板 → [编译器] → 渲染函数 → [执行] → 虚拟DOM → [渲染器] → 真实DOM
                      ↑                              ↓
                      └──── [响应式系统] ←────────────┘
```

## 一、如何描述 UI

```html
<h1 id="title" @click="handler"><span>hello</span></h1>
```

用 JS 对象描述：

```js
const vnode = {
  tag: 'h1',
  props: { id: 'title', onClick: handler },
  children: [{ tag: 'span', children: 'hello' }],
}
```

模板更直观，但 JS 对象更灵活：

```js
// 模板方式（冗长）
// <h1 v-if="level === 1">...</h1>
// <h2 v-else-if="level === 2">...</h2>

// JS 方式（简洁）
const title = { tag: `h${level}` }
```

## 二、编译器

将模板转换为渲染函数：

```vue
<template>
  <div><h1 :id="someId">Hello</h1></div>
</template>
```

编译为：

```js
function render() {
  return h('div', [h('h1', { id: someId }, 'Hello')])
}
```

**编译过程**：

```
模板 → [解析器] → 模板AST → [转换器] → JS AST → [生成器] → 渲染函数
```

**编译优化**：

- 静态提升
- 预字符串化
- 缓存事件处理函数
- Block Tree + PatchFlag

## 三、渲染器

将虚拟 DOM 转换为真实 DOM：

```js
function renderer(vnode, container) {
  // 1. 创建元素
  const el = document.createElement(vnode.tag)

  // 2. 处理属性和事件
  for (const key in vnode.props) {
    if (key.startsWith('on')) {
      el.addEventListener(key.slice(2).toLowerCase(), vnode.props[key])
    } else {
      el.setAttribute(key, vnode.props[key])
    }
  }

  // 3. 处理子节点
  if (typeof vnode.children === 'string') {
    el.textContent = vnode.children
  } else if (Array.isArray(vnode.children)) {
    vnode.children.forEach((child) => renderer(child, el))
  }

  container.appendChild(el)
}
```

**更新时**：使用 diff 算法找出变更点，只更新需要更新的内容。

## 四、组件的本质

组件是一组 DOM 元素的封装：

```js
const MyComponent = {
  render() {
    return { tag: 'div', children: 'click me' }
  },
}

const vnode = { tag: MyComponent }
```

## 五、响应式系统

渲染函数执行时，内部用到的响应式数据会与渲染函数建立依赖关系，数据变化时渲染函数自动重新执行。

## 参考答案

Vue3 是声明式框架，使用模板或虚拟 DOM 描述 UI。

1. **编译器**：将模板编译为渲染函数，同时做静态分析优化
2. **响应式系统**：建立数据与渲染函数的依赖关系，数据变化自动触发更新
3. **渲染器**：将虚拟 DOM 渲染为真实 DOM，更新时使用 diff 算法最小化 DOM 操作

三个模块互相配合，共同构成 Vue 的核心运行机制。
