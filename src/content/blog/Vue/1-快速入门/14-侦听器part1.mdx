---
title: 'Vue3 ä¾¦å¬å™¨ watch åŸºç¡€'
pubDate: 2024-01-15
category: 'Vue'
tags: ['Vue3', 'watch', 'ä¾¦å¬å™¨']
description: 'æŒæ¡ watch çš„åŸºæœ¬ç”¨æ³•ã€å¯ä¾¦å¬çš„æ•°æ®æºç±»å‹ã€ä»¥åŠé…ç½®é€‰é¡¹'
---

ğŸ™‹ computed å’Œ watch æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

- **computed**ï¼šæ ¹æ®ä¾èµ–æ•°æ®**æ´¾ç”Ÿ**æ–°æ•°æ®ï¼Œä¸èƒ½æœ‰å‰¯ä½œç”¨
- **watch**ï¼šä¾èµ–æ•°æ®å˜åŒ–æ—¶**æ‰§è¡Œå‰¯ä½œç”¨**ï¼ˆè¯·æ±‚ã€DOM æ“ä½œç­‰ï¼‰

## åŸºæœ¬ç”¨æ³•

```vue
<script setup>
import { ref, watch } from 'vue'

const question = ref('')
const answer = ref('')

watch(question, async (newVal, oldVal) => {
  if (newVal.includes('?')) {
    answer.value = 'æ€è€ƒä¸­...'
    const res = await fetch('https://yesno.wtf/api')
    const data = await res.json()
    answer.value = data.answer
  }
})
</script>

<template>
  <input v-model="question" placeholder="è¾“å…¥é—®é¢˜ï¼Œä»¥ ? ç»“å°¾" />
  <p>{{ answer }}</p>
</template>
```

`watch` æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼š

1. **ä¾¦å¬æº**ï¼šè¦ä¾¦å¬çš„æ•°æ®
2. **å›è°ƒå‡½æ•°**ï¼šæ•°æ®å˜åŒ–æ—¶æ‰§è¡Œï¼Œæ¥æ”¶ `(newValue, oldValue)`
3. **é€‰é¡¹å¯¹è±¡**ï¼ˆå¯é€‰ï¼‰

## å¯ä¾¦å¬çš„æ•°æ®æº

### 1. ref

```ts
const count = ref(0)
watch(count, (newVal, oldVal) => {
  console.log(`${oldVal} â†’ ${newVal}`)
})
```

### 2. reactive å¯¹è±¡

```ts
const state = reactive({ count: 0, name: 'Vue' })

// ä¾¦å¬æ•´ä¸ªå¯¹è±¡ï¼ˆè‡ªåŠ¨æ·±å±‚ä¾¦å¬ï¼‰
watch(state, () => {
  console.log('state å˜åŒ–äº†')
})
```

### 3. getter å‡½æ•°

```ts
const state = reactive({ count: 0 })

// ä¾¦å¬å¯¹è±¡çš„æŸä¸ªå±æ€§ï¼Œç”¨ getter
watch(
  () => state.count,
  (newVal) => console.log(newVal)
)
```

ğŸ”¶ **æ³¨æ„**ï¼šä¸èƒ½ç›´æ¥ä¾¦å¬ `state.count`ï¼Œå¿…é¡»åŒ…è£…æˆ getterï¼š

```ts
// âŒ é”™è¯¯
watch(state.count, () => {})

// âœ… æ­£ç¡®
watch(
  () => state.count,
  () => {}
)
```

### 4. è®¡ç®—å±æ€§

```ts
const doubled = computed(() => count.value * 2)

watch(doubled, (newVal) => {
  console.log('doubled:', newVal)
})
```

### 5. å¤šä¸ªæ•°æ®æºï¼ˆæ•°ç»„ï¼‰

```ts
const firstName = ref('John')
const lastName = ref('Doe')

watch([firstName, lastName], ([newFirst, newLast], [oldFirst, oldLast]) => {
  console.log(`${oldFirst} ${oldLast} â†’ ${newFirst} ${newLast}`)
})
```

## é…ç½®é€‰é¡¹

```ts
watch(source, callback, {
  immediate: false, // æ˜¯å¦ç«‹å³æ‰§è¡Œä¸€æ¬¡
  deep: false, // æ˜¯å¦æ·±å±‚ä¾¦å¬
  once: false, // æ˜¯å¦åªæ‰§è¡Œä¸€æ¬¡ï¼ˆVue 3.4+ï¼‰
  flush: 'pre', // å›è°ƒæ—¶æœºï¼š'pre' | 'post' | 'sync'
})
```

### immediateï¼šç«‹å³æ‰§è¡Œ

é»˜è®¤æƒ…å†µä¸‹ï¼Œwatch æ˜¯æƒ°æ€§çš„ï¼Œåªåœ¨æ•°æ®å˜åŒ–æ—¶æ‰æ‰§è¡Œã€‚è®¾ç½® `immediate: true` å¯ä»¥ç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼š

```ts
watch(
  userId,
  async (id) => {
    userData.value = await fetchUser(id)
  },
  { immediate: true } // ç»„ä»¶åˆ›å»ºæ—¶ç«‹å³è¯·æ±‚
)
```

### deepï¼šæ·±å±‚ä¾¦å¬

ä¾¦å¬ getter è¿”å›çš„å¯¹è±¡æ—¶ï¼Œé»˜è®¤ä¸æ˜¯æ·±å±‚ä¾¦å¬ï¼š

```ts
const state = reactive({
  nested: { count: 0 },
})

// é»˜è®¤ä¸ä¼šè§¦å‘ï¼ˆåªç›‘å¬ nested å¯¹è±¡å¼•ç”¨å˜åŒ–ï¼‰
watch(
  () => state.nested,
  () => console.log('changed')
)

// æ·»åŠ  deep æ‰ä¼šè§¦å‘
watch(
  () => state.nested,
  () => console.log('changed'),
  { deep: true }
)
```

ğŸ”¶ **æ³¨æ„**ï¼šç›´æ¥ä¾¦å¬ reactive å¯¹è±¡æ—¶è‡ªåŠ¨æ˜¯æ·±å±‚çš„ï¼Œä¸éœ€è¦åŠ  deepã€‚

### onceï¼šåªæ‰§è¡Œä¸€æ¬¡

```ts
watch(
  source,
  () => {
    // åªåœ¨ç¬¬ä¸€æ¬¡å˜åŒ–æ—¶æ‰§è¡Œ
  },
  { once: true }
)
```

## å®æˆ˜åœºæ™¯

### åœºæ™¯ 1ï¼šæœç´¢é˜²æŠ–

```vue
<script setup>
import { ref, watch } from 'vue'

const keyword = ref('')
const results = ref([])
let timer = null

watch(keyword, (val) => {
  clearTimeout(timer)
  timer = setTimeout(async () => {
    if (val) {
      results.value = await searchAPI(val)
    }
  }, 300)
})
</script>
```

### åœºæ™¯ 2ï¼šè·¯ç”±å‚æ•°å˜åŒ–

```ts
import { watch } from 'vue'
import { useRoute } from 'vue-router'

const route = useRoute()

watch(
  () => route.params.id,
  (newId) => {
    // è·¯ç”±å‚æ•°å˜åŒ–æ—¶é‡æ–°è¯·æ±‚æ•°æ®
    fetchData(newId)
  }
)
```

### åœºæ™¯ 3ï¼šlocalStorage åŒæ­¥

```ts
const theme = ref(localStorage.getItem('theme') || 'light')

watch(theme, (val) => {
  localStorage.setItem('theme', val)
  document.documentElement.className = val
})
```

## å°ç»“

| åœºæ™¯          | ç”¨æ³•                                 |
| ------------- | ------------------------------------ |
| ä¾¦å¬ ref      | `watch(ref, callback)`               |
| ä¾¦å¬ reactive | `watch(reactive, callback)` è‡ªåŠ¨æ·±å±‚ |
| ä¾¦å¬å¯¹è±¡å±æ€§  | `watch(() => obj.prop, callback)`    |
| ä¾¦å¬å¤šä¸ªæº    | `watch([a, b], callback)`            |
| ç«‹å³æ‰§è¡Œ      | `{ immediate: true }`                |
| æ·±å±‚ä¾¦å¬      | `{ deep: true }`                     |

ä¸‹ä¸€ç¯‡ç»§ç»­æ·±å…¥ watch çš„é«˜çº§ç”¨æ³•ã€‚
