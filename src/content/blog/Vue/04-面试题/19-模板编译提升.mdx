---
title: '模板编译优化'
pubDate: 2024-01-15
category: 'Vue'
tags: ['Vue3', '面试']
description: '面试题：Vue3 在模板编译时做了哪些优化？'
---

## 面试题

> 说一下 Vue3 在进行模板编译时做了哪些优化？

## 1. 静态提升

将静态节点提升到渲染函数外部，避免重复创建。

```vue
<p>静态内容</p>
<p>{{ dynamic }}</p>
```

```js
// 静态节点提升到外部
const _hoisted_1 = createStaticVNode('<p>静态内容</p>')

function render() {
  return [
    _hoisted_1, // 复用
    createElementVNode('p', null, toDisplayString(dynamic)),
  ]
}
```

静态属性也会提升：

```js
const _hoisted_1 = { class: 'btn' } // 静态属性
```

## 2. 预字符串化

大量连续静态节点（约 10 个以上）直接编译为字符串：

```js
const _hoisted_1 = createStaticVNode(
  "<div class='logo'><h1>logo</h1></div><ul>...</ul>",
  2
)
```

**好处**：

- 减少虚拟 DOM 节点数量
- 加速 diff 过程
- SSR 时减少服务器计算

## 3. 缓存事件处理函数

内联事件处理函数会被缓存：

```vue
<button @click="count++">plus</button>
```

```js
// Vue2: 每次渲染都创建新函数
onClick: () => ctx.count++

// Vue3: 使用缓存
onClick: cache[0] || (cache[0] = () => ctx.count++)
```

## 4. Block Tree

### Block 节点

带有 `dynamicChildren` 属性的虚拟 DOM 节点，只收集动态子节点：

```
form (block)
├── dynamicChildren: [input1, input2]
├── div (静态)
│   └── label (静态)
└── input (动态) ← 只对比这个
```

### 哪些节点会成为 Block

- 模板根节点
- v-if/v-else/v-for 节点（结构不稳定）

### 好处

diff 时跳过静态节点，只对比 dynamicChildren。

## 5. PatchFlag

标记动态节点的变化类型，精确更新：

```vue
<div :class="cls" data-id="1">{{ text }}</div>
```

```js
createElementVNode(
  'div',
  {
    'class': normalizeClass(cls),
    'data-id': '1',
  },
  toDisplayString(text),
  3 /* TEXT, CLASS */
)
```

只检查标记的部分：

- TEXT (1)：文本可能变化
- CLASS (2)：class 可能变化
- STYLE (4)：style 可能变化
- PROPS (8)：属性可能变化

## 总结

| 优化       | 解决的问题             |
| ---------- | ---------------------- |
| 静态提升   | 避免重复创建静态 vnode |
| 预字符串化 | 减少 vnode 数量        |
| 事件缓存   | 避免重复创建函数       |
| Block Tree | 跳过静态节点对比       |
| PatchFlag  | 精确更新动态部分       |
