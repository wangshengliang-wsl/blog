---
title: '响应式代码题'
pubDate: 2024-01-15
category: 'Vue'
tags: ['Vue3', '面试']
description: '两道关于响应式和渲染次数的代码题'
---

## 题目一：实现响应式

完成 Component 类代码，要求：

1. 修改数据时触发 render 方法
2. 同步变更需要合并，仅触发一次 render

```js
class Component {
  data = { name: '' }
  render() {
    console.log(`render - name: ${this.data.name}`)
  }
}

const com = new Component()
com.data.name = '张三'
com.data.name = '李四'
com.data.name = '王五' // 只触发一次 render

setTimeout(() => {
  com.data.name = '渡一' // 触发一次 render
}, 0)
```

**参考实现**：

```js
class Component {
  #pending = false

  constructor() {
    this.data = new Proxy(
      { name: '' },
      {
        set: (target, key, value) => {
          target[key] = value
          this.#scheduleRender()
          return true
        },
      }
    )
  }

  #scheduleRender() {
    if (this.#pending) return
    this.#pending = true
    Promise.resolve().then(() => {
      this.render()
      this.#pending = false
    })
  }

  render() {
    console.log(`render - name: ${this.data.name}`)
  }
}
```

## 题目二：渲染次数

**代码一**（同步赋值）：

```vue
<script setup>
import { ref } from 'vue'
const rCount = ref(0)
for (let i = 1; i <= 5; i++) {
  rCount.value = i
}
</script>
```

**答案**：渲染 **2 次**

- 初始化渲染 1 次
- 5 次同步修改被合并为 1 次更新

---

**代码二**（异步赋值）：

```vue
<script setup>
import { ref } from 'vue'
const rCount = ref(0)
for (let i = 1; i <= 5; i++) {
  setTimeout(() => {
    rCount.value = i
  }, 0)
}
</script>
```

**答案**：渲染 **6 次**

- 初始化渲染 1 次
- 每个 setTimeout 回调触发 1 次更新，共 5 次

## 核心知识点

| 场景         | 行为           |
| ------------ | -------------- |
| 同步修改多次 | 合并为一次更新 |
| 异步分别修改 | 每次触发更新   |

**原因**：Vue 的响应式更新是异步的，同步代码中的多次修改会在同一个微任务中被合并。
