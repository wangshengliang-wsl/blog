---
title: '图解双端 diff 算法'
pubDate: 2024-01-15
category: 'Vue'
tags: ['Vue3', '面试']
description: 'Vue2 双端 diff 算法详解，理解虚拟 DOM 对比的核心逻辑'
---

## diff 算法概念

比较新旧两棵虚拟 DOM 树，找出差异，最小化更新真实 DOM。

**为什么需要 diff？**

响应式只能定位到组件级别，组件重新渲染后会生成新的 vnode 树，需要 diff 找出具体哪些节点变化。

## diff 算法特点

1. **分层对比**：只比较同层节点，不做跨层比较
2. **深度优先**：先处理完子节点再处理兄弟节点
3. **key 值优化**：通过 key 判断节点是否可复用

## 双端 diff 流程

使用四个指针：`oldStart`、`oldEnd`、`newStart`、`newEnd`

```
旧: [A] [B] [C] [D]
     ↑           ↑
  oldStart    oldEnd

新: [D] [A] [C] [B]
     ↑           ↑
  newStart    newEnd
```

### 对比顺序

1. **头头对比**：oldStart vs newStart
2. **尾尾对比**：oldEnd vs newEnd
3. **旧头新尾**：oldStart vs newEnd
4. **新头旧尾**：newStart vs oldEnd
5. **暴力查找**：在旧节点中查找 newStart

### 步骤详解

**头头相同**：

- 复用节点
- 两个头指针右移

**尾尾相同**：

- 复用节点
- 两个尾指针左移

**旧头新尾相同**：

- 复用节点
- 将 DOM 移动到 oldEnd 之后
- oldStart 右移，newEnd 左移

**新头旧尾相同**：

- 复用节点
- 将 DOM 移动到 oldStart 之前
- newStart 右移，oldEnd 左移

**暴力查找**：

- 在旧节点中找到则移动
- 找不到则创建新节点
- newStart 右移

### 结束条件

- `oldStart > oldEnd`：旧节点遍历完，剩余新节点需要创建
- `newStart > newEnd`：新节点遍历完，剩余旧节点需要删除

## 示例

```
旧: A B C D E
新: A D C B F E
```

1. 头头 A=A，复用，指针右移
2. 尾尾 E=E，复用，指针左移
3. 头头 B≠D，尾尾 D≠B，旧头新尾 B≠B，新头旧尾 D=D，移动 D 到 B 前
4. 头头 B≠C，...，暴力查找 C，移动
5. 头头 B≠B，...，暴力查找 B，移动
6. newStart > newEnd？否，继续...
7. 新节点 F 在旧节点中找不到，创建
8. 完成

## 为什么需要 key

没有 key 时，只能按顺序对比，即使只是顺序变化也要删除重建。

有 key 时，可以识别出相同节点进行复用和移动。
