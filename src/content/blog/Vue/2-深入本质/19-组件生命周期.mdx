---
title: 'ç»„ä»¶ç”Ÿå‘½å‘¨æœŸçš„æœ¬è´¨'
pubDate: 2024-01-15
category: 'Vue'
tags: ['Vue3', 'åŸç†', 'ç”Ÿå‘½å‘¨æœŸ']
description: 'ä»æ¸²æŸ“å™¨è§’åº¦ç†è§£ç”Ÿå‘½å‘¨æœŸé’©å­çš„æ‰§è¡Œæ—¶æœºå’ŒåµŒå¥—ç»„ä»¶çš„æ‰§è¡Œé¡ºåº'
---

ğŸ™‹ ç”Ÿå‘½å‘¨æœŸçš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ

**åœ¨åˆé€‚çš„æ—¶æœºè°ƒç”¨ç”¨æˆ·æ³¨å†Œçš„å›è°ƒå‡½æ•°ã€‚**

## ç”Ÿå‘½å‘¨æœŸé˜¶æ®µ

| é˜¶æ®µ | é’©å­                           | æ—¶æœº                         |
| ---- | ------------------------------ | ---------------------------- |
| åˆ›å»º | setup / beforeCreate / created | ç»„ä»¶å®ä¾‹åˆ›å»ºå‰å             |
| æŒ‚è½½ | onBeforeMount / onMounted      | DOM æŒ‚è½½å‰å                 |
| æ›´æ–° | onBeforeUpdate / onUpdated     | å“åº”å¼æ•°æ®å˜åŒ–å¯¼è‡´é‡æ¸²æŸ“å‰å |
| å¸è½½ | onBeforeUnmount / onUnmounted  | ç»„ä»¶å¸è½½å‰å                 |

## Vue2 vs Vue3 é’©å­åç§°

| é˜¶æ®µ   | Vue2          | Vue3 Composition API |
| ------ | ------------- | -------------------- |
| åˆ›å»ºå‰ | beforeCreate  | setup                |
| åˆ›å»ºå | created       | setup                |
| æŒ‚è½½å‰ | beforeMount   | onBeforeMount        |
| æŒ‚è½½å | mounted       | onMounted            |
| æ›´æ–°å‰ | beforeUpdate  | onBeforeUpdate       |
| æ›´æ–°å | updated       | onUpdated            |
| å¸è½½å‰ | beforeDestroy | onBeforeUnmount      |
| å¸è½½å | destroyed     | onUnmounted          |

## ç»„ä»¶å®ä¾‹

ç»„ä»¶å®ä¾‹æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œç»´æŠ¤ç»„ä»¶è¿è¡Œè¿‡ç¨‹ä¸­çš„æ‰€æœ‰ä¿¡æ¯ï¼š

```ts
const instance = {
  state, // ç»„ä»¶çŠ¶æ€ï¼ˆdataï¼‰
  props, // æ¥æ”¶çš„ props
  isMounted: false, // æ˜¯å¦å·²æŒ‚è½½
  subTree: null, // æ¸²æŸ“çš„å­æ ‘ï¼ˆVNodeï¼‰
  // ç”Ÿå‘½å‘¨æœŸé’©å­
  bm: null, // beforeMount
  m: null, // mounted
  bu: null, // beforeUpdate
  u: null, // updated
  // ...
}
```

## æ¸²æŸ“å™¨ä¸­çš„å®ç°

```ts
function mountComponent(vnode, container) {
  // ä»é€‰é¡¹å¯¹è±¡ä¸­è·å–ç”Ÿå‘½å‘¨æœŸé’©å­
  const {
    render,
    data,
    beforeCreate,
    created,
    beforeMount,
    mounted,
    beforeUpdate,
    updated,
  } = vnode.type

  // â‘  beforeCreate
  beforeCreate?.()

  // åˆ›å»ºå“åº”å¼çŠ¶æ€
  const state = reactive(data())

  // åˆ›å»ºç»„ä»¶å®ä¾‹
  const instance = {
    state,
    isMounted: false,
    subTree: null,
  }
  vnode.component = instance

  // â‘¡ created
  created?.call(state)

  // è®¾ç½®æ¸²æŸ“å‰¯ä½œç”¨
  effect(() => {
    const subTree = render.call(state)

    if (!instance.isMounted) {
      // â‘¢ beforeMount
      beforeMount?.call(state)

      // æŒ‚è½½ DOM
      patch(null, subTree, container)
      instance.isMounted = true

      // â‘£ mounted
      mounted?.call(state)
    } else {
      // â‘¤ beforeUpdate
      beforeUpdate?.call(state)

      // æ›´æ–° DOM
      patch(instance.subTree, subTree, container)

      // â‘¥ updated
      updated?.call(state)
    }

    instance.subTree = subTree
  })
}
```

## åµŒå¥—ç»„ä»¶çš„æ‰§è¡Œé¡ºåº

ç»„ä»¶ A åŒ…å«ç»„ä»¶ Bï¼š

```
A å¼€å§‹æŒ‚è½½
  â”œâ”€â”€ A: onBeforeMount
  â”œâ”€â”€ B å¼€å§‹æŒ‚è½½
  â”‚   â”œâ”€â”€ B: onBeforeMount
  â”‚   â””â”€â”€ B: onMounted
  â””â”€â”€ A: onMounted
```

**æŒ‚è½½é¡ºåº**ï¼šå¤– beforeMount â†’ å†… beforeMount â†’ å†… mounted â†’ å¤– mounted

**å¸è½½é¡ºåº**ï¼šå¤– beforeUnmount â†’ å†… beforeUnmount â†’ å†… unmounted â†’ å¤– unmounted

```ts
// ä¼ªä»£ç æ¼”ç¤ºé€’å½’è¿‡ç¨‹
function mountComponent(vnode) {
  beforeMount()

  // æ¸²æŸ“å­æ ‘æ—¶ï¼Œå¦‚æœé‡åˆ°å­ç»„ä»¶ï¼Œé€’å½’è°ƒç”¨ mountComponent
  const subTree = render()
  patch(null, subTree) // è¿™é‡Œå¯èƒ½è§¦å‘å­ç»„ä»¶çš„ mountComponent

  mounted()
}
```

## ç”Ÿå‘½å‘¨æœŸå›¾è§£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç»„ä»¶åˆ›å»º                            â”‚
â”‚  setup() / beforeCreate â†’ åˆ›å»ºå®ä¾‹ â†’ created           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç¼–è¯‘æ¨¡æ¿                            â”‚
â”‚              template â†’ render function                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     åˆæ¬¡æŒ‚è½½                            â”‚
â”‚      beforeMount â†’ åˆ›å»ºçœŸå® DOM â†’ mounted              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å“åº”å¼æ›´æ–°                          â”‚
â”‚      beforeUpdate â†’ patch DOM â†’ updated                â”‚
â”‚              â†‘                    â”‚                    â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç»„ä»¶å¸è½½                            â”‚
â”‚      beforeUnmount â†’ ç§»é™¤ DOM â†’ unmounted              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å°ç»“

| æ¦‚å¿µ      | è¯´æ˜                             |
| --------- | -------------------------------- |
| æœ¬è´¨      | åœ¨ç‰¹å®šæ—¶æœºè°ƒç”¨ç”¨æˆ·çš„å›è°ƒå‡½æ•°     |
| ç»„ä»¶å®ä¾‹  | ç»´æŠ¤ç»„ä»¶çŠ¶æ€ã€å­æ ‘ã€æŒ‚è½½çŠ¶æ€ç­‰   |
| åµŒå¥—æ‰§è¡Œ  | é€’å½’è¿‡ç¨‹ï¼Œå†…å±‚ç»„ä»¶å…ˆå®ŒæˆæŒ‚è½½     |
| Vue3 å‘½å | ä½¿ç”¨ on å‰ç¼€ï¼Œæ›´ç¬¦åˆäº‹ä»¶ç›‘å¬è¯­ä¹‰ |

ä¸‹ä¸€ç¯‡æˆ‘ä»¬æ¥çœ‹ KeepAlive çš„ç‰¹æ®Šç”Ÿå‘½å‘¨æœŸã€‚
