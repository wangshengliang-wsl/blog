---
title: 'æ•°æ®æ‹¦æˆªï¼šdefineProperty vs Proxy'
pubDate: 2024-01-15
category: 'Vue'
tags: ['Vue3', 'åŸç†', 'Proxy']
description: 'å¯¹æ¯” Object.defineProperty å’Œ Proxy ä¸¤ç§æ•°æ®æ‹¦æˆªæ–¹å¼çš„å·®å¼‚'
---

ğŸ™‹ ä»€ä¹ˆæ˜¯æ•°æ®æ‹¦æˆªï¼Ÿ

å°±æ˜¯åœ¨è¯»å†™æ•°æ®æ—¶"æ‰“æ–­"ï¼Œè®©æˆ‘ä»¬æœ‰æœºä¼šåšé¢å¤–çš„äº‹æƒ…ï¼ˆæ¯”å¦‚é€šçŸ¥è§†å›¾æ›´æ–°ï¼‰ã€‚

## ä¸¤ç§æ‹¦æˆªæ–¹å¼

### 1. Object.defineProperty

ç»™å¯¹è±¡çš„**ç‰¹å®šå±æ€§**æ·»åŠ  getter/setterï¼š

```js
const obj = {}
let _value = 'åˆå§‹å€¼'

Object.defineProperty(obj, 'data', {
  get() {
    console.log('è¯»å– data')
    return _value
  },
  set(newVal) {
    console.log('è®¾ç½® data')
    _value = newVal
  },
})

obj.data // è¯»å– data
obj.data = 'x' // è®¾ç½® data
```

### 2. Proxy

ç»™**æ•´ä¸ªå¯¹è±¡**åˆ›å»ºä»£ç†ï¼š

```js
const obj = { data: 'åˆå§‹å€¼', name: 'å¼ ä¸‰' }

const proxy = new Proxy(obj, {
  get(target, key) {
    console.log(`è¯»å– ${key}`)
    return target[key]
  },
  set(target, key, value) {
    console.log(`è®¾ç½® ${key}`)
    target[key] = value
    return true
  },
})

proxy.data // è¯»å– data
proxy.data = 'x' // è®¾ç½® data
proxy.name // è¯»å– nameï¼ˆä¹Ÿèƒ½æ‹¦æˆªï¼ï¼‰
```

## æ ¸å¿ƒå·®å¼‚

| ç‰¹æ€§     | defineProperty | Proxy       |
| -------- | -------------- | ----------- |
| æ‹¦æˆªç›®æ ‡ | ç‰¹å®šå±æ€§       | æ•´ä¸ªå¯¹è±¡    |
| æ–°å¢å±æ€§ | âŒ æ— æ³•æ‹¦æˆª    | âœ… èƒ½æ‹¦æˆª   |
| åˆ é™¤å±æ€§ | âŒ æ— æ³•æ‹¦æˆª    | âœ… èƒ½æ‹¦æˆª   |
| æ•°ç»„æ“ä½œ | âŒ éœ€è¦ hack   | âœ… åŸç”Ÿæ”¯æŒ |

### æ–°å¢å±æ€§é—®é¢˜

```js
// definePropertyï¼šæ–°å¢å±æ€§æ— æ³•æ‹¦æˆª
const obj = {}
Object.defineProperty(obj, 'a', {
  /* ... */
})
obj.b = 2 // âŒ æ–°å¢çš„ b æ²¡æœ‰æ‹¦æˆª

// Proxyï¼šæ–°å¢å±æ€§ä¹Ÿèƒ½æ‹¦æˆª
const proxy = new Proxy(
  {},
  {
    set(target, key, value) {
      console.log(`è®¾ç½® ${key}`) // æ–°å¢ b ä¹Ÿä¼šè§¦å‘
      target[key] = value
      return true
    },
  }
)
proxy.b = 2 // âœ… è®¾ç½® b
```

è¿™å°±æ˜¯ Vue2 éœ€è¦ `Vue.set()` çš„åŸå› ï¼

### Proxy èƒ½æ‹¦æˆªæ›´å¤šæ“ä½œ

```js
const proxy = new Proxy(obj, {
  get(target, key) {
    /* è¯»å– */
  },
  set(target, key, value) {
    /* è®¾ç½® */
  },
  deleteProperty(target, key) {
    /* åˆ é™¤ */
  },
  has(target, key) {
    /* in æ“ä½œç¬¦ */
  },
  ownKeys(target) {
    /* Object.keys ç­‰ */
  },
})
```

## æ·±åº¦æ‹¦æˆª

ä¸¤è€…éƒ½éœ€è¦**é€’å½’**å®ç°æ·±åº¦æ‹¦æˆªï¼š

```js
// Proxy æ·±åº¦æ‹¦æˆª
function deepProxy(obj) {
  return new Proxy(obj, {
    get(target, key) {
      const value = target[key]
      // å¦‚æœæ˜¯å¯¹è±¡ï¼Œé€’å½’ä»£ç†
      if (typeof value === 'object' && value !== null) {
        return deepProxy(value)
      }
      return value
    },
    set(target, key, value) {
      target[key] = value
      return true
    },
  })
}
```

## Vue2 çš„å“åº”å¼ç¼ºé™·

å› ä¸ºç”¨çš„æ˜¯ `Object.defineProperty`ï¼š

```js
// âŒ æ— æ³•æ£€æµ‹
obj.newKey = value // æ–°å¢å±æ€§
delete obj.key // åˆ é™¤å±æ€§
arr[index] = value // é€šè¿‡ç´¢å¼•è®¾ç½®æ•°ç»„å…ƒç´ 
arr.length = 0 // ä¿®æ”¹æ•°ç»„é•¿åº¦
```

Vue2 çš„è§£å†³æ–¹æ¡ˆï¼š

- `Vue.set(obj, key, value)` - æ–°å¢å±æ€§
- `Vue.delete(obj, key)` - åˆ é™¤å±æ€§
- é‡å†™æ•°ç»„çš„ 7 ä¸ªæ–¹æ³•ï¼ˆpushã€popã€shiftã€unshiftã€spliceã€sortã€reverseï¼‰

## Vue3 ç”¨ Proxy çš„å¥½å¤„

```js
const state = reactive({ list: [1, 2, 3] })

// ä»¥ä¸‹æ“ä½œéƒ½èƒ½è§¦å‘å“åº”å¼æ›´æ–°
state.newKey = 'value' // âœ… æ–°å¢å±æ€§
delete state.key // âœ… åˆ é™¤å±æ€§
state.list[0] = 10 // âœ… æ•°ç»„ç´¢å¼•
state.list.length = 0 // âœ… æ•°ç»„é•¿åº¦
```

ä¸éœ€è¦ä»»ä½• hackï¼ŒåŸç”Ÿæ”¯æŒï¼

## æ€§èƒ½å¯¹æ¯”

| åœºæ™¯     | defineProperty   | Proxy                |
| -------- | ---------------- | -------------------- |
| å°‘é‡å±æ€§ | æ›´å¿«ï¼ˆç›´æ¥ç»‘å®šï¼‰ | ç•¥æ…¢ï¼ˆä»£ç†å±‚ï¼‰       |
| å¤§é‡å±æ€§ | æ…¢ï¼ˆé€ä¸ªå®šä¹‰ï¼‰   | å¿«ï¼ˆä¸€æ¬¡ä»£ç†ï¼‰       |
| æ·±å±‚å¯¹è±¡ | åˆå§‹åŒ–æ—¶é€’å½’     | è®¿é—®æ—¶é€’å½’ï¼ˆæ‡’ä»£ç†ï¼‰ |

Vue3 çš„ Proxy é‡‡ç”¨**æ‡’ä»£ç†**ï¼šåªæœ‰è®¿é—®åˆ°çš„åµŒå¥—å¯¹è±¡æ‰ä¼šè¢«ä»£ç†ã€‚

## å°ç»“

| æ–¹é¢       | Vue2 (defineProperty) | Vue3 (Proxy) |
| ---------- | --------------------- | ------------ |
| æ–°å¢å±æ€§   | éœ€è¦ Vue.set          | åŸç”Ÿæ”¯æŒ     |
| åˆ é™¤å±æ€§   | éœ€è¦ Vue.delete       | åŸç”Ÿæ”¯æŒ     |
| æ•°ç»„æ“ä½œ   | é‡å†™ 7 ä¸ªæ–¹æ³•         | åŸç”Ÿæ”¯æŒ     |
| ä»£ç†æ–¹å¼   | é€ä¸ªå±æ€§              | æ•´ä¸ªå¯¹è±¡     |
| æµè§ˆå™¨æ”¯æŒ | IE9+                  | ä¸æ”¯æŒ IE    |

ä¸‹ä¸€ç¯‡æˆ‘ä»¬æ¥çœ‹å“åº”å¼æ•°æ®çš„æœ¬è´¨ã€‚
