---
title: '异步组件与懒加载'
pubDate: 2024-01-15
category: 'Vue'
tags: ['Vue3', '进阶', '性能']
description: '使用 defineAsyncComponent 实现组件懒加载，优化应用初始加载速度'
---

## 什么是异步组件

异步组件在**需要时才加载**，而非应用启动时立即加载所有组件。

**普通导入**（同步）：

```js
import MyComponent from './MyComponent.vue'
// 应用启动时就会加载
```

**异步导入**：

```js
const MyComponent = defineAsyncComponent(() => import('./MyComponent.vue'))
// 使用时才会加载
```

## 基本用法

```vue
<script setup>
import { defineAsyncComponent, shallowRef } from 'vue'

const currentComponent = shallowRef(null)

const loadComponent = (name) => {
  currentComponent.value = defineAsyncComponent(
    () => import(`./components/${name}.vue`)
  )
}
</script>

<template>
  <button @click="loadComponent('Home')">首页</button>
  <button @click="loadComponent('About')">关于</button>

  <component :is="currentComponent" v-if="currentComponent" />
</template>
```

## 全局注册

```js
// main.js
app.component(
  'MyComponent',
  defineAsyncComponent(() => import('./components/MyComponent.vue'))
)
```

## 配置选项

```js
const AsyncComponent = defineAsyncComponent({
  // 加载函数（必需）
  loader: () => import('./MyComponent.vue'),

  // 加载中显示的组件
  loadingComponent: LoadingSpinner,

  // 显示加载组件前的延迟（毫秒）
  // 避免网络快时的闪烁
  delay: 200,

  // 加载失败时显示的组件
  errorComponent: ErrorDisplay,

  // 超时时间（毫秒），超时后显示错误组件
  timeout: 3000,
})
```

## 加载和错误状态

```vue
<script setup>
import { defineAsyncComponent } from 'vue'
import LoadingSpinner from './LoadingSpinner.vue'
import ErrorDisplay from './ErrorDisplay.vue'

const AsyncProfile = defineAsyncComponent({
  loader: () => import('./Profile.vue'),
  loadingComponent: LoadingSpinner,
  errorComponent: ErrorDisplay,
  delay: 200,
  timeout: 10000,
})
</script>

<template>
  <AsyncProfile />
</template>
```

## 配合 Suspense 使用

```vue
<template>
  <Suspense>
    <template #default>
      <AsyncProfile />
    </template>
    <template #fallback>
      <LoadingSpinner />
    </template>
  </Suspense>
</template>
```

## 路由懒加载

```js
// router/index.js
const routes = [
  {
    path: '/home',
    component: () => import('../views/Home.vue'),
  },
  {
    path: '/about',
    component: () => import('../views/About.vue'),
  },
]
```

## 使用场景

| 场景          | 说明                   |
| ------------- | ---------------------- |
| 路由页面      | 每个路由页面独立加载   |
| 模态框/对话框 | 打开时才加载           |
| Tab 内容      | 切换时才加载           |
| 条件渲染组件  | 满足条件时才加载       |
| 大型组件      | 包含复杂图表、编辑器等 |

## 注意事项

1. **shallowRef**：动态组件使用 `shallowRef` 而非 `ref`，避免深度响应
2. **网络延迟**：设置合适的 delay 避免闪烁
3. **错误处理**：提供 errorComponent 处理加载失败
4. **预加载**：关键组件可以在空闲时预加载

```js
// 预加载组件
const preloadComponent = () => import('./HeavyComponent.vue')

// 在空闲时预加载
requestIdleCallback(preloadComponent)
```
