---
title: 'Vue 插件开发'
pubDate: 2024-01-15
category: 'Vue'
tags: ['Vue3', '进阶']
description: '学习如何开发 Vue 插件，为应用添加全局功能'
---

## 什么是插件

插件是一种独立模块，可以为 Vue 应用添加全局功能。

```js
// 使用插件
app.use(router).use(pinia).use(ElementPlus)
```

## 插件结构

两种形式：

```js
// 形式 1：包含 install 方法的对象
const myPlugin = {
  install(app, options) {
    // 配置应用
  },
}

// 形式 2：直接是安装函数
const myPlugin = (app, options) => {
  // 配置应用
}
```

## 插件能做什么

| 功能          | API                           |
| ------------- | ----------------------------- |
| 注册全局组件  | `app.component()`             |
| 注册全局指令  | `app.directive()`             |
| 全局依赖注入  | `app.provide()`               |
| 全局属性/方法 | `app.config.globalProperties` |

## 示例：组件库插件

```js
// my-ui/index.js
import Button from './Button.vue'
import Card from './Card.vue'
import Modal from './Modal.vue'

const components = [Button, Card, Modal]

export default {
  install(app) {
    components.forEach((component) => {
      app.component(component.name, component)
    })
  },
}
```

```js
// main.js
import MyUI from './my-ui'
app.use(MyUI)
```

## 示例：全局方法

```js
// plugins/toast.js
export default {
  install(app, options = {}) {
    const toast = (message, type = 'info') => {
      // 创建 toast DOM
      const div = document.createElement('div')
      div.className = `toast toast-${type}`
      div.textContent = message
      document.body.appendChild(div)

      setTimeout(() => div.remove(), options.duration || 3000)
    }

    // 添加全局方法
    app.config.globalProperties.$toast = toast

    // 也可以通过 provide 注入
    app.provide('toast', toast)
  },
}
```

```vue
<script setup>
import { inject } from 'vue'

// Composition API 中使用
const toast = inject('toast')
toast('操作成功', 'success')
</script>
```

```vue
<script>
export default {
  mounted() {
    // Options API 中使用
    this.$toast('操作成功')
  },
}
</script>
```

## 示例：错误处理插件

```js
// plugins/errorHandler.js
export default {
  install(app, options = {}) {
    const errors = []

    // 捕获 Vue 错误
    app.config.errorHandler = (err, vm, info) => {
      const error = {
        message: err.message,
        stack: err.stack,
        info,
        timestamp: Date.now(),
      }
      errors.push(error)

      // 可选：发送到日志服务器
      if (options.logUrl) {
        fetch(options.logUrl, {
          method: 'POST',
          body: JSON.stringify(error),
        })
      }

      console.error('[Vue Error]', err)
    }

    // 提供获取错误日志的方法
    app.provide('errorLog', {
      getErrors: () => errors,
      clearErrors: () => (errors.length = 0),
    })
  },
}
```

```js
// main.js
app.use(errorHandler, {
  logUrl: '/api/log',
})
```

## 插件选项

```js
// 使用时传入选项
app.use(myPlugin, {
  theme: 'dark',
  locale: 'zh-CN',
})

// 插件中接收
const myPlugin = {
  install(app, options) {
    console.log(options.theme) // 'dark'
    console.log(options.locale) // 'zh-CN'
  },
}
```

## 最佳实践

1. **单一职责**：一个插件只做一件事
2. **提供默认值**：选项参数提供合理的默认值
3. **文档完善**：说明插件的用法和选项
4. **TypeScript 支持**：提供类型声明
