---
title: 从零搭建第一个MCP Server
description: 使用TypeScript SDK搭建MCP开发环境，实现一个包含天气查询功能的MCP Server并在Claude Desktop中调试
pubDate: 2025-12-03
toc: true
ogImage: true
category: MCP
---

上一篇介绍了 MCP 的核心概念，这篇开始动手写代码。目标：从零搭建一个 MCP Server，注册一个简单的工具，在 Claude Desktop 里调用它。

## 环境准备

开发 MCP Server 需要以下环境：

- **Node.js** 18+（推荐 20 LTS）
- **pnpm**（或 npm/yarn）
- **TypeScript**
- **Claude Desktop**（用于测试）

验证 Node.js 版本：

```bash
node -v
# v20.x.x
```

## 理解 stdio 通信

在写代码之前，先搞清楚 MCP Server 是怎么和 Host 通信的。

本地 MCP Server 使用 **stdio**（标准输入输出）与 Client 通信。stdio 是进程间通信的基础方式：

- **stdin**：标准输入，进程从这里读取数据
- **stdout**：标准输出，进程向这里写入数据

当 Claude Desktop 启动一个 MCP Server 时：

```
┌──────────────────┐          ┌──────────────────┐
│  Claude Desktop  │          │   MCP Server     │
│     (Host)       │          │   (子进程)        │
│                  │          │                  │
│   Client ────────┼──stdin──►│ 接收请求         │
│                  │          │                  │
│   Client ◄───────┼─stdout───│ 返回响应         │
└──────────────────┘          └──────────────────┘
```

Claude Desktop 是父进程，MCP Server 是子进程。父进程通过子进程的 stdin 发送请求，从子进程的 stdout 读取响应。

这种设计的好处是：

- 简单高效，无需网络开销
- 进程隔离，Server 崩溃不影响 Host
- 任何语言都能实现，只要能读写标准输入输出

**重要提示**：MCP Server 的 stdout 只能用于发送 JSON-RPC 消息。如果你在代码里用 `console.log()` 调试，输出会混入协议数据流，导致通信失败。调试信息应该输出到 **stderr**。

```typescript
// ❌ 错误：污染 stdout
console.log('调试信息')

// ✅ 正确：输出到 stderr
console.error('调试信息')
```

## 初始化项目

创建项目目录并初始化：

```bash
mkdir mcp-weather-server
cd mcp-weather-server
pnpm init
```

安装依赖：

```bash
pnpm add @modelcontextprotocol/sdk zod
pnpm add -D typescript @types/node
```

各依赖的作用：

- `@modelcontextprotocol/sdk`：MCP 官方 SDK，封装了协议细节
- `zod`：类型校验库，用于定义工具的参数 Schema
- `typescript` / `@types/node`：TypeScript 支持

创建 `tsconfig.json`：

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "Node16",
    "moduleResolution": "Node16",
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "declaration": true
  },
  "include": ["src/**/*"]
}
```

创建 `src` 目录：

```bash
mkdir src
```

更新 `package.json`，添加构建脚本和入口配置：

```json
{
  "name": "mcp-weather-server",
  "version": "1.0.0",
  "type": "module",
  "main": "dist/index.js",
  "scripts": {
    "build": "tsc",
    "start": "node dist/index.js"
  }
}
```

## 创建 MCP Server

在 `src/index.ts` 中编写 Server 代码：

```typescript
import { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js'
import { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js'
import { z } from 'zod'

// 创建 MCP Server 实例
const server = new McpServer({
  name: 'weather-server',
  version: '1.0.0',
})

// 注册工具：获取天气
server.tool(
  'get_weather', // 工具名称
  '获取指定城市的当前天气信息', // 工具描述
  {
    city: z.string().describe('城市名称'), // 参数定义
  },
  async ({ city }) => {
    // 工具实现
    // 模拟天气数据（实际项目中调用天气 API）
    const weatherData: Record<string, string> = {
      北京: '晴，25°C，东北风3级',
      上海: '多云，28°C，东南风2级',
      广州: '阵雨，30°C，南风4级',
      深圳: '多云，29°C，西南风3级',
    }

    const weather = weatherData[city]

    if (weather) {
      return {
        content: [{ type: 'text', text: `${city}天气：${weather}` }],
      }
    } else {
      return {
        content: [{ type: 'text', text: `暂无${city}的天气数据` }],
        isError: true,
      }
    }
  }
)

// 启动 Server
async function main() {
  const transport = new StdioServerTransport()
  await server.connect(transport)
  console.error('Weather MCP Server 已启动') // 注意用 stderr
}

main().catch(console.error)
```

代码解析：

**McpServer**：SDK 提供的 Server 类，封装了 MCP 协议的实现细节。

**server.tool()**：注册一个工具。四个参数：

1. 工具名称（Client 调用时使用）
2. 工具描述（大模型用来理解工具用途）
3. 参数 Schema（使用 Zod 定义）
4. 工具实现函数

**StdioServerTransport**：stdio 传输层实现，处理 stdin/stdout 的读写。

**返回值格式**：工具必须返回 `{ content: ContentItem[] }` 格式。content 是数组，每个元素可以是文本、图片等类型。如果执行失败，加上 `isError: true`。

## 构建并测试

编译 TypeScript：

```bash
pnpm build
```

直接运行会发现进程挂起——因为它在等待 stdin 输入：

```bash
node dist/index.js
# 进程等待中...
```

这是正常的。MCP Server 设计上就是被 Host 启动并通过 stdin/stdout 通信的，不是直接手动运行的。

## 使用 MCP Inspector 调试

手动测试 MCP Server 很麻烦，官方提供了 **MCP Inspector** 工具。

在项目目录下运行：

```bash
npx @modelcontextprotocol/inspector node dist/index.js
```

Inspector 会在浏览器打开一个调试界面。在界面上你可以：

1. 查看 Server 信息（名称、版本）
2. 列出所有注册的工具
3. 手动调用工具并查看返回结果

点击「Tools」标签，你会看到 `get_weather` 工具。点击它，在参数输入框填入 `{"city": "北京"}`，点击「Run」：

```json
{
  "content": [
    {
      "type": "text",
      "text": "北京天气：晴，25°C，东北风3级"
    }
  ]
}
```

调试通过，Server 工作正常。

## 配置 Claude Desktop

把 Server 接入 Claude Desktop，体验完整的 AI 对话流程。

找到 Claude Desktop 的配置文件：

- **macOS**: `~/Library/Application Support/Claude/claude_desktop_config.json`
- **Windows**: `%APPDATA%\Claude\claude_desktop_config.json`

如果文件不存在，创建它。添加以下配置：

```json
{
  "mcpServers": {
    "weather": {
      "command": "node",
      "args": ["/你的项目路径/mcp-weather-server/dist/index.js"]
    }
  }
}
```

**注意**：`args` 中的路径必须是**绝对路径**。

配置说明：

- `mcpServers`：MCP Server 配置的根节点
- `weather`：Server 的标识名，可以自定义
- `command`：启动 Server 的命令
- `args`：命令参数，这里是 Server 入口文件的路径

保存配置后，**完全退出并重启 Claude Desktop**（不是关闭窗口，要从菜单栏退出）。

重启后，打开一个新对话，试试这些提问：

- "北京今天天气怎么样？"
- "帮我查一下上海的天气"
- "深圳现在是什么天气？"

Claude 会识别出你的问题涉及天气查询，自动调用 `get_weather` 工具，把结果整合到回复中。

## 处理初始化参数

有时候 MCP Server 需要接收启动参数，比如 API Key、工作目录等。

修改配置，传入参数：

```json
{
  "mcpServers": {
    "weather": {
      "command": "node",
      "args": ["/你的项目路径/dist/index.js"],
      "env": {
        "WEATHER_API_KEY": "your-api-key"
      }
    }
  }
}
```

在代码中读取：

```typescript
const apiKey = process.env.WEATHER_API_KEY

if (!apiKey) {
  console.error('错误：缺少 WEATHER_API_KEY 环境变量')
  process.exit(1)
}
```

`env` 字段用于设置 Server 进程的环境变量，适合传递敏感信息。

## 添加更多工具

一个 Server 可以注册多个工具。给 weather server 加一个查询空气质量的工具：

```typescript
server.tool(
  'get_air_quality',
  '获取指定城市的空气质量指数',
  {
    city: z.string().describe('城市名称'),
  },
  async ({ city }) => {
    const aqiData: Record<string, { aqi: number; level: string }> = {
      北京: { aqi: 75, level: '良' },
      上海: { aqi: 45, level: '优' },
      广州: { aqi: 60, level: '良' },
      深圳: { aqi: 35, level: '优' },
    }

    const data = aqiData[city]

    if (data) {
      return {
        content: [
          {
            type: 'text',
            text: `${city}空气质量：AQI ${data.aqi}，${data.level}`,
          },
        ],
      }
    } else {
      return {
        content: [{ type: 'text', text: `暂无${city}的空气质量数据` }],
        isError: true,
      }
    }
  }
)
```

重新构建后，在 Claude Desktop 里可以问：

- "北京的空气质量怎么样？"
- "上海今天适合户外运动吗？"（Claude 会综合天气和空气质量回答）

## 完整代码

```typescript
// src/index.ts
import { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js'
import { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js'
import { z } from 'zod'

const server = new McpServer({
  name: 'weather-server',
  version: '1.0.0',
})

// 天气数据（模拟）
const weatherData: Record<string, string> = {
  北京: '晴，25°C，东北风3级',
  上海: '多云，28°C，东南风2级',
  广州: '阵雨，30°C，南风4级',
  深圳: '多云，29°C，西南风3级',
}

// 空气质量数据（模拟）
const aqiData: Record<string, { aqi: number; level: string }> = {
  北京: { aqi: 75, level: '良' },
  上海: { aqi: 45, level: '优' },
  广州: { aqi: 60, level: '良' },
  深圳: { aqi: 35, level: '优' },
}

// 工具：获取天气
server.tool(
  'get_weather',
  '获取指定城市的当前天气信息',
  { city: z.string().describe('城市名称') },
  async ({ city }) => {
    const weather = weatherData[city]
    if (weather) {
      return { content: [{ type: 'text', text: `${city}天气：${weather}` }] }
    }
    return {
      content: [{ type: 'text', text: `暂无${city}的天气数据` }],
      isError: true,
    }
  }
)

// 工具：获取空气质量
server.tool(
  'get_air_quality',
  '获取指定城市的空气质量指数',
  { city: z.string().describe('城市名称') },
  async ({ city }) => {
    const data = aqiData[city]
    if (data) {
      return {
        content: [
          {
            type: 'text',
            text: `${city}空气质量：AQI ${data.aqi}，${data.level}`,
          },
        ],
      }
    }
    return {
      content: [{ type: 'text', text: `暂无${city}的空气质量数据` }],
      isError: true,
    }
  }
)

// 启动
async function main() {
  const transport = new StdioServerTransport()
  await server.connect(transport)
  console.error('Weather MCP Server 已启动')
}

main().catch(console.error)
```

## 常见问题

**Q: Claude Desktop 没有检测到 Server？**

检查几个点：

1. 配置文件路径是否正确（注意大小写）
2. `args` 中的路径是否是绝对路径
3. 是否完全退出并重启了 Claude Desktop
4. Server 代码是否有语法错误（先用 Inspector 测试）

**Q: Server 启动后立即退出？**

可能是代码中有 `console.log`，导致协议解析失败。改用 `console.error` 输出调试信息。

**Q: 工具没有被 Claude 调用？**

检查工具的 description 是否清晰。大模型根据 description 判断何时使用工具。描述要准确说明工具的功能和适用场景。

## 下一步

这篇搭建了一个基础的 MCP Server，下一篇会深入 Tools 的高级用法：

- 复杂参数类型（嵌套对象、数组）
- 参数校验与默认值
- 错误处理最佳实践
- 异步工具与长时间任务

## 参考

- [MCP TypeScript SDK](https://github.com/modelcontextprotocol/typescript-sdk)
- [MCP Inspector](https://github.com/modelcontextprotocol/inspector)
- [Claude Desktop 配置文档](https://modelcontextprotocol.io/quickstart/user)
