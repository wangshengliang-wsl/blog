---

---

<button
  id="nav-open-button"
  class="hidden lt-md:flex items-center justify-center min-w-11 min-h-11 op-60 hover:op-100 op-transition touch-target"
  title="Navigation"
  aria-label="打开导航菜单"
  aria-expanded="false"
  aria-controls="nav-panel"
>
  <div u-i-ri-menu-line class="text-xl"></div>
</button>

<div
  id="nav-panel"
  class="hidden! fixed top-16
    overflow-y-auto flex flex-col gap-5
    w-[min(90vw,24rem)] max-h-[calc(100vh-5rem)] py-4 px-6 rounded-lg touch-scroll
    bg-[var(--c-bg)] shadow-custom_0_0_10_0 text-[var(--c-text)]"
  style="left: 50%; view-transition-name: none;"
  role="dialog"
  aria-modal="true"
  aria-label="导航菜单"
>
  <!-- 关闭按钮 -->
  <button
    id="nav-close-button"
    class="absolute top-3 right-3 p-2 op-50 hover:op-100 op-transition rounded-full touch-target"
    aria-label="关闭导航菜单"
  >
    <div u-i-ri-close-line class="text-lg"></div>
  </button>

  <ul class="mt-2">
    <slot name="text" />
  </ul>
  <div class="flex justify-center items-center gap-4 flex-wrap">
    <slot name="icon" />
  </div>
</div>

<script>
  import { toggleFadeEffect } from '~/utils/misc'

  document.addEventListener('astro:page-load', () => {
    const navPanel = document.getElementById('nav-panel')
    const navOpenButton = document.getElementById('nav-open-button')
    const navCloseButton = document.getElementById('nav-close-button')
    const backdrop = document.getElementById('backdrop')

    /* 重置面板状态 */
    const resetNavPanel = () => {
      if (navPanel) {
        // Ensure left: 50% is set for centering
        navPanel.style.left = '50%'
        // Don't remove transform - let CSS handle it completely
        // CSS will apply transform: translateX(-50%) for centering
      }
    }

    /* 页面加载时重置面板状态 */
    navPanel?.classList.remove('visible', 'fade-in', 'fade-out')
    navPanel?.classList.add('hidden!')
    backdrop?.classList.remove('fade-in', 'fade-out')
    backdrop?.classList.add('hidden')
    navOpenButton?.setAttribute('aria-expanded', 'false')
    resetNavPanel()

    /* 阻止点击事件冒泡到 backdrop */
    const stopPropagation = (e: Event) => {
      e.stopPropagation()
    }

    /* 打开导航面板 */
    const openNavPanel = () => {
      // Reset position before opening - ensure left: 50% for centering
      if (navPanel) {
        navPanel.style.left = '50%'
        // Don't touch transform - CSS handles it with translateX(-50%)
        // 阻止点击事件冒泡，确保可以直接点击面板内容
        navPanel.addEventListener('click', stopPropagation, true)
      }

      toggleFadeEffect('backdrop', true, 'hidden')
      toggleFadeEffect('nav-panel', true, 'hidden!')

      // Use double requestAnimationFrame to ensure CSS transition works
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          navPanel?.classList.add('visible')
        })
      })
      navOpenButton?.setAttribute('aria-expanded', 'true')

      // 聚焦到关闭按钮（无障碍）
      navCloseButton?.focus()
    }

    /* 关闭导航面板 */
    const closeNavPanel = () => {
      // 移除事件监听器
      if (navPanel) {
        navPanel.removeEventListener('click', stopPropagation, true)
      }

      toggleFadeEffect('backdrop', false, 'hidden')
      toggleFadeEffect('nav-panel', false, 'hidden!')
      navPanel?.classList.remove('visible')
      navOpenButton?.setAttribute('aria-expanded', 'false')

      // Reset position after animation completes
      setTimeout(() => {
        resetNavPanel()
      }, 300) // Match animation duration

      // 恢复焦点到打开按钮
      navOpenButton?.focus()
    }

    /* 事件绑定 */
    navOpenButton?.addEventListener('click', openNavPanel)
    navCloseButton?.addEventListener('click', closeNavPanel)
  })
</script>
