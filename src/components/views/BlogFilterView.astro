---
import { render } from 'astro:content'

import Categorizer from '~/components/base/Categorizer.astro'
import ListItem from '~/components/views/ListItem.astro'
import Warning from '~/components/base/Warning.astro'

import { getFilteredPosts, getPostsByCategory } from '~/utils/data'

import type { CollectionEntry } from 'astro:content'

const WARNING = `No content available for display.`

/* Posts */
const blogItems = await getFilteredPosts('blog')
const categorizedBlogItems = getPostsByCategory(blogItems)
const sortedBlogItems = categorizedBlogItems.flatMap(([_, p]) => p)

const categories = categorizedBlogItems.map(([category]) => category)
const isEmpty = sortedBlogItems.length === 0

// 预处理文章数据，添加阅读时间
interface PostWithReadTime {
  post: CollectionEntry<'blog' | 'changelog'>
  minutesRead: number
  category: string
  globalIdx: number
}

const postsWithReadTime: PostWithReadTime[] = []
let globalIdx = 0

// 用于 TOC 的文章数据
interface TocPostData {
  title: string
  slug: string
  category: string
}
const tocPostsData: TocPostData[] = []

for (const [category, posts] of categorizedBlogItems) {
  for (const post of posts) {
    const { remarkPluginFrontmatter } = await render(post)
    const minutesRead =
      post.data.minutesRead || remarkPluginFrontmatter.minutesRead
    postsWithReadTime.push({
      post,
      minutesRead,
      category,
      globalIdx: globalIdx++,
    })
    // 收集 TOC 数据
    tocPostsData.push({
      title: post.data.title,
      slug: post.id,
      category,
    })
  }
}
---

{
  isEmpty ? (
    <Warning html={WARNING} />
  ) : (
    <blog-filter-view
      data-categories={JSON.stringify(categories)}
      data-posts={JSON.stringify(tocPostsData)}
    >
      {/* 左侧分类导航 - 桌面端 */}
      <aside class="category-sidebar lt-lgp:hidden">
        <nav class="toc-desktop toc-desktop-content" id="blog-filter-toc">
          <a href="/" class="back-home-link" title="返回首页">
            <span class="i-ri-arrow-left-line" />
            <span>返回首页</span>
          </a>
          <ul id="blog-filter-toc-list" class="category-nav">
            {/* 全部分类选项 */}
            <li class="category-group">
              <button
                type="button"
                class="category-header active"
                data-category="all"
              >
                <span class="category-name">全部</span>
                <span class="category-count">({sortedBlogItems.length})</span>
              </button>
            </li>
            {/* 各分类及其文章 */}
            {categorizedBlogItems.map(([category, posts]) => (
              <li class="category-group">
                <button
                  type="button"
                  class="category-header"
                  data-category={category}
                >
                  <span class="expand-icon i-ri-arrow-right-s-line" />
                  <span class="category-name">{category}</span>
                  <span class="category-count">({posts.length})</span>
                </button>
                <ul class="category-posts">
                  {posts.map((post) => (
                    <li>
                      <a
                        href={`/blog/${post.id}/`}
                        class="post-link"
                        title={post.data.title}
                      >
                        {post.data.title}
                      </a>
                    </li>
                  ))}
                </ul>
              </li>
            ))}
          </ul>
        </nav>
      </aside>

      {/* 移动端分类抽屉触发按钮 */}
      <button
        type="button"
        class="category-drawer-trigger hidden lt-lgp:flex"
        id="category-drawer-trigger"
        aria-label="打开分类导航"
      >
        <span class="i-ri-menu-fold-line text-xl" />
      </button>

      {/* 移动端抽屉 */}
      <div class="category-drawer hidden lt-lgp:block" id="category-drawer">
        <div class="drawer-overlay" id="drawer-overlay" />
        <div class="drawer-content">
          <div class="drawer-header">
            <a href="/" class="back-home-link-mobile" title="返回首页">
              <span class="i-ri-arrow-left-line" />
              <span>返回首页</span>
            </a>
            <button
              type="button"
              class="drawer-close"
              id="drawer-close"
              aria-label="关闭"
            >
              <span class="i-ri-close-line text-xl" />
            </button>
          </div>
          <ul class="category-nav mobile-nav">
            {/* 全部分类选项 */}
            <li class="category-group">
              <button
                type="button"
                class="category-header active"
                data-category="all"
              >
                <span class="category-name">全部</span>
                <span class="category-count">({sortedBlogItems.length})</span>
              </button>
            </li>
            {/* 各分类及其文章 */}
            {categorizedBlogItems.map(([category, posts]) => (
              <li class="category-group">
                <button
                  type="button"
                  class="category-header"
                  data-category={category}
                >
                  <span class="expand-icon i-ri-arrow-right-s-line" />
                  <span class="category-name">{category}</span>
                  <span class="category-count">({posts.length})</span>
                </button>
                <ul class="category-posts">
                  {posts.map((post) => (
                    <li>
                      <a
                        href={`/blog/${post.id}/`}
                        class="post-link"
                        title={post.data.title}
                      >
                        {post.data.title}
                      </a>
                    </li>
                  ))}
                </ul>
              </li>
            ))}
          </ul>
        </div>
      </div>

      {/* 文章列表 */}
      <div aria-label="Post list" id="blog-post-list" class="mt-10">
        {postsWithReadTime.map(
          ({ post, minutesRead, category, globalIdx }, idx) => {
            const { data, id } = post
            const isFirstInCategory =
              idx === 0 || postsWithReadTime[idx - 1]?.category !== category

            return (
              <div class="post-item" data-category={category}>
                {isFirstInCategory && (
                  <Categorizer idx={globalIdx} needId={true} text={category} />
                )}
                <ListItem
                  idx={globalIdx}
                  collectionType="blog"
                  redirect={data.redirect}
                  postSlug={id}
                  title={data.title}
                  titleIcon={data.titleIcon}
                  video={data.video}
                  radio={data.radio}
                  date={data.pubDate}
                  {minutesRead}
                  platform={data.platform}
                />
              </div>
            )
          }
        )}
      </div>
    </blog-filter-view>
  )
}

<style>
  /* 返回首页按钮 */
  .back-home-link {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.5rem 0;
    margin-bottom: 0.75rem;
    font-size: 0.875rem;
    color: inherit;
    text-decoration: none;
    opacity: 0.8;
    transition: opacity 0.2s;
    border-bottom: 1px solid rgba(125, 125, 125, 0.15);
  }

  .back-home-link:hover {
    opacity: 1;
  }

  .back-home-link-mobile {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.9rem;
    font-weight: 500;
    color: inherit;
    text-decoration: none;
    opacity: 0.8;
    transition: opacity 0.2s;
  }

  .back-home-link-mobile:hover {
    opacity: 1;
  }

  /* 分类导航样式 */
  .category-nav {
    list-style: none;
    padding: 0;
    padding-right: 0.5rem;
    margin: 0;
  }

  .category-group {
    margin-bottom: 0.25rem;
  }

  .category-header {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    width: 100%;
    padding: 0.375rem 0;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 0.875rem;
    color: inherit;
    opacity: 0.85;
    transition: opacity 0.2s;
    text-align: left;
  }

  .category-header:hover {
    opacity: 1;
  }

  .category-header.active {
    opacity: 1;
    font-weight: 500;
  }

  .expand-icon {
    transition: transform 0.2s;
    font-size: 1rem;
    flex-shrink: 0;
  }

  .category-header.expanded .expand-icon {
    transform: rotate(90deg);
  }

  .category-name {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .category-count {
    opacity: 0.7;
    font-size: 0.75rem;
    flex-shrink: 0;
    padding-right: 0.5rem;
  }

  /* 文章列表缩进 */
  .category-posts {
    list-style: none;
    padding-left: 1.25rem;
    margin: 0;
    overflow: hidden;
    max-height: 0;
    transition: max-height 0.3s ease;
  }

  .category-posts.expanded {
    max-height: 2000px;
  }

  .category-posts li {
    padding: 0.2rem 0;
  }

  .category-posts .post-link {
    font-size: 0.8125rem;
    opacity: 0.75;
    transition: opacity 0.2s;
    display: block;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    color: inherit;
    text-decoration: none;
    border-bottom: none !important;
  }

  .category-posts .post-link:hover {
    opacity: 1;
  }

  /* 移动端抽屉触发按钮 */
  .category-drawer-trigger {
    position: fixed;
    bottom: 1.5rem;
    left: 1.5rem;
    z-index: 40;
    width: 3rem;
    height: 3rem;
    border-radius: 50%;
    background: var(--c-bg);
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(125, 125, 125, 0.2);
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
  }

  .category-drawer-trigger:hover {
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    transform: scale(1.05);
  }

  /* 抽屉遮罩 */
  .drawer-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
    z-index: 200;
  }

  /* 抽屉内容 */
  .drawer-content {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 80%;
    max-width: 300px;
    background: var(--c-bg);
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    overflow-y: auto;
    padding: 1rem;
    z-index: 201;
    box-shadow: 2px 0 12px rgba(0, 0, 0, 0.1);
  }

  .category-drawer.open .drawer-overlay {
    opacity: 1;
    pointer-events: auto;
  }

  .category-drawer.open .drawer-content {
    transform: translateX(0);
  }

  .drawer-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-bottom: 1rem;
    margin-bottom: 0.5rem;
    border-bottom: 1px solid rgba(125, 125, 125, 0.2);
  }

  .drawer-close {
    background: none;
    border: none;
    cursor: pointer;
    opacity: 0.6;
    transition: opacity 0.2s;
    padding: 0.25rem;
  }

  .drawer-close:hover {
    opacity: 1;
  }

  /* 移动端导航样式调整 */
  .mobile-nav .category-header {
    padding: 0.5rem 0;
  }

  .mobile-nav .category-posts .post-link {
    padding: 0.375rem 0;
  }

  /* 文章列表项隐藏 */
  .post-item.hidden {
    display: none;
  }
</style>

<script>
  class BlogFilterView extends HTMLElement {
    private categories: string[] = []
    private expandedCategories: Set<string> = new Set<string>()

    connectedCallback() {
      this.categories = JSON.parse(this.dataset.categories || '[]')
      this.init()
    }

    private init() {
      this.setupCategoryHeaders()
      this.setupDrawer()
      this.restoreCategoryFromStorage()
      this.restoreExpandedFromStorage()
    }

    private setupCategoryHeaders() {
      // 桌面端和移动端的分类头部
      const headers = this.querySelectorAll('.category-header')
      headers.forEach((header) => {
        header.addEventListener('click', () => {
          const category = (header as HTMLElement).dataset.category || 'all'
          const hasExpandIcon = header.querySelector('.expand-icon')

          // 如果有展开图标（非"全部"选项），切换展开状态
          if (hasExpandIcon) {
            this.toggleCategoryExpand(category, header as HTMLElement)
          }

          // 筛选文章
          this.filterByCategory(category)
          this.updateActiveCategory(category)
        })
      })
    }

    private setupDrawer() {
      const trigger = document.querySelector('#category-drawer-trigger')
      const drawer = document.querySelector('#category-drawer')
      const overlay = document.querySelector('#drawer-overlay')
      const closeBtn = document.querySelector('#drawer-close')

      trigger?.addEventListener('click', () => {
        drawer?.classList.add('open')
      })

      const closeDrawer = () => {
        drawer?.classList.remove('open')
      }

      overlay?.addEventListener('click', closeDrawer)
      closeBtn?.addEventListener('click', closeDrawer)
    }

    private toggleCategoryExpand(category: string, header: HTMLElement) {
      const postsContainer = header.nextElementSibling as HTMLElement
      if (!postsContainer) return

      const isExpanded = postsContainer.classList.contains('expanded')

      if (isExpanded) {
        postsContainer.classList.remove('expanded')
        header.classList.remove('expanded')
        this.expandedCategories.delete(category)
      } else {
        postsContainer.classList.add('expanded')
        header.classList.add('expanded')
        this.expandedCategories.add(category)
      }

      this.saveExpandedToStorage()
    }

    private updateActiveCategory(category: string) {
      // 更新桌面端和移动端的激活状态
      const allHeaders = this.querySelectorAll('.category-header')
      allHeaders.forEach((header) => {
        const headerCategory = (header as HTMLElement).dataset.category || 'all'
        if (headerCategory === category) {
          header.classList.add('active')
        } else {
          header.classList.remove('active')
        }
      })
    }

    private restoreCategoryFromStorage() {
      const savedCategory = localStorage.getItem('blog-filter-category')
      const categoryToRestore =
        savedCategory &&
        (savedCategory === 'all' || this.categories.includes(savedCategory))
          ? savedCategory
          : 'all'

      if (categoryToRestore !== 'all') {
        this.filterByCategory(categoryToRestore)
      }
      this.updateActiveCategory(categoryToRestore)
    }

    private restoreExpandedFromStorage() {
      try {
        const saved = localStorage.getItem('blog-filter-expanded')
        if (saved) {
          const expandedArray = JSON.parse(saved) as string[]
          this.expandedCategories = new Set(expandedArray)

          // 恢复展开状态
          expandedArray.forEach((category) => {
            const headers = this.querySelectorAll(
              `.category-header[data-category="${category}"]`
            )
            headers.forEach((header) => {
              const postsContainer = header.nextElementSibling as HTMLElement
              if (postsContainer?.classList.contains('category-posts')) {
                postsContainer.classList.add('expanded')
                header.classList.add('expanded')
              }
            })
          })
        }
      } catch {
        // ignore
      }
    }

    private saveExpandedToStorage() {
      localStorage.setItem(
        'blog-filter-expanded',
        JSON.stringify([...this.expandedCategories])
      )
    }

    private filterByCategory(category: string) {
      // 保存到 localStorage
      localStorage.setItem('blog-filter-category', category)
      const postItems = this.querySelectorAll('.post-item')

      // 用于追踪每个分类的第一篇文章
      const categoryFirstPost = new Map<string, boolean>()

      postItems.forEach((item) => {
        const itemCategory = (item as HTMLElement).dataset.category
        const categorizer = item.querySelector('.toc-heading')

        if (category === 'all') {
          // 显示所有文章
          item.classList.remove('hidden')
          // 显示分类标题（如果是该分类的第一篇）
          if (categorizer) {
            if (!categoryFirstPost.has(itemCategory!)) {
              categoryFirstPost.set(itemCategory!, true)
              ;(categorizer as HTMLElement).style.display = ''
            }
          }
        } else {
          // 筛选特定分类
          if (itemCategory === category) {
            item.classList.remove('hidden')
            // 显示分类标题（如果是该分类的第一篇）
            if (categorizer) {
              if (!categoryFirstPost.has(itemCategory!)) {
                categoryFirstPost.set(itemCategory!, true)
                ;(categorizer as HTMLElement).style.display = ''
              }
            }
          } else {
            item.classList.add('hidden')
            if (categorizer) {
              ;(categorizer as HTMLElement).style.display = 'none'
            }
          }
        }
      })
    }
  }

  customElements.define('blog-filter-view', BlogFilterView)
</script>
