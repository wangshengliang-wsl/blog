---
import '~/styles/music.css'
---

<aside class="song-list-container">
  <div class="song-list-header">
    <h2 class="song-list-title">
      <span class="i-ri-music-2-line mr-2"></span>
      <span id="current-album-name">播放列表</span>
    </h2>
    <span class="song-count" id="song-count"></span>
  </div>

  <!-- 当前唱片信息 -->
  <div
    class="current-album-info"
    id="current-album-info"
    style="display: none;"
  >
    <div class="album-cover-mini" id="album-cover-mini"></div>
    <div class="album-details">
      <p class="album-artist" id="album-artist">--</p>
      <p class="album-description" id="album-description">--</p>
    </div>
  </div>

  <!-- 专辑详情悬浮窗 -->
  <div class="album-popup" id="album-popup">
    <div class="album-popup-cover" id="album-popup-cover"></div>
    <div class="album-popup-content">
      <h3 class="album-popup-name" id="album-popup-name" aria-label="专辑名称">
        专辑名称
      </h3>
      <p class="album-popup-artist" id="album-popup-artist"></p>
      <p class="album-popup-desc" id="album-popup-desc"></p>
      <div class="album-popup-meta">
        <span class="i-ri-music-2-line"></span>
        <span id="album-popup-songs"></span>
      </div>
    </div>
  </div>

  <!-- 歌曲列表 -->
  <div class="song-list" id="song-list">
    <div class="empty-song-list" id="empty-song-list">
      <span class="i-ri-disc-line text-5xl op-20"></span>
      <p class="mt-3 op-40 text-sm">点击或拖拽唱片到留声机</p>
      <p class="op-30 text-xs">开始播放音乐</p>
    </div>
  </div>

  <!-- 播放控制 -->
  <div class="playback-controls" id="playback-controls" style="display: none;">
    <div class="now-playing" id="now-playing">
      <span class="i-ri-headphone-line mr-1"></span>
      <span class="now-playing-text">未播放</span>
    </div>
    <div class="progress-bar" id="progress-bar">
      <div class="progress-current" id="progress-current"></div>
      <div class="progress-handle" id="progress-handle"></div>
    </div>
    <div class="time-display">
      <span id="current-time">0:00</span>
      <span id="total-time">0:00</span>
    </div>

    <!-- 倍速控制 -->
    <div class="speed-control">
      <span class="speed-label">倍速</span>
      <div class="speed-options">
        <button class="speed-btn" data-rate="0.5">0.5x</button>
        <button class="speed-btn active" data-rate="1.0">1.0x</button>
        <button class="speed-btn" data-rate="1.5">1.5x</button>
        <button class="speed-btn" data-rate="2.0">2.0x</button>
      </div>
    </div>
  </div>
</aside>

<style>
  .song-list-container {
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
  }

  .song-list-header {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 0.75rem;
    border-bottom: 1px solid rgba(128, 128, 128, 0.1);
  }

  .song-list-title {
    display: flex;
    align-items: center;
    font-size: 1rem;
    font-weight: 600;
    margin: 0;
    min-width: 0;
    flex: 1;
  }

  .song-list-title #current-album-name {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 150px;
  }

  .song-count {
    font-size: 0.7rem;
    padding: 0.2rem 0.4rem;
    background: rgba(139, 69, 19, 0.1);
    color: rgba(139, 69, 19, 0.8);
    border-radius: 10px;
    font-weight: 500;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .song-count:empty {
    display: none;
  }

  .current-album-info {
    flex-shrink: 0;
    display: flex;
    gap: 0.5rem;
    padding: 0.75rem;
    background: rgba(128, 128, 128, 0.05);
    border-bottom: 1px solid rgba(128, 128, 128, 0.1);
  }

  .album-cover-mini {
    width: 40px;
    height: 40px;
    border-radius: 6px;
    background-size: cover;
    background-position: center;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    flex-shrink: 0;
  }

  .album-details {
    flex: 1;
    min-width: 0;
  }

  .album-artist {
    font-size: 0.875rem;
    font-weight: 500;
    margin: 0 0 0.25rem;
  }

  .album-description {
    font-size: 0.75rem;
    opacity: 0.6;
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .song-list {
    flex: 1;
    overflow-y: auto;
    overscroll-behavior: contain;
    padding: 0.5rem;
    scrollbar-width: thin;
  }

  .song-list::-webkit-scrollbar {
    width: 4px;
  }

  .song-list::-webkit-scrollbar-thumb {
    background: rgba(128, 128, 128, 0.3);
    border-radius: 2px;
  }

  .empty-song-list {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    text-align: center;
    padding: 2rem;
  }

  .playback-controls {
    padding: 1rem;
    border-top: 1px solid rgba(128, 128, 128, 0.1);
    background: rgba(128, 128, 128, 0.05);
  }

  .now-playing {
    display: flex;
    align-items: center;
    font-size: 0.8125rem;
    margin-bottom: 0.75rem;
    color: rgba(139, 69, 19, 0.8);
    font-weight: 500;
  }

  .now-playing-text {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .progress-bar {
    position: relative;
    height: 6px;
    background: rgba(128, 128, 128, 0.2);
    border-radius: 3px;
    cursor: pointer;
    transition: height 0.2s ease;
  }

  .progress-bar:hover {
    height: 8px;
  }

  .progress-current {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #8b4513, #cd853f);
    border-radius: 3px;
    transition: width 0.1s linear;
  }

  .progress-handle {
    position: absolute;
    top: 50%;
    left: 0%;
    transform: translate(-50%, -50%) scale(0);
    width: 14px;
    height: 14px;
    background: #8b4513;
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    transition: transform 0.2s ease;
  }

  .progress-bar:hover .progress-handle {
    transform: translate(-50%, -50%) scale(1);
  }

  .time-display {
    display: flex;
    justify-content: space-between;
    margin-top: 0.5rem;
    font-size: 0.75rem;
    opacity: 0.6;
  }

  .speed-control {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid rgba(128, 128, 128, 0.1);
  }

  .speed-label {
    font-size: 0.75rem;
    opacity: 0.6;
  }

  .speed-options {
    display: flex;
    gap: 0.25rem;
  }

  .speed-btn {
    font-size: 0.7rem;
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    border: 1px solid transparent;
    background: transparent;
    opacity: 0.6;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .speed-btn:hover {
    opacity: 1;
    background: rgba(128, 128, 128, 0.1);
  }

  .speed-btn.active {
    opacity: 1;
    background: rgba(139, 69, 19, 0.1);
    color: #8b4513;
    border-color: rgba(139, 69, 19, 0.2);
  }

  /* Album popup styles */
  .album-popup {
    position: fixed;
    width: 220px;
    background: rgba(40, 40, 40, 0.98);
    backdrop-filter: blur(20px);
    border-radius: 12px;
    padding: 0.75rem;
    box-shadow:
      0 8px 24px rgba(0, 0, 0, 0.4),
      0 0 0 1px rgba(255, 255, 255, 0.08);
    opacity: 0;
    visibility: hidden;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 1000;
    pointer-events: none;
    color: #fff;
  }

  :global(:not(.dark)) .album-popup {
    background: rgba(255, 255, 255, 0.98);
    box-shadow:
      0 8px 24px rgba(0, 0, 0, 0.12),
      0 0 0 1px rgba(0, 0, 0, 0.06);
    color: #1a1a1a;
  }

  .album-popup.visible {
    opacity: 1;
    visibility: visible;
  }

  .album-popup-cover {
    width: 100%;
    aspect-ratio: 1;
    border-radius: 8px;
    background-size: cover;
    background-position: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
    margin-bottom: 0.75rem;
  }

  .album-popup-content {
    text-align: center;
  }

  .album-popup-name {
    font-size: 0.9375rem;
    font-weight: 600;
    margin: 0 0 0.125rem;
    color: inherit;
  }

  .album-popup-artist {
    font-size: 0.75rem;
    opacity: 0.7;
    margin: 0 0 0.5rem;
    color: inherit;
  }

  .album-popup-desc {
    font-size: 0.6875rem;
    line-height: 1.5;
    opacity: 0.85;
    margin: 0 0 0.5rem;
    color: inherit;
  }

  .album-popup-meta {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
    font-size: 0.6875rem;
    opacity: 0.6;
    color: inherit;
  }

  @media (max-width: 768px) {
    .song-list-container {
      height: auto;
      max-height: calc(100vh - 9rem);
      margin-right: 0;
      padding-right: 0;
      border-radius: 16px;
    }

    .album-popup {
      display: none;
    }
  }

  @media (max-width: 1200px) {
    .album-popup {
      display: none;
    }
  }
</style>

<script>
  interface Song {
    id: string
    name: string
    url: string
  }

  interface Album {
    id: string
    name: string
    description: string
    artist: string
    cover: string
    color: string
    songs: Song[]
  }

  document.addEventListener('astro:page-load', () => {
    const songList = document.getElementById('song-list')
    if (!songList || songList.dataset.initialized === 'true') return
    songList.dataset.initialized = 'true'

    const emptySongList = document.getElementById('empty-song-list')
    const currentAlbumName = document.getElementById('current-album-name')
    const songCount = document.getElementById('song-count')
    const currentAlbumInfo = document.getElementById('current-album-info')
    const albumCoverMini = document.getElementById('album-cover-mini')
    const albumArtist = document.getElementById('album-artist')
    const albumDescription = document.getElementById('album-description')
    const playbackControls = document.getElementById('playback-controls')
    const progressCurrent = document.getElementById('progress-current')
    const progressHandle = document.getElementById('progress-handle')
    const currentTimeEl = document.getElementById('current-time')
    const totalTimeEl = document.getElementById('total-time')
    const nowPlaying = document.getElementById('now-playing')
    const progressBar = document.getElementById('progress-bar')

    // Album popup elements
    const albumPopup = document.getElementById('album-popup')
    const albumPopupCover = document.getElementById('album-popup-cover')
    const albumPopupName = document.getElementById('album-popup-name')
    const albumPopupArtist = document.getElementById('album-popup-artist')
    const albumPopupDesc = document.getElementById('album-popup-desc')
    const albumPopupSongs = document.getElementById('album-popup-songs')

    let currentAlbum: Album | null = null

    // 监听唱片选择事件
    window.addEventListener('album-selected', ((e: CustomEvent) => {
      currentAlbum = e.detail
      if (currentAlbum) {
        renderSongList(currentAlbum)
      }
    }) as EventListener)

    // 监听播放进度更新
    window.addEventListener('playback-progress', ((e: CustomEvent) => {
      const { currentTime, duration, songIndex } = e.detail
      updateProgress(currentTime, duration)
      highlightCurrentSong(songIndex)
      updateNowPlaying(songIndex)
    }) as EventListener)

    // 监听播放状态变化
    window.addEventListener('playback-state', ((e: CustomEvent) => {
      const { isPlaying, songIndex } = e.detail
      updatePlayingState(isPlaying, songIndex)
      if (isPlaying) {
        updateNowPlaying(songIndex)
      } else {
        if (nowPlaying) {
          nowPlaying.querySelector('.now-playing-text')!.textContent = '已暂停'
        }
      }
    }) as EventListener)

    function renderSongList(album: Album) {
      if (
        !songList ||
        !currentAlbumName ||
        !currentAlbumInfo ||
        !playbackControls
      )
        return

      currentAlbumName.textContent = album.name

      // 更新歌曲数量
      if (songCount) {
        songCount.textContent = `${album.songs.length} 首`
      }

      if (albumCoverMini) {
        albumCoverMini.style.backgroundImage = `url(${album.cover})`
      }
      if (albumArtist) albumArtist.textContent = album.artist
      if (albumDescription) albumDescription.textContent = album.description

      currentAlbumInfo.style.display = 'flex'
      playbackControls.style.display = 'block'

      // 隐藏空状态
      if (emptySongList) {
        emptySongList.style.display = 'none'
      }

      // 渲染歌曲列表
      const songsHtml = album.songs
        .map(
          (song: Song, index: number) => `
        <div class="song-item" data-song-index="${index}" data-song-url="${song.url}" data-song-name="${song.name}">
          <span class="song-index">${index + 1}</span>
          <div class="song-info">
            <div class="song-name">${song.name}</div>
          </div>
          <div class="playing-indicator" style="display: none;">
            <span></span><span></span><span></span><span></span>
          </div>
        </div>
      `
        )
        .join('')

      // 保留空状态元素，添加歌曲列表
      songList.innerHTML = songsHtml + (emptySongList?.outerHTML || '')

      // 添加歌曲点击事件
      const songItems = songList.querySelectorAll('.song-item')
      songItems.forEach((item, index) => {
        item.addEventListener('click', () => {
          window.dispatchEvent(
            new CustomEvent('song-selected', {
              detail: { index, url: item.getAttribute('data-song-url') },
            })
          )
        })
      })
    }

    function updateProgress(currentTime: number, duration: number) {
      if (!progressCurrent || !currentTimeEl || !totalTimeEl) return

      const percent = duration > 0 ? (currentTime / duration) * 100 : 0
      progressCurrent.style.width = `${percent}%`

      // 更新进度手柄位置
      if (progressHandle) {
        progressHandle.style.left = `${percent}%`
      }

      currentTimeEl.textContent = formatTime(currentTime)
      totalTimeEl.textContent = formatTime(duration)
    }

    function formatTime(seconds: number): string {
      if (isNaN(seconds)) return '0:00'
      const mins = Math.floor(seconds / 60)
      const secs = Math.floor(seconds % 60)
      return `${mins}:${secs.toString().padStart(2, '0')}`
    }

    function updateNowPlaying(songIndex: number) {
      if (!nowPlaying || !currentAlbum) return
      const song = currentAlbum.songs[songIndex]
      if (song) {
        nowPlaying.querySelector('.now-playing-text')!.textContent =
          `正在播放: ${song.name}`
      }
    }

    function updatePlayingState(isPlaying: boolean, songIndex: number) {
      const songItems = songList?.querySelectorAll('.song-item')
      songItems?.forEach((item, i) => {
        const indicator = item.querySelector(
          '.playing-indicator'
        ) as HTMLElement
        const indexEl = item.querySelector('.song-index') as HTMLElement

        if (i === songIndex && isPlaying) {
          item.classList.add('playing')
          if (indicator) indicator.style.display = 'flex'
          if (indexEl) indexEl.style.display = 'none'
        } else {
          item.classList.remove('playing')
          if (indicator) indicator.style.display = 'none'
          if (indexEl) indexEl.style.display = ''
        }
      })
    }

    // 进度条点击跳转
    progressBar?.addEventListener('click', (e) => {
      const event = e as MouseEvent
      const rect = (progressBar as HTMLElement).getBoundingClientRect()
      const percent = (event.clientX - rect.left) / rect.width
      window.dispatchEvent(new CustomEvent('seek-to', { detail: percent }))
    })

    // 进度条拖拽
    let isDraggingProgress = false

    progressBar?.addEventListener('mousedown', () => {
      isDraggingProgress = true
    })

    document.addEventListener('mousemove', (e) => {
      if (!isDraggingProgress || !progressBar) return
      const rect = progressBar.getBoundingClientRect()
      let percent = (e.clientX - rect.left) / rect.width
      percent = Math.max(0, Math.min(1, percent))
      window.dispatchEvent(new CustomEvent('seek-to', { detail: percent }))
    })

    document.addEventListener('mouseup', () => {
      isDraggingProgress = false
    })

    const speedBtns = document.querySelectorAll('.speed-btn')
    let lastHighlightedIndex = -1

    // Speed control
    speedBtns.forEach((btn) => {
      btn.addEventListener('click', () => {
        const rate = parseFloat(btn.getAttribute('data-rate') || '1.0')

        // Update UI
        speedBtns.forEach((b) => b.classList.remove('active'))
        btn.classList.add('active')

        // Dispatch event
        window.dispatchEvent(
          new CustomEvent('set-playback-rate', { detail: rate })
        )
      })
    })

    // Album popup hover logic
    function showAlbumPopup() {
      if (!currentAlbum || !albumPopup) return

      // Update popup content
      if (albumPopupCover) {
        albumPopupCover.style.backgroundImage = `url(${currentAlbum.cover})`
      }
      if (albumPopupName) {
        albumPopupName.textContent = currentAlbum.name
      }
      if (albumPopupArtist) {
        albumPopupArtist.textContent = currentAlbum.artist
      }
      if (albumPopupDesc) {
        albumPopupDesc.textContent = currentAlbum.description
      }
      if (albumPopupSongs) {
        albumPopupSongs.textContent = `${currentAlbum.songs.length} 首歌曲`
      }

      // Position popup to the left of the sidebar, aligned with album info
      if (currentAlbumInfo) {
        const rect = currentAlbumInfo.getBoundingClientRect()
        const popupWidth = 220
        const gap = 12

        // Position at the same vertical level as album info
        let top = rect.top

        // Keep popup within viewport (minimum 80px from top to avoid header)
        const minTop = 80
        const maxTop = window.innerHeight - 320
        top = Math.max(minTop, Math.min(maxTop, top))

        albumPopup.style.top = `${top}px`
        albumPopup.style.left = `${rect.left - popupWidth - gap}px`
      }

      // Trigger animation
      requestAnimationFrame(() => {
        albumPopup.classList.add('visible')
      })
    }

    function hideAlbumPopup() {
      if (albumPopup) {
        albumPopup.classList.remove('visible')
      }
    }

    // Add hover listeners to album description
    albumDescription?.addEventListener('mouseenter', showAlbumPopup)
    albumDescription?.addEventListener('mouseleave', hideAlbumPopup)

    // Also trigger on album-details hover
    const albumDetails = document.querySelector('.album-details')
    albumDetails?.addEventListener('mouseenter', showAlbumPopup)
    albumDetails?.addEventListener('mouseleave', hideAlbumPopup)

    function highlightCurrentSong(index: number) {
      if (index === lastHighlightedIndex) return
      lastHighlightedIndex = index

      const songItems = songList?.querySelectorAll('.song-item')
      songItems?.forEach((item, i) => {
        if (i === index) {
          item.classList.add('current')
          // 自动滚动到当前歌曲
          item.scrollIntoView({ behavior: 'smooth', block: 'nearest' })
        } else {
          item.classList.remove('current')
        }
      })
    }
  })
</script>
