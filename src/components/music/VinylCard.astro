---
interface Song {
  id: string
  name: string
  url: string
}

interface Album {
  id: string
  name: string
  description: string
  artist: string
  cover: string
  color: string
  songs: Song[]
}

interface Props {
  album: Album
  index: number
}

const { album, index: _index } = Astro.props
---

<div
  class="vinyl-card"
  data-album-id={album.id}
  data-name={album.name}
  data-artist={album.artist}
  data-album={JSON.stringify(album)}
>
  <div class="vinyl-card-inner">
    <!-- 唱片视觉 -->
    <div
      class="vinyl-disc"
      style={`--cover-url: url(${album.cover}); --vinyl-color: ${album.color};`}
    >
      <div class="cover-center" style={`background-image: url(${album.cover})`}>
      </div>
    </div>

    <!-- 唱片信息 -->
    <div class="vinyl-info">
      <h3 class="vinyl-name">{album.name}</h3>
      <p class="vinyl-artist">{album.artist}</p>
      <p class="vinyl-songs-count">{album.songs.length} 首歌曲</p>
    </div>
  </div>

  <!-- 播放状态指示器 -->
  <div class="play-indicator">
    <span class="i-ri-play-circle-fill"></span>
  </div>
</div>

<style>
  .vinyl-card {
    position: relative;
    padding: 0.875rem;
    border-radius: 12px;
    background: rgba(128, 128, 128, 0.05);
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    user-select: none;
  }

  .vinyl-card:hover {
    background: rgba(128, 128, 128, 0.1);
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
  }

  .vinyl-card:active {
    transform: scale(0.98);
  }

  .vinyl-card.active {
    background: rgba(139, 69, 19, 0.1);
    box-shadow: 0 0 0 2px rgba(139, 69, 19, 0.3);
  }

  .vinyl-card-inner {
    display: flex;
    gap: 0.875rem;
    align-items: center;
  }

  .vinyl-disc {
    position: relative;
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: radial-gradient(
      circle at center,
      var(--vinyl-color, #1a1a1a) 0%,
      #1a1a1a 100%
    );
    box-shadow:
      inset 0 0 15px rgba(0, 0, 0, 0.5),
      0 2px 8px rgba(0, 0, 0, 0.2);
    flex-shrink: 0;
    transition: transform 0.3s ease;
  }

  .vinyl-card:hover .vinyl-disc {
    transform: rotate(15deg);
  }

  .vinyl-card.active .vinyl-disc {
    animation: spin 3s linear infinite;
  }

  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  .cover-center {
    position: absolute;
    inset: 2px;
    border-radius: 50%;
    background-size: cover;
    background-position: center;
    box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
  }

  .cover-center::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 50%;
    border: 2px solid rgba(0, 0, 0, 0.2);
    pointer-events: none;
  }

  .vinyl-info {
    flex: 1;
    min-width: 0;
  }

  .vinyl-name {
    font-size: 0.9375rem;
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin: 0 0 0.25rem;
  }

  .vinyl-artist {
    font-size: 0.8125rem;
    opacity: 0.6;
    margin: 0 0 0.25rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .vinyl-songs-count {
    font-size: 0.75rem;
    opacity: 0.4;
    margin: 0;
  }

  .play-indicator {
    position: absolute;
    top: 50%;
    right: 0.75rem;
    transform: translateY(-50%);
    opacity: 0;
    transition: opacity 0.2s ease;
    font-size: 1.5rem;
    color: rgba(139, 69, 19, 0.8);
  }

  .vinyl-card:hover .play-indicator {
    opacity: 1;
  }

  .vinyl-card.active .play-indicator {
    opacity: 1;
  }

  .vinyl-card.active .play-indicator span {
    animation: pulse 1s ease infinite;
  }

  @keyframes pulse {
    0%,
    100% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.1);
    }
  }
</style>

<script>
  document.addEventListener('astro:page-load', () => {
    const vinylCards = document.querySelectorAll('.vinyl-card')

    vinylCards.forEach((card) => {
      // Click to select album
      card.addEventListener('click', () => {
        const albumData = card.getAttribute('data-album')
        if (albumData) {
          // Remove active state from other cards
          vinylCards.forEach((c) => c.classList.remove('active'))
          card.classList.add('active')

          // Dispatch album selected event
          const album = JSON.parse(albumData)
          window.dispatchEvent(
            new CustomEvent('album-selected', {
              detail: album,
            })
          )

          // Auto-play first song after album is loaded
          setTimeout(() => {
            window.dispatchEvent(
              new CustomEvent('auto-play-album', {
                detail: { album },
              })
            )
          }, 100)
        }
      })
    })
  })
</script>
